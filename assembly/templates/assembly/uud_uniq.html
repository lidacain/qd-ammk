{% extends "users/base.html" %}
{% load static %}

{% block title %}UUD{% endblock %}

{% block content %}
<div id="uudPageRoot" data-user-role="{{ request.user.role|default_if_none:'' }}">
  <div class="container mt-4" style="max-width:720px">
    <h4 class="mb-3">–ü–æ—Å—Ç ‚Äî –£–£–î</h4>

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" action="">
      {% csrf_token %}

      <!-- VIN -->
      <div class="mb-3 position-relative">
        <label class="form-label">VIN <span class="text-danger">*</span></label>

        <div style="position: relative;">
          <input
            type="text"
            id="vin_search"
            name="vin"
            class="form-control"
            placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ VIN‚Ä¶"
            maxlength="17"
            autocomplete="off"
            autofocus
            value="{{ vin|default_if_none:'' }}"
          >
          <span
            id="clear_vin_search"
            style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#dc3545"
            title="–û—á–∏—Å—Ç–∏—Ç—å"
          >‚ùå</span>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
        <div id="qr-reader" style="width:300px; display:none;"></div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ VIN -->
        <ul
          id="vin_list"
          class="list-group mt-2"
          style="display:none; position:absolute; width:100%; z-index:1000;"
        ></ul>
      </div>

      <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ -->
      <div
        id="vehicle_info"
        class="mb-4 p-3 border rounded"
        style="{% if not vehicle_info %}display: none;{% endif %}"
      >
        <h6 class="mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ VIN</h6>
        <p class="mb-1"><strong>VIN:</strong> <span id="vin_value">{{ vehicle_info.vin|default_if_none:'' }}</span></p>
        <p class="mb-1"><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value">{{ vehicle_info.engine_number|default_if_none:'' }}</span></p>
        <p class="mb-1"><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value">{{ vehicle_info.model|default_if_none:'' }}</span></p>
        <p class="mb-0"><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value">{{ vehicle_info.body_color|default_if_none:'' }}</span></p>
      </div>

      <!-- –°–µ–∫—Ü–∏—è —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ -->
      <div id="defects_section" class="mb-4" style="{% if defects_count|default:0 == 0 %}display:none;{% endif %}">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">–î–µ—Ñ–µ–∫—Ç—ã –ø–æ VIN</h6>
          <span class="badge bg-danger-subtle text-danger border">
            –≤—Å–µ–≥–æ: {{ defects_count|default:0 }}
          </span>
        </div>

        <div class="accordion" id="defectsAccordion">
          {% for item in defect_list %}
            {% with key=forloop.counter|stringformat:"s" %}
            {% with acc_id="defect-"|add:key %}
            <div class="accordion-item mb-2
              {% if item.extra.UUD %}
                {% if item.extra.UUD.status == 'checking' %}uud-status-checking
                {% elif item.extra.UUD.status == 'resolved' %}uud-status-resolved
                {% elif item.extra.UUD.status == 'not_resolved' or not item.extra.UUD.status %}uud-status-failed
                {% elif item.extra.UUD.status == 'impossible' %}uud-status-impossible
                {% endif %}
              {% else %}
                uud-status-failed
              {% endif %}
            ">
              <h2 class="accordion-header" id="heading-{{ acc_id }}">
                <button
                  class="accordion-button collapsed py-2"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ acc_id }}"
                  aria-expanded="false"
                  aria-controls="collapse-{{ acc_id }}"
                >
                  <div class="w-100 d-flex flex-wrap align-items-center gap-2">
                    <span class="badge bg-danger text-white">{{ item.grade|default:"‚Äî" }}</span>
                    <strong class="me-1">{{ item.unit|default:"‚Äî" }}</strong>
                    <span class="text-muted">‚Äî {{ item.name|default:"‚Äî" }}</span>
                    <span class="ms-auto text-muted small">
                      {{ item.zone|default:"" }}{% if item.post %} / {{ item.post }}{% endif %}
                    </span>
                  </div>
                </button>
              </h2>

              <div
                id="collapse-{{ acc_id }}"
                class="accordion-collapse collapse"
                aria-labelledby="heading-{{ acc_id }}"
                data-bs-parent="#defectsAccordion"
              >
                <div class="accordion-body">
                  <!-- –ú–∞–ª–µ–Ω—å–∫–∏–π ID –¥–µ—Ñ–µ–∫—Ç–∞ -->
                  <div class="mb-3">
                    <span class="badge bg-secondary me-2">ID</span>
                    <code class="small text-muted">{{ item.defect_id }}</code>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <ul class="list-unstyled small mb-0">
                        <li><strong>–î–µ—Ç–∞–ª—å:</strong> {{ item.unit|default:"‚Äî" }}</li>
                        <li><strong>–î–µ—Ñ–µ–∫—Ç:</strong> {{ item.name|default:"‚Äî" }}</li>
                        <li><strong>–ì—Ä–µ–π–¥:</strong> {{ item.grade|default:"‚Äî" }}</li>
                        <li>
                          <strong>–ó–æ–Ω–∞ / –ü–æ—Å—Ç:</strong>
                          {{ item.zone|default:"‚Äî" }}{% if item.post %} / {{ item.post }}{% endif %}
                        </li>
                        <li><strong>–í–≤–µ–ª:</strong> {{ item.controller|default:"‚Äî" }}</li>
                        <li>
                          <strong>–ö–æ–≥–¥–∞:</strong>
                          {% if item.date_added %}{{ item.date_added|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}
                        </li>
                        {% if item.comment %}<li><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ item.comment }}</li>{% endif %}
                        {% if item.responsible %}<li><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> {{ item.responsible }}</li>{% endif %}
                        {% if item.quantity %}<li><strong>–ö–æ–ª-–≤–æ:</strong> {{ item.quantity }}</li>{% endif %}
                        {% if item.repair_type %}<li><strong>–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞:</strong> {{ item.repair_type }}</li>{% endif %}
                      </ul>
                    </div>

                    <div class="col-md-6">
                      {% if item.photos and item.photos|length > 0 %}
                        {% with car_id="carousel-"|add:key %}
                        <div id="{{ car_id }}" class="carousel slide" data-bs-ride="carousel">
                          <div class="carousel-inner">
                            {% for p in item.photos %}
                              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ p }}" class="d-block w-100 rounded" alt="defect photo {{ forloop.counter }}">
                              </div>
                            {% endfor %}
                          </div>

                          {% if item.photos|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#{{ car_id }}" data-bs-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#{{ car_id }}" data-bs-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Next</span>
                            </button>
                          {% endif %}
                        </div>
                        {% endwith %}
                      {% else %}
                        <div class="text-muted small">–§–æ—Ç–æ –Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω—ã</div>
                      {% endif %}
                    </div>
                  </div>

                  {# ==== –ë–õ–û–ö: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –£–£–î (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞) + –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π ==== #}
                  <section class="uud-section">
                    {% with uud=item.extra.UUD %}
                      {% if uud and uud.history %}
                        {% with last=uud.history|last %}
                          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                            <div class="d-flex align-items-center gap-2">
                              <span class="badge uud-badge
                                {% if uud.status == 'checking' %}bg-warning text-dark
                                {% elif uud.status == 'resolved' %}bg-success
                                {% elif uud.status == 'not_resolved' %}bg-danger
                                {% elif uud.status == 'impossible' %}bg-dark
                                {% else %}bg-secondary{% endif %}">
                                –£–£–î: {{ uud.status|default:"‚Äî" }}
                              </span>
                              <span class="uud-fix-meta">
                                –ò—Å–ø—Ä–∞–≤–ª—è–ª: {{ last.fix.by|default:"‚Äî" }} ‚Ä¢ {{ last.fix.at|slice:":10" }}&nbsp;&nbsp;{{ last.fix.at|slice:"11:16" }}
                              </span>
                            </div>
                          </div>

                          {% if last.fix.photos and last.fix.photos|length > 0 %}
                            {% with fix_car_id="carousel-fix-"|add:forloop.counter|stringformat:"s" %}
                            <div id="{{ fix_car_id }}" class="carousel slide mb-2 uud-fix-carousel" data-bs-ride="carousel">
                              <div class="carousel-inner">
                                {% for fp in last.fix.photos %}
                                  <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ fp }}" class="d-block w-100 rounded" alt="fix photo {{ forloop.counter }}">
                                  </div>
                                {% endfor %}
                              </div>
                              {% if last.fix.photos|length > 1 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#{{ fix_car_id }}" data-bs-slide="prev">
                                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                  <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#{{ fix_car_id }}" data-bs-slide="next">
                                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                  <span class="visually-hidden">Next</span>
                                </button>
                              {% endif %}
                            </div>
                            {% endwith %}
                          {% else %}
                            <div class="text-muted small">–§–æ—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω—ã</div>
                          {% endif %}

                          {% if last.decision %}
                            <div class="d-flex flex-column gap-1 mb-2">
                              <div>
                                {% if last.decision.status == 'resolved' %}
                                  <span class="badge bg-success">–ü—Ä–∏–Ω—è—Ç–æ: —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ</span>
                                {% elif last.decision.status == 'not_resolved' %}
                                  <span class="badge bg-danger">–ü—Ä–∏–Ω—è—Ç–æ: –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ</span>
                                {% elif last.decision.status == 'impossible' %}
                                  <span class="badge bg-dark">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å</span>
                                {% else %}
                                  <span class="badge bg-secondary">–†–µ—à–µ–Ω–∏–µ</span>
                                {% endif %}
                                <span class="uud-fix-meta ms-2">
                                  –†–µ—à–∏–ª: {{ last.decision.by|default:"‚Äî" }} ‚Ä¢ {{ last.decision.at|slice:":10" }}&nbsp;&nbsp;{{ last.decision.at|slice:"11:16" }}
                                </span>
                              </div>

                              {% if last.decision.status == 'not_resolved' %}
                                <div class="small">
                                  <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ last.decision.comment|default:"‚Äî" }}
                                </div>
                              {% endif %}
                            </div>
                          {% endif %}

                          {% if last.fix.kind == 'impossible' and not last.decision %}
                            {% if request.user.role == 'controller' or request.user.role == 'master' or request.user.role == 'head_area'%}
                              <div class="uud-actions" data-uud-impossible
                                   data-defect-id="{{ item.defect_id }}"
                                   data-vin="{{ vin|default_if_none:'' }}">
                                <button type="button" class="btn btn-warning btn-sm uud-impossible-confirm">
                                  ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
                                </button>
                              </div>
                            {% endif %}
                          {% endif %}
                        {% endwith %}
                      {% endif %}

                      {# –ö–Ω–æ–ø–∫–∞ ¬´–£—Å—Ç—Ä–∞–Ω–∏—Ç—å¬ª (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ uud_controller, –µ—Å–ª–∏ –º–æ–∂–Ω–æ —Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å) #}
                      {% if request.user.role == 'uud_controller' %}
                        {% if not uud or not uud.status or uud.status == 'not_resolved' %}
                          <div
                            class="uud-actions mt-2"
                            data-defect-actions
                            data-defect-id="{{ item.defect_id }}"
                            data-defect-name="{{ item.name|default:'' }}"
                            data-defect-unit="{{ item.unit|default:'' }}"
                            data-defect-grade="{{ item.grade|default:'' }}"
                            data-defect-zone="{{ item.zone|default:'' }}"
                            data-defect-post="{{ item.post|default:'' }}"
                          >
                            <button type="button" class="btn btn-outline-success btn-sm uud-fix-open">
                              ‚úÖ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å
                            </button>
                          </div>
                        {% else %}
                          <div class="uud-actions mt-2">
                            <span class="badge
                              {% if uud.status == 'resolved' %}bg-success
                              {% elif uud.status == 'checking' %}bg-warning text-dark
                              {% elif uud.status == 'not_resolved' %}bg-danger
                              {% elif uud.status == 'impossible' %}bg-dark
                              {% else %}bg-secondary{% endif %}">
                              –°—Ç–∞—Ç—É—Å –£–£–î: {{ uud.status }}
                            </span>
                          </div>
                        {% endif %}
                      {% else %}
                        {% if uud and uud.status %}
                          <div class="uud-actions mt-2">
                            <span class="badge
                              {% if uud.status == 'resolved' %}bg-success
                              {% elif uud.status == 'checking' %}bg-warning text-dark
                              {% elif uud.status == 'not_resolved' %}bg-danger
                              {% elif uud.status == 'impossible' %}bg-dark
                              {% else %}bg-secondary{% endif %}">
                              –°—Ç–∞—Ç—É—Å –£–£–î: {{ uud.status }}
                            </span>
                          </div>
                        {% endif %}
                      {% endif %}

                    {# –ö–Ω–æ–ø–∫–∏ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è controller/master: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –ø—Ä–∏ status='checking' –∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—à–µ–Ω–∏—è #}
                      {% if uud.status == 'checking' and not last.decision %}
                        {% if request.user.role == 'controller' or request.user.role == 'master'  or request.user.role == 'head_area' %}
                          <div class="uud-actions mt-2"
                               data-uud-decision
                               data-defect-id="{{ item.defect_id }}"
                               data-vin="{{ vin|default_if_none:'' }}">
                            <div class="btn-group" role="group" aria-label="–†–µ—à–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞">
                              <button type="button" class="btn btn-success btn-sm uud-decide" data-decision="resolved">
                                ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ
                              </button>
                              <button type="button" class="btn btn-danger btn-sm uud-decide" data-decision="not_resolved">
                                ‚ùå –ù–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ
                              </button>
                            </div>

                            <div class="mt-2 w-100" style="display:none;" data-uud-reject-wrap>
                              <label class="form-label small mb-1">–ü—Ä–∏—á–∏–Ω–∞ (–ø–æ—á–µ–º—É –Ω–µ –ø—Ä–∏–Ω—è—Ç–æ)</label>
                              <textarea class="form-control" rows="2" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω–µ —Ç–∞–∫‚Ä¶" data-uud-reject-text></textarea>
                              <div class="d-flex gap-2 mt-2 mb-5">
                                <button type="button" class="btn btn-danger btn-sm" data-uud-reject-save>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-uud-reject-cancel>–û—Ç–º–µ–Ω–∞</button>
                              </div>
                            </div>
                          </div>
                        {% endif %}
                      {% endif %}
                    {% endwith %}
                  </section>
                  {# /uud-section #}

                </div> <!-- /.accordion-body -->
              </div> <!-- /.accordion-collapse -->
            </div> <!-- /.accordion-item -->
            {% endwith %}
            {% endwith %}
          {% endfor %}
        </div>

        {% if history_updated_at %}
          <div class="text-muted small mt-2">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ history_updated_at|date:"Y-m-d H:i" }}</div>
        {% endif %}
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–ø–æ–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞) -->
      <button type="button" id="uudActionBtn" class="btn btn-success w-100" disabled>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</button>
      <small id="uudActionHint" class="text-muted d-block text-center mt-1 mb-5"></small>
    </form>
  </div>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
</div>



<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ -->
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–ª–∏—è–Ω–∏–µ —Å—Ç–∏–ª—è–º–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã –£–£–î */
  #uudPageRoot .uud-divider{ margin-top: .75rem !important; margin-bottom: .75rem !important; }
  #uudPageRoot .uud-section{
    padding-top: .75rem;
    margin-top: .25rem;
    border-top: 1px solid var(--bs-border-color);
  }
  #uudPageRoot .uud-actions{
    display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
  }
  #uudPageRoot .uud-badge{ vertical-align: middle; }
  #uudPageRoot .uud-fix-meta{ font-size:.875rem; color: var(--bs-secondary-color); }

  /* –ö–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∏ —Ä–æ–≤–Ω–µ–µ */
  #uudPageRoot .uud-actions .btn{ min-width: 136px; }

  /* –ü—Ä–µ–≤—å—é/–∫–∞—Ä—É—Å–µ–ª–∏: –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –∏ cover, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –ø—Ä—ã–≥–∞–ª–∏ */
  #uudPageRoot .carousel img{ object-fit: cover; width:100%; max-height: 280px; }
  @media (max-width: 576px){
    #uudPageRoot .carousel img{ max-height: 220px; }
  }

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É */
#uudPageRoot .accordion-item.uud-status-checking {
  border-left: 6px solid #ffc107; /* –∂–µ–ª—Ç—ã–π */
  background-color: #fffbea;
}
#uudPageRoot .accordion-item.uud-status-resolved {
  border-left: 6px solid #198754; /* –∑–µ–ª–µ–Ω—ã–π */
  background-color: #e9f7ef;
}
#uudPageRoot .accordion-item.uud-status-failed {
  border-left: 6px solid #dc3545; /* –∫—Ä–∞—Å–Ω—ã–π */
  background-color: #fcebea;
}
#uudPageRoot .accordion-item.uud-status-impossible {
  border-left: 6px solid #6c757d; /* —Å–µ—Ä—ã–π/—Ç—ë–º–Ω—ã–π */
  background-color: #f1f1f1;
}

</style>

<script>
  // === QR-—Å–∫–∞–Ω–µ—Ä ===
  document.addEventListener("DOMContentLoaded", function () {
    const qrReaderEl = document.getElementById("qr-reader");
    const startBtn = document.getElementById("start_qr_scan");
    const vinInput = document.getElementById("vin_search");
    const qrScanner = new Html5Qrcode("qr-reader");
    let qrActive = false;

    function onScanSuccess(decodedText) {
      if (vinInput) vinInput.value = (decodedText || "").trim().toUpperCase();

      qrReaderEl.style.display = "none";
      qrScanner.stop().finally(() => {
        qrActive = false;
        startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
      });

      try { triggerVinSearch && triggerVinSearch(vinInput.value); } catch (_) {}
    }

    startBtn.addEventListener("click", () => {
      if (!qrActive) {
        qrReaderEl.style.display = "block";
        startBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";

        qrScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess
        ).then(() => {
          qrActive = true;
        }).catch(err => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
        });

      } else {
        qrScanner.stop().finally(() => {
          qrReaderEl.style.display = "none";
          startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
          qrActive = false;
        });
      }
    });

    window.addEventListener("beforeunload", () => {
      if (qrActive) {
        try { qrScanner.stop(); } catch(_) {}
      }
    });
  });
</script>

<script>
  // === –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∞ VIN + –≤—ã–≤–æ–¥ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ ===
  (function(){
    const vinInput = document.getElementById("vin_search");
    const vinList  = document.getElementById("vin_list");
    const clearBtn = document.getElementById("clear_vin_search");
    const infoBox  = document.getElementById("vehicle_info");
    if (!vinInput || !vinList) return;

    let debounceTimer = null;
    function debounce(fn, ms = 200){
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fn, ms);
    }

    vinInput.addEventListener("input", () => {
      const q = vinInput.value.trim();
      if (clearBtn) clearBtn.style.display = q ? "block" : "none";

      if (!q) {
        hideList();
        if (infoBox) infoBox.style.display = "none";
        return;
      }

      debounce(() => {
        fetch(`/supplies/api/search_vin/?q=${encodeURIComponent(q)}`)
          .then(r => r.ok ? r.json() : Promise.reject(r.status))
          .then(data => {
            const items = Array.isArray(data?.results) ? data.results : [];
            renderList(items);
          })
          .catch(err => {
            console.error("VIN search error:", err);
            hideList();
          });
      }, 200);
    });

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        vinInput.value = "";
        hideList();
        if (infoBox) infoBox.style.display = "none";
        clearBtn.style.display = "none";
        vinInput.focus();
      });
    }

    document.addEventListener("click", (e) => {
      if (!vinList.contains(e.target) && !vinInput.contains(e.target)) hideList();
    });

    function renderList(items){
      vinList.innerHTML = "";
      if (!items.length) return hideList();

      items.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.innerHTML = `
          <div class="d-flex justify-content-between">
            <span>${item.vin || ""}</span>
            <small class="text-muted">${(item.model || "").trim()}</small>
          </div>
        `;
        li.addEventListener("click", () => {
          const vin = (item.vin || "").trim().toUpperCase();
          vinInput.value = vin;
          showInfo(vin, item);
          hideList();
        });
        vinList.appendChild(li);
      });

      vinList.style.display = "block";
    }

    function hideList(){
      vinList.style.display = "none";
      vinList.innerHTML = "";
    }

    function showInfo(vin, item){
      const vinValue   = document.getElementById("vin_value");
      const engValue   = document.getElementById("engine_number_value");
      const modelValue = document.getElementById("model_value");
      const colorValue = document.getElementById("body_color_value");

      if (vinValue)   vinValue.textContent   = vin || "";
      if (engValue)   engValue.textContent   = item?.engine_number || "";
      if (modelValue) modelValue.textContent = item?.model || "";
      if (colorValue) colorValue.textContent = item?.body_color || "";

      if (infoBox) infoBox.style.display = "block";

      try { triggerVinSearch && triggerVinSearch(vin); } catch(_) {}
    }
  })();
</script>

<script>
  (function () {
    const vinInput = document.getElementById("vin_search");
    const clearBtn = document.getElementById("clear_vin_search");
    const infoBox  = document.getElementById("vehicle_info");
    const defects  = document.getElementById("defects_section");

    // ‚îÄ‚îÄ helper: –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –±–ª–æ–∫
    function show(el) { if (el) el.style.display = ""; }
    function hide(el) { if (el) el.style.display = "none"; }

    // ‚îÄ‚îÄ –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é —É–∂–µ –∑–æ–≤—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫–∞–Ω–∞/–ø–æ–¥—Å–∫–∞–∑–æ–∫
    function triggerVinSearch(vin) {
      if (!vin) return;
      vin = (vin || "").trim().toUpperCase();
      if (!vin) return;

      // –°–æ–±–∏—Ä–∞–µ–º URL —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å ?vin=... –∏ —è–∫–æ—Ä–µ–º –Ω–∞ —Å–µ–∫—Ü–∏—é –¥–µ—Ñ–µ–∫—Ç–æ–≤
      const base   = window.location.pathname;
      const params = new URLSearchParams(window.location.search);
      params.set("vin", vin);

      // –ù–µ–±–æ–ª—å—à–æ–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
      if (vinInput) vinInput.disabled = true;

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä ‚Äî –≤—å—é—à–∫–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç vehicle_info –∏ defect_list
      window.location.replace(`${base}?${params.toString()}#defects_section`);
    }
    window.triggerVinSearch = triggerVinSearch;

    // ‚îÄ‚îÄ –ø–æ–≤–µ–¥–µ–Ω–∏–µ Enter –≤ –ø–æ–ª–µ VIN: –≤–º–µ—Å—Ç–æ submit ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ/–¥–µ—Ñ–µ–∫—Ç—ã
    if (vinInput) {
      vinInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          triggerVinSearch(vinInput.value);
        }
      });

      // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
      vinInput.addEventListener("input", () => {
        const has = !!vinInput.value.trim();
        if (clearBtn) clearBtn.style.display = has ? "block" : "none";
        if (!has) {
          hide(infoBox);
          hide(defects);
        }
      });
    }

    // ‚îÄ‚îÄ –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ VIN
    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        if (vinInput) {
          vinInput.value = "";
          vinInput.disabled = false;
          vinInput.focus();
        }
        hide(infoBox);
        hide(defects);
        clearBtn.style.display = "none";

        // —á–∏—Å—Ç–∏–º —Ö—ç—à –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä vin –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—è
        const url = new URL(window.location.href);
        url.hash = "";
        url.searchParams.delete("vin");
        window.history.replaceState({}, "", url.toString());
      });
    }

    // ‚îÄ‚îÄ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏: –µ—Å–ª–∏ –µ—Å—Ç—å —è–∫–æ—Ä—å –Ω–∞ —Å–µ–∫—Ü–∏—é –¥–µ—Ñ–µ–∫—Ç–æ–≤ ‚Äî –º—è–≥–∫–æ –ø–æ–¥—Å–≤–µ—Ç–∏–º –µ—ë
    function highlightDefects() {
      if (!defects) return;
      if (window.location.hash !== "#defects_section") return;

      const cls = "flash-highlight";
      defects.classList.add(cls);
      setTimeout(() => defects.classList.remove(cls), 1200);

      // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–∞—á–∞–ª—É —Å–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–ª)
      defects.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // –¥–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–æ–¥–∏–Ω —Ä–∞–∑)
    (function injectFlashStyle(){
      const id = "flash-highlight-style";
      if (document.getElementById(id)) return;

      const style = document.createElement("style");
      style.id = id;
      style.textContent = `
        .flash-highlight {
          box-shadow: 0 0 0 4px rgba(25,135,84,.25);
          transition: box-shadow .3s ease;
        }
      `;
      document.head.appendChild(style);
    })();

    // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener("DOMContentLoaded", () => {
      // –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–µ—Å—Ç–∏–∫, –µ—Å–ª–∏ vin —É–∂–µ –≤ –ø–æ–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏—à–ª–∏ —Å ?vin=...)
      if (vinInput && vinInput.value.trim() && clearBtn) {
        clearBtn.style.display = "block";
      }
      // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–µ–∫—Ü–∏—é –¥–µ—Ñ–µ–∫—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      highlightDefects();
    });
  })();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const acc = document.getElementById('defectsAccordion');
    if (!acc) return;

    const items = acc.querySelectorAll('.accordion-item');

    items.forEach((item, idx) => {
      const key    = String(idx + 1);
      const header = item.querySelector('.accordion-header');
      const btn    = header?.querySelector('[data-bs-toggle="collapse"]');
      const body   = item.querySelector('.accordion-collapse');

      if (!btn || !body) return;

      const newAccId      = 'defect-' + key;
      const newCollapseId = 'collapse-' + newAccId;

      header.id = 'heading-' + newAccId;
      body.id   = newCollapseId;
      body.setAttribute('aria-labelledby', header.id);
      btn.setAttribute('data-bs-target', '#' + newCollapseId);
      btn.setAttribute('aria-controls', newCollapseId);

      // –ø–æ—á–∏–Ω–∏–º –∏ –∫–∞—Ä—É—Å–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const carousel = item.querySelector('.carousel[id^="carousel-"]');
      if (carousel) {
        carousel.id = 'carousel-' + newAccId;
        const prev = item.querySelector('[data-bs-target^="#carousel-"]');
        const next = item.querySelectorAll('[data-bs-target^="#carousel-"]')[1];
        if (prev) prev.setAttribute('data-bs-target', '#' + carousel.id);
        if (next) next.setAttribute('data-bs-target', '#' + carousel.id);
      }
    });
  });
</script>
<script>
(function(){
  // ===== URLs (Django reverse) =====
  const URL_STATE           = "{% url 'assembly:uud_current_state' %}";
  const URL_US_TO_UUD       = "{% url 'assembly:us_to_uud' %}";
  const URL_UUD_TO_UUDZONE  = "{% url 'assembly:uud_to_uudzone' %}";
  const URL_UUDZONE_TO_UUD  = "{% url 'assembly:uudzone_to_uud' %}";
  const URL_UUD_TO_US       = "{% url 'assembly:uud_to_us' %}";

  // ===== Helpers =====
  const root   = document.getElementById('uudPageRoot') || document.body;
  const role   = (root.getAttribute('data-user-role') || '').trim() || 'none';
  const btn    = document.getElementById('uudActionBtn');
  const hint   = document.getElementById('uudActionHint');
  const vinInp = document.getElementById('vin_search');

  function getCSRF() {
    const name = 'csrftoken';
    const m = document.cookie.match(new RegExp('(^|;)\\s*' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : '';
  }
  function currentVIN(){
    return (vinInp?.value || (new URL(location.href).searchParams.get('vin') || '')).trim().toUpperCase();
  }
  function setBtn(label, {disabled=true, style='success', title=''}={}) {
    if (!btn) return;
    btn.textContent = label;
    btn.className = 'btn w-100 btn-' + style;
    btn.disabled = !!disabled;
    if (title) btn.setAttribute('title', title); else btn.removeAttribute('title');
  }
  function setHint(text){ if (hint) hint.textContent = text || ''; }

  async function fetchState(vin){
    if (!vin) return {status:'ok', uud_state:{has_active:false, step:null, status:null}};
    const url = new URL(URL_STATE, location.origin);
    url.searchParams.set('vin', vin);
    const r = await fetch(url.toString(), {credentials:'same-origin'});
    try { return await r.json(); } catch(_) { return {status:'error'}; }
  }

  async function postStep(url, vin){
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify({ vin })
    });
    let data = {};
    try { data = await r.json(); } catch(_){}
    if (!r.ok || data.status !== 'ok') {
      throw new Error(data.message || '–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏');
    }
    return data;
  }

  function renderByRoleAndState(role, state, vin){
    // state: { has_active, step, status }
    if (!vin) {
      setBtn('–£–∫–∞–∂–∏—Ç–µ VIN', {disabled:true, style:'secondary', title:'–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR'});
      setHint('');
      return;
    }

    const has = !!state?.has_active;
    const step = state?.step || null; // null | step1..4 | done

    // –ú–∞—Ç—Ä–∏—Ü–∞:
    // –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π (null) ‚Üí controller/master: –û—Ç–¥–∞—Ç—å –Ω–∞ –£–£–î; uud_controller: –ù–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –Ω–∞ –£–£–î (disabled)
    // step1 ‚Üí uud_controller: –ó–∞–±—Ä–∞—Ç—å –≤ –∑–æ–Ω—É –£–£–î; ctrl/master: –ú–∞—à–∏–Ω–∞ –Ω–∞ –£–£–î (disabled)
    // step2 ‚Üí uud_controller: –û—Ç–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ª–∏–Ω–∏—é; ctrl/master: –ú–∞—à–∏–Ω–∞ –Ω–∞ –£–£–î (disabled)
    // step3 ‚Üí ctrl/master: –ü—Ä–∏–Ω—è—Ç—å –º–∞—à–∏–Ω—É —Å –£–£–î; uud_controller: –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏—ë–º–∫—É (disabled)
    // done ‚Üí –∫–∞–∫ ¬´–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π¬ª: –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞

    if (!has || step === 'done' || step === null) {
      if (role === 'controller' || role === 'master' || role === 'head_area') {
        setBtn('–û—Ç–¥–∞—Ç—å –Ω–∞ –£–£–î', {disabled:false, style:'success'});
        setHint('');
        btn.dataset.action = 'us_to_uud';
      } else if (role === 'uud_controller') {
        setBtn('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –Ω–∞ –£–£–î', {disabled:true, style:'secondary', title:'–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É –Ω–∞ –£–£–î'});
        setHint('–ú–∞—à–∏–Ω–∞ –µ—â—ë –Ω–µ –æ—Ç–¥–∞–Ω–∞ –Ω–∞ –£–£–î.');
        btn.dataset.action = 'noop_not_sent';
      } else {
        setBtn('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', {disabled:true, style:'secondary'});
        setHint('');
        btn.dataset.action = 'noop_no_rights';
      }
      return;
    }

    if (step === 'step1') {
      if (role === 'uud_controller') {
        setBtn('–ó–∞–±—Ä–∞—Ç—å –≤ –∑–æ–Ω—É –£–£–î', {disabled:false, style:'primary'});
        setHint('');
        btn.dataset.action = 'uud_to_uudzone';
      } else {
        setBtn('–ú–∞—à–∏–Ω–∞ –Ω–∞ –£–£–î', {disabled:true, style:'secondary', title:'–û–∂–∏–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –£–£–î'});
        setHint('–û–∂–∏–¥–∞–µ—Ç –∑–∞–±–æ—Ä–∞ –≤ –∑–æ–Ω—É –£–£–î.');
        btn.dataset.action = 'noop_wait_uud';
      }
      return;
    }

    if (step === 'step2') {
      if (role === 'uud_controller') {
        setBtn('–û—Ç–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ª–∏–Ω–∏—é', {disabled:false, style:'warning'});
        setHint('–§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—Ç —Å –∑–æ–Ω—ã –Ω–∞ –£–£–î.');
        btn.dataset.action = 'uudzone_to_uud';
      } else {
        setBtn('–ú–∞—à–∏–Ω–∞ –Ω–∞ –£–£–î', {disabled:true, style:'secondary', title:'–û–∂–∏–¥–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å –∑–æ–Ω—ã'});
        setHint('–û–∂–∏–¥–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å –∑–æ–Ω—ã –£–£–î.');
        btn.dataset.action = 'noop_wait_return';
      }
      return;
    }

    if (step === 'step3') {
      if (role === 'controller' || role === 'master' || role === 'head_area') {
        setBtn('–ü—Ä–∏–Ω—è—Ç—å –º–∞—à–∏–Ω—É —Å –£–£–î', {disabled:false, style:'success'});
        setHint('');
        btn.dataset.action = 'uud_to_us';
      } else {
        setBtn('–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏—ë–º–∫—É –Ω–∞ –ª–∏–Ω–∏–∏', {disabled:true, style:'secondary'});
        setHint('–î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–∏—ë–º–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º/–º–∞—Å—Ç–µ—Ä–æ–º.');
        btn.dataset.action = 'noop_wait_accept';
      }
      return;
    }

    // –õ—é–±–æ–π –∏–Ω–æ–π —Å–ª—É—á–∞–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–æ–±—ã—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
    setBtn('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ', {disabled:true, style:'secondary'});
    setHint('');
    btn.dataset.action = 'noop';
  }

  async function refreshButton(){
    setBtn('–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶', {disabled:true, style:'secondary'});
    setHint('');
    const vin = currentVIN();
    try{
      const data = await fetchState(vin);
      const state = data?.uud_state || {has_active:false, step:null};
      renderByRoleAndState(role, state, vin);
    }catch(_){
      setBtn('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', {disabled:true, style:'danger'});
      setHint('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }
  }

  async function onActionClick(){
    const action = btn?.dataset?.action || '';
    const vin = currentVIN();
    if (!vin) {
      alert('–£–∫–∞–∂–∏—Ç–µ VIN');
      return;
    }

    // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
    if (action === 'noop_not_sent') {
      alert('–ú–∞—à–∏–Ω–∞ –Ω–µ –æ—Ç–¥–∞–Ω–∞ –Ω–∞ –£–£–î. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É –Ω–∞ –£–£–î.');
      return;
    }
    if (action.startsWith('noop')) return;

    let url = null;
    if (action === 'us_to_uud') url = URL_US_TO_UUD;
    else if (action === 'uud_to_uudzone') url = URL_UUD_TO_UUDZONE;
    else if (action === 'uudzone_to_uud') url = URL_UUDZONE_TO_UUD;
    else if (action === 'uud_to_us') url = URL_UUD_TO_US;
    else return;

    const originalLabel = btn.textContent;
    setBtn('–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶', {disabled:true, style:'secondary'});

    try{
      const data = await postStep(url, vin);
      if (data?.message) {
        // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ toast
        console.log(data.message);
      }
      // –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ –Ω–æ–≤–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
      await refreshButton();
    }catch(e){
      alert(e?.message || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏');
      setBtn(originalLabel, {disabled:false});
    }
  }

  // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
  document.addEventListener('DOMContentLoaded', () => {
    if (btn) btn.addEventListener('click', onActionClick);

    // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–∫–∏
    refreshButton();

    // –∫–æ–≥–¥–∞ VIN –º–µ–Ω—è–µ—Ç—Å—è (–≤–≤–æ–¥/—Å–∫–∞–Ω/–∫–ª–∏–∫ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫) ‚Äî –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ URL —Å ?vin=...
    // –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º—Å—è, –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å:
    if (vinInp) {
      vinInp.addEventListener('change', refreshButton);
      vinInp.addEventListener('input', () => {
        if (!vinInp.value.trim()) refreshButton();
      });
    }
  });

  // –ï—Å–ª–∏ –≤–∞—à –∫–æ–¥ –º–µ–Ω—è–µ—Ç VIN —á–µ—Ä–µ–∑ window.triggerVinSearch -> —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å ?vin=...,
  // –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ refreshButton() –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∏ –ø–æ–¥—Ç—è–Ω–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
})();
</script>
<!-- ===== –ü–∞–Ω–µ–ª—å —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–∏–∂–Ω–∏–π offcanvas) ===== -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="uudFixDrawer" data-bs-backdrop="static" style="height: 70vh;">
  <div class="offcanvas-header justify-content-between">
    <div class="d-flex align-items-center gap-2">
      {% if request.user.role == 'uud_controller' %}
      <button type="button" id="uudMarkImpossibleBtn" class="btn btn-outline-dark btn-sm">
        –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å
      </button>
      {% endif %}
      <h5 class="offcanvas-title mb-0">–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞</h5>
    </div>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column gap-3">

    <!-- –ò–Ω—Ñ–æ –ø–æ –¥–µ—Ñ–µ–∫—Ç—É -->
    <div class="small text-muted" id="uudFixDefectInfo">
      <strong id="uudFixDefectTitle">‚Äî</strong>
      <span class="ms-2" id="uudFixDefectMeta"></span>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã + input -->
    <div>
      <label class="form-label mb-1">–§–æ—Ç–æ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞)</label>
      <input
        type="file"
        id="uudFixPhotos"
        accept="image/*"
        capture="environment"
        multiple
        class="form-control"
      >
      <div class="form-text">–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–Ω–∏–º–∫–æ–≤ ‚Äî –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –ø—Ä–µ–≤—å—é –Ω–∏–∂–µ.</div>
    </div>

    <!-- –ö–∞—Ä—É—Å–µ–ª—å –ø—Ä–µ–≤—å—é —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤ -->
    <div id="uudFixCarouselWrap" style="display:none;">
      <div id="uudFixCarousel" class="carousel slide">
        <div class="carousel-inner" id="uudFixCarouselInner"></div>
        <button class="carousel-control-prev" type="button" data-bs-target="#uudFixCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Prev</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#uudFixCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      <div class="small text-muted mt-1">–¢–∞–ø–Ω–∏—Ç–µ –ø–æ –∫–æ—Ä–∑–∏–Ω–µ –Ω–∞ —Å–ª–∞–π–¥–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏.</div>
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
    <div>
      <label class="form-label mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="uudFixComment" class="form-control" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ‚Ä¶"></textarea>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="mt-auto d-grid gap-2">
      <button type="button" id="uudFixSaveBtn" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
<script>
(function(){
  // ===== URL-—ã API =====
  const URL_UUD_DEFECT_SUBMIT = "{% url 'assembly:uud_defect_submit_fix' %}";
  const URL_UUD_DEFECT_INFO   = "{% url 'assembly:uud_defect_info' %}";
  const URL_UUD_DEFECT_IMPOSSIBLE = "{% url 'assembly:uud_defect_mark_impossible' %}";

  // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
  const drawerEl   = document.getElementById('uudFixDrawer');
  const photosInp  = document.getElementById('uudFixPhotos');
  const commentEl  = document.getElementById('uudFixComment');
  const saveBtn    = document.getElementById('uudFixSaveBtn');
  const infoTitle  = document.getElementById('uudFixDefectTitle');
  const infoMeta   = document.getElementById('uudFixDefectMeta');
  const carWrap    = document.getElementById('uudFixCarouselWrap');
  const car        = document.getElementById('uudFixCarousel');
  const carInner   = document.getElementById('uudFixCarouselInner');

  let offcanvas = null;
  let currentDefectId = null;
  let currentVIN = null;

  // –ë—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω–æ (FileList –∑–∞–º–µ–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è, –ø–æ—ç—Ç–æ–º—É –∫–æ–ø–∏—è)
  let chosenFiles = [];     // –º–∞—Å—Å–∏–≤ File
  let previewURLs = [];     // –º–∞—Å—Å–∏–≤ ObjectURL –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

  function getCSRF() {
    const m = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[2]) : '';
  }
  function pageVIN(){
    // –±–µ—Ä—ë–º VIN –∏–∑ –ø–æ–ª—è (–æ–Ω —É —Ç–µ–±—è –≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å ?vin)
    const inp = document.getElementById('vin_search');
    return (inp?.value || '').trim().toUpperCase();
  }

  // ==== –û–¢–ö–†–´–¢–ò–ï –ü–ê–ù–ï–õ–ò ====
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.uud-fix-open');
    if (!btn) return;

    const actions = btn.closest('[data-defect-actions]');
    if (!actions) return;

    currentDefectId = actions.getAttribute('data-defect-id');
    currentVIN      = pageVIN();

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫/–º–µ—Ç—É
    const name  = actions.getAttribute('data-defect-name') || '‚Äî';
    const unit  = actions.getAttribute('data-defect-unit') || '';
    const grade = actions.getAttribute('data-defect-grade') || '';
    const zone  = actions.getAttribute('data-defect-zone') || '';
    const post  = actions.getAttribute('data-defect-post') || '';

    infoTitle.textContent = `${name}`;
    infoMeta.textContent  = [unit, grade ? `–≥—Ä–µ–π–¥ ${grade}` : '', zone || '', post || ''].filter(Boolean).join(' ‚Ä¢ ');

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    resetFilesPreview();
    commentEl.value = '';

    // –ü–æ–∫–∞–∑ offcanvas
    offcanvas = offcanvas || new bootstrap.Offcanvas(drawerEl);
    offcanvas.show();
  });

  // ==== –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ò–ï –§–û–¢–û ====
  photosInp?.addEventListener('change', () => {
    const files = Array.from(photosInp.files || []);
    if (!files.length) return;

    // –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
    chosenFiles.push(...files);
    renderCarousel();
    // –æ—á–∏—â–∞–µ–º input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É
    photosInp.value = '';
  });

  // ==== –†–ï–ù–î–ï–† –ö–ê–†–£–°–ï–õ–ò ====
  function renderCarousel(){
    // –æ—á–∏—Å—Ç–∏–º –ø—Ä–µ–∂–Ω–∏–µ objectURL
    previewURLs.forEach(u => URL.revokeObjectURL(u));
    previewURLs = [];

    carInner.innerHTML = '';
    if (!chosenFiles.length){
      carWrap.style.display = 'none';
      return;
    }
    chosenFiles.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      previewURLs.push(url);

      const item = document.createElement('div');
      item.className = 'carousel-item' + (idx === 0 ? ' active' : '');
      item.innerHTML = `
        <div class="position-relative">
          <img src="${url}" class="d-block w-100 rounded" alt="photo ${idx+1}">
          <button type="button" class="btn btn-light btn-sm position-absolute top-0 end-0 m-2 uud-del-photo" data-index="${idx}" title="–£–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ">
            üóë
          </button>
        </div>
      `;
      carInner.appendChild(item);
    });

    carWrap.style.display = '';
  }

  // —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–∑ –Ω–∞–±–æ—Ä–∞
  carInner?.addEventListener('click', (e) => {
    const del = e.target.closest('.uud-del-photo');
    if (!del) return;
    const idx = Number(del.getAttribute('data-index') || -1);
    if (idx < 0) return;
    chosenFiles.splice(idx, 1);
    renderCarousel();
  });

  // ==== –°–û–•–†–ê–ù–ï–ù–ò–ï ====
  saveBtn?.addEventListener('click', async () => {
    if (!currentVIN || !currentDefectId) {
      alert('–ù–µ –≤—ã–±—Ä–∞–Ω VIN –∏–ª–∏ –¥–µ—Ñ–µ–∫—Ç.');
      return;
    }

    // —Ñ–æ—Ä–º–∏—Ä—É–µ–º payload
    const fd = new FormData();
    fd.append('vin', currentVIN);
    fd.append('defect_id', currentDefectId);
    if (commentEl.value.trim()) fd.append('comment', commentEl.value.trim());
    chosenFiles.forEach(f => fd.append('photos', f, f.name || 'photo.jpg'));

    saveBtn.disabled = true;
    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';

    try{
      const r = await fetch(URL_UUD_DEFECT_SUBMIT, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': getCSRF() },
        body: fd
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok || data.status !== 'ok') {
        throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }

      // —É—Å–ø–µ—Ö: –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
      bootstrap.Offcanvas.getInstance(drawerEl)?.hide();
      toastOk('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É');

      // –û–±–Ω–æ–≤–∏–º –∫–æ—Ä–æ—Ç–∫–æ UI –≤ –∫–∞—Ä—Ç–æ—á–∫–µ (–±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å = checking)
      const actions = document.querySelector(`[data-defect-actions][data-defect-id="${CSS.escape(currentDefectId)}"]`);
      if (actions) {
        actions.innerHTML = `<span class="badge bg-warning text-dark">–°—Ç–∞—Ç—É—Å –£–£–î: checking</span>`;
      }

    }catch(e){
      alert(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
    }finally{
      saveBtn.disabled = false;
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É';
    }
  });

  const impossibleBtn = document.getElementById('uudMarkImpossibleBtn');
  impossibleBtn?.addEventListener('click', async () => {
    if (!currentVIN || !currentDefectId) {
      alert('–ù–µ –≤—ã–±—Ä–∞–Ω VIN –∏–ª–∏ –¥–µ—Ñ–µ–∫—Ç.');
      return;
    }
    if (!confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ—Ç –¥–µ—Ñ–µ–∫—Ç –∫–∞–∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–π –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é?')) return;

    const fd = new FormData();
    fd.append('vin', currentVIN);
    fd.append('defect_id', currentDefectId);

    const comment = (commentEl?.value || '').trim();
    if (comment) fd.append('comment', comment);

    // –ø—Ä–∏–ª–æ–∂–∏–º —Ç–µ –∂–µ —Ñ–æ—Ç–æ, —á—Ç–æ –∏ –≤ –æ–±—ã—á–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    chosenFiles.forEach(f => fd.append('photos', f, f.name || 'photo.jpg'));

    const originalLabel = impossibleBtn.textContent;
    impossibleBtn.disabled = true;
    impossibleBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';

    try{
      const r = await fetch(URL_UUD_DEFECT_IMPOSSIBLE, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': getCSRF() },
        body: fd
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok || data.status !== 'ok') {
        throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
      bootstrap.Offcanvas.getInstance(drawerEl)?.hide();
      toastOk('–û—Ç–º–µ—á–µ–Ω–æ: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å');

      const actions = document.querySelector(`[data-defect-actions][data-defect-id="${CSS.escape(currentDefectId)}"]`);
      if (actions) {
        actions.innerHTML = `<span class="badge bg-dark">–°—Ç–∞—Ç—É—Å –£–£–î: impossible</span>`;
      }
    }catch(e){
      alert(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
    }finally{
      impossibleBtn.disabled = false;
      impossibleBtn.textContent = originalLabel;
    }
  });

  // ==== –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ ====
  drawerEl?.addEventListener('hidden.bs.offcanvas', () => {
    resetFilesPreview();
    commentEl.value = '';
    currentDefectId = null;
  });

  function resetFilesPreview(){
    chosenFiles = [];
    previewURLs.forEach(u => URL.revokeObjectURL(u));
    previewURLs = [];
    carInner.innerHTML = '';
    carWrap.style.display = 'none';
    if (photosInp) photosInp.value = '';
  }

  // –ø—Ä–æ—Å—Ç–µ–π—à–∏–π —Ç–æ—Å—Ç (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–π)
  function toastOk(text){
    try{
      const el = document.createElement('div');
      el.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-3 px-3 py-2 text-bg-success rounded shadow';
      el.style.zIndex = 1080;
      el.textContent = text || '–ì–æ—Ç–æ–≤–æ';
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1600);
    }catch(_){}
  }
})();
</script>
<script>
(function(){
  const URL_UUD_DEFECT_DECIDE = "{% url 'assembly:uud_defect_decide' %}";

  function getCSRF(){
    const m = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[2]) : '';
  }

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤
  document.addEventListener('click', async (e) => {
    const decideBtn = e.target.closest('.uud-decide');
    if (!decideBtn) return;

    const decision = decideBtn.getAttribute('data-decision'); // "resolved" | "not_resolved"
    const wrap = decideBtn.closest('[data-uud-decision]');
    if (!wrap) return;

    const vin = wrap.getAttribute('data-vin') || '';
    const defectId = wrap.getAttribute('data-defect-id') || '';
    if (!vin || !defectId) {
      alert('VIN –∏–ª–∏ Defect ID –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.');
      return;
    }

    // –µ—Å–ª–∏ "–Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ" ‚Äî —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –ø—Ä–∏—á–∏–Ω—ã (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫)
    const rejectWrap = wrap.querySelector('[data-uud-reject-wrap]');
    const rejectText = wrap.querySelector('[data-uud-reject-text]');

    if (decision === 'not_resolved') {
      // –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –ø—Ä–∏—á–∏–Ω—ã –µ—â—ë —Å–∫—Ä—ã—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏ –≤—ã–π—Ç–∏
      if (rejectWrap && rejectWrap.style.display === 'none') {
        rejectWrap.style.display = '';
        return;
      }
    }

    // –¥–ª—è "resolved" –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
    if (decision === 'resolved') {
      return sendDecision({ vin, defectId, decision, wrap });
    }
  });

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.uud-impossible-confirm');
    if (!btn) return;

    const wrap = btn.closest('[data-uud-impossible]');
    if (!wrap) return;

    const vin = (wrap.getAttribute('data-vin') || '').trim().toUpperCase();
    const defectId = wrap.getAttribute('data-defect-id') || '';
    if (!vin || !defectId) {
      alert('VIN –∏–ª–∏ Defect ID –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.');
      return;
    }

    await sendDecision({ vin, defectId, decision: 'impossible', wrap });
  });

  // –ö–ª–∏–∫ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤ –±–ª–æ–∫–µ –ø—Ä–∏—á–∏–Ω—ã
  document.addEventListener('click', async (e) => {
    const save = e.target.closest('[data-uud-reject-save]');
    if (!save) return;

    const wrap = save.closest('[data-uud-decision]');
    const vin = wrap.getAttribute('data-vin') || '';
    const defectId = wrap.getAttribute('data-defect-id') || '';
    const textarea = wrap.querySelector('[data-uud-reject-text]');
    const comment = (textarea?.value || '').trim();

    if (!comment) {
      alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞.');
      return;
    }

    await sendDecision({ vin, defectId, decision: 'not_resolved', comment, wrap });
  });

  // –ö–ª–∏–∫ "–û—Ç–º–µ–Ω–∞" –≤ –±–ª–æ–∫–µ –ø—Ä–∏—á–∏–Ω—ã
  document.addEventListener('click', (e) => {
    const cancel = e.target.closest('[data-uud-reject-cancel]');
    if (!cancel) return;
    const rejectWrap = cancel.closest('[data-uud-reject-wrap]');
    const ta = rejectWrap?.querySelector('[data-uud-reject-text]');
    if (ta) ta.value = '';
    if (rejectWrap) rejectWrap.style.display = 'none';
  });

  async function sendDecision({ vin, defectId, decision, comment = '', wrap }){
    try{
      // –¥–∏–∑–µ–π–±–ª–∏–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
      const buttons = wrap.querySelectorAll('.uud-decide, [data-uud-reject-save]');
      buttons.forEach(b => b.disabled = true);

      const body = new FormData();
      body.append('vin', vin);
      body.append('defect_id', defectId);
      body.append('decision', decision);
      if (comment) body.append('comment', comment);

      const r = await fetch(URL_UUD_DEFECT_DECIDE, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': getCSRF() },
        body
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok || data.status !== 'ok') {
        throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è');
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º UI: –ø—Ä—è—á–µ–º –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
      const container = wrap.closest('.accordion-item') || wrap.parentElement;
      if (container) {
        // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ —Å–≤–µ—Ä—Ö—É (–µ—Å–ª–∏ –µ—Å—Ç—å ¬´actions¬ª —Å–µ–∫—Ü–∏—è –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —à–∞–≥–∞)
        const actions = container.querySelector('[data-defect-actions]');
        if (actions) {
          const st = data?.UUD?.status || decision;
          const cls =
          st === 'resolved' ? 'bg-success' :
          st === 'not_resolved' ? 'bg-danger' :
          st === 'impossible' ? 'bg-dark' :
          'bg-warning text-dark';

        actions.innerHTML = `<span class="badge ${cls}">–°—Ç–∞—Ç—É—Å –£–£–î: ${st}</span>`;
        }
      }

      // –í–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞ —Ä–µ—à–µ–Ω–∏–π –º–µ–Ω—è–µ–º –Ω–∞ ¬´–∏—Ç–æ–≥¬ª
      const statusBadge = document.createElement('div');
      statusBadge.className = 'mt-2';
      let badgeCls = 'bg-secondary';
      let label = '–†–µ—à–µ–Ω–∏–µ';

      if (decision === 'resolved') {
        badgeCls = 'bg-success'; label = '–†–µ—à–µ–Ω–∏–µ: —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ';
      } else if (decision === 'not_resolved') {
        badgeCls = 'bg-danger'; label = '–†–µ—à–µ–Ω–∏–µ: –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ';
      } else if (decision === 'impossible') {
        badgeCls = 'bg-dark'; label = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å';
      }

      statusBadge.innerHTML = `<span class="badge ${badgeCls}">${label}</span>`;
      wrap.replaceWith(statusBadge);

      // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–æ—Å—Ç
      try{
        const el = document.createElement('div');
        el.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-3 px-3 py-2 text-bg-success rounded shadow';
        el.style.zIndex = 1080;
        el.textContent =
          decision === 'resolved' ? '–ü—Ä–∏–Ω—è—Ç–æ: —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ' :
          decision === 'not_resolved' ? '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ: –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ' :
          '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å';
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 1600);
      }catch(_){}

    }catch(e){
      alert(e?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏–µ–º–∞ —Ä–µ—à–µ–Ω–∏—è');
    }finally{
      const buttons = wrap.querySelectorAll('.uud-decide, [data-uud-reject-save]');
      buttons.forEach(b => b.disabled = false);
    }
  }
})();
</script>

{% endblock %}
