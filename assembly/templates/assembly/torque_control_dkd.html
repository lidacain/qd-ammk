{% extends "users/base.html" %}

{% block title %}–ü–æ—Å—Ç –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–ü–æ—Å—Ç –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- –ü–æ–∏—Å–∫ –ø–æ VIN -->
<!-- üîç –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div style="position: relative;">
            <input type="text" id="vin_search" name="vin_number"
                   class="form-control pe-5"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ VIN..."
                   style="position: relative; z-index: 2;">

            <!-- ‚ùå –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ -->
            <span id="clear_vin_search" style="
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 20px;
                color: red;
                cursor: pointer;
                display: none;
                z-index: 10;
            ">‚ùå</span>

            <!-- üìã –°–ø–∏—Å–æ–∫ VIN (—Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS –∫–∞–∫ ul, –±—É–¥–µ—Ç –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–≤–µ—Ä—Ö input) -->
        </div>

        <!-- üì∑ –°–∫–∞–Ω–µ—Ä QR -->
        <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
        <div id="qr-reader" style="width: 300px; display: none;"></div>
        <button type="button" id="stop_qr_scan" class="btn btn-danger mt-2" style="display: none;">‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>

        <!-- –î–∞–Ω–Ω—ã–µ –æ VIN -->
        <div id="trace_data_container" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–î–∞–Ω–Ω—ã–µ –ø–æ VIN</h5>
            <p><strong>VIN:</strong> <span id="vin_value"></span></p>
            <p><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value"></span></p>
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
            <p><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
            <p><strong>–¢–∏–ø –ø—Ä–∏–≤–æ–¥–∞:</strong> <span id="drive_type_value"></span></p>
        </div>
        <input type="hidden" name="modification" id="modification_input">

        <!-- –í—ã–±–æ—Ä —É–∑–ª–∞/–¥–µ—Ç–∞–ª–∏ -->
        <div class="mb-3">
            <label for="assembly_part_search" class="form-label">–£–∑–µ–ª / –î–µ—Ç–∞–ª—å</label>
            <input type="text" id="assembly_part_search" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞...">
            <ul id="assembly_part_list" class="list-group mt-2" style="display: none;"></ul>
        </div>
        <input type="hidden" name="assembly_part" id="assembly_part_input">
        <!-- –î–∞–Ω–Ω—ã–µ –ø–æ —É–∑–ª—É -->
        <div id="part_data_container" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–î–∞–Ω–Ω—ã–µ –ø–æ —É–∑–ª—É</h5>
            <p><strong>–†–∞–∑–º–µ—Ä:</strong> <span id="part_size"></span></p>
            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –∑–∞—Ç—è–∂–∫–∏:</strong> <span id="part_quantity"></span></p>
            <p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–∫–∏:</strong> <span id="torque_range"></span> –ù¬∑–º</p>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏ -->
        <div id="torque_input_container" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–í–Ω–µ—Å–∏—Ç–µ –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–∫–∏</h5>
            <div id="torque_inputs"></div>
        </div>

        <!-- –í—ã–±–æ—Ä –Ω–∞–ª–∏—á–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç?</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no" checked>
                <label class="form-check-label" for="defect_no">–ù–µ—Ç –¥–µ—Ñ–µ–∫—Ç–∞</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç</label>
            </div>
        </div>


        <!-- üìå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div id="defect_container" class="mt-3" style="display: none;">
            <h5>–°–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤:</h5>
            <div id="defect_list"></div> <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ -->
            <button type="button" class="btn btn-primary mt-2" id="add_defect_btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>

            <!-- üìå –®–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–∞ (—Å–∫—Ä—ã—Ç, –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏) -->
            <div id="defect_template" class="defect-form border p-3 mt-2 rounded" style="display: none;">
                <h6 class="defect-title">–î–µ—Ñ–µ–∫—Ç 1</h6>

                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–µ—Ñ–µ–∫—Ç–∞ -->
                <div class="mb-3">
                    <label class="form-label">–¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <select class="form-control defect-type" name="defect_type[]">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞...</option>
                        <option value="undertorque">–ù–µ–¥–æ—Ç—è–≥</option>
                        <option value="overtorque">–ü–µ—Ä–µ—Ç—è–≥</option>
                        <option value="thread_stripped">–†–µ–∑—å–±–∞ —Å–æ—Ä–≤–∞–Ω–∞</option>
                        <option value="missing">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                    </select>
                </div>

                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="form-control defect-quantity" name="defect_quantity[]" min="1" value="1">
                </div>

                <!-- –§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ -->
                <div class="mb-3">
                    <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <input type="file" class="form-control defect-photo" name="defect_photos[]" multiple>
                    <button type="button" class="btn btn-primary open-camera-btn">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                    <div class="defect-photo-preview d-flex flex-wrap mt-2 gap-2"></div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ -->
                <button type="button" class="btn btn-danger remove-defect-btn">‚ùå –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
            </div>
        </div>
        <input type="hidden" name="torque_values" id="torque_values_input">

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn btn-success w-100 mb-5">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<!--<script>-->
<!--    function confirmSave() {-->
<!--        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {-->
<!--            document.querySelector('form').submit();-->
<!--        }-->
<!--    }-->
<!--</script>-->


<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    setupVinSearch();
    setupQrScanner();
});


function setupVinSearch() {
    let vinInput = document.getElementById("vin_search");
    let clearBtn = document.getElementById("clear_vin_search");

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ VIN
    let vinList = document.createElement("ul");
    vinList.classList.add("list-group", "mt-2");
    vinList.style.position = "absolute";
    vinList.style.zIndex = "3";  // ‚úÖ —Å–ø–∏—Å–æ–∫ –ø–æ–¥ ‚ùå
    vinList.style.backgroundColor = "white";
    vinList.style.width = "100%";
    vinList.style.maxHeight = "200px";
    vinList.style.overflowY = "auto";
    vinList.style.border = "0";
    vinList.style.borderTop = "none";
    vinList.style.marginTop = "0";
    vinInput.parentNode.appendChild(vinList);

    let traceDataContainer = document.getElementById("trace_data_container");
    let vinValue = document.getElementById("vin_value");
    let engineNumberValue = document.getElementById("engine_number_value");
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");
    let driveTypeValue = document.getElementById("drive_type_value");

    vinInput.addEventListener("input", function () {
        let query = vinInput.value.trim().toUpperCase();

        // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º ‚ùå
        clearBtn.style.display = query ? "block" : "none";

        if (!query) {
            vinList.style.display = "none";
            return;
        }

        fetch(`/assembly/api/vin-lookup/?q=${query}`)
            .then(response => response.json())
            .then(data => {
                vinList.innerHTML = "";
                if (!data.results || data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.addEventListener("click", function () {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        clearBtn.style.display = "block";  // ‚úÖ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ‚ùå –ø—Ä–∏ –≤—ã–±–æ—Ä–µ

                        vinValue.textContent = item.vin;
                        engineNumberValue.textContent = item.engine_number;
                        modelValue.textContent = item.model;
                        bodyColorValue.textContent = item.body_color;
                        driveTypeValue.textContent = item.drive_type;
                        document.getElementById("modification_input").value = item.drive_type.replace(/\s+/g, '');

                        traceDataContainer.style.display = "block";
                    });

                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ VIN:", error));
    });

    // –°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener("click", function (event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ ‚ùå
    clearBtn.addEventListener("click", function () {
        vinInput.value = "";
        clearBtn.style.display = "none";
        vinList.style.display = "none";
        traceDataContainer.style.display = "none";
    });
}


/* ------------------- */
/* üì∑ –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ VIN */
/* ------------------- */
function setupQrScanner() {
    const qrReaderContainer = document.getElementById("qr-reader");
    const scanBtn = document.getElementById("start_qr_scan");
    const vinInput = document.getElementById("vin_search");
    const clearButton = document.getElementById("clear_vin_search");

    let qrScanner = new Html5Qrcode("qr-reader");
    let qrActive = false;

    function onScanSuccess(decodedText, decodedResult) {
        vinInput.value = decodedText;
        if (clearButton) clearButton.style.display = "block";
        qrReaderContainer.style.display = "none";

        qrScanner.stop().then(() => {
            console.log("üì∏ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
            scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
            qrActive = false;
        }).catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        });

        triggerVinSearch(decodedText);
    }

    scanBtn.addEventListener("click", function () {
        if (!qrActive) {
            // üîπ –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
            qrReaderContainer.style.display = "block";
            scanBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                qrActive = true;
            }).catch(err => {
                console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å QR-—Å–∫–∞–Ω–µ—Ä:", err);
                scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
                qrReaderContainer.style.display = "none";
                qrActive = false;
            });

        } else {
            // üîπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
            qrScanner.stop().then(() => {
                qrReaderContainer.style.display = "none";
                scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
                qrActive = false;
            }).catch(err => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
            });
        }
    });
}



/* ------------------- */
/* üîç –§—É–Ω–∫—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –ø–æ–∏—Å–∫–∞ VIN –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
/* ------------------- */
function triggerVinSearch(vin) {
    let traceDataContainer = document.getElementById("trace_data_container");

    let vinValue = document.getElementById("vin_value");
    let engineNumberValue = document.getElementById("engine_number_value");
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");
    let driveTypeValue = document.getElementById("drive_type_value");

    fetch(`/assembly/api/vin-lookup/?q=${vin}`)
        .then(response => response.json())
        .then(data => {
            if (!data.results || data.results.length === 0) {
                traceDataContainer.style.display = "none";
                return;
            }

            let vinData = data.results[0];

            vinValue.textContent = vinData.vin;
            engineNumberValue.textContent = vinData.engine_number;
            modelValue.textContent = vinData.model;
            bodyColorValue.textContent = vinData.body_color;
            driveTypeValue.textContent = vinData.drive_type;
            document.getElementById("modification_input").value = vinData.drive_type.replace(/\s+/g, '');

            traceDataContainer.style.display = "block";
        })
        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö VIN:", error));
}


document.addEventListener("DOMContentLoaded", function () {
    setupAssemblyPartSearch();
});


/* ------------------- */
/* üîπ –ü–æ–∏—Å–∫ —É–∑–ª–∞/–¥–µ—Ç–∞–ª–∏ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–∑–ª—É */
/* ------------------- */
function setupAssemblyPartSearch() {
    let assemblyPartInput = document.getElementById("assembly_part_search");
    let assemblyPartList = document.createElement("ul");
    assemblyPartList.classList.add("list-group", "mt-2");
    assemblyPartList.style.position = "absolute";
    assemblyPartList.style.width = "100%";
    assemblyPartList.style.display = "none";
    assemblyPartInput.parentNode.appendChild(assemblyPartList);

    let driveTypeElement = document.getElementById("drive_type_value");

    assemblyPartInput.addEventListener("input", function () {
        let query = assemblyPartInput.value.trim().toLowerCase();
        let driveType = driveTypeElement.textContent.trim().replace(/\s+/g, ""); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "4 WD" ‚Üí "4WD")

        if (!query || !driveType) {
            assemblyPartList.style.display = "none";
            return;
        }

        console.log(`üîç –ü–æ–∏—Å–∫ —É–∑–ª–∞: ${query}, –ü—Ä–∏–≤–æ–¥: ${driveType}`);

        fetch(`/assembly/api/assembly-parts/?drive_type=${driveType}`)
            .then(response => response.json())
            .then(data => {
                assemblyPartList.innerHTML = "";
                if (!data.length) {
                    assemblyPartList.style.display = "none";
                    return;
                }

                let filteredParts = data.filter(part =>
                    part.name.toLowerCase().includes(query) &&
                    part.modification.replace(/\s+/g, "") === driveType // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
                );

                if (!filteredParts.length) {
                    assemblyPartList.style.display = "none";
                    return;
                }

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–≤–æ–¥ –¥–æ 6 –¥–µ—Ç–∞–ª–µ–π
                filteredParts.slice(0, 6).forEach(part => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = `${part.name} (${part.modification})`;
                    li.setAttribute("data-id", part.id);

                    li.addEventListener("click", function () {
                        assemblyPartInput.value = `${part.name} (${part.modification})`;
                        assemblyPartList.style.display = "none";
                        document.getElementById("assembly_part_input").value = part.id;
                        console.log("üìå –í—ã–±—Ä–∞–Ω —É–∑–µ–ª:", part.name, "| –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:", part.modification, "| ID:", part.id);

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–∑–ª—É (—Ä–∞–∑–º–µ—Ä, –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–∫–∏)
                        loadPartDetails(part.id);
                    });

                    assemblyPartList.appendChild(li);
                });

                assemblyPartList.style.display = "block";
            })
            .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–∑–ª–æ–≤/–¥–µ—Ç–∞–ª–µ–π:", error));
    });

    document.addEventListener("click", function (event) {
        if (!assemblyPartInput.contains(event.target) && !assemblyPartList.contains(event.target)) {
            assemblyPartList.style.display = "none";
        }
    });
}


/* ------------------- */
/* üîÑ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏ */
/* ------------------- */
function loadPartDetails(partId) {
    let partDataContainer = document.getElementById("part_data_container");
    let torqueInputContainer = document.getElementById("torque_input_container");
    let torqueInputs = document.getElementById("torque_inputs");

    if (!partId) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞: —É–∑–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.");
        return;
    }

    console.log(`üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–µ—Ç–∞–ª–∏ ID: ${partId}`);

    fetch(`/assembly/api/part-details/?part_id=${partId}`)
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ –¥–µ—Ç–∞–ª–∏:", data);

            if (data.error) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –î–µ—Ç–∞–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                return;
            }

            // ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
            partDataContainer.style.display = "block";
            document.getElementById("part_size").textContent = data.size;
            document.getElementById("part_quantity").textContent = `${data.min_quantity} ‚Äì ${data.max_quantity}`;
            document.getElementById("torque_range").textContent = `${data.min_torque} ‚Äì ${data.max_torque} –ù¬∑–º`;

            // ‚úÖ –°–æ–∑–¥–∞—ë–º –ø–æ–ª—è –¥–ª—è –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏ (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ü–≤–µ—Ç–æ–≤)
            torqueInputs.innerHTML = "";
            torqueInputContainer.style.display = "block";

            let minTorque = data.min_torque || 10;
            let maxTorque = data.max_torque || 100;
            window.requiredMinTorqueCount = data.min_quantity || 1;
            let maxQuantity = data.max_quantity || 1; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–ª—Ç–æ–≤

            for (let i = 1; i <= maxQuantity; i++) {
                let inputGroup = document.createElement("div");
                inputGroup.classList.add("input-group", "mb-2");

                let input = document.createElement("input");
                input.type = "number";
                input.classList.add("form-control", "torque-value");
                input.setAttribute("id", `torque_value_${i}`);
                input.setAttribute("name", `torque_value_${i}`);
                input.setAttribute("step", "0.1");
                input.setAttribute("placeholder", `–í–≤–µ–¥–∏—Ç–µ –º–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–∫–∏ (${i})`);

                // ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
                input.addEventListener("input", function () {
                    validateTorqueInput(input, minTorque, maxTorque);
                });

                inputGroup.appendChild(input);
                torqueInputs.appendChild(inputGroup);
            }
        })
        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–∏:", error));
}


/* ------------------- */
/* ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏ (—Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è) */
/* ------------------- */
function validateTorqueInput(inputElement, minTorque, maxTorque) {
    let value = inputElement.value.trim();

    if (value === "") {
        inputElement.style.backgroundColor = "#fff"; // –û—Å—Ç–∞–≤–ª—è–µ–º –±–µ–ª—ã–º
        return;
    }

    value = parseFloat(value);

    if (value >= minTorque && value <= maxTorque) {
        inputElement.style.backgroundColor = "#d4edda"; // ‚úÖ –ó–µ–ª–µ–Ω—ã–π (–Ω–æ—Ä–º–∞)
    } else {
        inputElement.style.backgroundColor = "#f8d7da"; // ‚ùå –ö—Ä–∞—Å–Ω—ã–π (–æ—à–∏–±–∫–∞)
    }
}


document.addEventListener("DOMContentLoaded", function () {
    console.log("üîß –î–µ—Ñ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");

    let defectNoRadio = document.getElementById("defect_no");
    let defectYesRadio = document.getElementById("defect_yes");
    let defectContainer = document.getElementById("defect_container");
    let defectList = document.getElementById("defect_list");
    let addDefectBtn = document.getElementById("add_defect_btn");
    let defectTemplate = document.getElementById("defect_template");

    if (!defectNoRadio || !defectYesRadio || !defectContainer) {
        console.error("‚ùå –û—à–∏–±–∫–∞: –û–¥–∏–Ω –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        return;
    }

    // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function toggleDefectForm() {
        if (defectYesRadio.checked) {
            defectContainer.style.display = "block";
            // ‚ùó –§–æ—Ä–º–∞ –¥–µ—Ñ–µ–∫—Ç–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        } else {
            defectContainer.style.display = "none";
            defectList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤
        }
    }

    defectNoRadio.addEventListener("change", toggleDefectForm);
    defectYesRadio.addEventListener("change", toggleDefectForm);

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
    function addDefectForm() {
        let defectIndex = defectList.children.length + 1;

        let newDefect = defectTemplate.cloneNode(true);
        newDefect.style.display = "block";
        newDefect.classList.add("defect-form");
        newDefect.querySelector(".defect-title").textContent = `–î–µ—Ñ–µ–∫—Ç ${defectIndex}`;

        // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ID –∏ name –¥–ª—è –ø–æ–ª–µ–π
        newDefect.querySelector(".defect-type").name = `defect_type_${defectIndex}`;
        newDefect.querySelector(".defect-quantity").name = `defect_quantity_${defectIndex}`;
        newDefect.querySelector(".defect-photo").name = `defect_photo_${defectIndex}`;
        newDefect.querySelector(".defect-photo").id = `defect_photo_${defectIndex}`;

        let previewContainer = document.createElement("div");
        previewContainer.id = `defect_photo_preview_${defectIndex}`;
        previewContainer.classList.add("defect-photo-preview");
        newDefect.querySelector(".defect-photo").after(previewContainer);

        // üì∑ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
        let openCameraBtn = newDefect.querySelector(".open-camera-btn");
        openCameraBtn.setAttribute("data-input-id", `defect_photo_${defectIndex}`);
        openCameraBtn.setAttribute("data-preview-id", `defect_photo_preview_${defectIndex}`);
        openCameraBtn.addEventListener("click", function () {
            openCamera(`defect_photo_${defectIndex}`, `defect_photo_preview_${defectIndex}`);
        });

        // ‚ùå –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
        newDefect.querySelector(".remove-defect-btn").addEventListener("click", function () {
            newDefect.remove();
            updateDefectNumbers();
        });

        defectList.appendChild(newDefect);
        updateDefectNumbers();
    }

    // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function updateDefectNumbers() {
        document.querySelectorAll(".defect-form").forEach((form, index) => {
            const i = index + 1;
            form.querySelector(".defect-title").textContent = `–î–µ—Ñ–µ–∫—Ç ${i}`;

            const typeInput = form.querySelector(".defect-type");
            const quantityInput = form.querySelector(".defect-quantity");
            const photoInput = form.querySelector(".defect-photo");
            const previewContainer = form.querySelector(".defect-photo-preview");
            const openCameraBtn = form.querySelector(".open-camera-btn");

            // –û–±–Ω–æ–≤–ª—è–µ–º name –∏ id
            typeInput.name = `defect_type_${i}`;
            quantityInput.name = `defect_quantity_${i}`;
            photoInput.name = `defect_photo_${i}`;
            photoInput.id = `defect_photo_${i}`;
            previewContainer.id = `defect_photo_preview_${i}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–º–µ—Ä—ã
            openCameraBtn.setAttribute("data-input-id", `defect_photo_${i}`);
            openCameraBtn.setAttribute("data-preview-id", `defect_photo_preview_${i}`);

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ
            const newBtn = openCameraBtn.cloneNode(true);
            openCameraBtn.replaceWith(newBtn);
            newBtn.addEventListener("click", function () {
                openCamera(`defect_photo_${i}`, `defect_photo_preview_${i}`);
            });
        });
    }


    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    toggleDefectForm();
});



document.addEventListener("DOMContentLoaded", function () {
    console.log("üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!");

    let defectContainer = document.getElementById("defect_container");
    let defectList = document.getElementById("defect_list");
    let addDefectBtn = document.getElementById("add_defect_btn");
    let defectTemplate = document.getElementById("defect_template");

    // üìå –û–±—Ä–∞–±–æ—Ç–∫–∞ "–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç"
    document.querySelectorAll("input[name='has_defect']").forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "yes") {
                defectContainer.style.display = "block";
                if (defectList.children.length === 0) {
                    addDefectForm(true); // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –¥–µ—Ñ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                }
            } else {
                defectContainer.style.display = "none";
                defectList.innerHTML = "";
            }
        });
    });

    // üìå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞
    function addDefectForm(isFirst = false) {
        let defectIndex = defectList.children.length + 1;
        let newDefect = defectTemplate.cloneNode(true);
        newDefect.style.display = "block";
        newDefect.classList.add("defect-form");
        newDefect.querySelector(".defect-title").textContent = `–î–µ—Ñ–µ–∫—Ç ${defectIndex}`;

        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –¥–ª—è —Ñ–æ—Ç–æ
        let photoInput = newDefect.querySelector(".defect-photo");
        let previewContainer = newDefect.querySelector(".defect-photo-preview");
        let openCameraBtn = newDefect.querySelector(".open-camera-btn");

        let inputId = `defect_photo_${defectIndex}`;
        let previewId = `defect_photo_preview_${defectIndex}`;

        photoInput.id = inputId;
        previewContainer.id = previewId;
        openCameraBtn.setAttribute("data-input-id", inputId);
        openCameraBtn.setAttribute("data-preview-id", previewId);

        // üì∑ –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞–º–µ—Ä—ã
        openCameraBtn.addEventListener("click", function () {
            openCamera(inputId, previewId);
        });

        // ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞
        newDefect.querySelector(".remove-defect-btn").addEventListener("click", function () {
            newDefect.remove();
            updateDefectNumbers();
        });

        if (isFirst) {
            defectList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã
        }

        defectList.appendChild(newDefect);
    }

    // üìå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function updateDefectNumbers() {
        document.querySelectorAll(".defect-form").forEach((form, index) => {
            form.querySelector(".defect-title").textContent = `–î–µ—Ñ–µ–∫—Ç ${index + 1}`;
        });
    }

    // üìå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    addDefectBtn.addEventListener("click", function () {
        addDefectForm();
    });

    // üì∑ –§—É–Ω–∫—Ü–∏—è –∫–∞–º–µ—Ä—ã
    function openCamera(inputId, previewId) {
        let modal = document.createElement("div");
        modal.id = "camera_modal";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0, 0, 0, 0.8)";
        modal.style.zIndex = "9999";
        modal.style.display = "flex";
        modal.style.flexDirection = "column";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";

        modal.innerHTML = `
            <video id="camera_feed" autoplay playsinline style="width: 90%; max-width: 400px;"></video>
            <button id="capture_button" class="btn btn-success mt-2">üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        `;

        document.body.appendChild(modal);

        let video = modal.querySelector("#camera_feed");
        let captureButton = modal.querySelector("#capture_button");
        let closeButton = modal.querySelector("#close_camera");

        let activeInput = document.getElementById(inputId);
        let activePreview = document.getElementById(previewId);
        let activeStream = null;

        // üì∑ –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
                activeStream = stream;
                video.srcObject = stream;
                setTimeout(() => video.play(), 500);
            })
            .catch(function (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
            });

        // üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ
        captureButton.addEventListener("click", function () {
            let canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(function (blob) {
                let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

                let dataTransfer = new DataTransfer();
                if (activeInput.multiple) {
                    for (let existingFile of activeInput.files) {
                        dataTransfer.items.add(existingFile);
                    }
                }
                dataTransfer.items.add(file);
                activeInput.files = dataTransfer.files;

                // ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ—Ç–æ
                let imgContainer = document.createElement("div");
                imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

                let img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.classList.add("img-thumbnail", "defect-photo-img");

                let deleteBtn = document.createElement("button");
                deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
                deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
                deleteBtn.onclick = function () {
                    imgContainer.remove();
                    removeFileFromInput(activeInput, file);
                };

                imgContainer.appendChild(img);
                imgContainer.appendChild(deleteBtn);
                activePreview.appendChild(imgContainer);

                closeCamera();
            }, "image/jpeg");
        });

        // ‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã
        function closeCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
            }
            video.srcObject = null;
            modal.remove();
        }

        closeButton.addEventListener("click", closeCamera);
        modal.addEventListener("click", function (event) {
            if (event.target === modal) {
                closeCamera();
            }
        });

        function removeFileFromInput(inputElement, fileToRemove) {
            let dataTransfer = new DataTransfer();
            for (let i = 0; i < inputElement.files.length; i++) {
                if (inputElement.files[i] !== fileToRemove) {
                    dataTransfer.items.add(inputElement.files[i]);
                }
            }
            inputElement.files = dataTransfer.files;
        }
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.querySelectorAll("input[name='has_defect']:checked").forEach(radio => {
        if (radio.value === "yes") {
        }
    });

    console.log("‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
});


document.querySelector("form").addEventListener("submit", function (e) {
    const torqueInputs = document.querySelectorAll(".torque-value");
    const values = [];

    torqueInputs.forEach(input => {
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            values.push(value);
        }
    });

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –∑–∞—Ç—è–∂–∫–∏
    const required = window.requiredMinTorqueCount || 1;
    if (values.length < required) {
        e.preventDefault();  // ‚ùå –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
        alert(`‚ö†Ô∏è –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –º–∏–Ω–∏–º—É–º ${required} –∑–Ω–∞—á–µ–Ω–∏–π –º–æ–º–µ–Ω—Ç–∞ –∑–∞—Ç—è–∂–∫–∏.`);
        return;
    }

    // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
    document.getElementById("torque_values_input").value = JSON.stringify(values);

    // üîÑ –û—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ hidden input'—ã (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –º—É—Å–æ—Ä–∞ –æ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤)
    document.querySelectorAll("input[name^='defect_type_'], input[name^='defect_quantity_'], input[name^='defect_photo_']").forEach(el => el.remove());

    // ‚úÖ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –ø–æ–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É —Å–ø–∏—Å–∫—É
    const defectForms = document.querySelectorAll(".defect-form");
    defectForms.forEach((form, index) => {
        const i = index + 1;

        const type = form.querySelector(".defect-type").value;
        const quantity = form.querySelector(".defect-quantity").value;
        const photoInput = form.querySelector(".defect-photo");

        let typeInput = document.createElement("input");
        typeInput.type = "hidden";
        typeInput.name = `defect_type_${i}`;
        typeInput.value = type;
        form.appendChild(typeInput);

        let quantityInput = document.createElement("input");
        quantityInput.type = "hidden";
        quantityInput.name = `defect_quantity_${i}`;
        quantityInput.value = quantity;
        form.appendChild(quantityInput);

        photoInput.name = `defect_photo_${i}`;
        photoInput.id = `defect_photo_${i}`;
    });
});

</script>
{% endblock %}
