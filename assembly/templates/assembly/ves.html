{% extends "users/base.html" %}
{% load static %}

{% block title %}{{ post_name }}{% endblock %}

{% block content %}

<div class="container mt-4">
    <h2>
        {{ post_name }}
        {% if line and line != "1" %}
            <span class="text-muted" style="font-size: 0.9em;">[{{ line|title }}]</span>
        {% endif %}
    </h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" onsubmit="return beforeSubmit(event);">
        {% csrf_token %}

        <!-- –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä VIN</label>

            <!-- ‚úÖ –û–±—ë—Ä—Ç–∫–∞ –±–µ–∑ flex -->
            <div class="position-relative" style="width: 100%;">
                <input type="text" id="vin_search" name="vin_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ VIN..." maxlength="17"
                {% if user_role == "controller" %}readonly{% endif %}>
                <!-- ‚ùå –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ -->
                <span id="clear_vin_search"
                      style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                             cursor: pointer; display: none; font-size: 18px;">‚ùå</span>
            </div>

            <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">
                <i class="bi bi-qr-code-scan"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
            </button>
            <div id="qr-reader" style="width: 300px; display: none;"></div>
        </div>

        <!-- –î–∞–Ω–Ω—ã–µ –æ VIN -->
        <div id="trace_data_container" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–î–∞–Ω–Ω—ã–µ –ø–æ VIN</h5>
            <p><strong>VIN:</strong> <span id="vin_value"></span></p>
            <p><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value"></span></p>
            <p><strong>–ö–æ–¥ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏:</strong><span id="configuration_code"></span></p>
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
            <p><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
            <p><strong>–¢–∏–ø –ø—Ä–∏–≤–æ–¥–∞:</strong> <span id="drive_type_value"></span></p>
        </div>

        <div id="vin_defects_block" class="mb-3" style="display:none;">
          <h5 class="mb-3">–ò—Å—Ç–æ—Ä–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤</h5>
          <div id="vin_defects_list" class="d-grid gap-2"></div>
        </div>

        <!-- üö© –í–æ–ø—Ä–æ—Å: –µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç? -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç? <span style="color: red">*</span></label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no">
                <label class="form-check-label" for="defect_no">–ù–µ—Ç –¥–µ—Ñ–µ–∫—Ç–∞</label>
            </div>
        </div>

        <!-- üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div id="defect_container" class="mt-3" style="display: none;">
            <h5>–°–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤:</h5>
            <div id="defect_list"></div>
            <button type="button" class="btn btn-primary mt-2" id="add_defect_btn">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç
            </button>
        </div>

        <!-- üß± –®–∞–±–ª–æ–Ω –¥–µ—Ñ–µ–∫—Ç–∞ (–°–ö–†–´–¢) -->
        <div id="defect_template" class="defect-form border p-3 mt-2 rounded" style="display: none;">
            <h6 class="defect-title">–î–µ—Ñ–µ–∫—Ç 1</h6>

            <!-- –ó–æ–Ω–∞ -->
            <div class="mb-3">
                <label class="form-label">–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ <span style="color: red">*</span></label>
                <select class="form-control select2-zone defect-zone" name="defect_zone_X">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É...</option>
                    {% for zone in zones %}
                        <option value="{{ zone.name }}">{{ zone.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –£–∑–µ–ª -->
            <div class="mb-3">
                <label class="form-label">–î–µ—Ç–∞–ª—å <span style="color: red">*</span></label>
                <select class="form-control select2-unit defect-unit" name="defect_unit[]" >
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å...</option>
                </select>
            </div>

            <!-- –î–µ—Ñ–µ–∫—Ç -->
            <div class="mb-3">
                <label class="form-label">–î–µ—Ñ–µ–∫—Ç <span style="color: red">*</span></label>
                <select class="form-control select2-defect defect-name" name="defect_name[]" >
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç...</option>
                    {% for defect in defects %}
                        <option value="{{ defect.id }}">{{ defect.name }}{% if defect.nameENG %} / {{ defect.nameENG }}{% endif %}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
            <div class="mb-3">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <span style="color: red">*</span></label>
                <input type="number" class="form-control defect-quantity" name="defect_quantity[]" min="1" value="1">
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div class="mb-3">
                <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea class="form-control defect-comment" name="defect_comment[]" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            </div>

            <!-- –ì—Ä–µ–π–¥ -->
            <div class="mb-3">
                <label class="form-label">–ì—Ä–µ–π–¥ –¥–µ—Ñ–µ–∫—Ç–∞ <span style="color: red">*</span></label>
                <select class="form-control defect-grade" name="defect_grade[]">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–µ–π–¥...</option>
                    {% for grade in grades %}
                        <option value="{{ grade.id }}">{{ grade.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
            <div class="mb-3">
                <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π <span style="color: red">*</span></label>
                <select class="form-control defect-responsible" name="defect_responsible[]">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ...</option>
                    {% for responsible in responsibles %}
                        <option value="{{ responsible.id }}">{{ responsible.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ -->
            <div class="mb-3">
                <label class="form-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ <span style="color: red">*</span></label>
                <select class="form-control defect-repair-type" name="defect_repair_type[]">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø...</option>
                    <option value="online">–û–Ω–ª–∞–π–Ω</option>
                    <option value="offline">–û—Ñ—Ñ–ª–∞–π–Ω</option>
                </select>
            </div>

            <!-- –§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ -->
            <div class="mb-3 position-relative">
                <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ <span style="color: red">*</span></label>
                <input type="file" class="form-control defect-photo" name="defect_photo[]" accept="image/*"
                       style="opacity: 0; pointer-events: none; position: absolute; z-index: 2; height: 100%; width: 100%; top: 0; left: 0;" readonly>
                <div class="form-control bg-light fw-bold defect-photo-display">üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
                <button type="button" class="btn btn-primary mt-2 open-camera-btn">
                    <i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                </button>
                <div class="defect-photo-preview d-flex flex-wrap gap-2 mt-2"></div>
            </div>

            <button type="button" class="btn btn-danger btn-sm remove-defect-btn">
                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç
            </button>
        </div>
        <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–¥–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É) -->
        <div id="annotator_modal"
             style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:5000;">
          <div style="position:absolute; left:0; right:0; bottom:0; top:0;
                      display:flex; align-items:center; justify-content:center; padding:12px;">
            <div style="background:#fff; width:100%; max-width:680px; border-radius:16px; overflow:hidden;
                        box-shadow:0 8px 24px rgba(0,0,0,.25); display:flex; flex-direction:column;">

              <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
              <div style="display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid #eee;">
                <button id="ann_undo"  type="button" class="btn btn-outline-secondary btn-sm">‚Ü∂ –ù–∞–∑–∞–¥</button>
                <div style="flex:1 1 auto; text-align:center; font-weight:600;">–†–∞–∑–º–µ—Ç–∫–∞</div>
                <button id="ann_redo"  type="button" class="btn btn-outline-secondary btn-sm">–í–ø–µ—Ä—ë–¥ ‚Ü∑</button>
              </div>

              <!-- –ü–æ–ª–æ—Ç–Ω–æ -->
              <div style="padding:10px; display:flex; justify-content:center; align-items:center;">
                <canvas id="ann_canvas" style="max-width:92vw; max-height:65vh;"></canvas>
              </div>

              <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
              <div style="display:flex; gap:10px; padding:10px; border-top:1px solid #eee;">
                <button id="ann_delete" type="button" class="btn btn-outline-danger w-50">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="ann_save"   type="button" class="btn btn-primary w-50">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>


        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ç–∞–π–º–µ—Ä–∞ -->
        <input type="hidden" name="inspection_duration_seconds" id="inspection_duration_seconds">

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn btn-success w-100 mb-5" style="margin-top: 100px;">
            <i class="bi bi-check-circle-fill me-1"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
    </form>
</div>
<style>
  .defect-card{border:1px solid #e5e7eb;border-radius:8px;padding:10px 12px;background:#fff}
  .defect-card .summary-line{display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer}
  .defect-card .defect-details{display:none}
  .defect-card:not(.collapsed) .defect-details{display:block}
</style>
{{ vin_defects_data|json_script:"vin-defects-data" }}
<!-- –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∫–∞–º–µ—Ä—ã –∏ QR -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
function renderDefectsForVin(vinRaw){
  const block = document.getElementById("vin_defects_block");
  const list  = document.getElementById("vin_defects_list");
  if (!block || !list) return;

  const vin = String(vinRaw || "").toUpperCase();

  let map;
  try {
    map = JSON.parse(document.getElementById("vin-defects-data").textContent || "{}");
  } catch (e) {
    console.error("VIN defects JSON parse error:", e);
    block.style.display = "none";
    return;
  }

  const defects = map[vin] || [];
  list.innerHTML = "";

  if (!defects.length) {
    block.style.display = "none";
    return;
  }

  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const escapeAttr = (s) => escapeHtml(s).replace(/"/g, "&quot;");
  const formatDateLocal = (iso) => {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const pad = n => String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  defects.forEach((d, idx) => {
    const card = document.createElement("div");
    card.className = "defect-card collapsed";

    const summary = document.createElement("div");
    summary.className = "summary-line";
    summary.innerHTML = `
      <div class="text-truncate">
        <span class="badge bg-secondary">${escapeHtml(d.unit || "‚Äî")}</span>
        &nbsp;‚Ä¢&nbsp;<strong>${escapeHtml(d.name || "‚Äî")}</strong>
        &nbsp;‚Ä¢&nbsp;<span class="badge bg-info text-dark">${escapeHtml(d.grade || "‚Äî")}</span>
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary toggle-btn">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    `;

    const photos = Array.isArray(d.photos) ? d.photos : [];
    const when = formatDateLocal(d.date_added);

    const details = document.createElement("div");
    details.className = "defect-details mt-2";
    const carouselId = `defectCarousel_${idx}`;

    details.innerHTML = `
      <div class="row g-2 mb-2">
        <div class="col-md-4"><strong>–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞:</strong> ${escapeHtml(d.zone || "‚Äî")}</div>
        <div class="col-md-4"><strong>–ü–æ—Å—Ç:</strong> ${escapeHtml(d.post || "‚Äî")}</div>
        <div class="col-md-4"><strong>–ö–æ–≥–¥–∞:</strong> ${escapeHtml(when)}</div>
        <div class="col-md-6"><strong>–î–µ—Ç–∞–ª—å:</strong> ${escapeHtml(d.unit || "‚Äî")}</div>
        <div class="col-md-6"><strong>–î–µ—Ñ–µ–∫—Ç:</strong> ${escapeHtml(d.name || "‚Äî")}</div>
        <div class="col-md-6"><strong>–ì—Ä–µ–π–¥:</strong> ${escapeHtml(d.grade || "‚Äî")}</div>
        <div class="col-md-6"><strong>–í–≤—ë–ª:</strong> ${escapeHtml(d.controller || "‚Äî")}</div>
      </div>
      ${photos.length ? `
        <div id="${carouselId}" class="carousel slide mt-2" data-bs-ride="carousel">
          <div class="carousel-inner">
            ${photos.map((url,i)=>`
              <div class="carousel-item ${i===0?'active':''}">
                <img src="${escapeAttr(url)}" class="d-block w-100 img-fluid rounded" alt="photo ${i+1}">
              </div>`).join("")}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">–°–ª–µ–¥—É—é—â–µ–µ</span>
          </button>
        </div>
      ` : ``}
    `;

    summary.addEventListener("click", () => {
      const isCollapsed = card.classList.contains("collapsed");
      card.classList.toggle("collapsed", !isCollapsed);
      const btn = summary.querySelector(".toggle-btn");
      if (btn) btn.textContent = isCollapsed ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å";
    });

    card.appendChild(summary);
    card.appendChild(details);
    list.appendChild(card);
  });

  block.style.display = "block";
}
</script>

<script>
let inspectionStartTime = null;
let inspectionTimerInterval = null;

function startInspectionTimer() {
    inspectionStartTime = new Date();

    const display = document.getElementById("inspection_timer_display");
    if (!display) return;

    display.style.display = "block";

    inspectionTimerInterval = setInterval(() => {
        const now = new Date();
        const elapsedMs = now - inspectionStartTime;
        const minutes = Math.floor(elapsedMs / 60000);
        const seconds = Math.floor((elapsedMs % 60000) / 1000);
        display.textContent = `–í—Ä–µ–º—è –æ—Å–º–æ—Ç—Ä–∞: ${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
    }, 1000);
}

function stopInspectionTimer() {
    if (!inspectionStartTime) return;

    const now = new Date();
    const elapsedSeconds = Math.floor((now - inspectionStartTime) / 1000);

    const hiddenField = document.getElementById("inspection_duration_seconds");
    if (hiddenField) {
        hiddenField.value = elapsedSeconds;
        console.log("‚è±Ô∏è –í—Ä–µ–º—è –æ—Å–º–æ—Ç—Ä–∞:", elapsedSeconds, "—Å–µ–∫—É–Ω–¥");
    } else {
        console.warn("‚ö†Ô∏è –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
    }

    clearInterval(inspectionTimerInterval);

    const display = document.getElementById("inspection_timer_display");
    if (display) display.style.display = "none";
}

document.addEventListener("DOMContentLoaded", function () {
    function initSelect2Filters() {
        // üß© –£–∑–ª—ã
        $('.select2-unit').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ —É–∑–µ–ª...',
            allowClear: true,
            language: {
                noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            }
        });

        // üõ† –î–µ—Ñ–µ–∫—Ç—ã
        $('.select2-defect').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ –¥–µ—Ñ–µ–∫—Ç...',
            allowClear: true,
            language: {
                noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            }
        });

        // üóÇ –ó–æ–Ω—ã —É–∑–ª–æ–≤
        $('.select2-zone').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ –∑–æ–Ω—É...',
            allowClear: true,
            language: {
                noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            }
        });
    }

    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initSelect2Filters();

    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    window.initSelect2Filters = initSelect2Filters;
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let qrScanner = new Html5Qrcode("qr-reader");
    let qrActive = false;

    function onScanSuccess(decodedText, decodedResult) {
        const vinInput = document.getElementById("vin_search");
        const qrReader = document.getElementById("qr-reader");
        const scanBtn = document.getElementById("start_qr_scan");

        vinInput.value = decodedText;
        startInspectionTimer();
        qrReader.style.display = "none";

        qrScanner.stop().then(() => {
            console.log("üì∏ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR");
            scanBtn.innerHTML = '<i class="bi bi-qr-code-scan"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR';; // ‚úÖ –≤–µ—Ä–Ω—É–ª–∏ –Ω–∞–¥–ø–∏—Å—å
            qrActive = false;
        }).catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:", err);
        });

        triggerVinSearch(decodedText);
        startInspectionTimer();
    }

    document.getElementById("start_qr_scan").addEventListener("click", function () {
        const qrReader = document.getElementById("qr-reader");
        const scanBtn = document.getElementById("start_qr_scan");

        if (!qrActive) {
            qrReader.style.display = "block";
            scanBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                qrActive = true;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
            });
        } else {
            qrScanner.stop().then(() => {
                qrReader.style.display = "none";
                scanBtn.innerHTML = '<i class="bi bi-qr-code-scan"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR';;
                qrActive = false;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:", err);
            });
        }
    });
});
document.addEventListener("DOMContentLoaded", function () {
    const vinInput = document.getElementById("vin_search");
    const clearBtn = document.getElementById("clear_vin_search");

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–ª–∏ —Å–∫—Ä—ã–≤–∞—Ç—å –∫—Ä–µ—Å—Ç–∏–∫
    function toggleClearButton() {
        clearBtn.style.display = vinInput.value.trim() ? "block" : "none";
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é
    clearBtn.addEventListener("click", function () {
        vinInput.value = "";
        toggleClearButton();
        vinInput.focus();

        // üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö VIN
        const traceContainer = document.getElementById("trace_data_container");
        traceContainer.style.display = "none";

        document.getElementById("vin_value").textContent = "";
        document.getElementById("engine_number_value").textContent = "";
        document.getElementById("configuration_code").textContent = "";
        document.getElementById("model_value").textContent = "";
        document.getElementById("body_color_value").textContent = "";
        document.getElementById("drive_type_value").textContent = "";
    });

    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    toggleClearButton();

    // –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º ‚Äî –≤—Ä—É—á–Ω—É—é, QR, –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ)
    const checkInterval = setInterval(toggleClearButton, 200);
});


function triggerVinSearch(vin) {
    const vinValue = document.getElementById("vin_value");
    const engineNumberValue = document.getElementById("engine_number_value");
    const configurationCode = document.getElementById("configuration_code");
    const modelValue = document.getElementById("model_value");
    const bodyColorValue = document.getElementById("body_color_value");
    const driveTypeValue = document.getElementById("drive_type_value");
    const traceDataContainer = document.getElementById("trace_data_container");

    fetch(`/assembly/api/search_vin/?q=${encodeURIComponent(vin)}`)
      .then(response => {
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (!data.results || data.results.length === 0) {
          traceDataContainer.style.display = "none";
          const block = document.getElementById("vin_defects_block");
          if (block) block.style.display = "none";
          return;
        }

        const vinData = data.results[0];
        vinValue.textContent = vinData.vin;
        engineNumberValue.textContent = vinData.engine_number || "";
        configurationCode.textContent = vinData.config_code || "";
        modelValue.textContent = vinData.model || "";
        bodyColorValue.textContent = vinData.body_color || "";
        driveTypeValue.textContent = vinData.drive_type || "";

        traceDataContainer.style.display = "block";
        startInspectionTimer();

        // ‚úÖ —Å—Ä–∞–∑—É —Ä–∏—Å—É–µ–º –¥–µ—Ñ–µ–∫—Ç—ã –∏–∑ –∑–∞—Ä–∞–Ω–µ–µ –æ—Ç–¥–∞–Ω–Ω–æ–≥–æ JSON
        renderDefectsForVin(vinData.vin);
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error);
        const block = document.getElementById("vin_defects_block");
        if (block) block.style.display = "none";
      });

    startInspectionTimer();
}



function setupCamera() {
    const isMobileDevice = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobileDevice()) {
        async function compressImageFile(file, maxWidth = 1600, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                const reader = new FileReader();

                reader.onload = function (e) {
                    image.src = e.target.result;
                };

                image.onload = function () {
                    const canvas = document.createElement("canvas");
                    let scale = Math.min(1, maxWidth / image.width);
                    canvas.width = image.width * scale;
                    canvas.height = image.height * scale;

                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(function (blob) {
                        const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + "_compressed.jpg", {
                            type: "image/jpeg",
                            lastModified: Date.now()
                        });
                        resolve(compressedFile);
                    }, "image/jpeg", quality);
                };

                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –Ω–∞—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
        window.openCamera = function (inputId, previewId) {
            window.continueCaptureLoop = true;
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            if (!input || !preview) return;

            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment"); // –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É

            input.onchange = function () {
                if (!input.files || input.files.length === 0) {
                    window.continueCaptureLoop = false; // ‚ùå –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
                    return;
                }
                const dt = new DataTransfer();

                const existingImages = preview.querySelectorAll("img[data-file]");
                let promises = [];

                // üîÅ 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                existingImages.forEach(img => {
                    const base64 = img.src;
                    const filename = img.getAttribute("data-file");

                    const p = fetch(base64)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], filename, { type: blob.type });
                            dt.items.add(file);
                        });

                    promises.push(p);
                });

                // üì∏ 2. –ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å –∫–∞–º–µ—Ä—ã
                const newFiles = Array.from(input.files);

                newFiles.forEach(file => {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        compressImageFile(file).then(renamedFile => {
                            const imageURL = URL.createObjectURL(renamedFile);

                            if (!preview.dataset.carouselInitialized) {
                                preview.dataset.carouselInitialized = "true";
                                preview.carouselData = [];
                                preview.currentIndex = 0;

                                preview.innerHTML = `
                                    <div class="carousel-wrapper d-flex flex-column align-items-center">
                                        <div class="carousel-img-container position-relative" style="position: relative;">
                                            <img class="carousel-img img-thumbnail mb-2"
                                                 style="max-width:300px; border-radius:5px; object-fit:cover; width: 100%; position: relative; z-index: 1;">

                                            <div class="carousel-left-zone"
                                                 style="position:absolute; top:0; bottom:0; left:0; width:50%; z-index:2;"></div>
                                            <div class="carousel-right-zone"
                                                 style="position:absolute; top:0; bottom:0; right:0; width:50%; z-index:2;"></div>
                                        </div>

                                        <button type="button" class="carousel-delete btn btn-danger btn-sm mt-2 mb-1">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>

                                        <div class="carousel-controls d-flex justify-content-between align-items-center mt-3 w-100" style="max-width:300px;">
                                            <button type="button" class="carousel-prev btn btn-secondary btn-lg px-4">‚Üê</button>
                                            <span class="carousel-counter fs-5">1 / 1</span>
                                            <button type="button" class="carousel-next btn btn-secondary btn-lg px-4">‚Üí</button>
                                        </div>
                                    </div>
                                `;
                                const imgContainer = preview.querySelector(".carousel-img-container");
                                if (imgContainer && !imgContainer.querySelector(".annotate-fab")) {
                                    const fab = document.createElement("button");
                                    fab.type = "button";
                                    fab.className = "annotate-fab btn btn-light btn-sm";
                                    fab.setAttribute("aria-label", "–†–∞–∑–º–µ—Ç–∏—Ç—å —Ñ–æ—Ç–æ");
                                    fab.title = "–†–∞–∑–º–µ—Ç–∏—Ç—å —Ñ–æ—Ç–æ";
                                    fab.innerHTML = '<i class="bi bi-pencil-square"></i>'; // –º–æ–∂–Ω–æ 'bi-brush', 'bi-pencil', –∫–∞–∫ –Ω—Ä–∞–≤–∏—Ç—Å—è

                                    Object.assign(fab.style, {
                                        position: "absolute",
                                        top: "6px",
                                        right: "6px",
                                        zIndex: "3",                 // –≤—ã—à–µ –∑–æ–Ω –ª–∏—Å—Ç–∞–Ω–∏—è (—É –Ω–∏—Ö 2)
                                        width: "36px",               // —É–≤–µ–ª–∏—á–∏–ª–∏ —Ö–∏—Ç–±–æ–∫—Å –ø–æ–¥ –ø–∞–ª–µ—Ü
                                        height: "36px",
                                        borderRadius: "9999px",
                                        display: "inline-flex",
                                        alignItems: "center",
                                        justifyContent: "center",
                                        boxShadow: "0 2px 8px rgba(0,0,0,.25)",
                                        padding: "0",
                                        lineHeight: "1",
                                        fontSize: "18px"
                                    });

                                    fab.addEventListener("click", (e) => {
                                        e.preventDefault();
                                        e.stopPropagation(); // —á—Ç–æ–±—ã –Ω–µ –ª–∏—Å—Ç–∞–ª–∞—Å—å –∫–∞—Ä—É—Å–µ–ª—å
                                        openAnnotatorForInput(inputId, previewId);
                                    });

                                    imgContainer.appendChild(fab);
                                }


                                const imgElement = preview.querySelector(".carousel-img");
                                const deleteBtn = preview.querySelector(".carousel-delete");
                                const prevBtn = preview.querySelector(".carousel-prev");
                                const nextBtn = preview.querySelector(".carousel-next");
                                const counter = preview.querySelector(".carousel-counter");

                                function updateCarousel() {
                                    const data = preview.carouselData;
                                    if (data.length === 0) {
                                        preview.innerHTML = "<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>";
                                        preview.dataset.carouselInitialized = "";
                                        preview.carouselData = null;
                                        return;
                                    }

                                    const current = data[preview.currentIndex];
                                    imgElement.src = current.url;
                                    counter.textContent = `${preview.currentIndex + 1} / ${data.length}`;
                                }

                                deleteBtn.onclick = () => {
                                    preview.carouselData.splice(preview.currentIndex, 1);
                                    if (preview.currentIndex >= preview.carouselData.length) {
                                        preview.currentIndex = preview.carouselData.length - 1;
                                    }
                                    updateCarousel();

                                    const dt = new DataTransfer();
                                    preview.carouselData.forEach(item => dt.items.add(item.file));
                                    input.files = dt.files;

                                    if (input.id === "body_photos") {
                                        const display = document.getElementById("body_photos_display");
                                        if (display) {
                                            const count = input.files.length;
                                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                        }
                                    } else if (input.id.startsWith("defect_photo_input_")) {
                                        const index = input.id.split("_").pop();
                                        const display = document.getElementById(`defect_photo_display_${index}`);
                                        if (display) {
                                            const count = input.files.length;
                                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                        }
                                    }
                                };

                                prevBtn.onclick = () => {
                                    if (preview.currentIndex > 0) {
                                        preview.currentIndex--;
                                        updateCarousel();
                                    }
                                };

                                nextBtn.onclick = () => {
                                    if (preview.currentIndex < preview.carouselData.length - 1) {
                                        preview.currentIndex++;
                                        updateCarousel();
                                    }
                                };

                                preview.updateCarousel = updateCarousel;

                                const leftZone = preview.querySelector(".carousel-left-zone");
                                const rightZone = preview.querySelector(".carousel-right-zone");

                                leftZone.addEventListener("click", () => {
                                    if (preview.currentIndex > 0) {
                                        preview.currentIndex--;
                                        preview.updateCarousel();
                                    }
                                });

                                rightZone.addEventListener("click", () => {
                                    if (preview.currentIndex < preview.carouselData.length - 1) {
                                        preview.currentIndex++;
                                        preview.updateCarousel();
                                    }
                                });
                            }

                            preview.carouselData.push({ file: renamedFile, url: imageURL });
                            preview.currentIndex = preview.carouselData.length - 1;
                            preview.updateCarousel();

                            const dt = new DataTransfer();
                            preview.carouselData.forEach(item => dt.items.add(item.file));
                            input.files = dt.files;

                            if (input.id === "body_photos") {
                                const display = document.getElementById("body_photos_display");
                                if (display) {
                                    const count = input.files.length;
                                    display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                }
                            } else if (input.id.startsWith("defect_photo_input_")) {
                                const index = input.id.split("_").pop();
                                const display = document.getElementById(`defect_photo_display_${index}`);
                                if (display) {
                                    const count = input.files.length;
                                    display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                }
                            }
                        }).catch(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", err);
                        });
                    };

                    reader.readAsDataURL(file);
                });


                // ‚è≥ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å–µ—Ö fetch
                Promise.all(promises).then(() => {
                    input.files = dt.files;
                    // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                    if (input.id === "body_photos") {
                        const display = document.getElementById("body_photos_display");
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    } else if (input.id.startsWith("defect_photo_input_")) {
                        const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                        const display = document.getElementById(`defect_photo_display_${index}`);
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    }
                });
            };

            input.click();
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è base64 –≤ Blob
        function dataURLToBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        };


    } else {
        // üíª –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let modal = document.createElement("div");
        modal.id = "camera_modal";
        modal.style.display = "none";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.flexDirection = "column";
        modal.innerHTML = `
            <video id="camera_feed" autoplay playsinline style="width:90%; max-width:500px;"></video>
            <button id="capture_button" class="btn btn-success mt-3">'<i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ'</button>
            <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        document.body.appendChild(modal);

        let video = document.getElementById("camera_feed");
        let captureButton = document.getElementById("capture_button");
        let closeButton = document.getElementById("close_camera");

        let canvas = document.createElement("canvas");
        let activeStream = null;
        let activeInput = null;
        let activePreview = null;

        window.openCamera = function (inputId, previewId) {
            activeInput = document.getElementById(inputId);
            activePreview = document.getElementById(previewId);

            if (!activeInput || !activePreview) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –∏–ª–∏ preview");
                return;
            }

            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function (stream) {
                    activeStream = stream;
                    video.srcObject = stream;
                    modal.style.display = "flex";
                    setTimeout(() => video.play(), 500);
                })
                .catch(function (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                    alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
                });

            captureButton.onclick = function () {
                if (!activeInput || !activePreview) return;

                let context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(function (blob) {
                    let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

                    let dataTransfer = new DataTransfer();
                    if (!activeInput.multiple) {
                        activeInput.value = "";
                        while (activePreview.firstChild) activePreview.removeChild(activePreview.firstChild);
                    } else {
                        for (let f of activeInput.files) {
                            dataTransfer.items.add(f);
                        }
                    }

                    dataTransfer.items.add(file);
                    activeInput.files = dataTransfer.files;

                    let imgContainer = document.createElement("div");
                    imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

                    let img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    img.classList.add("img-thumbnail");
                    img.style.maxWidth = "300px";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";

                    let deleteBtn = document.createElement("button");
                    deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
                    deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
                    deleteBtn.onclick = function () {
                        imgContainer.remove();
                        removeFileFromInput(activeInput, file);
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(deleteBtn);
                    activePreview.appendChild(imgContainer);

                    closeCamera();
                }, "image/jpeg");
            };
        };

        function removeFileFromInput(inputElement, fileToRemove) {
            let dataTransfer = new DataTransfer();
            for (let i = 0; i < inputElement.files.length; i++) {
                let file = inputElement.files[i];
                if (file.name !== fileToRemove.name || file.size !== fileToRemove.size) {
                    dataTransfer.items.add(file);
                }
            }
            inputElement.files = dataTransfer.files;
        }

        function closeCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
            }
            video.srcObject = null;
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", closeCamera);
        modal.addEventListener("click", function (event) {
            if (event.target === modal) closeCamera();
        });
    }
}


function rebuildInputFiles(input, preview) {
    const dt = new DataTransfer();

    const images = preview.querySelectorAll("img[data-file]");
    let promises = [];

    images.forEach(img => {
        const base64 = img.src;
        const filename = img.getAttribute("data-file");

        const p = fetch(base64)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], filename, { type: blob.type });
                dt.items.add(file);
            });

        promises.push(p);
    });

    Promise.all(promises).then(() => {
        input.files = dt.files;
        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
        if (input.id === "body_photos") {
            const display = document.getElementById("body_photos_display");
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        } else if (input.id.startsWith("defect_photo_input_")) {
            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
            const display = document.getElementById(`defect_photo_display_${index}`);
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        }
    });
}
document.addEventListener("DOMContentLoaded", function () {
    setupCamera();
});
</script>
<script>
    const userRole = "{{ user_role|escapejs }}";
</script>
<script>
(function(){
  const BRUSH_WIDTH = 8; // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–æ–ª—â–∏–Ω–∞ –∫–∏—Å—Ç–∏

  let modal, canvas, ctx, imgObj;
  let drawing = false;
  let strokes = [];      // –¥–ª—è undo
  let redoStack = [];    // –¥–ª—è redo
  let currentPath = [];
  let onSaveCallback = null;
  let outType = "image/jpeg"; // —Ñ–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

  // —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã —É–±–∏—Ä–∞—Ç—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  const H = {
    mousedown: null,
    mousemove: null,
    mouseup:   null,
    touchstart:null,
    touchmove: null,
    touchend:  null,
    resize:    null,
    undo:      null,
    redo:      null,
    del:       null,
    save:      null,
  };

  function showModal(){
    modal.style.display = "block";
    document.body.style.overflow = "hidden";
  }
  function hideModal(){
    modal.style.display = "none";
    document.body.style.overflow = "";
    removeAllListeners();
    cleanup();
  }
  function cleanup(){
    strokes = [];
    redoStack = [];
    currentPath = [];
    imgObj = null;
    if (ctx && canvas) ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  function fitCanvasToImage(img){
    const maxW = Math.min(img.width,  Math.floor(window.innerWidth * 0.92));
    const maxH = Math.min(img.height, Math.floor(window.innerHeight * 0.65));
    const k = Math.min(maxW/img.width, maxH/img.height);
    canvas.width  = Math.floor(img.width * k);
    canvas.height = Math.floor(img.height * k);
    redraw();
  }

  function redraw(){
    if(!ctx || !imgObj) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);

    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#ff0000";

    strokes.forEach(p => {
      ctx.lineWidth = p.w;
      ctx.beginPath();
      p.points.forEach((pt,i)=> i ? ctx.lineTo(pt.x, pt.y) : ctx.moveTo(pt.x, pt.y));
      ctx.stroke();
    });

    if(currentPath.length){
      ctx.lineWidth = BRUSH_WIDTH;
      ctx.beginPath();
      currentPath.forEach((pt,i)=> i ? ctx.lineTo(pt.x, pt.y) : ctx.moveTo(pt.x, pt.y));
      ctx.stroke();
    }
  }

  function getPos(e){
    const r = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : null;
    const x = (t ? t.clientX : e.clientX) - r.left;
    const y = (t ? t.clientY : e.clientY) - r.top;
    return { x, y };
  }

  function startDraw(e){
    e.preventDefault(); e.stopPropagation();
    drawing = true;
    redoStack = []; // –Ω–æ–≤–∞—è –ª–∏–Ω–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç redo
    currentPath = [ getPos(e) ];
    redraw();
  }
  function moveDraw(e){
    if(!drawing) return;
    e.preventDefault(); e.stopPropagation();
    currentPath.push(getPos(e));
    redraw();
  }
  function endDraw(e){
    if(!drawing) return;
    e && (e.preventDefault(), e.stopPropagation());
    drawing = false;
    if(currentPath.length>1){
      strokes.push({ points:[...currentPath], w:BRUSH_WIDTH });
    }
    currentPath = [];
    redraw();
  }

  function loadImage(url){
    return new Promise((res,rej)=>{
      const im = new Image();
      im.crossOrigin = "anonymous";
      im.onload = ()=>res(im);
      im.onerror = rej;
      im.src = url;
    });
  }

  function addAllListeners(){
    // —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
    H.mousedown = startDraw;
    H.mousemove = moveDraw;
    H.mouseup   = endDraw;
    H.touchstart= startDraw;
    H.touchmove = moveDraw;
    H.touchend  = endDraw;

    canvas.addEventListener("mousedown", H.mousedown, { passive:false });
    canvas.addEventListener("mousemove", H.mousemove, { passive:false });
    window.addEventListener("mouseup",   H.mouseup,   { passive:false });
    canvas.addEventListener("touchstart",H.touchstart,{ passive:false });
    canvas.addEventListener("touchmove", H.touchmove, { passive:false });
    canvas.addEventListener("touchend",  H.touchend,  { passive:false });

    // resize
    H.resize = ()=> imgObj && fitCanvasToImage(imgObj);
    window.addEventListener("resize", H.resize, { passive:true });

    // –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    const undoBtn = document.getElementById("ann_undo");
    const redoBtn = document.getElementById("ann_redo");
    const delBtn  = document.getElementById("ann_delete");
    const saveBtn = document.getElementById("ann_save");

    H.undo = (e)=>{ e.preventDefault(); e.stopPropagation();
      if(strokes.length){ redoStack.push(strokes.pop()); redraw(); }
    };
    H.redo = (e)=>{ e.preventDefault(); e.stopPropagation();
      if(redoStack.length){ strokes.push(redoStack.pop()); redraw(); }
    };
    H.del  = (e)=>{ e.preventDefault(); e.stopPropagation();
      strokes = []; redoStack = []; redraw();
    };
    H.save = (e)=>{ e.preventDefault(); e.stopPropagation();
      const off = document.createElement("canvas");
      off.width  = imgObj.naturalWidth || imgObj.width;
      off.height = imgObj.naturalHeight || imgObj.height;
      const octx = off.getContext("2d");

      // —Ñ–æ–Ω ‚Äî –∏—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
      octx.drawImage(imgObj, 0, 0, off.width, off.height);

      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ª–∏–Ω–∏–∏ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      const sx = off.width / canvas.width, sy = off.height / canvas.height;
      octx.lineCap="round"; octx.lineJoin="round"; octx.strokeStyle="#ff0000";
      strokes.forEach(p=>{
        octx.lineWidth = p.w * ((sx+sy)/2);
        octx.beginPath();
        p.points.forEach((pt,i)=>{
          const x=pt.x*sx, y=pt.y*sy;
          i ? octx.lineTo(x,y) : octx.moveTo(x,y);
        });
        octx.stroke();
      });

      const quality = outType === "image/jpeg" ? 1.0 : undefined; // –º–∞–∫—Å–∏–º—É–º –¥–ª—è JPEG
      off.toBlob((blob)=>{
        onSaveCallback && onSaveCallback(blob, outType);
        hideModal();
      }, outType, quality);
    };

    undoBtn?.addEventListener("click", H.undo);
    redoBtn?.addEventListener("click", H.redo);
    delBtn ?.addEventListener("click", H.del);
    saveBtn?.addEventListener("click", H.save);
  }

  function removeAllListeners(){
    if (!canvas) return;
    canvas.removeEventListener("mousedown", H.mousedown);
    canvas.removeEventListener("mousemove", H.mousemove);
    window.removeEventListener("mouseup",   H.mouseup);
    canvas.removeEventListener("touchstart",H.touchstart);
    canvas.removeEventListener("touchmove", H.touchmove);
    canvas.removeEventListener("touchend",  H.touchend);
    window.removeEventListener("resize",    H.resize);

    document.getElementById("ann_undo")  ?.removeEventListener("click", H.undo);
    document.getElementById("ann_redo")  ?.removeEventListener("click", H.redo);
    document.getElementById("ann_delete")?.removeEventListener("click", H.del);
    document.getElementById("ann_save")  ?.removeEventListener("click", H.save);
  }

  // === –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ ===
  async function openAnnotator(imgUrl, onSave, options = {}){
    modal  = document.getElementById("annotator_modal");
    canvas = document.getElementById("ann_canvas");
    ctx    = canvas.getContext("2d");
    onSaveCallback = onSave;
    outType = (options.mime && /image\/(jpeg|png|webp)/.test(options.mime))
                ? options.mime : "image/jpeg";

    imgObj = await loadImage(imgUrl);
    fitCanvasToImage(imgObj);

    addAllListeners();
    showModal();
  }

  // === API –¥–ª—è —Ç–≤–æ–∏—Ö –ø—Ä–µ–≤—å—é ===
  window.openAnnotatorForInput = function(inputId, previewId){
    const input   = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if(!input || !preview) return;

    const imgEl = preview.querySelector(".carousel-img") || preview.querySelector("img");
    if(!imgEl) return;

    // –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π MIME —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
    const existing = preview.carouselData || [];
    const currentURL = imgEl.src;
    const currentItem = existing.find(it => it.url === currentURL);
    const mime = currentItem?.file?.type || "image/jpeg";

    openAnnotator(imgEl.src, (blob, finalMime)=>{
      const ext = finalMime === "image/png" ? "png" :
                  finalMime === "image/webp" ? "webp" : "jpg";
      const annotatedFile = new File([blob], `annotated_${Date.now()}.${ext}`, { type: finalMime });

      const dt = new DataTransfer();
      const newData = existing.length
        ? existing.map(item => {
            if (item.url === currentURL) {
              const u = URL.createObjectURL(annotatedFile);
              return { file: annotatedFile, url: u };
            }
            return item;
          })
        : [{ file: annotatedFile, url: URL.createObjectURL(annotatedFile) }];

      newData.forEach(it => dt.items.add(it.file));
      input.files = dt.files;

      if (preview.carouselData) {
        preview.carouselData = newData;
        preview.updateCarousel && preview.updateCarousel();
      } else {
        imgEl.src = newData[0].url;
      }

      const displayId = inputId.replace("input","display");
      const display = document.getElementById(displayId);
      if(display){
        const count = input.files.length;
        display.textContent = count>0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
      }
    }, { mime });
  };
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    setupVinSearch();
});

function setupVinSearch() {
    let vinInput = document.getElementById("vin_search");
    let clearButton = document.getElementById("clear_vin_search");
    let vinList = document.createElement("ul");
    vinList.id = "vin_list";
    vinList.classList.add("list-group", "position-absolute", "w-100", "mt-1");
    vinList.style.zIndex = "1000";
    vinInput.parentNode.appendChild(vinList);

    vinInput.addEventListener("input", function () {
        if (userRole === "controller") {
            // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞
            vinInput.value = "";
            return;
        }

        let query = vinInput.value.trim();

        if (query.length > 0) {
            clearButton.style.display = "block";
            startInspectionTimer();
        } else {
            clearButton.style.display = "none";
            vinList.style.display = "none";
            return;
        }

        fetch(`/supplies/api/search_vin/?q=${query}`)
            .then(response => {
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                return response.json();
            })
            .then(data => {
                vinList.innerHTML = "";
                if (data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.style.cursor = "pointer";

                    li.addEventListener("click", function () {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        clearButton.style.display = "block";

                        triggerVinSearch(item.vin);
                        startInspectionTimer()
                    });

                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error));
    });

    clearButton.addEventListener("click", function () {
        if (userRole === "controller") return;  // –∑–∞–ø—Ä–µ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä–∞

        vinInput.value = "";
        clearButton.style.display = "none";
        vinList.style.display = "none";
        document.getElementById("trace_data_container").style.display = "none";
    });

    document.addEventListener("click", function(event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });
}


document.addEventListener("DOMContentLoaded", function () {
    const vinInput = document.getElementById("vin_search");

    if (userRole === "controller" && vinInput) {
        vinInput.addEventListener("keydown", function (e) {
            e.preventDefault();
        });

        vinInput.addEventListener("paste", function (e) {
            e.preventDefault();
        });
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const defectContainer = document.getElementById("defect_container");
    const defectList = document.getElementById("defect_list");
    const addDefectBtn = document.getElementById("add_defect_btn");
    const defectTemplate = document.getElementById("defect_template");

    // üîÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ "–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç"
    document.querySelectorAll("input[name='has_defect']").forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "yes") {
                defectContainer.style.display = "block";
                if (defectList.children.length === 0) {
                    addDefectForm(true); // –ü–µ—Ä–≤—ã–π –¥–µ—Ñ–µ–∫—Ç
                }
            } else {
                defectContainer.style.display = "none";
                defectList.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞
            }
        });
    });

    // ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞
    addDefectBtn.addEventListener("click", function () {
        addDefectForm();
    });

    // üß± –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
     // üß± –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
    function addDefectForm(isFirst = false) {
        const index = defectList.children.length + 1;
        const newDefect = defectTemplate.cloneNode(true);
        newDefect.style.display = "block";
        newDefect.id = "";

        // üßº –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —Å–ª–µ–¥–æ–≤ Select2
        $(newDefect).find('.select2').remove(); // —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã select2
        $(newDefect).find('select').each(function () {
            this.classList.remove("select2-hidden-accessible");
            this.removeAttribute("data-select2-id");
            this.removeAttribute("aria-hidden");
            this.removeAttribute("tabindex");
        });

        // üè∑ –ó–∞–≥–æ–ª–æ–≤–æ–∫
        newDefect.querySelector(".defect-title").textContent = `–î–µ—Ñ–µ–∫—Ç ${index}`;

        // üß© –£–∑–µ–ª
        const unitInput = newDefect.querySelector(".defect-unit");
        if (unitInput) unitInput.name = `defect_unit_${index}`;

        // üß≠ –ó–æ–Ω–∞
        const zoneInput = newDefect.querySelector(".defect-zone");
        if (zoneInput) zoneInput.name = `defect_zone_${index}`;

        // üìå –î–µ—Ñ–µ–∫—Ç
        const nameInput = newDefect.querySelector(".defect-name");
        if (nameInput) nameInput.name = `defect_name_${index}`;

        // üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
        const quantityInput = newDefect.querySelector(".defect-quantity");
        if (quantityInput) quantityInput.name = `defect_quantity_${index}`;

        // üéö –ì—Ä–µ–π–¥
        const gradeInput = newDefect.querySelector(".defect-grade");
        if (gradeInput) gradeInput.name = `defect_grade_${index}`;

        // üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
        const responsibleInput = newDefect.querySelector(".defect-responsible");
        if (responsibleInput) responsibleInput.name = `defect_responsible_${index}`;

        // üõ† –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
        const repairTypeInput = newDefect.querySelector(".defect-repair-type");
        if (repairTypeInput) repairTypeInput.name = `defect_repair_type_${index}`;

        // üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        const commentInput = newDefect.querySelector(".defect-comment");
        if (commentInput) commentInput.name = `defect_comment_${index}`;

        // üì∏ –§–æ—Ç–æ
        const photoInput = newDefect.querySelector(".defect-photo");
        const photoDisplay = newDefect.querySelector(".defect-photo-display");
        const preview = newDefect.querySelector(".defect-photo-preview");
        const cameraBtn = newDefect.querySelector(".open-camera-btn");

        const inputId = `defect_photo_input_${index}`;
        const previewId = `defect_photo_preview_${index}`;
        const displayId = `defect_photo_display_${index}`;

        if (photoInput) {
            photoInput.name = `defect_photo_${index}`;
            photoInput.id = inputId;
        }
        if (photoDisplay) photoDisplay.id = displayId;
        if (preview) preview.id = previewId;

        if (cameraBtn) {
            cameraBtn.setAttribute("data-defect-index", index);
            cameraBtn.onclick = function () {
                openCamera(inputId, previewId);
            };
        }

        // üóë –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞
        const removeBtn = newDefect.querySelector(".remove-defect-btn");
        if (removeBtn) {
            removeBtn.addEventListener("click", function () {
                newDefect.remove();
                updateDefectNumbers();
            });
        }

        // üëá –í—Å—Ç–∞–≤–∫–∞ –≤ DOM
        defectList.appendChild(newDefect);

        // üîÅ Select2 (–ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏!)
        $(newDefect).find('.select2-unit').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ —É–∑–µ–ª...',
            allowClear: true,
            language: { noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" }
        });

        $(newDefect).find('.select2-defect').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ –¥–µ—Ñ–µ–∫—Ç...',
            allowClear: true,
            language: { noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" }
        });

        $(newDefect).find('.select2-zone').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'üîç –ù–∞–π—Ç–∏ –∑–æ–Ω—É...',
            allowClear: true,
            language: { noResults: () => "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" }
        });
        // üß≠ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∑–ª–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –∑–æ–Ω—ã
        $(newDefect).find('.select2-zone').on('change', function () {
            const selectedZone = $(this).val();
            const unitSelect = $(newDefect).find('.select2-unit');

            unitSelect.empty(); // –û—á–∏—Å—Ç–∏—Ç—å

            // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π option
            unitSelect.append(new Option('–í—ã–±–µ—Ä–∏—Ç–µ —É–∑–µ–ª...', '', true, true));

            if (UNITS_BY_ZONE[selectedZone]) {
                UNITS_BY_ZONE[selectedZone].forEach(unit => {
                    const option = new Option(unit.name, unit.id, false, false);
                    unitSelect.append(option);
                });
            }

            unitSelect.trigger('change.select2'); // –û–±–Ω–æ–≤–∏—Ç—å select2
        });
    }



    // üî¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ –∏ –∏–º—ë–Ω –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
    function updateDefectNumbers() {
        const forms = defectList.querySelectorAll(".defect-form");
        forms.forEach((form, idx) => {
            const number = idx + 1;

            // üè∑ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const title = form.querySelector(".defect-title");
            if (title) title.textContent = `–î–µ—Ñ–µ–∫—Ç ${number}`;

            // üìå –ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞
            const nameInput = form.querySelector(".defect-name");
            if (nameInput) nameInput.name = `defect_name_${number}`;

            // üóÇÔ∏è –ó–æ–Ω–∞
            const zoneSelect = form.querySelector(".defect-zone");
            if (zoneSelect) zoneSelect.name = `defect_zone_${number}`;

            // üß© –£–∑–µ–ª
            const unitInput = form.querySelector(".defect-unit");
            if (unitInput) unitInput.name = `defect_unit_${number}`;

            const quantityInput = form.querySelector(".defect-quantity");
            if (quantityInput) quantityInput.name = `defect_quantity_${number}`;

            // üéö –ì—Ä–µ–π–¥
            const gradeInput = form.querySelector(".defect-grade");
            if (gradeInput) gradeInput.name = `defect_grade_${number}`;

            // üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
            const responsibleInput = form.querySelector(".defect-responsible");
            if (responsibleInput) responsibleInput.name = `defect_responsible_${number}`;

            // üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            const commentInput = form.querySelector(".defect-comment");
            if (commentInput) commentInput.name = `defect_comment_${number}`;

            // üõ† –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const repairTypeInput = form.querySelector(".defect-repair-type");
            if (repairTypeInput) repairTypeInput.name = `defect_repair_type_${number}`;

            // üì∏ –§–æ—Ç–æ
            const photoInput = form.querySelector(".defect-photo");
            const photoDisplay = form.querySelector(".defect-photo-display");
            const preview = form.querySelector(".defect-photo-preview");
            const cameraBtn = form.querySelector(".open-camera-btn");

            const inputId = `defect_photo_input_${number}`;
            const displayId = `defect_photo_display_${number}`;
            const previewId = `defect_photo_preview_${number}`;

            if (photoInput) {
                photoInput.name = `defect_photo_${number}`;
                photoInput.id = inputId;
            }
            if (photoDisplay) photoDisplay.id = displayId;
            if (preview) preview.id = previewId;

            if (cameraBtn) {
                cameraBtn.setAttribute("data-defect-index", number);
                cameraBtn.onclick = function () {
                    openCamera(inputId, previewId);
                };
            }
        });
    }
});

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫ –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–∞–º

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    if (form) {
        form.addEventListener("submit", function () {
            stopInspectionTimer();
        });
    }
});
</script>
<script>
async function checkVinExists(vin) {
  try {
    const res = await fetch(`/assembly/api/search_vin/?q=${encodeURIComponent(vin)}`, { cache: 'no-store' });
    if (!res.ok) return false;
    const data = await res.json();
    return Array.isArray(data.results) && data.results.some(r => (r.vin || '').toUpperCase() === vin.toUpperCase());
  } catch (e) {
    console.error('VIN check error:', e);
    return false;
  }
}

async function beforeSubmit(e) {
  e.preventDefault(); // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Å–∞–±–º–∏—Ç
  stopInspectionTimer();

  const form = e.target;
  const vinInput = document.getElementById('vin_search');
  const vin = vinInput ? vinInput.value.trim() : '';

  // helper –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  const focusScroll = (el) => {
    if (!el) return;
    el.classList.add('is-invalid');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // —Ñ–æ–∫—É—Å –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
    setTimeout(() => el.focus({ preventScroll: true }), 250);
  };

  // 1) VIN –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
  if (!vin) {
    alert('–í–≤–µ–¥–∏—Ç–µ VIN.');
    focusScroll(vinInput);
    return false;
  }
  vinInput.classList.remove('is-invalid');

  // 2) VIN –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –±–∞–∑–µ
  const exists = await checkVinExists(vin);
  if (!exists) {
    alert('‚ùå –¢–∞–∫–æ–≥–æ VIN –Ω–µ—Ç –≤ –±–∞–∑–µ.');
    focusScroll(vinInput);
    return false;
  }

  // 3) –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä "–µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç?"
  const hasDefectRadio = document.querySelector('input[name="has_defect"]:checked');
  if (!hasDefectRadio) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ, –µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç.');
    document.querySelector('input[name="has_defect"]')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false;
  }

  // 4) –ï—Å–ª–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
  if (hasDefectRadio.value !== 'yes') {
    form.submit();
    return false;
  }

  // 5) –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞
  const defectForms = document.querySelectorAll("#defect_list .defect-form");
  if (defectForms.length === 0) {
    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ—Ñ–µ–∫—Ç.');
    document.getElementById('add_defect_btn')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false;
  }

  for (const f of defectForms) {
    const unit        = f.querySelector(".defect-unit");
    const name        = f.querySelector(".defect-name");
    const responsible = f.querySelector(".defect-responsible");
    const grade       = f.querySelector(".defect-grade");
    const repairType  = f.querySelector(".defect-repair-type");
    const photoInput  = f.querySelector(".defect-photo");

    let hasError = false;

    const requireField = (el) => {
      if (!el || !el.value) { el && el.classList.add("is-invalid"); return true; }
      el.classList.remove("is-invalid"); return false;
    };

    hasError = requireField(unit)        || hasError;
    hasError = requireField(name)        || hasError;
    hasError = requireField(responsible) || hasError;
    hasError = requireField(grade)       || hasError;
    hasError = requireField(repairType)  || hasError;

    if (!photoInput || !photoInput.files || photoInput.files.length === 0) {
      photoInput && photoInput.classList.add("is-invalid");
      hasError = true;
    } else {
      photoInput.classList.remove("is-invalid");
    }

    if (hasError) {
      f.scrollIntoView({ behavior: "smooth", block: "center" });
      alert("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–µ—Ñ–µ–∫—Ç–∞.");
      return false;
    }
  }

  // –≤—Å—ë –æ–∫ ‚Äî —Å–∞–±–º–∏—Ç–∏–º
  form.submit();
  return false;
}
</script>

<script>
const UNITS_BY_ZONE = {
    {% for zone in zones %}
        "{{ zone.name }}": [
            {% for unit in units %}
                {% if unit.zone and unit.zone.name == zone.name %}
                    { id: {{ unit.id }}, name: "{{ unit.name }}" },
                {% endif %}
            {% endfor %}
        ],
    {% endfor %}
};
</script>
{% endblock %}
