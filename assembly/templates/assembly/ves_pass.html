{% extends "users/base.html" %}
{% load static %}
{% block title %}VES ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞/–ø—Ä–∏—ë–º{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 760px">
  <h4 class="mb-3">–ü–æ—Å—Ç ‚Äî VES: –ø–µ—Ä–µ–¥–∞—á–∞ / –ø—Ä–∏—ë–º</h4>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} mb-2">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- –ü–æ–∏—Å–∫ VIN (GET) -->
  <form id="vin_get_form" method="get" action="" class="mb-3">
    <div class="mb-2 position-relative">
      <label class="form-label">VIN <span class="text-danger">*</span></label>
      <div style="position: relative;">
        <input
          type="text"
          id="vin_search"
          name="vin"
          class="form-control"
          placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ VIN‚Ä¶"
          maxlength="17"
          autocomplete="off"
          value="{{ vin|default:'' }}"
          autofocus
        >
        <button type="button"
                id="clear_vin_search"
                class="btn btn-link p-0"
                style="position:absolute; right:10px; top:50%; transform:translateY(-50%); text-decoration:none;"
                title="–û—á–∏—Å—Ç–∏—Ç—å">
          ‚úñ
        </button>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
      <div class="d-flex gap-2 mt-2">
        <button type="button" id="start_qr_scan" class="btn btn-primary">
          üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
        </button>
        <button type="submit" class="btn btn-outline-secondary">
          –ù–∞–π—Ç–∏ VIN
        </button>
      </div>
      <div id="qr-reader" style="width:300px; display:none;"></div>

      <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ VIN -->
      <ul id="vin_list" class="list-group mt-2" style="display:none; position:absolute; width:100%; z-index:1000;"></ul>
    </div>
  </form>

  <!-- –ë–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ VIN -->
  {% if trace %}
    <div id="vehicle_info" class="mb-3 p-3 border rounded">
      <h6 class="mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ VIN</h6>
      <div class="row">
        <div class="col-12"><strong>VIN:</strong> {{ trace.vin }}</div>
        <div class="col-12"><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> {{ trace.engine_number }}</div>
        <div class="col-12"><strong>–ú–æ–¥–µ–ª—å:</strong> {{ trace.model }}</div>
        <div class="col-12"><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> {{ trace.body_color }}</div>
        {% if trace.modification %}<div class="col-12"><strong>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:</strong> {{ trace.modification }}</div>{% endif %}
        {% if trace.config_code %}<div class="col-12"><strong>–ö–æ–¥ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏:</strong> {{ trace.config_code }}</div>{% endif %}
      </div>
    </div>
  {% endif %}

  <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
  {% if vin %}
    {% if show_receive_button and open_log %}
      <div class="alert alert-warning">
        VIN <strong>{{ vin }}</strong> –æ—Ç–¥–∞–Ω –Ω–∞ VES:
        <strong>{{ open_log.given_at|date:"Y-m-d H:i" }}</strong>
        {% if open_log.given_by %} ({{ open_log.given_by.username }}){% endif %}.
        –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏—ë–º–∞.
      </div>
      <form method="post" class="mb-3 d-inline">
        {% csrf_token %}
        <input type="hidden" name="vin" value="{{ vin }}">
        <input type="hidden" name="action" value="receive">
        <button class="btn btn-success w-100">–ü—Ä–∏–Ω—è—Ç—å —Å VES</button>
      </form>
    {% elif show_give_button %}
      <div class="alert alert-info">
        –ü–æ VIN <strong>{{ vin }}</strong> –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–µ—Ä–µ–¥–∞—á –Ω–∞ VES –Ω–µ—Ç.
      </div>
      <form method="post" class="mb-3 d-inline">
        {% csrf_token %}
        <input type="hidden" name="vin" value="{{ vin }}">
        <input type="hidden" name="action" value="give">
        <button class="btn btn-primary w-100">–û—Ç–¥–∞—Ç—å –Ω–∞ VES</button>
      </form>
    {% endif %}
  {% endif %}

  {% if last_log %}
    <div class="card mt-2">
      <div class="card-header">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è</div>
      <div class="card-body">
        <div><strong>–û—Ç–¥–∞–Ω:</strong> {{ last_log.given_at|date:"Y-m-d H:i" }} {% if last_log.given_by %}({{ last_log.given_by.username }}){% endif %}</div>
        <div><strong>–ü—Ä–∏–Ω—è—Ç:</strong>
          {% if last_log.received_at %}
            {{ last_log.received_at|date:"Y-m-d H:i" }} {% if last_log.received_by %}({{ last_log.received_by.username }}){% endif %}
          {% else %}
            ‚Äî
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// === QR-—Å–∫–∞–Ω–µ—Ä ===
document.addEventListener("DOMContentLoaded", function () {
  const qrReaderEl = document.getElementById("qr-reader");
  const startBtn = document.getElementById("start_qr_scan");
  const vinInput = document.getElementById("vin_search");
  const vinForm  = document.getElementById("vin_get_form");

  const qrScanner = new Html5Qrcode("qr-reader");
  let qrActive = false;

  function submitSearch(){
    if (vinForm) vinForm.submit();
  }

  function onScanSuccess(decodedText) {
    if (vinInput) vinInput.value = (decodedText || "").trim().toUpperCase();
    qrReaderEl.style.display = "none";
    qrScanner.stop().finally(() => {
      qrActive = false;
      startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
      submitSearch();
    });
  }

  startBtn.addEventListener("click", () => {
    if (!qrActive) {
      qrReaderEl.style.display = "block";
      startBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
      ).then(() => { qrActive = true; })
       .catch(err => { console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err); });
    } else {
      qrScanner.stop().finally(() => {
        qrReaderEl.style.display = "none";
        startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
        qrActive = false;
      });
    }
  });

  window.addEventListener("beforeunload", () => { if (qrActive) { try { qrScanner.stop(); } catch(_){} }});
});
</script>

<script>
// === –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∞ VIN + –≤—ã–≤–æ–¥ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞) ===
(function(){
  const vinInput  = document.getElementById("vin_search");
  const vinList   = document.getElementById("vin_list");
  const clearBtn  = document.getElementById("clear_vin_search");
  const vinForm   = document.getElementById("vin_get_form");

  if (!vinInput || !vinList) return;

  let debounceTimer = null;
  function debounce(fn, ms=200){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fn, ms);
  }

  function hideList(){
    vinList.style.display = "none";
    vinList.innerHTML = "";
  }

  vinInput.addEventListener("input", () => {
    const q = vinInput.value.trim();
    if (clearBtn) clearBtn.style.display = q ? "block" : "none";
    if (!q) { hideList(); return; }

    debounce(() => {
      fetch(`/supplies/api/search_vin/?q=${encodeURIComponent(q)}`)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          const items = Array.isArray(data?.results) ? data.results : [];
          vinList.innerHTML = "";
          if (!items.length) { hideList(); return; }

          items.forEach(item => {
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.innerHTML = `<div class="d-flex justify-content-between">
                <span>${item.vin || ""}</span>
                <small class="text-muted">${(item.model || "").trim()}</small>
              </div>`;
            li.addEventListener("click", () => {
              vinInput.value = (item.vin || "").trim().toUpperCase();
              hideList();
              if (vinForm) vinForm.submit();
            });
            vinList.appendChild(li);
          });
          vinList.style.display = "block";
        })
        .catch(err => { console.error("VIN search error:", err); hideList(); });
    }, 200);
  });

  if (clearBtn) {
    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      vinInput.value = "";
      hideList();
      clearBtn.style.display = "none";
      vinInput.focus();
    });
  }

  document.addEventListener("click", (e) => {
    if (!vinList.contains(e.target) && !vinInput.contains(e.target)) hideList();
  });
})();
</script>
{% endblock %}