{% extends "users/base.html" %}
{% block title %}–£—á–∞—Å—Ç–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ (DKD){% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–£—á–∞—Å—Ç–æ–∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ (DKD)</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- 1Ô∏è‚É£ VIN-–ø–æ–∏—Å–∫ -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä VIN</label>
            <div style="position: relative;">
                <input type="text" id="vin_search" name="vin_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ VIN...">
                <span id="clear_vin_search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #dc3545;">‚ùå</span>
            </div>
            <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
            <div id="qr-reader" style="width: 300px; display: none;"></div>
            <button type="button" id="stop_qr_scan" class="btn btn-danger mt-2" style="display: none;">‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <ul id="vin_list" class="list-group mt-2" style="display: none; position: absolute; width: 100%; z-index: 1000;"></ul>
        </div>

        <!-- 2Ô∏è‚É£ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –ë–î -->
        <div id="info_block" class="p-3 border rounded mb-3" style="display: none;">
            <h5>–î–∞–Ω–Ω—ã–µ –ø–æ VIN:</h5>
            <p><strong>VIN:</strong> <span id="trace_vin"></span></p>
            <p><strong>–ù–æ–º–µ—Ä –î–í–°:</strong> <span id="trace_engine"></span></p>
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="trace_model"></span></p>
            <p><strong>–¶–≤–µ—Ç:</strong> <span id="body_color_value"></span></p>

            <hr>
            <h5>–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç—ã:</h5>
            <div id="offline_defects_block"><p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p></div>

            <hr>
            <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ—Å—Ç–∞ –£–£–î:</h5>
            <div id="uud_previous_block"><p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p></div>
        </div>

        <!-- 3Ô∏è‚É£ –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞ -->
        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞</label>
            <textarea name="repair_description" class="form-control" maxlength="1000" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –±—ã–ª —É—Å—Ç—Ä–∞–Ω—ë–Ω –¥–µ—Ñ–µ–∫—Ç..." required></textarea>
        </div>

        <!-- 4Ô∏è‚É£ –§–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤</label>
            <input type="file" name="repair_photos" id="repair_photos" class="form-control" accept="image/*" multiple>
            <button type="button" class="btn btn-primary mt-2" id="open_repair_camera">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div id="repair_photo_preview" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="button" class="btn btn-success w-100" onclick="confirmSave()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<script>
    function confirmSave() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
            document.querySelector('form').submit();
        }
    }
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º QR –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        setupVinSearch(); // —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –Ω–∏–∂–µ
        setupQrScanner(); // —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –Ω–∏–∂–µ
    });

    document.getElementById("open_repair_camera").addEventListener("click", function () {
        openCamera("repair_photos", "repair_photo_preview"); // —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–∫ –≤ –æ–±—Ä–∞–∑—Ü–µ
    });





function setupVinSearch() {
    const vinInput = document.getElementById("vin_search");
    const vinList = document.getElementById("vin_list");
    const clearBtn = document.getElementById("clear_vin_search");

    vinInput.addEventListener("input", function () {
        const query = vinInput.value.trim().toUpperCase();
        if (!query) {
            vinList.style.display = "none";
            return;
        }

        fetch(`/assembly/api/vin-lookup/?q=${query}`)
            .then(res => res.json())
            .then(data => {
                vinList.innerHTML = "";
                if (!data.results || data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    const li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.addEventListener("click", function () {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        loadVinData(item);  // üëà –æ—Å–Ω–æ–≤–Ω–æ–π –≤—ã–∑–æ–≤
                    });
                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(err => {
                console.error("‚ùå –û—à–∏–±–∫–∞ VIN-–ø–æ–∏—Å–∫–∞:", err);
                vinList.style.display = "none";
            });
    });

    clearBtn.addEventListener("click", function () {
        vinInput.value = "";
        vinList.style.display = "none";
        document.getElementById("info_block").style.display = "none";
    });

    document.addEventListener("click", function (event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });
}

/* üì• –ó–∞–≥—Ä—É–∑–∫–∞ VIN-–¥–∞–Ω–Ω—ã—Ö –∏–∑ API */
function loadVinData(item) {
    const infoBlock = document.getElementById("info_block");
    const vinSpan = document.getElementById("trace_vin");
    const engineSpan = document.getElementById("trace_engine");
    const modelSpan = document.getElementById("trace_model");
    const colorSpan = document.getElementById("body_color_value");
    const offlineBlock = document.getElementById("offline_defects_block");
    const uudBlock = document.getElementById("uud_previous_block");

    infoBlock.style.display = "block";

    // üü© –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—Ä–µ–π—Å–∏–Ω–≥
    vinSpan.textContent = item.vin || "-";
    engineSpan.textContent = item.engine_number || "-";
    modelSpan.textContent = item.model || "-";
    colorSpan.textContent = item.body_color || "-";

    // üü® –û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç—ã
    offlineBlock.innerHTML = "<p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>";
    fetch(`/assembly/api/get-offline-defects/?vin=${item.vin}`)
        .then(res => res.json())
        .then(data => {
            offlineBlock.innerHTML = "";
            const defects = data.offline_defects;
            if (!defects || defects.length === 0) {
                offlineBlock.innerHTML = "<p><em>–ù–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç–æ–≤.</em></p>";
                return;
            }

            defects.forEach(defect => {
                const div = document.createElement("div");
                div.className = "border rounded p-2 mb-3";

                div.innerHTML = `
                    <p><strong>–î–∞—Ç–∞:</strong> ${defect.date}</p>
                    <p><strong>–ó–æ–Ω–∞:</strong> ${defect.zone}</p>
                    <p><strong>–ü–æ—Å—Ç:</strong> ${defect.post}</p>
                    <p><strong>–î–µ—Ç–∞–ª—å:</strong> ${defect.detail}</p>
                    <p><strong>–î–µ—Ñ–µ–∫—Ç:</strong> ${defect.defect}</p>
                    <p><strong>–ì—Ä–µ–π–¥:</strong> ${defect.grade}</p>
                    <p><strong>–ö–æ–ª-–≤–æ:</strong> ${defect.quantity}</p>
                    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${defect.responsible}</p>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞:</strong> ${defect.repair_type_description || "-"}</p>
                `;

                if (defect.photos && defect.photos.length > 0) {
                    const photoRow = document.createElement("div");
                    photoRow.className = "d-flex flex-wrap gap-2 mt-2";
                    defect.photos.forEach(url => {
                        const img = document.createElement("img");
                        img.src = url;
                        img.classList.add("img-thumbnail");
                        img.style.maxWidth = "120px";
                        img.style.objectFit = "cover";
                        img.style.borderRadius = "4px";
                        photoRow.appendChild(img);
                    });
                    div.appendChild(photoRow);
                }

                offlineBlock.appendChild(div);
            });
        })
        .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç–æ–≤:", err);
            offlineBlock.innerHTML = "<p><em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</em></p>";
        });

    // üü• –î–∞–Ω–Ω—ã–µ —Å –£–£–î
    uudBlock.innerHTML = "<p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>";
    fetch(`/assembly/api/uud-zone-data/?vin=${item.vin}`)
        .then(res => res.json())
        .then(data => {
            const uud = data.uud_data;
            if (!uud) {
                uudBlock.innerHTML = "<p><em>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å –£–£–î.</em></p>";
                return;
            }

            uudBlock.innerHTML = `
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${uud.repair_description || "-"}</p>
                <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${uud.controller || "-"}</p>
                <p><strong>–î–∞—Ç–∞:</strong> ${uud.date_added || "-"}</p>
            `;

            if (uud.repair_photos && uud.repair_photos.length > 0) {
                const photoRow = document.createElement("div");
                photoRow.className = "d-flex flex-wrap gap-2 mt-2";
                uud.repair_photos.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.classList.add("img-thumbnail");
                    img.style.maxWidth = "120px";
                    img.style.objectFit = "cover";
                    img.style.borderRadius = "4px";
                    photoRow.appendChild(img);
                });
                uudBlock.appendChild(photoRow);
            }

            if (uud.check_status === "not_passed") {
                uudBlock.innerHTML += `
                    <div class="border rounded mt-3 p-2 bg-light">
                        <h6 class="text-danger">‚ùå –ú–∞—à–∏–Ω–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h6>
                        <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${uud.check_comment || "-"}</p>
                        <p><strong>–ü—Ä–æ–≤–µ—Ä–∏–ª:</strong> ${uud.checked_by || "-"}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${uud.checked_at || "-"}</p>
                    </div>
                `;

                if (uud.check_photos && uud.check_photos.length > 0) {
                    const checkRow = document.createElement("div");
                    checkRow.className = "d-flex flex-wrap gap-2 mt-2";
                    uud.check_photos.forEach(url => {
                        const img = document.createElement("img");
                        img.src = url;
                        img.classList.add("img-thumbnail");
                        img.style.maxWidth = "100px";
                        checkRow.appendChild(img);
                    });
                    uudBlock.appendChild(checkRow);
                }
            }

        })
        .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –£–£–î:", err);
            uudBlock.innerHTML = "<p><em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</em></p>";
        });
}


document.addEventListener("DOMContentLoaded", function () {
    const photoInput = document.getElementById("repair_photos");
    const previewContainer = document.getElementById("repair_photo_preview");

    photoInput.addEventListener("change", function () {
        previewContainer.innerHTML = "";

        const files = Array.from(photoInput.files);
        const dataTransfer = new DataTransfer();

        files.forEach((file, index) => {
            const container = document.createElement("div");
            container.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail");
            img.style.maxWidth = "200px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "5px";

            const delBtn = document.createElement("button");
            delBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
            delBtn.addEventListener("click", () => {
                container.remove();
                const newDT = new DataTransfer();
                for (let i = 0; i < photoInput.files.length; i++) {
                    if (photoInput.files[i].name !== file.name) {
                        newDT.items.add(photoInput.files[i]);
                    }
                }
                photoInput.files = newDT.files;
            });

            container.appendChild(img);
            container.appendChild(delBtn);
            previewContainer.appendChild(container);

            dataTransfer.items.add(file);
        });

        photoInput.files = dataTransfer.files;
    });

    document.getElementById("open_repair_camera").addEventListener("click", function () {
        openCamera("repair_photos", "repair_photo_preview");
    });
});

/* üì∑ –ö–∞–º–µ—Ä–∞ */
function openCamera(inputId, previewId) {
    // ‚õî –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –Ω–µ —Å–æ–∑–¥–∞–µ–º –µ—â—ë –æ–¥–Ω—É
    if (document.getElementById("camera_modal")) {
        console.warn("üì∑ –ö–∞–º–µ—Ä–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞.");
        return;
    }

    const modal = document.createElement("div");
    modal.id = "camera_modal";
    modal.style = `
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        z-index: 9999;
    `;
    modal.innerHTML = `
        <video id="camera_feed" autoplay playsinline style="width: 90%; max-width: 400px;"></video>
        <button id="capture_button" class="btn btn-success mt-2">üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    `;
    document.body.appendChild(modal);

    const video = modal.querySelector("#camera_feed");
    const captureBtn = modal.querySelector("#capture_button");
    const closeBtn = modal.querySelector("#close_camera");
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    let activeStream = null;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            activeStream = stream;
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
            closeCamera();
        });

    captureBtn.addEventListener("click", () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

            const dataTransfer = new DataTransfer();
            for (let existing of input.files) {
                dataTransfer.items.add(existing);
            }
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;

            const container = document.createElement("div");
            container.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail");
            img.style.maxWidth = "200px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "5px";

            const delBtn = document.createElement("button");
            delBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
            delBtn.addEventListener("click", () => {
                container.remove();
                const newDT = new DataTransfer();
                for (let f of input.files) {
                    if (f.name !== file.name) newDT.items.add(f);
                }
                input.files = newDT.files;
            });

            container.appendChild(img);
            container.appendChild(delBtn);
            preview.appendChild(container);

            closeCamera();
        }, "image/jpeg");
    });

    function closeCamera() {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
        }
        if (modal) modal.remove();
    }

    closeBtn.addEventListener("click", closeCamera);
    modal.addEventListener("click", e => {
        if (e.target === modal) closeCamera();
    });
}

</script>

{% endblock %}
