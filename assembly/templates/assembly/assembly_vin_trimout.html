{% extends "users/base.html" %}
{% load static %}
{% block title %}–°–∫–∞–Ω VIN ‚Äî TRIM OUT ‚Äî {% if line == "gwm" %}GWM{% elif line == "chery" %}Chery{% elif line == "changan" %}Changan{% elif line == "frame" %}Frame{% else %}–°—á—ë—Ç—á–∏–∫{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width:720px">
    <h2>
        –ü–æ—Å—Ç ‚Äî TRIM OUT: —Å–∫–∞–Ω VIN –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        {% if line and line != "1" %}
            <span class="text-muted" style="font-size: 0.9em;">[{{ line|title }}]</span>
        {% endif %}
    </h2>

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" action="">
      {% csrf_token %}

      <!-- VIN -->
      <div class="mb-3 position-relative">
        <label class="form-label">VIN <span class="text-danger">*</span></label>
        <div style="position: relative;">
          <input
            type="text"
            id="vin_search"
            name="vin"
            class="form-control"
            placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ VIN‚Ä¶"
            maxlength="17"
            autocomplete="off"
            autofocus
          >
          <span
            id="clear_vin_search"
            style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:18px; color:#dc3545"
            title="–û—á–∏—Å—Ç–∏—Ç—å"
          >‚ùå</span>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
        <div id="qr-reader" style="width:300px; display:none;"></div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ VIN -->
        <ul id="vin_list" class="list-group mt-2" style="display:none; position:absolute; width:100%; z-index:1000;"></ul>
      </div>

      <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ -->
      <div id="vehicle_info" class="mb-3 p-3 border rounded" style="display: none;">
          <h6 class="mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ VIN</h6>
          <p class="mb-1"><strong>VIN:</strong> <span id="vin_value"></span></p>
          <p class="mb-1"><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value"></span></p>
          <p class="mb-1"><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
          <p class="mb-0"><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
      <button type="submit" class="btn btn-success w-100">
          ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å TRIM OUT
          {% if line %}<small class="ms-1">(–õ–∏–Ω–∏—è: {% if line == "gwm" %}GWM{% elif line == "chery" %}Chery{% elif line == "changan" %}Changan{% elif line == "frame" %}Frame{% else %}–Ω–µ –∑–∞–¥–∞–Ω–æ{% endif %})</small>{% endif %}
      </button>
    </form>
</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// === QR-—Å–∫–∞–Ω–µ—Ä ===
document.addEventListener("DOMContentLoaded", function () {
  const qrReaderEl = document.getElementById("qr-reader");
  const startBtn = document.getElementById("start_qr_scan");
  const vinInput = document.getElementById("vin_search");

  const qrScanner = new Html5Qrcode("qr-reader");
  let qrActive = false;

  function onScanSuccess(decodedText) {
    if (vinInput) vinInput.value = (decodedText || "").trim().toUpperCase();
    qrReaderEl.style.display = "none";

    qrScanner.stop().finally(() => {
      qrActive = false;
      startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
    });

    try { triggerVinSearch && triggerVinSearch(vinInput.value); } catch (_) {}
  }

  startBtn.addEventListener("click", () => {
    if (!qrActive) {
      qrReaderEl.style.display = "block";
      startBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
      ).then(() => { qrActive = true; })
       .catch(err => { console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err); });
    } else {
      qrScanner.stop().finally(() => {
        qrReaderEl.style.display = "none";
        startBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
        qrActive = false;
      });
    }
  });

  window.addEventListener("beforeunload", () => { if (qrActive) { try { qrScanner.stop(); } catch(_){} }});
});
</script>

<script>
// === –ê–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∞ VIN + –≤—ã–≤–æ–¥ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ ===
(function(){
  const vinInput  = document.getElementById("vin_search");
  const vinList   = document.getElementById("vin_list");
  const clearBtn  = document.getElementById("clear_vin_search");
  const infoBox   = document.getElementById("vehicle_info");

  if (!vinInput || !vinList) return;

  let debounceTimer = null;
  function debounce(fn, ms=200){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fn, ms);
  }

  vinInput.addEventListener("input", () => {
    const q = vinInput.value.trim();
    if (clearBtn) clearBtn.style.display = q ? "block" : "none";
    if (!q) { hideList(); if (infoBox) infoBox.style.display = "none"; return; }

    debounce(() => {
      fetch(`/supplies/api/search_vin/?q=${encodeURIComponent(q)}`)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          const items = Array.isArray(data?.results) ? data.results : [];

          // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø—Ä–∏ –ø–æ–ª–Ω–æ–º VIN (17 —Å–∏–º–≤–æ–ª–æ–≤)
          const qUpper = (vinInput.value || "").trim().toUpperCase();
          if (qUpper.length === 17) {
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            const exact = items.find(it => (it?.vin || "").toUpperCase() === qUpper);
            if (exact) {
              showInfo(qUpper, exact);
              hideList();
              return;
            }
            // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –Ω–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
            if (items.length === 1) {
              const only = items[0];
              const onlyVin = (only?.vin || "").trim().toUpperCase();
              vinInput.value = onlyVin || qUpper;
              showInfo(vinInput.value, only);
              hideList();
              return;
            }
          }

          renderList(items);
        })
        .catch(err => { console.error("VIN search error:", err); hideList(); });
    }, 200);
  });

  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      vinInput.value = "";
      hideList();
      if (infoBox) infoBox.style.display = "none";
      clearBtn.style.display = "none";
      vinInput.focus();
    });
  }

  document.addEventListener("click", (e) => {
    if (!vinList.contains(e.target) && !vinInput.contains(e.target)) hideList();
  });

  function renderList(items){
    vinList.innerHTML = "";
    if (!items.length) return hideList();

    items.forEach(item => {
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.innerHTML = `<div class="d-flex justify-content-between">
          <span>${item.vin || ""}</span>
          <small class="text-muted">${(item.model || "").trim()}</small>
        </div>`;
      li.addEventListener("click", () => {
        const vin = (item.vin || "").trim().toUpperCase();
        vinInput.value = vin;
        showInfo(vin, item);
        hideList();
      });
      vinList.appendChild(li);
    });
    vinList.style.display = "block";
  }

  function hideList(){ vinList.style.display = "none"; vinList.innerHTML = ""; }

  function showInfo(vin, item){
    const vinValue   = document.getElementById("vin_value");
    const engValue   = document.getElementById("engine_number_value");
    const modelValue = document.getElementById("model_value");
    const colorValue = document.getElementById("body_color_value");

    if (vinValue)   vinValue.textContent   = vin || "";
    if (engValue)   engValue.textContent   = item?.engine_number || "";
    if (modelValue) modelValue.textContent = item?.model || "";
    if (colorValue) colorValue.textContent = item?.body_color || "";
    if (infoBox)    infoBox.style.display  = "block";

    try { triggerVinSearch && triggerVinSearch(vin); } catch(_) {}
  }
})();
</script>
{% endblock %}