{% extends "users/base.html" %}
{% block title %}–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ (DKD){% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ (DKD)</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- üìå –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä VIN</label>

            <!-- –û–±–µ—Ä—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è input –∏ ‚ùå -->
            <div style="position: relative;">
                <input type="text" id="vin_search" name="vin_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ VIN...">
                <span id="clear_vin_search" style="
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    font-size: 18px;
                    color: #dc3545;
                    z-index: 10;">‚ùå</span>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –≤–Ω–µ input'–∞ -->
            <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
            <div id="qr-reader" style="width: 300px; display: none;"></div>
            <button type="button" id="stop_qr_scan" class="btn btn-danger mt-2" style="display: none;">‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>

            <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
            <ul id="vin_list" class="list-group mt-2" style="display: none; position: absolute; width: 100%; z-index: 1000;"></ul>
        </div>

        <!-- 2Ô∏è‚É£ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –£—á–∞—Å—Ç–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ + offline –¥–µ—Ñ–µ–∫—Ç—ã -->
        <div id="uud_data_block" class="p-3 border rounded mb-3" style="display: none;">
            <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –£—á–∞—Å—Ç–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤:</h5>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞:</strong> <span id="repair_description"></span></p>
            <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> <span id="controller"></span></p>
            <p><strong>–î–∞—Ç–∞:</strong> <span id="date_added"></span></p>
            <div id="repair_photos_block" class="d-flex flex-wrap gap-2 mt-2 mb-3"></div>

            <hr>
            <h5>–ò—Å—Ç–æ—Ä–∏—è –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç–æ–≤:</h5>
            <div id="offline_defects_block">
                <p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>
            </div>
        </div>

        <!-- 3Ô∏è‚É£ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div class="mb-3">
            <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:</label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="check_status" id="check_passed" value="passed" required>
                <label class="form-check-label" for="check_passed">‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ—à—ë–ª</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="check_status" id="check_not_passed" value="not_passed" required>
                <label class="form-check-label" for="check_not_passed">‚ùå –ù–µ –ø—Ä–æ—à—ë–ª</label>
            </div>
        </div>

        <!-- 4Ô∏è‚É£ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—à—ë–ª) -->
        <div class="mb-3" id="comment_block" style="display: none;">
            <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea name="comment" class="form-control" maxlength="1000" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ..."></textarea>
        </div>

        <div class="mb-3" id="check_photos_block" style="display: none;">
            <label class="form-label">–§–æ—Ç–æ –Ω–µ–¥–æ—Ä–∞–±–æ—Ç–æ–∫</label>

            <input type="file" name="check_photos" id="check_photos" class="form-control" accept="image/*" multiple>

            <!-- üì∏ –ö–Ω–æ–ø–∫–∞ —Å—ä—ë–º–∫–∏ ‚Äî —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –æ–±—Ä–∞–∑—Ü–µ -->
            <button type="button" class="btn btn-primary mt-2" id="open_check_camera">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>

            <div id="check_photo_preview" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="button" class="btn btn-success w-100" onclick="confirmSave()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<script>
    function confirmSave() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
            document.querySelector('form').submit();
        }
    }
</script>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    setupVinSearch();
    setupQrScanner();
});

/* --------------------- */
/* üîç –ü–æ–∏—Å–∫ VIN –ø–æ API   */
/* --------------------- */
function setupVinSearch() {
    const vinInput = document.getElementById("vin_search");
    const vinList = document.getElementById("vin_list");
    const clearBtn = document.getElementById("clear_vin_search");

    vinInput.addEventListener("input", function () {
        const query = vinInput.value.trim().toUpperCase();
        if (!query) {
            vinList.style.display = "none";
            return;
        }

        fetch(`/assembly/api/vin-lookup/?q=${query}`)
            .then(res => res.json())
            .then(data => {
                vinList.innerHTML = "";
                if (!data.results || data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    const li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.addEventListener("click", function () {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        loadUUDData(item.vin);
                    });
                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(err => {
                console.error("‚ùå –û—à–∏–±–∫–∞ VIN-–ø–æ–∏—Å–∫–∞:", err);
                vinList.style.display = "none";
            });
    });

    clearBtn.addEventListener("click", function () {
        vinInput.value = "";
        vinList.style.display = "none";

        // üßπ –û—á–∏—â–∞–µ–º –±–ª–æ–∫ –£–£–î
        document.getElementById("uud_data_block").style.display = "none";
        document.getElementById("repair_description").textContent = "";
        document.getElementById("controller").textContent = "";
        document.getElementById("date_added").textContent = "";
        document.getElementById("repair_photos_block").innerHTML = "";
        document.getElementById("offline_defects_block").innerHTML = "";
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener("click", function (event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });
}

/* -------------------------- */
/* üì∑ QR —Å–∫–∞–Ω–µ—Ä VIN-–∫–æ–¥–∞      */
/* -------------------------- */
function setupQrScanner() {
    const qrReader = document.getElementById("qr-reader");
    const startBtn = document.getElementById("start_qr_scan");
    const stopBtn = document.getElementById("stop_qr_scan");

    const scanner = new Html5Qrcode("qr-reader");

    function onScanSuccess(decodedText) {
        document.getElementById("vin_search").value = decodedText;
        qrReader.style.display = "none";
        startBtn.style.display = "inline-block";
        stopBtn.style.display = "none";

        scanner.stop().catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ QR:", err));
        loadUUDData(decodedText);
    }

    startBtn.addEventListener("click", function () {
        qrReader.style.display = "block";
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";

        scanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        ).catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ QR:", err);
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
        });
    });

    stopBtn.addEventListener("click", function () {
        scanner.stop()
            .then(() => {
                qrReader.style.display = "none";
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
            })
            .catch(err => console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err));
    });
}

/* ----------------------------- */
/* üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –£–£–î –ø–æ VIN */
/* ----------------------------- */
function loadUUDData(vin) {
    // –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ ‚Äî –¥–∞–ª—å—à–µ –¥–æ–±–∞–≤–∏–º —Å—é–¥–∞ –∑–∞–≥—Ä—É–∑–∫—É –±–ª–æ–∫–∞ –£–£–î –∏ –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–µ—Ñ–µ–∫—Ç–æ–≤
    console.log("üì• VIN –≤—ã–±—Ä–∞–Ω:", vin);
}



function loadUUDData(vin) {
    const uudBlock = document.getElementById("uud_data_block");
    const descSpan = document.getElementById("repair_description");
    const controllerSpan = document.getElementById("controller");
    const dateSpan = document.getElementById("date_added");
    const photosContainer = document.getElementById("repair_photos_block");
    const offlineDefectsBlock = document.getElementById("offline_defects_block");

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –±–ª–æ–∫ –∏ –æ—á–∏—â–∞–µ–º
    uudBlock.style.display = "block";
    descSpan.textContent = controllerSpan.textContent = dateSpan.textContent = "";
    photosContainer.innerHTML = "";
    offlineDefectsBlock.innerHTML = "<p><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></p>";

    fetch(`/assembly/api/uud-zone-data/?vin=${vin}`)
        .then(response => response.json())
        .then(data => {
            const uud = data.uud_data;

            if (!uud) {
                uudBlock.innerHTML = "<p><em>–î–∞–Ω–Ω—ã—Ö —Å –£–£–î –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</em></p>";
                return;
            }

            descSpan.textContent = uud.repair_description || "-";
            controllerSpan.textContent = uud.controller || "-";
            dateSpan.textContent = uud.date_added || "-";

            // –§–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
            if (uud.repair_photos && uud.repair_photos.length > 0) {
                uud.repair_photos.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.classList.add("img-thumbnail", "me-2", "mb-2");
                    img.style.maxWidth = "150px";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";
                    photosContainer.appendChild(img);
                });
            } else {
                photosContainer.innerHTML = "<p><em>–ù–µ—Ç —Ñ–æ—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è.</em></p>";
            }

            // üëÅ –î–æ–±–∞–≤–∏–º –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (uud.check_status === "not_passed") {
                const checkInfo = document.createElement("div");
                checkInfo.classList.add("mt-3", "border", "rounded", "p-3", "bg-light");

                checkInfo.innerHTML = `
                    <h6 class="text-danger">‚ùå –ú–∞—à–∏–Ω–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</h6>
                    <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${uud.check_comment || "-"}</p>
                    <p><strong>–ü—Ä–æ–≤–µ—Ä–∏–ª:</strong> ${uud.checked_by || "-"}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${uud.checked_at || "-"}</p>
                `;

                if (uud.check_photos && uud.check_photos.length > 0) {
                    const photoRow = document.createElement("div");
                    photoRow.className = "d-flex flex-wrap gap-2 mt-2";
                    uud.check_photos.forEach(url => {
                        const img = document.createElement("img");
                        img.src = url;
                        img.classList.add("img-thumbnail");
                        img.style.maxWidth = "120px";
                        img.style.objectFit = "cover";
                        img.style.borderRadius = "4px";
                        photoRow.appendChild(img);
                    });
                    checkInfo.appendChild(photoRow);
                }

                photosContainer.appendChild(checkInfo);
            }

        })
        .catch(error => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –£–£–î:", error);
            uudBlock.innerHTML = "<p><em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</em></p>";
        });

    // üõ† –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–µ—Ñ–µ–∫—Ç—ã
    fetch(`/assembly/api/get-offline-defects/?vin=${vin}`)
        .then(response => response.json())
        .then(data => {
            offlineDefectsBlock.innerHTML = "";
            const defects = data.offline_defects;

            if (!defects || defects.length === 0) {
                offlineDefectsBlock.innerHTML = "<p><em>–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–º–æ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</em></p>";
                return;
            }

            defects.forEach(defect => {
                const div = document.createElement("div");
                div.className = "border rounded p-2 mb-3";

                div.innerHTML = `
                    <p><strong>–î–∞—Ç–∞:</strong> ${defect.date}</p>
                    <p><strong>–ó–æ–Ω–∞:</strong> ${defect.zone}</p>
                    <p><strong>–ü–æ—Å—Ç:</strong> ${defect.post}</p>
                    <p><strong>–î–µ—Ç–∞–ª—å:</strong> ${defect.detail}</p>
                    <p><strong>–î–µ—Ñ–µ–∫—Ç:</strong> ${defect.defect}</p>
                    <p><strong>–ì—Ä–µ–π–¥:</strong> ${defect.grade}</p>
                    <p><strong>–ö–æ–ª-–≤–æ:</strong> ${defect.quantity}</p>
                    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${defect.responsible}</p>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞:</strong> ${defect.repair_type_description || "-"}</p>
                `;

                if (defect.photos && defect.photos.length > 0) {
                    const photoRow = document.createElement("div");
                    photoRow.className = "d-flex flex-wrap gap-2 mt-2";
                    defect.photos.forEach(url => {
                        const img = document.createElement("img");
                        img.src = url;
                        img.classList.add("img-thumbnail");
                        img.style.maxWidth = "120px";
                        img.style.objectFit = "cover";
                        img.style.borderRadius = "4px";
                        photoRow.appendChild(img);
                    });
                    div.appendChild(photoRow);
                }

                offlineDefectsBlock.appendChild(div);
            });
        })
        .catch(error => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–µ—Ñ–µ–∫—Ç–æ–≤:", error);
            offlineDefectsBlock.innerHTML = "<p><em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤.</em></p>";
        });
}



document.addEventListener("DOMContentLoaded", function () {
    const passedRadio = document.getElementById("check_passed");
    const notPassedRadio = document.getElementById("check_not_passed");
    const commentBlock = document.getElementById("comment_block");
    const photoBlock = document.getElementById("check_photos_block");

    function updateVisibility() {
        if (notPassedRadio.checked) {
            commentBlock.style.display = "block";
            photoBlock.style.display = "block";
        } else {
            commentBlock.style.display = "none";
            photoBlock.style.display = "none";
        }
    }

    passedRadio.addEventListener("change", updateVisibility);
    notPassedRadio.addEventListener("change", updateVisibility);

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –ø—É—Å—Ç–∞)
    updateVisibility();
});





document.addEventListener("DOMContentLoaded", function () {
    const checkPhotoInput = document.getElementById("check_photos");
    const previewContainer = document.getElementById("check_photo_preview");

    checkPhotoInput.addEventListener("change", function () {
        previewContainer.innerHTML = "";

        const files = Array.from(checkPhotoInput.files);
        if (files.length === 0) return;

        const dataTransfer = new DataTransfer(); // –î–ª—è —Å–±–æ—Ä–∞ "–æ—Å—Ç–∞–≤—à–∏—Ö—Å—è" —Ñ–∞–π–ª–æ–≤

        files.forEach((file, index) => {
            const imgContainer = document.createElement("div");
            imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail");
            img.style.maxWidth = "200px";
            img.style.height = "auto";
            img.style.borderRadius = "5px";
            img.style.objectFit = "cover";

            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";

            deleteBtn.addEventListener("click", function () {
                imgContainer.remove();
                files.splice(index, 1);

                // –û–±–Ω–æ–≤–∏–º input –±–µ–∑ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
                const newDataTransfer = new DataTransfer();
                files.forEach(f => newDataTransfer.items.add(f));
                checkPhotoInput.files = newDataTransfer.files;
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(deleteBtn);
            previewContainer.appendChild(imgContainer);

            dataTransfer.items.add(file); // —Å–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
        });

        checkPhotoInput.files = dataTransfer.files;
    });
});




document.getElementById("open_check_camera").addEventListener("click", function () {
    openCamera("check_photos", "check_photo_preview");
});



function openCamera(inputId, previewId) {
    let modal = document.createElement("div");
    modal.id = "camera_modal";
    modal.style.position = "fixed";
    modal.style.top = 0;
    modal.style.left = 0;
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.background = "rgba(0,0,0,0.8)";
    modal.style.display = "flex";
    modal.style.flexDirection = "column";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
        <video id="camera_feed" autoplay playsinline style="width: 90%; max-width: 400px;"></video>
        <button id="capture_button" class="btn btn-success mt-2">üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    `;
    document.body.appendChild(modal);

    let video = modal.querySelector("#camera_feed");
    let captureButton = modal.querySelector("#capture_button");
    let closeButton = modal.querySelector("#close_camera");
    let input = document.getElementById(inputId);
    let preview = document.getElementById(previewId);
    let activeStream = null;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            activeStream = stream;
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
        });

    captureButton.addEventListener("click", () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

            const dataTransfer = new DataTransfer();
            if (input.multiple) {
                for (let existingFile of input.files) {
                    dataTransfer.items.add(existingFile);
                }
            }
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;

            // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            const container = document.createElement("div");
            container.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail");
            img.style.maxWidth = "200px";
            img.style.borderRadius = "5px";
            img.style.objectFit = "cover";

            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-danger btn-sm mt-2";
            delBtn.innerText = "–£–¥–∞–ª–∏—Ç—å";
            delBtn.addEventListener("click", () => {
                container.remove();
                const newDT = new DataTransfer();
                for (let i = 0; i < input.files.length; i++) {
                    if (input.files[i].name !== file.name) {
                        newDT.items.add(input.files[i]);
                    }
                }
                input.files = newDT.files;
            });

            container.appendChild(img);
            container.appendChild(delBtn);
            preview.appendChild(container);

            closeCamera();
        }, "image/jpeg");
    });

    function closeCamera() {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
        }
        modal.remove();
    }

    closeButton.addEventListener("click", closeCamera);
    modal.addEventListener("click", (e) => {
        if (e.target === modal) closeCamera();
    });
}



</script>

{% endblock %}
