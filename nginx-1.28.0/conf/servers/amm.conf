# =========================
# AMM: PROD (Windows, HTTPS)
# qd-ammk.com
# =========================

# --- HTTP: редирект на HTTPS ---
server {
    listen      80;
    server_name qd-ammk.com www.qd-ammk.com;
    return 301 https://$host$request_uri;
}

# --- HTTPS: основной сервер ---
server {
    listen      443 ssl;
    server_name qd-ammk.com www.qd-ammk.com;

    client_max_body_size 500m;

    # ----- SSL (замени пути на свои) -----
    ssl_certificate      C:/Users/lidacain/PycharmProjects/amm_server/factory_server/deploy/certs/fullchain.pem;
    ssl_certificate_key  C:/Users/lidacain/PycharmProjects/amm_server/factory_server/deploy/certs/privkey.pem;
    ssl_protocols        TLSv1.2 TLSv1.3;
    ssl_ciphers          HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # ----- FACTORY: STATIC/MEDIA -----
    location /static/ {
        alias C:/Users/lidacain/PycharmProjects/amm_server/factory_server/staticfiles/;
        access_log off;  expires 7d;
    }
    location /media/ {
        alias C:/Users/lidacain/PycharmProjects/amm_server/factory_server/media/;
        access_log off;  expires 7d;
    }

    # ----- FACTORY: backend at "/" -----
    # Запуск: uvicorn factory_server.asgi:application --host 127.0.0.1 --port 8001 --workers 4
    location / {
        proxy_pass         http://127.0.0.1:8001;
        proxy_http_version 1.1;

        proxy_set_header   Host               $host;
        proxy_set_header   X-Real-IP          $remote_addr;
        proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto  $scheme;

        proxy_set_header   Upgrade            $http_upgrade;
        proxy_set_header   Connection         $connection_upgrade;

        proxy_connect_timeout 180s;
        proxy_read_timeout    180s;
        proxy_send_timeout    180s;
    }

    # ----- AUDIT: backend под "/audit" -----
    # Запуск (Windows): waitress-serve --listen=127.0.0.1:8002 audit_dashboard.wsgi:application
    # (или gunicorn, если используешь через WSL/compat)
    location /audit/ {
        proxy_pass         http://127.0.0.1:8002/;   # ← завершающий / обязателен
        proxy_http_version 1.1;

        proxy_set_header   Host               $host;
        proxy_set_header   X-Real-IP          $remote_addr;
        proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto  $scheme;

        # говорим Django, что живём под /audit (совместимо с DJANGO_URL_PREFIX=/audit)
        proxy_set_header   X-Script-Name      /audit;
        proxy_set_header   X-Forwarded-Prefix /audit;

        proxy_set_header   Upgrade            $http_upgrade;
        proxy_set_header   Connection         $connection_upgrade;

        proxy_connect_timeout 180s;
        proxy_read_timeout    180s;
        proxy_send_timeout    180s;
    }

    # ----- AUDIT: STATIC/MEDIA -----
    # с твоими настройками (URL_PREFIX=/audit) статика/медиа = /audit/static/ и /audit/media/
    location /audit/static/ {
        alias C:/Users/lidacain/PycharmProjects/amm_server/audit_dashboard/staticfiles/;  # STATIC_ROOT аудита
        access_log off;  expires 7d;
    }
    location /audit/media/ {
        alias C:/Users/lidacain/PycharmProjects/amm_server/audit_dashboard/media/;        # MEDIA_ROOT аудита
        access_log off;  expires 7d;
    }

    # страница ошибок
    error_page 500 502 503 504 /50x.html;
    location = /50x.html { root html; }
}
