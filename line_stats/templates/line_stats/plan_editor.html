{% extends "users/base.html" %}
{% load static %}
{% block title %}Редактор планов{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Редактор планов (админ‑таблица)</h2>
    <a class="btn btn-outline-secondary" href="{% url 'line_stats:offtake' %}">← К таблице оффтейка</a>
  </div>

  {# Сообщения #}
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        {% with message.tags as t %}
          {% if t == 'error' %}
            {% with 'danger' as bs %}
              <div class="alert alert-{{ bs }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endwith %}
          {% else %}
            {% with t as bs %}
              <div class="alert alert-{{ bs }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endwith %}
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" id="bulk-plan-form">
    {% csrf_token %}

    <div class="card shadow-sm mb-3">
      <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <label class="me-2 mb-0 fw-semibold">Действует с:</label>
        <input type="date" name="effective_from" class="form-control" style="max-width:220px" value="{{ effective_from|date:'Y-m-d' }}">
        <div class="ms-auto d-flex gap-2">
          <button type="submit" class="btn btn-primary">Сохранить</button>
          <button type="reset" class="btn btn-outline-secondary">Сбросить</button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="min-width:120px">Линия</th>
              <th style="min-width:140px">Смена</th>
              <th style="min-width:140px">Слот</th>
              <th class="text-end" style="width:140px">План</th>
              <th style="min-width:160px">Автор</th>
              <th style="min-width:170px">Создано</th>
            </tr>
          </thead>
          <tbody>
          {% for row in rows %}
            <tr>
              <td>
                {% if row.line_key == 'gwm' %}
                  <span class="badge" style="background:rgba(255,215,211,.45);color:#7a3b36;">{{ row.line }}</span>
                {% elif row.line_key == 'frame' %}
                  <span class="badge" style="background:rgba(248,249,250,.8);color:#495057;">{{ row.line }}</span>
                {% elif row.line_key == 'chery' %}
                  <span class="badge" style="background:rgba(216,232,255,.55);color:#2c4f88;">{{ row.line }}</span>
                {% elif row.line_key == 'changan' %}
                  <span class="badge" style="background:rgba(231,233,238,.8);color:#50565e;">{{ row.line }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ row.line }}</span>
                {% endif %}
              </td>
              <td>{{ row.shift }}</td>
              <td>{{ row.slot }}</td>
              <td class="text-end">
                <input type="number" min="0" step="1" name="{{ row.name }}" value="{{ row.value }}" class="form-control form-control-sm text-end" style="max-width:120px; margin-left:auto;">
              </td>
              <td class="text-muted small">{{ row.created_by|default:"" }}</td>
              <td class="text-muted small">{% if row.created_at %}{{ row.created_at|date:"d.m.Y H:i" }}{% endif %}</td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted">Нет строк для редактирования.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button type="submit" class="btn btn-primary">Сохранить</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Небольшой UX: цифровая клавиатура на мобилках
  document.querySelectorAll('#bulk-plan-form input[type="number"]').forEach(el=>{el.inputMode='numeric'});
</script>
{% endblock %}