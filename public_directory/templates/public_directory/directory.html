{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}QD AMMK{% endblock %}</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="{% static 'vendor/bootstrap/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}">

  <!-- jQuery -->
  <script src="{% static 'vendor/jquery/jquery-3.6.0.min.js' %}"></script>

  <!-- Select2 -->
  <link rel="stylesheet" href="{% static 'vendor/select2/select2.min.css' %}">
  <script src="{% static 'vendor/select2/select2.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'vendor/select2/select2-bootstrap-5-theme.min.css' %}">

  <!-- QR Scanner -->
  <script src="{% static 'vendor/qr-scanner/qr-scanner.min.js' %}"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon/favicon_qd_fullsize.png' %}">
  <link rel="shortcut icon" href="{% static 'favicon/favicon_qd_fullsize.ico' %}">

  <link rel="stylesheet" href="{% static 'css/modal.css' %}">
  <script src="{% static 'js/table-enhancements.js' %}"></script>

  <link rel="stylesheet" href="{% static 'vendor/datatables/jquery.dataTables.min.css' %}">
  <script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'js/table-filters.js' %}"></script>

  <script src="{% static 'vendor/particles/particles.min.js' %}"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
    }

    body {
      position: relative;
      background: #f8f9fa url("{% static 'videos/factory_background.jpg' %}") no-repeat center center;
      background-size: cover;
      background-attachment: fixed;
    }

    #background-darken {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: -3;
      pointer-events: none;
    }

    #particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
      pointer-events: auto;
    }

    .footer-space {
      margin-bottom: 50px;
    }
  </style>
</head>
<body>
  <div id="background-darken"></div>
  <div id="particles-js"></div>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" >
        QD-AMMK
      </a>
    </div>
  </nav>

  <div class="container mt-5 footer-space">
        <h1 class="mb-4" style="color: white">Справочник сотрудников</h1>

        <form method="get" class="row g-2 mb-4 position-relative">
            <div class="col-9 col-md-10 position-relative">
                <input id="searchInput" type="text" name="q" class="form-control pe-5" placeholder="Введите имя сотрудника, номер телефона, e-mail, должность или отдел" value="{{ query }}">
                <button type="button" id="clearButton" class="btn position-absolute top-50 end-0 translate-middle-y me-2 p-0 border-0 bg-transparent" style="display: none;">
                    <i class="bi bi-x-lg" style="font-size: 1.6rem; color: red; font-weight: bold; text-shadow: 0 0 0.5px red;"></i>
                </button>
            </div>
            <div class="col-3 col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Поиск
                </button>
            </div>
        </form>

        <button id="scrollToTopBtn" class="btn btn-dark rounded-circle shadow position-fixed"
                style="bottom: 20px; right: 20px; display: none; z-index: 1000;">
            <i class="bi bi-arrow-up" style="font-size: 1.3rem;"></i>
        </button>

        {% if contacts %}
            {% for contact in contacts %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">{{ contact.department }}</h5>
                        <p class="card-text mb-1"><strong>Должность:</strong> {{ contact.position }}</p>
                        <p class="card-text mb-1"><strong>Сотрудник:</strong> {{ contact.employee_name }}</p>
                        <p class="card-text mb-1">
                            <strong>Мобильный:</strong> {{ contact.phone_number }}
                            {% with contact.phone_number|cut:" "|cut:"-"|cut:"("|cut:")"|cut:"+" as phone_clean %}
                                {% if phone_clean|length >= 11 %}
                                    <a href="https://wa.me/{{ phone_clean }}" target="_blank" class="ms-2">
                                        <i class="bi bi-whatsapp text-success"></i>
                                    </a>
                                    <a href="tel:{{ phone_clean }}" class="ms-2">
                                        <i class="bi bi-telephone-outbound text-primary"></i>
                                    </a>
                                {% else %}
                                    {% with "7"|add:phone_clean as phone_link %}
                                        <a href="https://wa.me/{{ phone_link }}" target="_blank" class="ms-2">
                                            <i class="bi bi-whatsapp text-success"></i>
                                        </a>
                                        <a href="tel:{{ phone_link }}" class="ms-2">
                                            <i class="bi bi-telephone-outbound text-primary"></i>
                                        </a>
                                    {% endwith %}
                                {% endif %}
                            {% endwith %}
                        </p>
                        <p class="card-text mb-0">
                            <strong>E-mail:</strong>
                            <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                        </p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>Ничего не найдено.</p>
        {% endif %}
  </div>

  <script src="{% static 'vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      particlesJS('particles-js', {
        particles: {
          number: { value: 80 },
          color: { value: "#ffffff" },
          shape: { type: "circle" },
          opacity: { value: 0.8 },
          size: { value: 3 },
          line_linked: {
            enable: true,
            distance: 150,
            color: "#ffffff",
            opacity: 0.6,
            width: 1
          },
          move: { enable: true, speed: 1.5 }
        },
        interactivity: {
          detect_on: "window",
          events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" }
          },
          modes: {
            repulse: { distance: 150 },
            push: { particles_nb: 4 }
          }
        }
      });
    });

        // Clear button logic
        const input = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearButton');
        function toggleClearButton() {
            clearBtn.style.display = input.value ? 'inline' : 'none';
        }
        input.addEventListener('input', toggleClearButton);
        clearBtn.addEventListener('click', () => {
            input.value = '';
            toggleClearButton();
            input.focus();
        });
        window.addEventListener('DOMContentLoaded', toggleClearButton);

        // Scroll to top logic
        const scrollToTopBtn = document.getElementById("scrollToTopBtn");
        window.addEventListener("scroll", () => {
            scrollToTopBtn.style.display = window.scrollY > 300 ? "block" : "none";
        });
        scrollToTopBtn.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
        });
    </script>
</body>
</html>