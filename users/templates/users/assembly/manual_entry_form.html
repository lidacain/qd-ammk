{% extends "users/base.html" %}
{% load static %}

{% block title %}{{ post_name }}{% endblock %}

{% block content %}

<a href="{% url 'assembly_workshop_dashboard' %}" class="btn btn-outline-secondary mb-4">‚Üê –ù–∞–∑–∞–¥</a>

<div class="container mt-4">
    <h2 class="mb-4 text-center">{{ post_name }}</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä VIN</label>
            <div style="position: relative;">
                <input type="text" id="vin_search" name="vin_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ VIN...">
                <span id="clear_vin_search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none;">‚ùå</span>
                <button type="button" id="start_qr_scan" class="btn btn-primary mt-2">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
                <div id="qr-reader" style="width: 300px; display: none;"></div>
                <button type="button" id="stop_qr_scan" class="btn btn-danger mt-2" style="display: none;">‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            </div>
        </div>

        <!-- –î–∞–Ω–Ω—ã–µ –æ VIN -->
        <div id="trace_data_container" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–î–∞–Ω–Ω—ã–µ –ø–æ VIN</h5>
            <p><strong>VIN:</strong> <span id="vin_value"></span></p>
            <p><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value"></span></p>
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
            <p><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
            <p><strong>–¢–∏–ø –ø—Ä–∏–≤–æ–¥–∞:</strong> <span id="drive_type_value"></span></p>
        </div>


        <!-- –ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç? <span style="color: red">*</span></label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–î–∞</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no">
                <label class="form-check-label" for="defect_no">–ù–µ—Ç</label>
            </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ -->
        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞</label>
            <textarea name="defect_description" rows="4" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞"></textarea>
        </div>

        <!-- –§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ -->
        <div class="mb-3 position-relative">
            <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ <span style="color: red">*</span></label>

            <!-- –°–∫—Ä—ã—Ç—ã–π input -->
            <input type="file" name="defect_photos" id="defect_photos"
                   class="form-control"
                   multiple accept="image/*">

            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
            <div id="defect_photos_display" class="form-control bg-light fw-bold" style="z-index: 1;">
                üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã -->
            <button type="button" class="btn btn-primary mt-2"
                    onclick="openCamera('defect_photos', 'defect_photos_preview')">
                üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
            </button>

            <!-- –ü—Ä–µ–≤—å—é -->
            <div id="defect_photos_preview" class="d-flex flex-wrap mt-2 gap-2"></div>
        </div>

        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ç–∞–π–º–µ—Ä–∞ -->
        <input type="hidden" name="inspection_duration_seconds" id="inspection_duration_seconds">

        <div class="row mb-3">
            <div class="col">
                <label for="custom_date" class="form-label">–î–∞—Ç–∞ –æ—Å–º–æ—Ç—Ä–∞ <span style="color:red">*</span></label>
                <input type="date" class="form-control" name="custom_date" required>
            </div>
            <div class="col">
                <label for="custom_time" class="form-label">–í—Ä–µ–º—è –æ—Å–º–æ—Ç—Ä–∞ <span style="color:red">*</span></label>
                <input type="time" class="form-control" name="custom_time" step="1" required>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn btn-success w-100">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∫–∞–º–µ—Ä—ã –∏ QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let qrScanner = new Html5Qrcode("qr-reader");
    let qrActive = false;

    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById("vin_search").value = decodedText;
        document.getElementById("qr-reader").style.display = "none";

        qrScanner.stop().then(() => {
            console.log("üì∏ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR");
            qrActive = false;
        }).catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:", err);
        });

        triggerVinSearch(decodedText);
    }

    document.getElementById("start_qr_scan").addEventListener("click", function () {
        const qrReader = document.getElementById("qr-reader");
        const scanBtn = document.getElementById("start_qr_scan");

        if (!qrActive) {
            qrReader.style.display = "block";
            scanBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                qrActive = true;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
            });
        } else {
            qrScanner.stop().then(() => {
                qrReader.style.display = "none";
                scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
                qrActive = false;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:", err);
            });
        }
    });
});

function triggerVinSearch(vin) {
    let vinValue = document.getElementById("vin_value");
    let engineNumberValue = document.getElementById("engine_number_value");
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");
    let driveTypeValue = document.getElementById("drive_type_value");

    let traceDataContainer = document.getElementById("trace_data_container");

    fetch(`/supplies/api/search_vin/?q=${vin}`)
        .then(response => {
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.results.length === 0) {
                traceDataContainer.style.display = "none";
                return;
            }

            let vinData = data.results[0];
            vinValue.textContent = vinData.vin;
            engineNumberValue.textContent = vinData.engine_number;
            modelValue.textContent = vinData.model;
            bodyColorValue.textContent = vinData.body_color;
            driveTypeValue.textContent = vinData.drive_type;

            traceDataContainer.style.display = "block";
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error));
}


function setupCamera() {
    const isMobileDevice = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobileDevice()) {
        // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –Ω–∞—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
        window.openCamera = function (inputId, previewId) {
            window.continueCaptureLoop = true;
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            if (!input || !preview) return;

            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment"); // –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É

            input.onchange = function () {
                if (!input.files || input.files.length === 0) {
                    window.continueCaptureLoop = false; // ‚ùå –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
                    return;
                }
                const dt = new DataTransfer();

                const existingImages = preview.querySelectorAll("img[data-file]");
                let promises = [];

                // üîÅ 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                existingImages.forEach(img => {
                    const base64 = img.src;
                    const filename = img.getAttribute("data-file");

                    const p = fetch(base64)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], filename, { type: blob.type });
                            dt.items.add(file);
                        });

                    promises.push(p);
                });

                // üì∏ 2. –ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å –∫–∞–º–µ—Ä—ã
                const newFiles = Array.from(input.files);

                newFiles.forEach(file => {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const dataURL = e.target.result;
                        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                        const filename = `photo_${timestamp}.jpg`;

                        const blob = dataURLToBlob(dataURL);
                        const renamedFile = new File([blob], filename, { type: file.type });
                        const imageURL = URL.createObjectURL(renamedFile);

                        // üîÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—É—Å–µ–ª—å, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                        if (!preview.dataset.carouselInitialized) {
                            preview.dataset.carouselInitialized = "true";
                            preview.carouselData = [];
                            preview.currentIndex = 0;

                            preview.innerHTML = `
                                <div class="carousel-wrapper d-flex flex-column align-items-center">
                                    <div class="carousel-img-container position-relative" style="position: relative;">
                                        <img class="carousel-img img-thumbnail mb-2"
                                             style="max-width:300px; border-radius:5px; object-fit:cover; width: 100%; position: relative; z-index: 1;">

                                        <!-- –ó–æ–Ω—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫—Ä–∞—è–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                        <div class="carousel-left-zone"
                                             style="position:absolute; top:0; bottom:0; left:0; width:50%; z-index:2;"></div>
                                        <div class="carousel-right-zone"
                                             style="position:absolute; top:0; bottom:0; right:0; width:50%; z-index:2;"></div>
                                    </div>

                                    <!-- üîò –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                                    <button type="button" class="carousel-delete btn btn-danger btn-sm mt-2 mb-1">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>

                                    <!-- ‚¨ÖÔ∏è‚û°Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                                    <div class="carousel-controls d-flex justify-content-between align-items-center mt-3 w-100" style="max-width:300px;">
                                        <button type="button" class="carousel-prev btn btn-secondary btn-lg px-4">‚Üê</button>
                                        <span class="carousel-counter fs-5">1 / 1</span>
                                        <button type="button" class="carousel-next btn btn-secondary btn-lg px-4">‚Üí</button>
                                    </div>
                                </div>
                            `;

                            // üìå –ü—Ä–∏–≤—è–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            const imgElement = preview.querySelector(".carousel-img");
                            const deleteBtn = preview.querySelector(".carousel-delete");
                            const prevBtn = preview.querySelector(".carousel-prev");
                            const nextBtn = preview.querySelector(".carousel-next");
                            const counter = preview.querySelector(".carousel-counter");

                            // üìå –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—É—Å–µ–ª–∏
                            function updateCarousel() {
                                const data = preview.carouselData;
                                if (data.length === 0) {
                                    preview.innerHTML = "<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>";
                                    preview.dataset.carouselInitialized = "";
                                    preview.carouselData = null;
                                    return;
                                }

                                const current = data[preview.currentIndex];
                                imgElement.src = current.url;
                                counter.textContent = `${preview.currentIndex + 1} / ${data.length}`;
                            }

                            // üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
                            deleteBtn.onclick = () => {
                                preview.carouselData.splice(preview.currentIndex, 1);
                                if (preview.currentIndex >= preview.carouselData.length) {
                                    preview.currentIndex = preview.carouselData.length - 1;
                                }
                                updateCarousel();

                                const dt = new DataTransfer();
                                preview.carouselData.forEach(item => dt.items.add(item.file));
                                input.files = dt.files;

                                // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                                if (input.id === "body_photos") {
                                    const display = document.getElementById("body_photos_display");
                                    if (display) {
                                        const count = input.files.length;
                                        display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                    }
                                } else if (input.id.startsWith("defect_photo_input_")) {
                                    const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                                    const display = document.getElementById(`defect_photo_display_${index}`);
                                    if (display) {
                                        const count = input.files.length;
                                        display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                    }
                                }
                            };

                            prevBtn.onclick = () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    updateCarousel();
                                }
                            };

                            nextBtn.onclick = () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    updateCarousel();
                                }
                            };

                            preview.updateCarousel = updateCarousel;
                            const leftZone = preview.querySelector(".carousel-left-zone");
                            const rightZone = preview.querySelector(".carousel-right-zone");

                            leftZone.addEventListener("click", () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    preview.updateCarousel();
                                }
                            });

                            rightZone.addEventListener("click", () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    preview.updateCarousel();
                                }
                            });
                        }

                        // ‚ûï –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        preview.carouselData.push({ file: renamedFile, url: imageURL });
                        preview.currentIndex = preview.carouselData.length - 1;
                        preview.updateCarousel();

                        // üóÇÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º input.files
                        const dt = new DataTransfer();
                        preview.carouselData.forEach(item => dt.items.add(item.file));
                        input.files = dt.files;

                        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                        if (input.id === "body_photos") {
                            const display = document.getElementById("body_photos_display");
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        } else if (input.id.startsWith("defect_photo_input_")) {
                            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                            const display = document.getElementById(`defect_photo_display_${index}`);
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        }
                    };

                    reader.readAsDataURL(file);
                });


                // ‚è≥ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å–µ—Ö fetch
                Promise.all(promises).then(() => {
                    input.files = dt.files;
                    // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                    if (input.id === "body_photos") {
                        const display = document.getElementById("body_photos_display");
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    } else if (input.id.startsWith("defect_photo_input_")) {
                        const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                        const display = document.getElementById(`defect_photo_display_${index}`);
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    }
                });
            };

            input.click();
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è base64 –≤ Blob
        function dataURLToBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        };


    } else {
        // üíª –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let modal = document.createElement("div");
        modal.id = "camera_modal";
        modal.style.display = "none";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.flexDirection = "column";
        modal.innerHTML = `
            <video id="camera_feed" autoplay playsinline style="width:90%; max-width:500px;"></video>
            <button id="capture_button" class="btn btn-success mt-3">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        document.body.appendChild(modal);

        let video = document.getElementById("camera_feed");
        let captureButton = document.getElementById("capture_button");
        let closeButton = document.getElementById("close_camera");

        let canvas = document.createElement("canvas");
        let activeStream = null;
        let activeInput = null;
        let activePreview = null;

        window.openCamera = function (inputId, previewId) {
            activeInput = document.getElementById(inputId);
            activePreview = document.getElementById(previewId);

            if (!activeInput || !activePreview) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –∏–ª–∏ preview");
                return;
            }

            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function (stream) {
                    activeStream = stream;
                    video.srcObject = stream;
                    modal.style.display = "flex";
                    setTimeout(() => video.play(), 500);
                })
                .catch(function (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                    alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
                });

            captureButton.onclick = function () {
                if (!activeInput || !activePreview) return;

                let context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(function (blob) {
                    let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

                    let dataTransfer = new DataTransfer();
                    for (let i = 0; i < activeInput.files.length; i++) {
                        dataTransfer.items.add(activeInput.files[i]);
                    }

                    dataTransfer.items.add(file);
                    activeInput.files = dataTransfer.files;

                    let imgContainer = document.createElement("div");
                    imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

                    let img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    img.classList.add("img-thumbnail");
                    img.style.maxWidth = "300px";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";

                    let deleteBtn = document.createElement("button");
                    deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
                    deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
                    deleteBtn.onclick = function () {
                        imgContainer.remove();
                        removeFileFromInput(activeInput, file);
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(deleteBtn);
                    activePreview.appendChild(imgContainer);

                    closeCamera();
                }, "image/jpeg");
            };
        };

        function removeFileFromInput(inputElement, fileToRemove) {
            let dataTransfer = new DataTransfer();
            for (let i = 0; i < inputElement.files.length; i++) {
                let file = inputElement.files[i];
                if (file.name !== fileToRemove.name || file.size !== fileToRemove.size) {
                    dataTransfer.items.add(file);
                }
            }
            inputElement.files = dataTransfer.files;
        }

        function closeCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
            }
            video.srcObject = null;
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", closeCamera);
        modal.addEventListener("click", function (event) {
            if (event.target === modal) closeCamera();
        });
    }
}


function rebuildInputFiles(input, preview) {
    const dt = new DataTransfer();

    const images = preview.querySelectorAll("img[data-file]");
    let promises = [];

    images.forEach(img => {
        const base64 = img.src;
        const filename = img.getAttribute("data-file");

        const p = fetch(base64)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], filename, { type: blob.type });
                dt.items.add(file);
            });

        promises.push(p);
    });

    Promise.all(promises).then(() => {
        input.files = dt.files;
        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
        if (input.id === "body_photos") {
            const display = document.getElementById("body_photos_display");
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        } else if (input.id.startsWith("defect_photo_input_")) {
            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
            const display = document.getElementById(`defect_photo_display_${index}`);
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        }
    });
}
document.addEventListener("DOMContentLoaded", function () {
    setupCamera();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    setupVinSearch();
});

function setupVinSearch() {
    let vinInput = document.getElementById("vin_search");
    let clearButton = document.getElementById("clear_vin_search");
    let vinList = document.createElement("ul");
    vinList.id = "vin_list";
    vinList.classList.add("list-group", "position-absolute", "w-100", "mt-1");
    vinList.style.zIndex = "1000";
    vinInput.parentNode.appendChild(vinList);

    vinInput.addEventListener("input", function() {
        let query = vinInput.value.trim();

        if (query.length > 0) {
            clearButton.style.display = "block";
        } else {
            clearButton.style.display = "none";
            vinList.style.display = "none";
            return;
        }

        fetch(`/supplies/api/search_vin/?q=${query}`)
            .then(response => {
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                return response.json();
            })
            .then(data => {
                vinList.innerHTML = "";
                if (data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.style.cursor = "pointer";

                    li.addEventListener("click", function() {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        clearButton.style.display = "block";

                        triggerVinSearch(item.vin);
                    });

                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error));
    });

    clearButton.addEventListener("click", function() {
        vinInput.value = "";
        clearButton.style.display = "none";
        vinList.style.display = "none";
        document.getElementById("trace_data_container").style.display = "none";
    });

    document.addEventListener("click", function(event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });
}
</script>

{% endblock %}
