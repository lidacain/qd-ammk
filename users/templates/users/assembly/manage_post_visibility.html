{% extends "users/base.html" %}
{% load static %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Å—Ç–æ–≤{% endblock %}

{% block content %}
<style>
    .scroll-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.5rem;
    }
.tab-inner-wrapper {
    display: flex;
    flex-direction: column;
    height: 500px; /* —Ñ–∏–∫—Å–∏—Ä—É–π –ø–æ –¥–∏–∑–∞–π–Ω—É */
}

.scroll-container {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

</style>
<div class="container-fluid mt-4">
    <div class="mb-3">
        <a href="{% url 'master_dashboard' %}" class="btn btn-secondary">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </div>

    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    <h3 class="mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø–æ—Å—Ç–∞—Ö</h3>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–æ—Å—Ç—ã -->
        <div class="col-md-3 border-end" style="max-height: 600px; overflow-y: auto;">
            <h5>–ü–æ—Å—Ç—ã</h5>
            <ul class="list-group" id="post-list">
                {% for post in posts %}
                    <li class="list-group-item post-item" data-post-id="{{ post.id }}">
                        {{ post.name }}
                    </li>
                {% endfor %}
            </ul>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö (–û–ë–ï–†–ù–£–¢–ê!) -->
        <div class="col-md-9">
            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="zones-tab" data-bs-toggle="tab" href="#zones" role="tab">–ü–æ–¥—Å–∏—Å—Ç–µ–º—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="units-tab" data-bs-toggle="tab" href="#units" role="tab">–î–µ—Ç–∞–ª–∏</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="defects-tab" data-bs-toggle="tab" href="#defects" role="tab">–î–µ—Ñ–µ–∫—Ç—ã</a>
                </li>
            </ul>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
            <div class="tab-content mt-3" id="dataTabsContent">

                <!-- –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ -->
                <div class="tab-pane fade show active" id="zones" role="tabpanel">
                    <div class="tab-inner-wrapper">
                        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ü–æ–¥—Å–∏—Å—Ç–µ–º—ã -->
                        <form method="post" class="mb-3 d-flex align-items-center" style="gap: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="zone">
                            <input type="text" name="name" class="form-control" placeholder="–ù–æ–≤–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞..." required>
                            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </form>

                        <table class="table table-bordered align-middle custom-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã</th>
                                    <th style="width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="zone-list">
                                {% for zone in zones %}
                                    <tr data-id="{{ zone.id }}" data-type="zone">
                                        <td>
                                            <input class="form-check-input visibility-checkbox"
                                                   type="checkbox"
                                                   data-id="{{ zone.id }}"
                                                   data-type="zone">
                                        </td>
                                        <td>
                                            <form method="post" class="inline-edit-form row g-2 align-items-center">
                                                {% csrf_token %}
                                                <input type="hidden" name="id" value="{{ zone.id }}">
                                                <input type="text" name="name" value="{{ zone.name }}" class="form-control form-control-sm">
                                        </td>
                                        <td class="text-nowrap">
                                            <div class="d-flex gap-1">
                                                <!-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
                                                <button type="submit"
                                                        class="btn btn-sm btn-success"
                                                        formaction="{% url 'assembly_zone_update' %}">
                                                    üíæ
                                                </button>
                                                <!-- –£–¥–∞–ª–∏—Ç—å -->
                                                <button type="submit"
                                                        class="btn btn-sm btn-danger"
                                                        formaction="{% url 'assembly_zone_delete' %}"
                                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Å–∏—Å—Ç–µ–º—É ¬´{{ zone.name }}¬ª?')">
                                                    üóë
                                                </button>
                                            </div>
                                            </form>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">–ù–µ—Ç –ø–æ–¥—Å–∏—Å—Ç–µ–º</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –î–ï–¢–ê–õ–ò -->
                <div class="tab-pane fade" id="units" role="tabpanel">
                    <div class="tab-inner-wrapper">

                        <!-- üßæ –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ -->
                        <form method="post" class="mb-3 d-flex align-items-center flex-wrap" style="gap: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="unit">
                            <input type="text" name="name" class="form-control" placeholder="–ù–æ–≤–∞—è –¥–µ—Ç–∞–ª—å..." required>
                            <select name="zone" class="form-select" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ü–æ–¥—Å–∏—Å—Ç–µ–º—É</option>
                                {% for zone in zones %}
                                    <option value="{{ zone.id }}">{{ zone.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </form>

                        <!-- üîç –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ -->
                        <div class="d-flex flex-wrap mb-3" style="gap: 8px;">
                            <!-- ‚ö†Ô∏è –±–µ–∑ active –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –µ–≥–æ –ø–æ—Å—Ç–∞–≤–∏—Ç JS –∏–∑ URL -->
                            <button type="button" class="btn btn-outline-secondary btn-sm filter-zone-btn" data-zone-id="all">
                                –í—Å–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã
                            </button>
                            {% for zone in zones %}
                                <button type="button" class="btn btn-outline-secondary btn-sm filter-zone-btn" data-zone-id="{{ zone.id }}">
                                    {{ zone.name }}
                                </button>
                            {% endfor %}
                            <button type="button" class="btn btn-outline-secondary btn-sm filter-zone-btn" data-zone-id="__none__">
                                –ë–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã
                            </button>
                        </div>

                        <!-- üìã –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π -->
                        <table class="table table-bordered align-middle custom-table">
                            <thead>
                              <tr>
                                <th style="width: 50px;"></th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏</th>
                                <th>–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞</th>
                                <th style="width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                              </tr>
                            </thead>
                            <tbody id="unit-list">
                              {% for unit in units %}
                                <tr data-id="{{ unit.id }}" data-type="unit" data-zone-id="{{ unit.zone_id|default_if_none:'' }}">
                                  <td>
                                    <input class="form-check-input visibility-checkbox"
                                           type="checkbox"
                                           data-id="{{ unit.id }}"
                                           data-type="unit">
                                  </td>
                                  <td>
                                    <form method="post" class="inline-edit-form row g-2 align-items-center">
                                      {% csrf_token %}
                                      <input type="hidden" name="id" value="{{ unit.id }}">
                                      <input type="text" name="name" value="{{ unit.name }}" class="form-control form-control-sm">
                                  </td>
                                  <td>
                                      <select name="zone" class="form-select form-select-sm">
                                        <option value="" {% if not unit.zone_id %}selected{% endif %}>–ë–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã</option>
                                        {% for z in zones %}
                                          <option value="{{ z.id }}" {% if unit.zone_id == z.id %}selected{% endif %}>{{ z.name }}</option>
                                        {% endfor %}
                                      </select>
                                  </td>
                                  <td class="text-nowrap">
                                      <div class="d-flex gap-1">
                                        <button type="submit"
                                                class="btn btn-sm btn-success"
                                                formaction="{% url 'assembly_unit_update' %}">
                                          üíæ
                                        </button>
                                        <button type="submit"
                                                class="btn btn-sm btn-danger"
                                                formaction="{% url 'assembly_unit_delete' %}"
                                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å ¬´{{ unit.name }}¬ª?')">
                                          üóë
                                        </button>
                                      </div>
                                    </form>
                                  </td>
                                </tr>
                              {% empty %}
                                <tr>
                                  <td colspan="4" class="text-center text-muted">–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –î–ï–§–ï–ö–¢–´ -->
                <div class="tab-pane fade" id="defects" role="tabpanel">
                    <div class="tab-inner-wrapper">
                        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ -->
                        <form method="post" class="mb-3 d-flex align-items-center" style="gap: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="defect">
                            <input type="text" name="name" class="form-control" placeholder="–ù–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç..." required>
                            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </form>

                        <table class="table table-bordered align-middle custom-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞</th>
                                    <th style="width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="defect-list">
                                {% for defect in defects %}
                                    <tr data-id="{{ defect.id }}" data-type="defect">
                                        <td>
                                            <input class="form-check-input visibility-checkbox"
                                                   type="checkbox"
                                                   data-id="{{ defect.id }}"
                                                   data-type="defect">
                                        </td>
                                        <td>
                                            <form method="post" class="inline-edit-form row g-2 align-items-center">
                                                {% csrf_token %}
                                                <input type="hidden" name="id" value="{{ defect.id }}">
                                                <input type="text" name="name" value="{{ defect.name }}" class="form-control form-control-sm">
                                        </td>
                                        <td class="text-nowrap">
                                            <div class="d-flex gap-1">
                                                <button type="submit"
                                                        class="btn btn-sm btn-success"
                                                        formaction="{% url 'assembly_defect_update' %}">
                                                    üíæ
                                                </button>
                                                <button type="submit"
                                                        class="btn btn-sm btn-danger"
                                                        formaction="{% url 'assembly_defect_delete' %}"
                                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç ¬´{{ defect.name }}¬ª?')">
                                                    üóë
                                                </button>
                                            </div>
                                            </form>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">–ù–µ—Ç –¥–µ—Ñ–µ–∫—Ç–æ–≤</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    .post-item {
        cursor: pointer;
    }
    .post-item.active {
        background-color: #0d6efd;
        color: white;
    }
    .list-group-item.active {
        background-color: #0d6efd;
        color: white;
        font-weight: 500;
    }
    /* —Ñ–æ–Ω –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã —Å–µ—Ä—ã–π */
    .custom-table { background-color: #f2f2f2; }

    /* —Å—Ç—Ä–æ–∫–∏ –Ω–µ –∫—Ä–∞—Å–∏–º */
    .custom-table tbody tr { background-color: transparent; }

    /* –Ø–ß–ï–ô–ö–ò –±–µ–ª—ã–µ */
    .custom-table tbody td { background-color: #ffffff; }

    /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–µ–≥–∫–∞ —Å–µ—Ä—ã–π */
    .custom-table thead th { background-color: #f7f7f7; }

    /* –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–º—è–≥—á–µ */
    .custom-table td, .custom-table th { border-color: #dcdcdc !important; }

    /* —Ö–æ–≤–µ—Ä ‚Äì –ª—ë–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –±–µ–ª–æ–π —è—á–µ–π–∫–∏ */
    .custom-table tbody tr:hover td { background-color: #fafafa; }
</style>
<script>
    const postVisibility = {{ post_visibility_json|safe }};
    let currentPostId = null;  // ‚úÖ –û–±—ä—è–≤–ª–µ–Ω–æ –≤ –Ω–∞—á–∞–ª–µ

    document.addEventListener("DOMContentLoaded", function () {

        // üîπ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function highlightItemsByIds(type, ids) {
            const selected = Array.isArray(ids) ? ids.map(Number) : [];
            document.querySelectorAll(`tr[data-type="${type}"]`).forEach(item => {
                const id = Number(item.dataset.id);
                const checkbox = item.querySelector(`.visibility-checkbox[data-type="${type}"]`);
                const active = selected.includes(id);
                item.classList.toggle("active", active);
                if (checkbox) checkbox.checked = active;
            });
        }

        // üîπ –í—ã–±–æ—Ä –ø–æ—Å—Ç–∞
        document.querySelectorAll(".post-item").forEach(item => {
            item.addEventListener("click", function () {
                // ‚úÖ –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤
                document.querySelectorAll(".post-item").forEach(i => i.classList.remove("active"));
                this.classList.add("active");

                // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Å—Ç
                currentPostId = this.dataset.postId;

                // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                const visibility = postVisibility[currentPostId];
                if (visibility) {
                    highlightItemsByIds("zone", visibility.zones);
                    highlightItemsByIds("unit", visibility.units);
                    highlightItemsByIds("defect", visibility.defects);
                }
            });
        });

        // üîπ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ (—Å –æ—Ç–ª–∞–¥–∫–æ–π)
        document.querySelectorAll('.filter-input').forEach(input => {
            const targetId = input.dataset.target;
            const listContainer = document.getElementById(targetId);

            if (!listContainer) {
                console.warn("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Å–ø–∏—Å–æ–∫:", targetId);
                return;
            }

            input.addEventListener('input', function () {
                const query = this.value.toLowerCase().trim();
                const items = listContainer.querySelectorAll('.list-group-item');

                items.forEach(item => {
                    const text = item.textContent.toLowerCase().trim();
                    const isVisible = text.includes(query);
                    item.style.display = isVisible ? '' : 'none';
                });
            });
        });

        // üîπ –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ —á–µ–∫–±–æ–∫—Å—É —Å–ø—Ä–∞–≤–∞ ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏
        document.querySelectorAll('.visibility-checkbox').forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                if (!currentPostId) {
                    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç —Å–ª–µ–≤–∞.");
                    this.checked = !this.checked;
                    return;
                }

                const itemId = this.dataset.id;     // id –∑–æ–Ω—ã/–¥–µ—Ç–∞–ª–∏/–¥–µ—Ñ–µ–∫—Ç–∞
                const itemType = this.dataset.type; // "zone" | "unit" | "defect"
                const element = this.closest('tr');

                fetch("", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `post_id=${encodeURIComponent(currentPostId)}&item_id=${encodeURIComponent(itemId)}&item_type=${encodeURIComponent(itemType)}`
                })
                .then(response => response.json())
                .then(data => {
                    const itemIdInt = parseInt(itemId);

                    if (data.status === "added") {
                        element?.classList.add("active");
                        checkbox.checked = true;

                        // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ postVisibility
                        const list = postVisibility[currentPostId][`${itemType}s`];
                        if (!list.includes(itemIdInt)) list.push(itemIdInt);

                        // –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –ó–û–ù–£ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –µ—ë –¥–µ—Ç–∞–ª–∏
                        if (itemType === "zone") {
                            if (confirm("–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —ç—Ç–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ—Å—Ç?")) {
                                fetch("", {
                                    method: "POST",
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: `action=bulk_units_from_zone&post_id=${encodeURIComponent(currentPostId)}&zone_id=${encodeURIComponent(itemId)}`
                                })
                                .then(r => r.json())
                                .then(bulk => {
                                    if (!bulk.ok) {
                                        alert(bulk.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π.");
                                        return;
                                    }
                                    const added = (bulk.added_unit_ids || []).map(Number);

                                    // 1) –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ units
                                    const unitsList = postVisibility[currentPostId]["units"];
                                    added.forEach(uid => { if (!unitsList.includes(uid)) unitsList.push(uid); });

                                    // 2) –ø–æ–¥—Å–≤–µ—Ç–∏–º —Å—Ç—Ä–æ–∫–∏ –∏ —á–µ–∫–±–æ–∫—Å—ã
                                    added.forEach(uid => {
                                        const row = document.querySelector(`#unit-list tr[data-type="unit"][data-id="${uid}"]`);
                                        if (row) {
                                            row.classList.add("active");
                                            const cb = row.querySelector('.visibility-checkbox[data-type="unit"]');
                                            if (cb) cb.checked = true;
                                        }
                                    });
                                })
                                .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π."));
                            }
                        }

                    } else if (data.status === "removed") {
                        element?.classList.remove("active");
                        checkbox.checked = false;

                        // –≤—ã—á–µ—Ä–∫–Ω–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ postVisibility
                        postVisibility[currentPostId][`${itemType}s`] =
                            postVisibility[currentPostId][`${itemType}s`].filter(id => id !== itemIdInt);

                        // –µ—Å–ª–∏ —Å–Ω—è–ª–∏ –ó–û–ù–£ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –µ—ë –¥–µ—Ç–∞–ª–∏ —Å –ø–æ—Å—Ç–∞
                        if (itemType === "zone") {
                            if (confirm("–£–±—Ä–∞—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —ç—Ç–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞?")) {
                                fetch("", {
                                    method: "POST",
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: `action=bulk_remove_units_of_zone&post_id=${encodeURIComponent(currentPostId)}&zone_id=${encodeURIComponent(itemId)}`
                                })
                                .then(r => r.json())
                                .then(bulk => {
                                    if (!bulk.ok) {
                                        alert(bulk.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –º–∞—Å—Å–æ–≤–æ —É–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª–∏.");
                                        return;
                                    }
                                    const removed = (bulk.removed_unit_ids || []).map(Number);

                                    // 1) –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ units
                                    postVisibility[currentPostId]["units"] =
                                        postVisibility[currentPostId]["units"].filter(uid => !removed.includes(uid));

                                    // 2) —Å–Ω–∏–º–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —á–µ–∫–±–æ–∫—Å—ã
                                    removed.forEach(uid => {
                                        const row = document.querySelector(`#unit-list tr[data-type="unit"][data-id="${uid}"]`);
                                        if (row) {
                                            row.classList.remove("active");
                                            const cb = row.querySelector('.visibility-checkbox[data-type="unit"]');
                                            if (cb) cb.checked = false;
                                        }
                                    });
                                })
                                .catch(() => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π."));
                            }
                        }

                    } else {
                        alert("–û—à–∏–±–∫–∞: " + (data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                        checkbox.checked = !checkbox.checked;
                    }
                })
                .catch(() => {
                    checkbox.checked = !checkbox.checked;
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
                });
            });
        });

        // üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });


</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const zoneButtons = document.querySelectorAll(".filter-zone-btn");
    // ‚¨áÔ∏è –ë–µ—Ä—ë–º –°–¢–†–û–ö–ò-—Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã, –∞ –Ω–µ .list-group-item
    const unitRows = document.querySelectorAll("#unit-list tr[data-zone-id]");

    // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã —Ö—Ä–∞–Ω–∏–º –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
    let selectedZones = new Set();

    function applyButtonsState() {
        zoneButtons.forEach(btn => btn.classList.remove("active"));
        if (selectedZones.size === 0) {
            document.querySelector('.filter-zone-btn[data-zone-id="all"]')?.classList.add("active");
        } else {
            selectedZones.forEach(id => {
                document.querySelector(`.filter-zone-btn[data-zone-id="${id}"]`)?.classList.add("active");
            });
        }
    }

    function filterUnitsByZone() {
        if (selectedZones.size === 0) {
            unitRows.forEach(row => row.style.display = "");
            return;
        }

        const showOnlyNoZone = selectedZones.has("__none__");

        unitRows.forEach(row => {
            const zoneId = (row.getAttribute("data-zone-id") || "").trim(); // "" –µ—Å–ª–∏ –±–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã
            if (showOnlyNoZone) {
                row.style.display = zoneId === "" ? "" : "none";
            } else {
                row.style.display = selectedZones.has(zoneId) ? "" : "none";
            }
        });
    }

    zoneButtons.forEach(btn => {
        btn.addEventListener("click", function () {
            const id = String(this.getAttribute("data-zone-id"));

            if (id === "all") {
                selectedZones.clear(); // –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
            } else if (id === "__none__") {
                selectedZones.clear();
                selectedZones.add("__none__"); // –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã
            } else {
                // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                if (selectedZones.has(id)) {
                    selectedZones.delete(id);
                } else {
                    selectedZones.add(id);
                    selectedZones.delete("__none__"); // –Ω–µ–ª—å–∑—è –≤–º–µ—Å—Ç–µ —Å "–±–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º–ø—ã"
                }
            }

            applyButtonsState();
            filterUnitsByZone();
        });
    });

    // –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–î–µ—Ç–∞–ª–∏" ‚Äî –æ–±–Ω–æ–≤–∏–º —Ñ–∏–ª—å—Ç—Ä
    document.getElementById("units-tab")?.addEventListener("shown.bs.tab", () => {
        applyButtonsState();
        filterUnitsByZone();
    });

    // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    applyButtonsState();
    filterUnitsByZone();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // —É–Ω–∏–≤–µ—Ä—Å–∞–ª–∫–∞ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤ (–º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π toast)
  function showInlineAlert(containerEl, msg, type='success') {
    // type: success | danger | warning | info
    const el = document.createElement('div');
    el.className = `alert alert-${type} py-1 px-2 my-1`;
    el.textContent = msg;
    containerEl.prepend(el);
    setTimeout(() => el.remove(), 2500);
  }

  // –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤—Å–µ—Ö –∏–Ω–ª–∞–π–Ω-—Ñ–æ—Ä–º
  document.querySelectorAll('.inline-edit-form').forEach(form => {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.submitter; // –∫–Ω–æ–ø–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –∫–ª–∏–∫–Ω—É–ª–∏
      const url = submitBtn?.getAttribute('formaction') || form.getAttribute('action') || '';
      if (!url) return;

      const formData = new FormData(form);
      // –¥–æ–±–∞–≤–∏–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –≤—å—é—Ö–∞ –≤–µ—Ä–Ω—É–ª–∞ JSON
      const headers = {'X-Requested-With': 'XMLHttpRequest'};
      // csrf —É–∂–µ –µ—Å—Ç—å –≤ formData

      fetch(url, {method: 'POST', body: formData, headers})
        .then(r => r.json())
        .then(data => {
          // –æ–∂–∏–¥–∞–µ–º {ok: true/false, message: "...", removed: true?}
          const row = form.closest('tr') || form; // –∫—É–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (data.removed) {
            // —É–¥–∞–ª–µ–Ω–∏–µ: —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É
            const tr = form.closest('tr');
            if (tr) tr.remove();
            return;
          }
          if (data.ok) {
            showInlineAlert(row, data.message || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
          } else {
            showInlineAlert(row, data.message || '–û—à–∏–±–∫–∞', 'danger');
          }
        })
        .catch(() => {
          const row = form.closest('tr') || form;
          showInlineAlert(row, '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'danger');
        });
    });
  });
});
</script>
<style>
/* –ù–µ–≤–∏–¥–∏–º–∞—è –∑–æ–Ω–∞ —Å–ø—Ä–∞–≤–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å */
.scroll-to-top-zone {
    position: fixed;
    top: 0;
    right: 0;
    width: 40px; /* —à–∏—Ä–∏–Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π –∑–æ–Ω—ã */
    height: 100%;
    cursor: pointer;
    z-index: 9999;
    background: transparent; /* —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å */
}
</style>

<div class="scroll-to-top-zone" id="scrollToTopZone" title="–ù–∞–≤–µ—Ä—Ö"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const zone = document.getElementById("scrollToTopZone");

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞
    zone.style.display = "none";

    window.addEventListener("scroll", function () {
        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–æ–Ω—É, –µ—Å–ª–∏ –ø—Ä–æ–ª–∏—Å—Ç–∞–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω
        if (window.scrollY > window.innerHeight) {
            zone.style.display = "block";
        } else {
            zone.style.display = "none";
        }
    });

    zone.addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: "smooth" });
    });
});
</script>
{% endblock %}