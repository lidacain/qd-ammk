{% extends "users/base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ post }}{% endblock %}

{% block content %}
<style>
    .table-header-fixed {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        background-color: white;
        border-bottom: 1px solid #dee2e6;
        z-index: 1000;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-container-scroll {
        position: fixed;
        top: 110px; /* –Ω–∏–∂–µ .table-header-fixed */
        left: 0;
        right: 0;
        bottom: 0;
        overflow: auto;
        padding: 20px;
        background-color: white;
    }

    table {
        width: 100%;
        min-width: 1400px;
        border-collapse: collapse;
    }

    thead th {
        position: sticky;
        top: 0;
        background-color: #212529;
        color: white;
        z-index: 10;
        text-align: center;
    }

    .table td {
        vertical-align: top;
        word-break: break-word;
        max-width: 300px;
    }

    .controller-info small {
        display: block;
        color: #6c757d;
    }

    .vin-link {
        color: #495057; /* —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π (–∫–∞–∫ —Ç–µ–∫—Å—Ç Bootstrap) */
        font-weight: 600;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .vin-link:hover {
        color: #6c757d; /* —Å–µ—Ä—ã–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        text-decoration: underline;
        cursor: pointer;
    }

    .photo-chip{
      display:inline-flex;align-items:center;justify-content:center;
      padding:.6rem .9rem;border:1px solid #dee2e6;border-radius:12px;
      background:#f8f9fa;color:#212529;text-decoration:none;font-weight:600;
      min-width:110px;white-space:nowrap;
    }
    .photo-chip:hover{background:#eef2f6;text-decoration:none}

    /* –ö–Ω–æ–ø–∫–∞-—Ñ–∏–ª—å—Ç—Ä –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ */
  .filter-btn{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:999px;
    border:1px solid #6c757d;background:#fff;color:#212529;cursor:pointer;
    transition:background-color .15s,border-color .15s,color .15s,box-shadow .15s;
  }
  .filter-btn i{pointer-events:none}
  .filter-btn:hover{background:#f1f3f5}

  /* –ê–∫—Ç–∏–≤–Ω–∞—è ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–µ–ª—ë–Ω–∞—è */
  .filter-btn.active{
    background:#198754;border-color:#198754;color:#fff;
    box-shadow:0 0 0 2px rgba(25,135,84,.25);
  }
  .filter-btn.active i{color:#fff}
  .filter-btn.active:focus-visible{
    outline:0;box-shadow:0 0 0 3px rgba(25,135,84,.35);
  }

  /* –ü–æ–ø–æ–≤–µ—Ä –æ–¥–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ */
  #filter-popover{
    position:fixed;            /* –≤–∞–∂–Ω–æ: –Ω–µ absolute */
    z-index:2000;              /* –≤—ã—à–µ –ª–∏–ø–∫–æ–≥–æ thead (z-index:10) */
    min-width:260px;max-width:340px;
    background:#fff;border:1px solid #dee2e6;border-radius:.5rem;
    box-shadow:0 .5rem 1rem rgba(0,0,0,.15);
    display:none;              /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç, JS –ø–æ–∫–∞–∂–µ—Ç */
  }
  #filter-popover .fp-head{
    display:flex;align-items:center;justify-content:space-between;
    padding:.5rem .75rem;border-bottom:1px solid #eee
  }
  #filter-popover .fp-body{max-height:300px;overflow:auto;padding:.5rem .75rem}
  #filter-popover .fp-foot{display:flex;gap:.5rem;justify-content:flex-end;padding:.5rem .75rem;border-top:1px solid #eee}
  #filter-popover .form-check{margin:.15rem 0}
  #filter-popover .subttl{font-size:.85rem;color:#6c757d;margin:.25rem 0}

  .page-btn{min-width:36px}
  .page-btn.active{border-color:#0d6efd;color:#0d6efd;font-weight:600}
  .page-nav[disabled]{opacity:.5;pointer-events:none}

    /* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ —ç–∫—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–∞ */
  .export-pop{
    position:fixed; z-index:2001;
    background:#fff;border:1px solid #dee2e6;border-radius:.5rem;
    box-shadow:0 .5rem 1rem rgba(0,0,0,.15);
    display:none; min-width:280px; max-width:420px;
  }
  .export-pop .head{
    padding:.5rem .75rem;border-bottom:1px solid #eee;
    display:flex;align-items:center;justify-content:space-between
  }
  .export-pop .body{padding:.5rem .75rem;max-height:420px;overflow:auto}
  .export-pop .foot{padding:.5rem .75rem;border-top:1px solid #eee;display:flex;gap:.5rem;justify-content:flex-end}

  .export-option{display:flex;gap:.6rem;align-items:center;
    width:100%;text-align:left;padding:.5rem .6rem;border:1px solid #dee2e6;background:#fff;border-radius:.5rem}
  .export-option:hover{background:#f8f9fa}

  /* —á–µ–∫–ª–∏c—Ç –∫–æ–ª–æ–Ω–æ–∫ */
  .cols-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.25rem .75rem}
  .cols-grid .form-check{margin:.1rem 0}
  .muted{color:#6c757d}

  #custom-modal {position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:2500; }
  #custom-modal .modal-dialog{margin:6rem auto;}
  #custom-modal .modal-content{border-radius:.75rem;}
</style>

<div class="table-header-fixed">
  <a href="{% url 'assembly_workshop_dashboard' %}" class="btn btn-outline-secondary">–ù–∞–∑–∞–¥</a>
  <h3 class="m-0 text-center w-100">–¢–∞–±–ª–∏—Ü–∞ –æ—Å–º–æ—Ç—Ä–æ–≤ ‚Äî {{ post }}</h3>

  <!-- –ø–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø—Ä–∞–≤–∞ -->
  <div id="pagination-bar" class="d-flex align-items-center gap-2 ms-auto" style="display:none;">
    <div id="page-buttons" class="d-flex align-items-center gap-1">
      <button class="page-nav btn btn-sm btn-outline-secondary" data-dir="-1" title="–õ–∏—Å—Ç –Ω–∞–∑–∞–¥">‚Äπ</button>
      <div class="pages d-flex align-items-center gap-1"></div>
      <button class="page-nav btn btn-sm btn-outline-secondary" data-dir="1" title="–õ–∏—Å—Ç –≤–ø–µ—Ä—ë–¥">‚Ä∫</button>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label for="page-size" class="small text-muted m-0">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ:</label>
      <select id="page-size" class="form-select form-select-sm" style="width:auto;min-width:90px;">
        <option value="100" selected>100</option>
        <option value="200">200</option>
      </select>
    </div>
  </div>
</div>

<div class="table-container-scroll">

    <!-- üîç –§–ò–õ–¨–¢–†–´ -->
    <div class="row mb-3 px-3 align-items-end">
      <!-- –ø–æ–∏—Å–∫ -->
      <div class="col-md-3">
        <label for="quick-search" class="form-label">–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ:</label>
        <input id="quick-search" type="search" class="form-control" placeholder="VIN, –¥–µ—Ç–∞–ª—å, –¥–µ—Ñ–µ–∫—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä‚Ä¶" autocomplete="off">
      </div>

      <!-- –¥–µ—Ñ–µ–∫—Ç—ã -->
      <div class="col-md-2">
        <label for="filter-has-defect" class="form-label">–î–µ—Ñ–µ–∫—Ç—ã:</label>
        <select id="filter-has-defect" class="form-select">
          <option value="all">–í—Å–µ</option>
          <option value="yes">–¢–æ–ª—å–∫–æ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏</option>
          <option value="no">–ë–µ–∑ –¥–µ—Ñ–µ–∫—Ç–æ–≤</option>
        </select>
      </div>

      <!-- –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
      <div class="col-auto ms-auto d-flex gap-2 position-relative">
        <button id="reset-all-filters" class="btn btn-outline-danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>

        <!-- –æ—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
        <button id="download-excel" class="btn btn-success">–°–∫–∞—á–∞—Ç—å Excel</button>

        <!-- –≤—ã–ø–∞–¥–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="dl-panel" class="card shadow-sm" style="display:none; position:absolute; right:0; top:42px; z-index:1500; min-width:260px;">
          <div class="list-group list-group-flush">
            <button id="dl-with-photos"  class="list-group-item list-group-item-action">–°–∫–∞—á–∞—Ç—å —Å —Ñ–æ—Ç–æ</button>
            <button id="dl-no-photos"    class="list-group-item list-group-item-action">–°–∫–∞—á–∞—Ç—å –±–µ–∑ —Ñ–æ—Ç–æ</button>
            <button id="dl-custom"       class="list-group-item list-group-item-action">Custom‚Ä¶</button>
          </div>
        </div>
      </div>
    </div>
    <table class="table table-bordered table-hover table-striped align-middle">
      <thead>
        <tr>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>VIN</span>
              <!-- –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: VIN/–ë—Ä–µ–Ω–¥/–ú–æ–¥–µ–ª—å/–ö–æ–¥ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ -->
              <button class="filter-btn" data-col="vin" title="–§–∏–ª—å—Ç—Ä VIN / –ë—Ä–µ–Ω–¥ / –ú–æ–¥–µ–ª—å / –ö–æ–¥">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–î–∞—Ç–∞, –≤—Ä–µ–º—è</span>
              <!-- —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ -->
              <button class="filter-btn" data-col="date" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ/–≤—Ä–µ–º–µ–Ω–∏">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–õ–∏–Ω–∏—è</span>
              <button class="filter-btn" data-col="line" title="–§–∏–ª—å—Ç—Ä –ø–æ –ª–∏–Ω–∏–∏">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–î–µ—Ç–∞–ª—å</span>
              <button class="filter-btn" data-col="unit" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–µ—Ç–∞–ª–∏">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–î–µ—Ñ–µ–∫—Ç</span>
              <button class="filter-btn" data-col="defect" title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–µ—Ñ–µ–∫—Ç—É">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–ì—Ä–µ–π–¥</span>
              <button class="filter-btn" data-col="grade" title="–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä–µ–π–¥—É">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>
            <div class="d-flex align-items-center justify-content-between">
              <span>–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</span>
              <button class="filter-btn" data-col="controller" title="–§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É">
                <i class="bi bi-funnel"></i>
              </button>
            </div>
          </th>
          <th>–§–æ—Ç–æ</th>
          {% if request.user.role == "" %}
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for vin, entries in records_grouped %}
          {% for entry in entries %}
          <tr class="{% if entry.has_defect %}table-danger{% else %}table-success{% endif %}">
            {% if forloop.first %}
              {% with trace=vin_trace_map|get_item:vin %}
                <td rowspan="{{ entries|length }}"
                    data-brand="{{ trace.brand|default_if_none:'' }}"
                    data-model="{{ trace.model|default_if_none:'' }}"
                    data-config="{{ trace.config_code|default_if_none:'' }}">
                  <div style="white-space: nowrap;">
                    <a href="{% url 'vin_tracking_view' vin=vin %}" class="vin-link" target="_blank" rel="noopener noreferrer">
                      {{ vin }}
                    </a>
                  </div>
                  <div style="font-size: 0.9em; color: #6c757d;">
                    {{ trace.brand|default:"" }}<br>
                    {{ trace.model|default:"" }}<br>
                    {{ trace.config_code|default:"" }}
                  </div>
                </td>
              {% endwith %}
            {% endif %}
            <td>{{ entry.date|date:"d.m.Y H:i" }}</td>
            <td>{{ entry.line|default_if_none:"" }}</td>
            <td>{{ entry.unit|default_if_none:"" }}</td>
            <td>{{ entry.defect_description|default_if_none:"" }}</td>
            <td>{{ entry.comment|default_if_none:"" }}</td>
            <td>{{ entry.grade|default_if_none:"" }}</td>
            <td class="controller-info">
              {{ entry.controller }}
              {% with controller_users|dict_get:entry.controller as user %}
                {% if user %}
                  <small>{{ user.last_name }} {{ user.first_name }}</small>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% with photos=entry.photos %}
                {% if photos and photos|length > 0 %}
                  {% with first=photos.0 %}
                    <a class="photo-chip"
                       href="{% url 'view_image' image_path=first|cut:'/media/' %}?index=0&group={{ entry.group_key }}&photos={{ entry.photos_json|urlencode }}">
                      –§–æ—Ç–æ ({{ photos|length }})
                    </a>
                  {% endwith %}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              {% endwith %}
            </td>
            {% if request.user.role == "" %}
              <td class="text-center">
                <a href="{% url 'assembly_post_edit' vin=vin post_name=post timestamp=entry.date|date:'c' %}" class="me-2 text-primary fs-4 text-decoration-none" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a href="#" class="text-danger fs-4 text-decoration-none" title="–£–¥–∞–ª–∏—Ç—å" onclick="confirmDelete('{{ vin }}', '{{ post }}', '{{ entry.date|date:'c' }}')">
                  <i class="bi bi-trash3"></i>
                </a>
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
    <div id="filter-popover" role="dialog" aria-hidden="true">
      <div class="fp-head">
        <strong id="fp-title">–§–∏–ª—å—Ç—Ä</strong>
        <div class="d-flex gap-2">
          <button id="fp-select-all" class="btn btn-sm btn-outline-secondary">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
          <button id="fp-unselect-all" class="btn btn-sm btn-outline-secondary">–°–Ω—è—Ç—å –≤—Å–µ</button>
          <button id="fp-reset" class="btn btn-sm btn-outline-danger">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
      <div id="fp-body" class="fp-body"></div>
      <div class="fp-foot">
        <button id="fp-apply" class="btn btn-sm btn-success">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ -->
<div id="image-modal" class="modal" style="display: none;">
    <span class="close" onclick="closeModal()">&times;</span>
    <img id="modal-img" class="modal-content">
    <button id="prev-btn" class="nav-btn left" onclick="showPrev()">&#10094;</button>
    <button id="next-btn" class="nav-btn right" onclick="showNext()">&#10095;</button>
</div>
<script>
function confirmDelete(vin, post, timestamp) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
        window.location.href = `/users/delete-entry/${vin}/${post}/${timestamp}/`;
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- —ç–ª–µ–º–µ–Ω—Ç—ã
  const tbodyRows = Array.from(document.querySelectorAll('tbody tr'));
  const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
  const pop = document.getElementById('filter-popover');
  const fpTitle = document.getElementById('fp-title');
  const fpBody  = document.getElementById('fp-body');
  const btnApply = document.getElementById('fp-apply');
  const btnReset = document.getElementById('fp-reset');
  const btnAll   = document.getElementById('fp-select-all');
  const btnNone  = document.getElementById('fp-unselect-all');
  const quickSearch    = document.getElementById('quick-search');
  const hasDefectSel   = document.getElementById('filter-has-defect');
  const resetAllBtn    = document.getElementById('reset-all-filters');
  const downloadExcelBtn = document.getElementById('download-excel');
  // –µ—Å–ª–∏ –µ—Å—Ç—å namespace —É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (app_name='users'), –∏—Å–ø–æ–ª—å–∑—É–π 'users:assembly_post_export'
  const exportUrlPhotos   = "{% url 'assembly_post_export' %}?post={{ post|urlencode }}";
  const exportUrlNoPhotos = "{% url 'assembly_post_export_nophotos' %}?post={{ post|urlencode }}";
  const exportUrlCustom   = "{% url 'assembly_post_export_custom' %}?post={{ post|urlencode }}";

  // --- CSRF –∏–∑ –∫—É–∫–∏ Django
  function getCsrfToken(){
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  // --- —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —Ñ–æ—Ç–æ –∏–∑ —Å—Å—ã–ª–∫–∏ "–§–æ—Ç–æ (N)"
  function photosFromRow(row){
    const a = row.querySelector('a.photo-chip');
    if (!a) return [];
    try{
      const u = new URL(a.getAttribute('href'), window.location.origin);
      const enc = u.searchParams.get('photos') || '';
      return JSON.parse(decodeURIComponent(enc));
    }catch(e){ return []; }
  }

  /* ====== —ç–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é (–Ω–æ–≤—ã–µ id –ø–æ–¥ —Ç–≤–æ—é —Ä–∞–∑–º–µ—Ç–∫—É) ====== */
  const dlPanel = document.getElementById('dl-panel');
  const dlWithPhotosBtn = document.getElementById('dl-with-photos');
  const dlNoPhotosBtn   = document.getElementById('dl-no-photos');
  const dlCustomBtn     = document.getElementById('dl-custom');

  /* –≤—ã–ø–∞–¥–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "–°–∫–∞—á–∞—Ç—å Excel" */
  function toggleDlPanel(show){
    if (show === undefined) show = (dlPanel.style.display==='none' || !dlPanel.style.display);
    dlPanel.style.display = show ? 'block' : 'none';
  }
  downloadExcelBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDlPanel(true);
  });
  document.addEventListener('click', (e)=>{
    if (dlPanel.style.display==='block' && !dlPanel.contains(e.target) && e.target!==downloadExcelBtn){
      toggleDlPanel(false);
    }
  });

  /* —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π POST->blob->—Å–∫–∞—á–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é postAndDownload) */
  /* —Å–º. –≤—ã—à–µ: —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å postAndDownload(url, payload, fallbackName, btnForState) */

  /* === –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–≤—É—Ö –ø—Ä—è–º—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ === */
  // "–°–∫–∞—á–∞—Ç—å —Å —Ñ–æ—Ç–æ"
  dlWithPhotosBtn?.addEventListener('click', async ()=>{
    toggleDlPanel(false);
    const rows = collectFilteredRowsForExport();
    if (!rows.length){ alert('–ù–µ—Ç —Å—Ç—Ä–æ–∫, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.'); return; }
    await postAndDownload(exportUrlPhotos, { rows }, 'export_with_photos.xlsx', dlWithPhotosBtn);
  });
  // "–°–∫–∞—á–∞—Ç—å –±–µ–∑ —Ñ–æ—Ç–æ"
  dlNoPhotosBtn?.addEventListener('click', async ()=>{
    toggleDlPanel(false);
    const rows = collectFilteredRowsForExport();
    if (!rows.length){ alert('–ù–µ—Ç —Å—Ç—Ä–æ–∫, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.'); return; }
    await postAndDownload(exportUrlNoPhotos, { rows }, 'export_no_photos.xlsx', dlNoPhotosBtn);
  });

  /* ====== –∫–∞—Å—Ç–æ–º–Ω—ã–π –º–æ–¥–∞–ª ====== */
  const customModal = document.getElementById('custom-modal');
  const customCloseX = document.getElementById('custom-close-x');
  const customCancel = document.getElementById('custom-cancel');
  const customExport = document.getElementById('custom-export');
  const customSelectAll = document.getElementById('custom-select-all');
  const customUnselectAll = document.getElementById('custom-unselect-all');
  const photosCheckbox = document.getElementById('col-photos');
  const photoLimitWrap = document.getElementById('photo-limit-wrap');
  const photoLimitInput = document.getElementById('photo-limit');

  function openCustom(){ customModal.style.display='block'; }
  function closeCustom(){ customModal.style.display='none'; }

  // –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Å—Ç–æ–º –∏–∑ –º–µ–Ω—é
  dlCustomBtn?.addEventListener('click', ()=>{
    toggleDlPanel(false);
    openCustom();
  });

  // –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞
  customCloseX?.addEventListener('click', closeCustom);
  customCancel?.addEventListener('click', closeCustom);
  customModal?.addEventListener('click',(e)=>{ if (e.target===customModal) closeCustom(); });

  // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ "–ú–∞–∫—Å. —Ñ–æ—Ç–æ" –ø—Ä–∏ (–¥–µ)–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ "–§–æ—Ç–æ"
  function refreshPhotoLimit(){
    photoLimitWrap.style.display = photosCheckbox?.checked ? '' : 'none';
  }
  photosCheckbox?.addEventListener('change', refreshPhotoLimit);
  refreshPhotoLimit();

  // –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ/—Å–Ω—è—Ç—å –≤—Å–µ (VIN –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∫–ª—é—á—ë–Ω–Ω—ã–º –∏ disabled)
  function setAllCols(checked){
    document.querySelectorAll('.col-opt').forEach(cb=>{
      if (cb.id==='col-vin') return;
      cb.checked = !!checked;
    });
    refreshPhotoLimit();
  }
  customSelectAll?.addEventListener('click', ()=> setAllCols(true));
  customUnselectAll?.addEventListener('click', ()=> setAllCols(false));

  // –∑–∞–ø—É—Å–∫ –∫–∞—Å—Ç–æ–º-—ç–∫—Å–ø–æ—Ä—Ç–∞
  customExport?.addEventListener('click', async ()=>{
    const rows = collectFilteredRowsForExport();
    if (!rows.length){ alert('–ù–µ—Ç —Å—Ç—Ä–æ–∫, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã.'); return; }

    // –∂—ë—Å—Ç–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫
    const ORDER = ['vin','brand','model','config_code','date','time','line','unit','defect','comment','grade','controller','responsible','photos'];
    const chosen = ORDER.filter(k=>{
      const el = document.querySelector(`.col-opt[value="${k}"]`);
      return el && el.checked;
    });
    if (!chosen.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É.'); return; }

    const payload = { rows, columns: chosen };
    if (chosen.includes('photos')){
      const n = parseInt(photoLimitInput.value, 10);
      if (!isNaN(n) && n >= 1) payload.photo_limit = n;
    }

    closeCustom();
    await postAndDownload(exportUrlCustom, payload, 'export_custom.xlsx', customExport);
  });

  /* ====== helper: —Å–æ–±—Ä–∞—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∫ —Å–µ–π—á–∞—Å) ====== */
  function collectFilteredRowsForExport(){
    const result = [];
    groups.forEach(g => {
      g.rows.forEach(row => {
        if (!rowMatchesAll(row, g)) return;
        const dtText = (getCellText(row, 'date') || '').trim();
        const [date = '', time = ''] = dtText.split(' ');
        result.push({
          vin: g.vin,
          brand: g.brand || '',
          model: g.model || '',
          config_code: g.config || '',
          date: date,
          time: time,
          line: getCellText(row, 'line') || '',
          unit: getCellText(row, 'unit') || '',
          defect: getCellText(row, 'defect') || '',
          comment: getCellText(row, 'comment') || '',
          grade: getCellText(row, 'grade') || '',
          controller: getCellText(row, 'controller') || '',
          photos: photosFromRow(row) || []
        });
      });
    });
    return result;
  }

  /* ====== helper: POST -> —Å–∫–∞—á–∞—Ç—å blob ====== */
  async function postAndDownload(url, payload, fallbackName='export.xlsx', btnForState=null){
    const prev = btnForState?.innerHTML;
    if (btnForState){ btnForState.disabled = true; btnForState.innerHTML = '–ì–æ—Ç–æ–≤–ª—é‚Ä¶'; }
    try{
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCsrfToken()},
        credentials:'same-origin',
        body: JSON.stringify(payload||{})
      });
      if (!res.ok){
        const msg = await res.text().catch(()=> '');
        throw new Error(msg || `–û—à–∏–±–∫–∞ (${res.status})`);
      }
      const blob = await res.blob();
      let filename = fallbackName;
      const dispo = res.headers.get('Content-Disposition') || '';
      const m = dispo.match(/filename\*?=(?:UTF-8''|")?([^";]+)[";]?/i);
      if (m && m[1]) filename = decodeURIComponent(m[1]);

      const urlObj = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = urlObj; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(urlObj);
    } catch(e){
      alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç: ${e.message || e}`);
    } finally {
      if (btnForState){ btnForState.disabled = false; btnForState.innerHTML = prev; }
    }
  }

  /* ====== –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø–æ–≤–µ—Ä–æ–≤ –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π ====== */
  function placePop(el, anchor){
    const r = anchor.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const width = Math.min(420, Math.max(280, 360));
    el.style.minWidth = width+'px';
    let left = r.left, top = r.bottom + 6;
    if (left + width + 16 > vw) left = vw - width - 16;
    el.style.left = left + 'px';
    el.style.top  = top  + 'px';
  }



  // üëá –≠–¢–ò –î–í–ï –°–¢–†–û–ö–ò –ù–£–ñ–ù–´ (—Å–µ–ª–µ–∫—Ç—ã —Å–≤–µ—Ä—Ö—É —Ç–∞–±–ª–∏—Ü—ã)
  const modelFilterSel  = document.getElementById('filter-model');
  const defectFilterSel = document.getElementById('filter-defect');

    // --- —Å–æ–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—ã (–ø–æ VIN)
  const groups = [];
  function rebuildGroups(){
    groups.length = 0;
    let cur = null;
    document.querySelectorAll('tbody tr').forEach(row => {
      const c0 = row.children[0];
      const isVin = !!(c0 && c0.hasAttribute('rowspan') && c0.dataset && ('brand' in c0.dataset));
      if (isVin) {
        if (cur) groups.push(cur);
        const brand  = c0.dataset.brand?.trim()  || '';
        const model  = c0.dataset.model?.trim()  || '';
        const config = c0.dataset.config?.trim() || '';
        const vinTxt = (c0.querySelector('a')?.textContent || c0.textContent || '')
                        .trim().split('\n')[0].trim();
        cur = { rows:[row], first:row, vin:vinTxt, brand, model, config };
      } else if (cur) {
        cur.rows.push(row);
      }
    });
    if (cur) groups.push(cur);
  }
  rebuildGroups();

  function refreshVinSpans(){
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é VIN-—è—á–µ–π–∫—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π rowspan —É –≤–∏–¥–∏–º—ã—Ö —Ä—è–¥–æ–≤ –≥—Ä—É–ø–ø—ã
    groups.forEach(g => {
      const vis = g.rows.filter(r => r.style.display !== 'none');
      const vinCell = g.first.children[0];
      if (!vinCell || !vinCell.hasAttribute('rowspan') || !('brand' in vinCell.dataset)) return;
      if (vis.length === 0) return;        // –≤—Å—è –≥—Ä—É–ø–ø–∞ —Å–∫—Ä—ã—Ç–∞

      // –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è –≤–∏–¥–∏–º–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω–µ —Ç–∞, –≥–¥–µ —Å—Ç–æ–∏—Ç VIN-—è—á–µ–π–∫–∞, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –µ—ë
      if (vis[0] !== g.first) {
        // —É–±—Ä–∞—Ç—å VIN-—è—á–µ–π–∫—É –∏–∑ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –Ω–æ–≤—É—é, –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ
        vinCell.remove();
        vis[0].insertBefore(vinCell, vis[0].firstChild);
        g.first = vis[0];                  // –æ–±–Ω–æ–≤–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ "–ø–µ—Ä–≤—É—é" –≤ –≥—Ä—É–ø–ø–µ
      }
      // –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π rowspan = —á–∏—Å–ª–æ –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
      vinCell.rowSpan = vis.length;
    });
  }

  function hasVinCell(row){
    const c0 = row.children[0];
    // VIN-—è—á–µ–π–∫–∞: –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤—ã–π <td>, –∏–º–µ–µ—Ç rowspan –∏ data-–∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞
    return !!(c0 && c0.hasAttribute('rowspan') && c0.dataset && ('brand' in c0.dataset));
  }

  // --- helpers –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ —Å—Ç—Ä–æ–∫–∏ (–ø–æ –∏–Ω–¥–µ–∫—Å–∞–º –∫–æ–ª–æ–Ω–æ–∫)
  function getCellText(row, colKey){
    // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≥—Ä—É–ø–ø—ã —Å–æ–¥–µ—Ä–∂–∏—Ç td[rowspan] (VIN), –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –Ω–µ—Ç
    const shift = hasVinCell(row) ? 0 : -1;

    // –ë–ê–ó–û–í–´–ï –∏–Ω–¥–µ–∫—Å—ã –∫–∞–∫ –±—É–¥—Ç–æ VIN-—è—á–µ–π–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    const baseIdx = {
      date: 1,      // –î–∞—Ç–∞, –≤—Ä–µ–º—è
      line: 2,      // –õ–∏–Ω–∏—è
      unit: 3,      // –î–µ—Ç–∞–ª—å
      defect: 4,    // –î–µ—Ñ–µ–∫—Ç
      comment: 5,   // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      grade: 6,     // –ì—Ä–µ–π–¥
      controller: 7 // –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä (–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è ¬´–ö—Ç–æ –≤–∏–Ω–æ–≤–∞—Ç¬ª —Å–¥–≤–∏–Ω—É–ª—Å—è)
    };

    const idx = baseIdx[colKey];
    if (idx === undefined) return '';
    const cell = row.children[idx + shift];

    if (colKey === 'controller') {
      // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–Ω (–ø–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç –¥–æ <small>)
      const firstText = (cell?.childNodes[0]?.textContent || '').trim();
      return firstText || (cell?.textContent || '').trim();
    }
    return (cell?.textContent || '').trim();
  }

  // === merge –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö "–î–∞—Ç–∞, –≤—Ä–µ–º—è" –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã VIN ===
  function getDateCellEl(row){
    // —É –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≥—Ä—É–ø–ø—ã –µ—Å—Ç—å td[rowspan] —Å VIN ‚Üí –¥–∞—Ç–∞ –≤ children[1]
    // —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî –¥–∞—Ç–∞ –≤ children[0]
    const idx = hasVinCell(row) ? 1 : 0;
    return row.children[idx] || null;
  }

  function resetDateMerging(){
    // —Å–Ω–∏–º–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ rowspan/—Å–∫—Ä—ã—Ç–∏—è
    document.querySelectorAll('tbody tr').forEach(row => {
      const c = getDateCellEl(row);
      if (c){
        c.style.display = '';
        c.removeAttribute('rowspan');
      }
    });
  }

  function mergeVisibleDateCells(){
    // –ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º VIN –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –¥–∞—Ç—ã
    groups.forEach(g => {
      const visRows = g.rows.filter(r => r.style.display !== 'none');
      let i = 0;
      while (i < visRows.length){
        const c0 = getDateCellEl(visRows[i]);
        const t0 = (c0?.textContent || '').trim();
        let j = i + 1;
        while (j < visRows.length){
          const cj = getDateCellEl(visRows[j]);
          const tj = (cj?.textContent || '').trim();
          if (tj === t0) j++; else break;
        }
        const span = j - i;
        if (c0 && span > 1){
          c0.rowSpan = span;
          for (let k = i + 1; k < j; k++){
            const ck = getDateCellEl(visRows[k]);
            if (ck) ck.style.display = 'none';
          }
        }
        i = j;
      }
    });
  }

  function refreshDateMerging(){
    resetDateMerging();
    mergeVisibleDateCells();
  }

  // --- –ø–∞—Ä—Å–∏–Ω–≥ dd.mm.yyyy HH:MM ‚Üí Date
  function parseRusDateTime(s){
    if (!s) return null;
    const [dpart,tpart='00:00'] = s.split(' ');
    const [dd,mm,yyyy] = dpart.split('.').map(n=>parseInt(n,10));
    const [HH,MM] = tpart.split(':').map(n=>parseInt(n,10)||0);
    if (!yyyy||!mm||!dd) return null;
    return new Date(yyyy, mm-1, dd, HH, MM, 0, 0);
  }

  function sameYMD(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function toMin(hhmm){
    if (!hhmm) return null;
    const [h,m] = hhmm.split(':').map(n=>parseInt(n,10)||0);
    return h*60 + m;
  }
  function timePasses(dt){
    // —Ä–µ–∂–∏–º —Å–º–µ–Ω
    const tm = dt.getHours()*60 + dt.getMinutes();
    const tf = toMin(state.timeFrom);
    const tt = toMin(state.timeTo);

    if (state.shiftMode === 's1'){
      // 07:30 ‚Äî 16:30
      return tm >= (7*60+30) && tm <= (16*60+30);
    }
    if (state.shiftMode === 's2'){
      // 16:30 ‚Äî 07:30 (—á–µ—Ä–µ–∑ –Ω–æ—á—å)
      return (tm >= (16*60+30)) || (tm <= (7*60+30));
    }

    // —Ä–µ–∂–∏–º "–í—Å–µ": –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω—ã–µ –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã)
    if (tf==null && tt==null) return true;

    // –∫–æ–≥–¥–∞ –æ–±–µ –≥—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞–Ω—ã
    if (tf!=null && tt!=null){
      if (tf === tt){
        // –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π "07:30 -> 07:30": 24—á –æ–∫–Ω–æ, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –Ω–∞—á–∞–ª—É/–∫–æ–Ω—Ü—É –¥–∞—Ç
        if (state.dateFrom && sameYMD(dt, state.dateFrom)) return tm >= tf;
        if (state.dateTo   && sameYMD(dt, state.dateTo))   return tm < tt;
        return true; // –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–Ω–µ–π –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
      }
      if (tf < tt){
        return tm >= tf && tm <= tt;
      } else {
        // –¥–∏–∞–ø–∞–∑–æ–Ω —á–µ—Ä–µ–∑ –Ω–æ—á—å
        return (tm >= tf) || (tm <= tt);
      }
    }

    // –æ–¥–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞
    if (tf!=null) { if (tm < tf) return false; }
    if (tt!=null) { if (tm > tt) return false; }
    return true;
  }
  function dateTimePasses(dt){
    if (state.dateFrom && dt < floorDate(state.dateFrom)) return false;
    if (state.dateTo   && dt > ceilDate(state.dateTo))     return false;
    return timePasses(dt);
  }

  // --- —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  const state = {
    // VIN-–∫–æ–º–±–æ
    vinText: '',                 // –ø–æ–¥—Å—Ç—Ä–æ–∫–∞ VIN (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    brand: new Set(),            // –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π
    model: new Set(),
    config: new Set(),
    // –î–∞—Ç–∞/–≤—Ä–µ–º—è
    dateFrom: null,              // Date –∏–ª–∏ null
    dateTo:   null,              // Date –∏–ª–∏ null
    timeFrom: '',                // "HH:MM" –∏–ª–∏ ''
    timeTo:   '',                // "HH:MM" –∏–ª–∏ ''
    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ¬´–ø–æ –∫–æ–ª–æ–Ω–∫–∞–º¬ª
    line: new Set(),
    unit: new Set(),
    defect: new Set(),
    grade: new Set(),
    controller: new Set(),
    uiModel:  '',  // –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ "–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏" (lowercase)
    uiDefect: '',  // –∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ "–§–∏–ª—å—Ç—Ä –ø–æ –¥–µ—Ñ–µ–∫—Ç—É" (lowercase)
    searchText: '',     // –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
    hasDefect: 'all',   // 'all' | 'yes' | 'no'
    shiftMode: 'all',   // 'all' | 's1' | 's2'
  };

  // --- –∫–∞–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Å—á–∏—Ç–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º–∏
  function buttonActive(key){
    if (key==='vin'){
      return !!(state.vinText || state.brand.size || state.model.size || state.config.size);
    }
    if (key==='date'){
      return !!(state.dateFrom || state.dateTo || state.timeFrom || state.timeTo);
    }
    return state[key] && state[key].size>0;
  }

  // --- –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (–≥—Ä—É–ø–ø–∞–º–∏)
  function applyFilters(){
    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
    filterBtns.forEach(btn => btn.classList.toggle('active', buttonActive(btn.dataset.col)));

    groups.forEach(g => {
      const matchesGroup = g.rows.some(row => rowMatchesAll(row, g));
      g.rows.forEach(r => r.style.display = matchesGroup ? '' : 'none');
    });

  }



  function rowMatchesAll(row, groupMeta){
    // --- —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –≤–µ—Ä—Ö–Ω–∏—Ö —Å–µ–ª–µ–∫—Ç–æ–≤
    const uiModel  = (state.uiModel  || '').trim().toLowerCase();
    const uiDefect = (state.uiDefect || '').trim().toLowerCase();

    if (uiModel){
      const gm = (groupMeta.model || '').toLowerCase();
      if (!gm.includes(uiModel)) return false;
    }
    if (uiDefect){
      const defectText = (getCellText(row, 'defect') || '').toLowerCase();
      if (!defectText.includes(uiDefect)) return false;
    }

    // --- VIN-–∫–æ–º–±–æ
    if (state.vinText && !groupMeta.vin.toLowerCase().includes(state.vinText.toLowerCase())) return false;
    if (state.brand.size && !state.brand.has(groupMeta.brand))   return false;
    if (state.model.size && !state.model.has(groupMeta.model))   return false;
    if (state.config.size && !state.config.has(groupMeta.config))return false;

    // --- –î–∞—Ç–∞/–≤—Ä–µ–º—è (—á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é –ª–æ–≥–∏–∫—É —Å–æ —Å–º–µ–Ω–∞–º–∏)
    {
      const dt = parseRusDateTime(getCellText(row, 'date'));
      if (!dt || !dateTimePasses(dt)) return false;
    }

    // --- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
    if (state.searchText){
      const hayGroup = [groupMeta.vin, groupMeta.brand, groupMeta.model, groupMeta.config]
                        .join(' ').toLowerCase();
      const rowBundle = [
        getCellText(row, 'date'),
        getCellText(row, 'line'),
        getCellText(row, 'unit'),
        getCellText(row, 'defect'),
        getCellText(row, 'comment'),
        getCellText(row, 'grade'),
        getCellText(row, 'controller'),
      ].join(' ').toLowerCase();
      if (!hayGroup.includes(state.searchText) && !rowBundle.includes(state.searchText)) {
        return false;
      }
    }

    // --- –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ª–∏—á–∏—é –¥–µ—Ñ–µ–∫—Ç–æ–≤
    if (state.hasDefect === 'yes' && !row.classList.contains('table-danger')) return false;
    if (state.hasDefect === 'no'  && !row.classList.contains('table-success')) return false;

    // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ)
    const keys = ['line','unit','defect','grade','controller'];
    for (const k of keys){
      const set = state[k];
      if (set && set.size){
        const v = getCellText(row, k);
        if (!set.has(v)) return false;
      }
    }

    return true;
  }

  function floorDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
  function ceilDate(d){  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }

  // --- —Å–æ–±—Ä–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–µ —Å —É—á—ë—Ç–æ–º –î–†–£–ì–ò–• —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å)
  function visibleRowsExcept(exceptKeys){
    // exceptKeys: Set<string>
    const res = [];
    groups.forEach(g => {
      const show = g.rows.some(row => rowMatchesAllExcept(row, g, exceptKeys));
      if (show) res.push(...g.rows);
    });
    return res;
  }

  function applyTopSelects(){
    state.uiModel   = (modelFilterSel?.value  || '').toLowerCase();
    state.uiDefect  = (defectFilterSel?.value || '').toLowerCase();
    state.searchText = (quickSearch?.value || '').trim().toLowerCase();
    state.hasDefect  = (hasDefectSel?.value || 'all');
    applyFilters();
    rebuildPages();
  }
  modelFilterSel?.addEventListener('change', applyTopSelects);
  defectFilterSel?.addEventListener('change', applyTopSelects);
  quickSearch?.addEventListener('input', applyTopSelects);       // –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ
  hasDefectSel?.addEventListener('change', applyTopSelects);

  function rowMatchesAllExcept(row, g, exceptKeys){
    // –≤–µ—Ä—Ö–Ω–∏–µ —Å–µ–ª–µ–∫—Ç—ã
    if (!exceptKeys.has('uiModel')) {
      const uiModel = (state.uiModel || '').trim().toLowerCase();
      if (uiModel && !(g.model || '').toLowerCase().includes(uiModel)) return false;
    }
    if (!exceptKeys.has('uiDefect')) {
      const uiDefect = (state.uiDefect || '').trim().toLowerCase();
      if (uiDefect && !(getCellText(row, 'defect') || '').toLowerCase().includes(uiDefect)) return false;
    }

    // VIN-–∫–æ–º–±–æ
    if (!exceptKeys.has('vinText') && state.vinText &&
        !g.vin.toLowerCase().includes(state.vinText.toLowerCase())) return false;
    if (!exceptKeys.has('brand')  && state.brand.size   && !state.brand.has(g.brand))   return false;
    if (!exceptKeys.has('model')  && state.model.size   && !state.model.has(g.model))   return false;
    if (!exceptKeys.has('config') && state.config.size  && !state.config.has(g.config)) return false;

    // –¥–∞—Ç–∞/–≤—Ä–µ–º—è ‚Äî –µ–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ —Å–º–µ–Ω–∞–º–∏
    if (!exceptKeys.has('date')) {
      const dt = parseRusDateTime(getCellText(row, 'date'));
      if (!dt || !dateTimePasses(dt)) return false;
    }

    // –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–Ω—ã
    for (const k of ['line','unit','defect','grade','controller']){
      if (exceptKeys.has(k)) continue;
      const set = state[k];
      if (set && set.size){
        const v = getCellText(row, k);
        if (!set.has(v)) return false;
      }
    }
    return true;
  }

  function collectUnique(colKey, baseRows){
    const s = new Set();
    if (colKey==='brand' || colKey==='model' || colKey==='config'){
      // —Å–æ–±–∏—Ä–∞–µ–º —Å —É—Ä–æ–≤–Ω–µ–º –≥—Ä—É–ø–ø
      const okGroups = new Set(baseRows.map(r => r.closest('tr')));
      groups.forEach(g => {
        // –≤–∫–ª—é—á–∞–µ–º, –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≥—Ä—É–ø–ø—ã –≤ baseRows –≤–∏–¥–∏–º–∞
        if (g.rows.some(r => okGroups.has(r))) {
          s.add(g[colKey] || '');
        }
      });
    } else {
      baseRows.forEach(row => {
        const v = getCellText(row, colKey);
        if (v) s.add(v);
      });
    }
    return Array.from(s).filter(Boolean).sort((a,b)=>a.localeCompare(b,'ru',{numeric:true}));
  }

  // --- –ø–æ–ø–æ–≤–µ—Ä
  let openedKey = null;

  resetAllBtn?.addEventListener('click', () => {
    // 1) –∑–∞–∫—Ä—ã—Ç—å –ø–æ–ø–æ–≤–µ—Ä, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
    if (pop) { pop.style.display = 'none'; openedKey = null; }

    // 2) —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–≤–µ—Ä—Ö—É
    if (modelFilterSel)  modelFilterSel.value  = '';
    if (defectFilterSel) defectFilterSel.value = '';
    if (quickSearch)     quickSearch.value     = '';
    if (hasDefectSel)    hasDefectSel.value    = 'all';

    // 3) —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    state.uiModel   = '';
    state.uiDefect  = '';
    state.searchText = '';
    state.hasDefect  = 'all';

    state.vinText = '';
    state.brand.clear();
    state.model.clear();
    state.config.clear();

    state.dateFrom = null;
    state.dateTo   = null;
    state.timeFrom = '';
    state.timeTo   = '';
    state.shiftMode = 'all';

    ['line','unit','defect','grade','controller'].forEach(k => state[k].clear());

    // 4) —Å–Ω—è—Ç—å "–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫-–≤–æ—Ä–æ–Ω–æ–∫
    filterBtns.forEach(b => b.classList.remove('active'));

    // 5) –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é (–≤ –Ω–∞—á–∞–ª–æ)
    paging.current = 1;
    applyFilters();
    rebuildGroups();      // –æ–±–Ω–æ–≤–∏–º –º–µ—Ç–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º
    refreshVinSpans();    // –ø–µ—Ä–µ–Ω–µ—Å—ë–º VIN-—è—á–µ–π–∫—É –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º rowspan
    rebuildPages();
  });

  filterBtns.forEach(btn => {
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const key = btn.dataset.col;
      if (pop.style.display==='block' && openedKey===key){ pop.style.display='none'; openedKey=null; return; }
      openedKey = key;
      renderPopoverFor(key, btn);
    });
  });

  document.addEventListener('click', (e)=>{
    if (pop.style.display==='block' && !pop.contains(e.target)){
      pop.style.display='none'; openedKey=null;
    }
  });

  btnAll.addEventListener('click', () => {
    if (!openedKey) return;

    // 1) –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    fpBody.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);

    // 2) VIN: –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
    if (openedKey === 'vin') {
      const vinInput = fpBody.querySelector('#f_vin_text');
      if (vinInput) vinInput.value = '';
    }

    // 3) –î–∞—Ç–∞/–≤—Ä–µ–º—è: –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º "–í—Å–µ", —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –∏ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
    if (openedKey === 'date') {
      const modeInp = fpBody.querySelector('#f_shift_mode');
      const tFrom   = fpBody.querySelector('#f_time_from');
      const tTo     = fpBody.querySelector('#f_time_to');
      const btns    = fpBody.querySelectorAll('.shift-btn');

      // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –≤ "all"
      if (modeInp) modeInp.value = 'all';

      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å–º–µ–Ω
      btns.forEach(b => {
        const on = b.dataset.mode === 'all';
        b.classList.toggle('btn-success', on);
        b.classList.toggle('active', on);
        b.classList.toggle('btn-outline-secondary', !on);
      });

      // —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º—è
      if (tFrom) { tFrom.disabled = false; tFrom.value = ''; }
      if (tTo)   { tTo.disabled   = false; tTo.value   = ''; }

      // –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞—Ç—ã
      const df = fpBody.querySelector('#f_date_from');
      const dt = fpBody.querySelector('#f_date_to');
      if (df) df.value = '';
      if (dt) dt.value = '';
    }
  });

  btnNone.addEventListener('click', () => {
    if (!openedKey) return;
    const boxes = fpBody.querySelectorAll('input[type=checkbox]');
    if (boxes.length) {
      boxes.forEach(cb => cb.checked = false);
    }
    // –¥–ª—è VIN —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º; –¥–ª—è –¥–∞—Ç—ã —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  });

  btnReset.addEventListener('click', ()=>{
    if (!openedKey) return;
    if (openedKey==='vin'){
      state.vinText=''; state.brand.clear(); state.model.clear(); state.config.clear();
    } else if (openedKey==='date'){
      state.dateFrom=null; state.dateTo=null; state.timeFrom=''; state.timeTo='';
      state.shiftMode='all';
    } else {
      state[openedKey].clear();
    }
    pop.style.display='none'; openedKey=null;
    applyFilters();
    rebuildPages();
  });

  btnApply.addEventListener('click', () => {
    if (!openedKey) return;

    if (openedKey === 'vin') {
      // —Å–æ–±—Ä–∞—Ç—å: vinText + brand/model/config (—á–µ–∫–±–æ–∫—Å—ã)
      const vinText = fpBody.querySelector('#f_vin_text')?.value || '';
      state.vinText = vinText.trim();
      const chosen = key => {
        const s = new Set();
        fpBody.querySelectorAll(`input[name="f_${key}"]:checked`).forEach(cb => s.add(cb.value));
        return s;
      };
      const allBrand  = fpBody.querySelectorAll(`input[name="f_brand"]`).length;
      const allModel  = fpBody.querySelectorAll(`input[name="f_model"]`).length;
      const allConfig = fpBody.querySelectorAll(`input[name="f_config"]`).length;
      const b = chosen('brand');  state.brand  = (b.size===0 || b.size===allBrand ) ? new Set() : b;
      const m = chosen('model');  state.model  = (m.size===0 || m.size===allModel ) ? new Set() : m;
      const c = chosen('config'); state.config = (c.size===0 || c.size===allConfig) ? new Set() : c;

    } else if (openedKey === 'date') {
      const df = fpBody.querySelector('#f_date_from')?.value || '';
      const dt = fpBody.querySelector('#f_date_to')?.value   || '';
      const tf = fpBody.querySelector('#f_time_from')?.value || '';
      const tt = fpBody.querySelector('#f_time_to')?.value   || '';
      const mode = fpBody.querySelector('#f_shift_mode')?.value || 'all';

      // –¥–∞—Ç—ã
      state.dateFrom = df ? new Date(df + 'T00:00:00') : null;
      state.dateTo   = dt ? new Date(dt + 'T00:00:00') : null;

      // —Ä–µ–∂–∏–º —Å–º–µ–Ω
      state.shiftMode = mode;
      if (mode === 's1') {
        state.timeFrom = '07:30';
        state.timeTo   = '16:30';
      } else if (mode === 's2') {
        state.timeFrom = '16:30';
        state.timeTo   = '07:30';
      } else {
        // 'all' ‚Äî –±–µ—Ä—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        state.timeFrom = tf;
        state.timeTo   = tt;
      }

    } else {
      const chosen = new Set();
      fpBody.querySelectorAll('input[type=checkbox]:checked').forEach(cb => chosen.add(cb.value));
      const total = fpBody.querySelectorAll('input[type=checkbox]').length;
      state[openedKey] = (chosen.size===0 || chosen.size===total) ? new Set() : chosen;
    }

    pop.style.display = 'none';
    openedKey = null;
    applyFilters();
    rebuildPages();
  });

  function renderPopoverFor(key, btn){
    // –±–∞–∑–∞ –¥–ª—è –æ–ø—Ü–∏–π ‚Äî —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏–º—ã –ø–æ–¥ –≤–ª–∏—è–Ω–∏–µ–º –≤—Å–µ—Ö –ø—Ä–æ—á–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const except = new Set(key==='vin' ? ['vinText','brand','model','config']
                           : key==='date' ? ['date'] : [key]);
    const baseRows = visibleRowsExcept(except);

    if (key === 'vin'){
      fpTitle.textContent = '–§–∏–ª—å—Ç—Ä: VIN / –ë—Ä–µ–Ω–¥ / –ú–æ–¥–µ–ª—å / –ö–æ–¥';
      const brands  = collectUnique('brand',  baseRows);
      const models  = collectUnique('model',  baseRows);
      const configs = collectUnique('config', baseRows);
      fpBody.innerHTML = `
        <div class="mb-2">
          <div class="subttl">VIN (–ø–æ–¥—Å—Ç—Ä–æ–∫–∞)</div>
          <input id="f_vin_text" class="form-control form-control-sm" placeholder="–ù–∞–ø—Ä.: SK000123" value="${state.vinText||''}">
        </div>
        <div class="mb-2">
          <div class="subttl">–ë—Ä–µ–Ω–¥</div>
          ${brands.map(v=>`
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="f_brand" id="b_${cssId(v)}" value="${escapeHtml(v)}" ${state.brand.size? (state.brand.has(v)?'checked':'') : 'checked'}>
              <label class="form-check-label" for="b_${cssId(v)}">${escapeHtml(v)}</label>
            </div>`).join('') || '<div class="text-muted small">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>'}
        </div>
        <div class="mb-2">
          <div class="subttl">–ú–æ–¥–µ–ª—å</div>
          ${models.map(v=>`
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="f_model" id="m_${cssId(v)}" value="${escapeHtml(v)}" ${state.model.size? (state.model.has(v)?'checked':'') : 'checked'}>
              <label class="form-check-label" for="m_${cssId(v)}">${escapeHtml(v)}</label>
            </div>`).join('') || '<div class="text-muted small">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>'}
        </div>
        <div class="mb-2">
          <div class="subttl">–ö–æ–¥ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏</div>
          ${configs.map(v=>`
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="f_config" id="c_${cssId(v)}" value="${escapeHtml(v)}" ${state.config.size? (state.config.has(v)?'checked':'') : 'checked'}>
              <label class="form-check-label" for="c_${cssId(v)}">${escapeHtml(v)}</label>
            </div>`).join('') || '<div class="text-muted small">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>'}
        </div>
      `;
    } else if (key === 'date'){
      fpTitle.textContent = '–§–∏–ª—å—Ç—Ä: –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è';
      fpBody.innerHTML = `
        <div class="row g-2 align-items-end">
          <div class="col-6">
            <label class="form-label">–° –¥–∞—Ç—ã</label>
            <input id="f_date_from" type="date" class="form-control form-control-sm" value="${state.dateFrom? isoDate(state.dateFrom):''}">
          </div>
          <div class="col-6">
            <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
            <input id="f_date_to" type="date" class="form-control form-control-sm" value="${state.dateTo? isoDate(state.dateTo):''}">
          </div>

          <div class="col-12">
            <div class="btn-group w-100" role="group" aria-label="–°–º–µ–Ω–∞">
              <button type="button" class="btn btn-outline-secondary shift-btn" data-mode="s1">–°–º–µ–Ω–∞ 1 (07:30‚Äì16:30)</button>
              <button type="button" class="btn btn-outline-secondary shift-btn" data-mode="s2">–°–º–µ–Ω–∞ 2 (16:30‚Äì07:30)</button>
              <button type="button" class="btn btn-outline-secondary shift-btn" data-mode="all">–í—Å–µ</button>
            </div>
            <input type="hidden" id="f_shift_mode" value="${state.shiftMode||'all'}">
          </div>

          <div class="col-6">
            <label class="form-label">–° –≤—Ä–µ–º–µ–Ω–∏</label>
            <input id="f_time_from" type="time" class="form-control form-control-sm" value="${state.timeFrom||''}">
          </div>
          <div class="col-6">
            <label class="form-label">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</label>
            <input id="f_time_to" type="time" class="form-control form-control-sm" value="${state.timeTo||''}">
          </div>
        </div>
        <div class="text-muted small mt-2">–ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–º–µ–Ω—ã –≤—Ä–µ–º—è —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∏ –ø–æ–ª—è –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.</div>
      `;

      const modeInp = fpBody.querySelector('#f_shift_mode');
      const tFrom   = fpBody.querySelector('#f_time_from');
      const tTo     = fpBody.querySelector('#f_time_to');
      const btns    = fpBody.querySelectorAll('.shift-btn');

      function setMode(mode){
        modeInp.value = mode;
        btns.forEach(b=>{
          const on = b.dataset.mode===mode;
          b.classList.toggle('btn-success', on);
          b.classList.toggle('active', on);
          b.classList.toggle('btn-outline-secondary', !on);
        });

        if (mode === 's1'){
          tFrom.value = '07:30';
          tTo.value   = '16:30';
          tFrom.disabled = true;
          tTo.disabled   = true;
        } else if (mode === 's2'){
          tFrom.value = '16:30';
          tTo.value   = '07:30';
          tFrom.disabled = true;
          tTo.disabled   = true;
        } else { // 'all'
          tFrom.disabled = false;
          tTo.disabled   = false;
          // –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ state
          tFrom.value = state.timeFrom || tFrom.value || '';
          tTo.value   = state.timeTo   || tTo.value   || '';
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      setMode(modeInp.value || 'all');
      btns.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));

    } else {
      // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
      fpTitle.textContent = '–§–∏–ª—å—Ç—Ä: ' + (btn.previousElementSibling?.textContent?.trim() || '');
      const opts = collectUnique(key, baseRows);
      fpBody.innerHTML = opts.map(v=>`
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="o_${cssId(v)}" value="${escapeHtml(v)}" ${state[key].size? (state[key].has(v)?'checked':'') : 'checked'}>
          <label class="form-check-label" for="o_${cssId(v)}">${escapeHtml(v)}</label>
        </div>`).join('') || '<div class="text-muted small">–ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π</div>';
    }

    // –ø–æ–∑–∏—Ü–∏—è –ø–æ–ø–æ–≤–µ—Ä–∞ –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
    const r = btn.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    const width = Math.min(340, Math.max(260, r.width*9));
    pop.style.minWidth = width+'px';
    let left = r.left, top = r.bottom + 6;
    if (left + width + 16 > vw) left = vw - width - 16;
    pop.style.left = left + 'px';
    pop.style.top  = top  + 'px';
    pop.style.display = 'block';
  }

  function cssId(s){ return btoa(unescape(encodeURIComponent(s))).replace(/=/g,''); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function isoDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }



   // ====== –ü–ê–ì–ò–ù–ê–¶–ò–Ø (–ª–∏—Å—Ç–∞–º–∏) ======
  const paginationBar = document.getElementById('pagination-bar');
  const pagesWrap = document.querySelector('#page-buttons .pages');
  const navBtns = document.querySelectorAll('#page-buttons .page-nav');
  const pageSizeSel = document.getElementById('page-size');

  const paging = {
    size: parseInt(pageSizeSel?.value,10) || 100,
    pages: [],
    current: 1,
    windowStart: 1
  };

  function matchedGroups() {
    const arr = [];
    groups.forEach((g, idx) => {
      const ok = g.rows.some(row => rowMatchesAll(row, g));
      if (ok) arr.push({g, idx, rows: g.rows.length});
    });
    return arr;
  }

  function rebuildPages() {
    const mg = matchedGroups();
    const totalRows = mg.reduce((s,x)=>s+x.rows, 0);

    if (!paginationBar) return;

    // ‚ùó –µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç—Ä–æ–∫ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    if (totalRows < paging.size) {
      paginationBar.style.display = 'none';
      paging.pages = [];
      paging.current = 1;
      paging.windowStart = 1;

      // –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≥—Ä—É–ø–ø—ã —Ü–µ–ª–∏–∫–æ–º
      groups.forEach(g => {
        const ok = g.rows.some(row => rowMatchesAll(row, g));
        g.rows.forEach(r => r.style.display = ok ? '' : 'none');
      });
      refreshDateMerging();
      return;
    }

    // ... –¥–∞–ª—å—à–µ —Ç–≤–æ–π –∫–æ–¥ —Å–±–æ—Ä–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–∞–∫ –±—ã–ª (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const pages = [];
    let startIdx = 0, rowsFrom = 1, acc = 0;
    for (let i = 0; i < mg.length; i++) {
      const gr = mg[i];
      if (acc > 0 && acc + gr.rows > paging.size) {
        pages.push({ gFrom: startIdx, gTo: i-1, rowsFrom, rowsTo: rowsFrom + acc - 1 });
        startIdx = i;
        rowsFrom = pages[pages.length-1].rowsTo + 1;
        acc = 0;
      }
      acc += gr.rows;
    }
    if (acc > 0) {
      pages.push({ gFrom: startIdx, gTo: mg.length-1, rowsFrom, rowsTo: rowsFrom + acc - 1 });
    }

    paging.pages = pages;
    paging.current = Math.min(paging.current, pages.length) || 1;

    const maxWin = Math.max(1, pages.length - 5 + 1);
    if (paging.current < paging.windowStart) paging.windowStart = paging.current;
    if (paging.current >= paging.windowStart + 5) paging.windowStart = Math.min(paging.current - 4, maxWin);

    renderPager(totalRows);
    showPage(paging.current);
    refreshDateMerging();
  }

  function renderPager(totalRows){
    paginationBar.style.display = '';

    const total = paging.pages.length;
    let from = paging.windowStart;
    let to = Math.min(from + 5 - 1, total);

    pagesWrap.innerHTML = '';
    for (let i = from; i <= to; i++) {
      const b = document.createElement('button');
      b.className = 'page-btn btn btn-sm btn-outline-secondary' + (i===paging.current ? ' active' : '');
      b.textContent = i;
      b.dataset.page = i;
      b.addEventListener('click', ()=>{
        paging.current = i;
        showPage(i);
        renderPager(totalRows);
      });
      pagesWrap.appendChild(b);
    }

    navBtns.forEach(btn=>{
      const dir = parseInt(btn.dataset.dir,10);
      if (total <= 5) {
        btn.style.display = 'none';
      } else {
        btn.style.display = '';
        btn.disabled = (dir<0 ? (from<=1) : (to>=total));
        btn.onclick = () => {
          const step = 1;
          const maxWin = Math.max(1, total - 5 + 1);
          paging.windowStart = Math.min(Math.max(1, paging.windowStart + dir*step), maxWin);
          renderPager(totalRows);
        };
      }
    });
  }

  function showPage(pageNum){
    const mg = matchedGroups();
    const p = paging.pages[pageNum-1];
    // —Å–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ
    mg.forEach(obj => obj.g.rows.forEach(r => r.style.display = 'none'));
    // –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    for (let i = p.gFrom; i <= p.gTo; i++){
      mg[i].g.rows.forEach(r => r.style.display = '');
    }
    // –Ω–∞ –≤—Å—è–∫–∏–π —Å–∫—Ä—ã—Ç—å —Ç–µ, —á—Ç–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä—ã
    const mgIdx = new Set(mg.slice(p.gFrom, p.gTo+1).map(x=>x.idx));
    groups.forEach((g, idx) => {
      if (!mgIdx.has(idx)){
        const ok = mg.find(x=>x.idx===idx);
        if (!ok) g.rows.forEach(r => r.style.display = 'none');
      }
    });
    refreshDateMerging();
  }

  // –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  pageSizeSel?.addEventListener('change', ()=>{
    paging.size = parseInt(pageSizeSel.value,10) || 100;
    paging.current = 1;
    rebuildPages();
  });

  // === –î–ï–§–û–õ–¢: —Å–µ–≥–æ–¥–Ω—è –ø–æ –æ–∫–Ω—É 07:30 ‚Üí 07:30 (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞) ===
  (function setDefaultToday0730(){
    const now = new Date();
    const today0730 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 30, 0, 0);

    // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –¥–æ 07:30 ‚Äî –æ–∫–Ω–æ —ç—Ç–æ "–≤—á–µ—Ä–∞ 07:30 ‚Üí —Å–µ–≥–æ–¥–Ω—è 07:30"
    const start = (now < today0730)
      ? new Date(today0730.getTime() - 24*60*60*1000)
      : today0730;
    const end = (now < today0730)
      ? today0730
      : new Date(today0730.getTime() + 24*60*60*1000);

    // –≤—ã—Å—Ç–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
    state.dateFrom = new Date(start.getFullYear(), start.getMonth(), start.getDate());
    state.dateTo   = new Date(end.getFullYear(),   end.getMonth(),   end.getDate());
    state.timeFrom = "07:30";
    state.timeTo   = "07:30";

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    applyFilters();
    rebuildPages();
  })();

  // üëâ –í–´–ó–û–í–´ –î–û–õ–ñ–ù–´ –ò–î–¢–ò –ü–û–°–õ–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø –í–°–ï–ì–û –í–´–®–ï:
  applyTopSelects();

  // --- –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ç–∞–±–ª–∏—Ü—ã ---

  // –ø—Ä–æ—Å—Ç–∞—è –¥–µ–±–∞—É–Ω—Å-—Ñ—É–Ω–∫—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ –¥—ë—Ä–≥–∞—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
  function _debounce(fn, wait = 120) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  // –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏
  const _repage = _debounce(() => {
    if (typeof rebuildGroups === 'function') rebuildGroups();
    refreshVinSpans();
    if (typeof rebuildPages === 'function') rebuildPages(); // —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  }, 80);

  // 1) —Å–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ tbody (–ø–æ—è–≤–ª–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–æ–∫, –∫–ª–∞—Å—Å/—Å—Ç–∏–ª—å –∏ —Ç.–¥.)
  (function initPaginationAutoRefresh() {
    const table = document.querySelector('table');
    const tbody = table ? table.querySelector('tbody') : null;
    if (!tbody || typeof MutationObserver === 'undefined') return;

    const obs = new MutationObserver(_repage);
    obs.observe(tbody, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['class'] // –±–µ–∑ 'style' –∏ 'hidden'
    });

    // 2) —Å–º–µ–Ω–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–∂–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    const pageSize = document.getElementById('page_size') || document.getElementById('page-size');
    if (pageSize) pageSize.addEventListener('change', _repage);

    // 3) –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ VIN ‚Äî —Ç–æ–∂–µ —Ç—Ä–∏–≥–≥–µ—Ä–∏–º
    const vinSearch = document.getElementById('quick-search');
    if (vinSearch) vinSearch.addEventListener('input', _repage);

    // 4) –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å/–°–±—Ä–æ—Å–∏—Ç—å¬ª –≤ –ø–æ–ø–æ–≤–µ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const pop = document.getElementById('filter-popover');
    if (pop) {
      pop.addEventListener('click', (e) => {
        const id = (e.target.id || '');
        if (id.includes('apply') || id.includes('reset')) _repage();
      });
    }

    // –ø–µ—Ä–≤–∏—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    _repage();
  })();
});
</script>
<!-- –ú–æ–¥–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞—Å—Ç–æ–º-—ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div id="custom-modal" class="modal" style="display:none;">
  <div class="modal-dialog" style="max-width:680px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title m-0">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞</h5>
        <button type="button" class="btn-close" aria-label="Close" id="custom-close-x"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫; –ø—Ä–æ—Å—Ç–æ –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º -->
          <div class="col-6">
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="vin" id="col-vin" checked disabled><label class="form-check-label" for="col-vin">VIN</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="brand" id="col-brand" checked><label class="form-check-label" for="col-brand">–ë—Ä–µ–Ω–¥</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="model" id="col-model" checked><label class="form-check-label" for="col-model">–ú–æ–¥–µ–ª—å</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="config_code" id="col-config" checked><label class="form-check-label" for="col-config">–ö–æ–¥ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="date" id="col-date" checked><label class="form-check-label" for="col-date">–î–∞—Ç–∞</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="time" id="col-time" checked><label class="form-check-label" for="col-time">–í—Ä–µ–º—è</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="line" id="col-line" checked><label class="form-check-label" for="col-line">–õ–∏–Ω–∏—è</label></div>
          </div>
          <div class="col-6">
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="unit" id="col-unit" checked><label class="form-check-label" for="col-unit">–î–µ—Ç–∞–ª—å</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="defect" id="col-defect" checked><label class="form-check-label" for="col-defect">–î–µ—Ñ–µ–∫—Ç</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="comment" id="col-comment" checked><label class="form-check-label" for="col-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="grade" id="col-grade" checked><label class="form-check-label" for="col-grade">–ì—Ä–µ–π–¥</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="controller" id="col-controller" checked><label class="form-check-label" for="col-controller">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</label></div>
            <div class="form-check mb-1"><input class="form-check-input col-opt" type="checkbox" value="responsible" id="col-resp"><label class="form-check-label" for="col-resp">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label></div>

            <div class="form-check mt-2 mb-1">
              <input class="form-check-input col-opt" type="checkbox" value="photos" id="col-photos">
              <label class="form-check-label" for="col-photos">–§–æ—Ç–æ</label>
            </div>
            <div id="photo-limit-wrap" class="ms-4" style="display:none;">
              <label for="photo-limit" class="form-label">–ú–∞–∫—Å. —Ñ–æ—Ç–æ –Ω–∞ —Å—Ç—Ä–æ–∫—É:</label>
              <input id="photo-limit" type="number" min="1" value="3" class="form-control form-control-sm" style="max-width:120px;">
              <div class="form-text">–ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–æ ‚Äî –±–µ—Ä—ë—Ç—Å—è –º–∞–∫—Å–∏–º—É–º –ø–æ –¥–∞–Ω–Ω—ã–º.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div>
          <button id="custom-select-all" class="btn btn-outline-secondary btn-sm" type="button">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
          <button id="custom-unselect-all" class="btn btn-outline-secondary btn-sm" type="button">–°–Ω—è—Ç—å –≤—Å–µ</button>
        </div>
        <div>
          <button id="custom-cancel" class="btn btn-outline-secondary" type="button">–û—Ç–º–µ–Ω–∞</button>
          <button id="custom-export" class="btn btn-success" type="button">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
