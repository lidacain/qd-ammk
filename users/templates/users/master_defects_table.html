{% extends "users/base.html" %}

{% block title %}–í—Å–µ –¥–µ—Ñ–µ–∫—Ç—ã{% endblock %}

{% block content %}
<div class="container">

    <a href="{% url 'master_dashboard' %}" class="btn btn-secondary my-3">‚¨Ö –ù–∞–∑–∞–¥ –≤ –î—ç—à–±–æ—Ä–¥</a>

    <h2 class="text-center mt-3">üìã –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤</h2>

    <!-- üîÑ –§–∏–ª—å—Ç—Ä—ã -->
    <div class="row my-3 align-items-end">
        <div class="col-md-3">
            <label for="filter-date-start">–°:</label>
            <input type="date" id="filter-start-date" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="filter-date-end">–ü–æ:</label>
            <input type="date" id="filter-end-date" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="search-detail">–î–µ—Ç–∞–ª—å:</label>
            <input type="text" id="search-detail" class="form-control" placeholder="üîç –î–µ—Ç–∞–ª—å">
        </div>
        <div class="col-md-3">
            <label for="search-defect">–î–µ—Ñ–µ–∫—Ç:</label>
            <input type="text" id="search-defect" class="form-control" placeholder="üîç –î–µ—Ñ–µ–∫—Ç">
        </div>
    </div>

    <div class="row my-3">
        <div class="col-md-3">
            <label for="search-container">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:</label>
            <input type="text" id="search-container" class="form-control" placeholder="üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä">
        </div>
        <div class="col-md-3">
            <label for="search-pallet">–ü–∞–ª–µ—Ç–∞:</label>
            <input type="text" id="search-pallet" class="form-control" placeholder="üîç –ü–∞–ª–µ—Ç–∞">
        </div>
    </div>

    <!-- üîÑ –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <button id="refresh-btn" class="btn btn-primary my-3">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>

<!-- üìä –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
<table class="table table-bordered table-striped" id="defects-table">
    <thead>
        <tr>
            <th onclick="sortTable(0)">‚Ññ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚¨ç</th>
            <th onclick="sortTable(1)">‚Ññ –ü–∞–ª–µ—Ç—ã ‚¨ç</th>
            <th onclick="sortTable(2)">–î–µ—Ç–∞–ª—å ‚¨ç</th>
            <th onclick="sortTable(3)">–î–µ—Ñ–µ–∫—Ç ‚¨ç</th>
            <th>–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</th>
            <th>–§–æ—Ç–æ –ø–∞–ª–µ—Ç—ã</th>
            <th>–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤</th>
            <th onclick="sortTable(7)">–ö—Ç–æ –≤–Ω–µ—Å ‚¨ç</th>
            <th onclick="sortTable(8)">–î–∞—Ç–∞ ‚¨ç</th>
        </tr>
    </thead>
    <tbody id="defects-table-body">
        {% for defect in defects %}
            <tr>
                <td>{{ defect.container_number }}</td>
                <td>{{ defect.pallet_number }}</td>
                <td>{{ defect.detail.name|default:"-" }}</td>
                <td>{{ defect.defect.name|default:"-" }}</td>
                <td>
                    {% if defect.container_image %}
                        <img src="{{ defect.container_image.url }}" class="clickable-img" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" width="100">
                    {% else %}-{% endif %}
                </td>
                <td>
                    {% if defect.pallet_image %}
                        <img src="{{ defect.pallet_image.url }}" class="clickable-img" alt="–§–æ—Ç–æ –ø–∞–ª–µ—Ç—ã" width="100">
                    {% else %}-{% endif %}
                </td>
                <td>
                    {% for image in defect.get_defect_images %}
                        <img src="{{ image }}" class="clickable-img" alt="–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞" width="100">
                    {% endfor %}
                </td>
                <td>{{ defect.controller.username|default:"-" }}</td>
                <td>{{ defect.created_at|date:"d.m.Y H:i" }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<!-- üîπ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ -->
<div id="image-modal" class="modal" onclick="this.style.display='none'">
    <span class="close">&times;</span>
    <img class="modal-content" id="img-view">
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
.modal-content {
    max-width: 90vw;  /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ 90% —ç–∫—Ä–∞–Ω–∞ */
    max-height: 90vh; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ 90% —ç–∫—Ä–∞–Ω–∞ */
    object-fit: contain; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
.close {
    position: absolute;
    top: 10px;
    right: 20px;
    color: white;
    font-size: 30px;
    font-weight: bold;
    cursor: pointer;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    enableImageClick();
    document.getElementById("image-modal").style.display = "none";
});

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
document.getElementById("refresh-btn").addEventListener("click", function() {
    fetch("{% url 'get_defects' %}")
    .then(response => response.json())
    .then(data => {
        let tableBody = document.getElementById("defects-table-body");
        tableBody.innerHTML = "";

        data.forEach(defect => {
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${defect.container_number || "-"}</td>
                <td>${defect.pallet_number || "-"}</td>
                <td>${defect.detail_name || "-"}</td>
                <td>${defect.defect_name || "-"}</td>
                <td>${defect.container_image ? `<img src="${defect.container_image}" class="clickable-img" width="100">` : "-"}</td>
                <td>${defect.pallet_image ? `<img src="${defect.pallet_image}" class="clickable-img" width="100">` : "-"}</td>
                <td>${defect.defect_images.length > 0 ? defect.defect_images.map(img => `<img src="${img}" class="clickable-img" width="100">`).join(" ") : "-"}</td>
                <td>${defect.controller_username || "-"}</td>
                <td>${defect.created_at}</td>
            `;

            tableBody.appendChild(row);
        });

        applyFilters();
        enableImageClick();
    });
});

// üîπ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
function applyFilters() {
    let searchContainer = document.getElementById("search-container").value.toLowerCase();
    let searchPallet = document.getElementById("search-pallet").value.toLowerCase();
    let searchDetail = document.getElementById("search-detail").value.toLowerCase();
    let searchDefect = document.getElementById("search-defect").value.toLowerCase();
    let filterStartDate = document.getElementById("filter-start-date").value;
    let filterEndDate = document.getElementById("filter-end-date").value;

    document.querySelectorAll("#defects-table-body tr").forEach(row => {
        let container = row.children[0].innerText.toLowerCase();
        let pallet = row.children[1].innerText.toLowerCase();
        let detail = row.children[2].innerText.toLowerCase();
        let defect = row.children[3].innerText.toLowerCase();
        let dateText = row.children[8].innerText.trim(); // –î–∞—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
        let date = new Date(dateText.split('.').reverse().join('-')); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –æ–±—ä–µ–∫—Ç –¥–∞—Ç—ã

        let matchContainer = searchContainer === "" || container.includes(searchContainer);
        let matchPallet = searchPallet === "" || pallet.includes(searchPallet);
        let matchDetail = searchDetail === "" || detail.includes(searchDetail);
        let matchDefect = searchDefect === "" || defect.includes(searchDefect);

        let matchDate = true;
        if (filterStartDate) {
            let startDate = new Date(filterStartDate);
            matchDate = date >= startDate;
        }
        if (filterEndDate) {
            let endDate = new Date(filterEndDate);
            matchDate = matchDate && date <= endDate;
        }

        row.style.display = (matchContainer && matchPallet && matchDetail && matchDefect && matchDate) ? "" : "none";
    });
}

// üîπ –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
document.querySelectorAll("#search-container, #search-pallet, #search-detail, #search-defect, #filter-start-date, #filter-end-date")
    .forEach(input => input.addEventListener("input", applyFilters));

// üîπ –§—É–Ω–∫—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞
function enableImageClick() {
    document.querySelectorAll(".clickable-img").forEach(img => {
        img.addEventListener("click", function() {
            let modal = document.getElementById("image-modal");
            let imgView = document.getElementById("img-view");

            imgView.src = this.src;
            modal.style.display = "flex";  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

            // ‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
            imgView.style.maxWidth = "90vw";
            imgView.style.maxHeight = "90vh";
        });
    });
}

// ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.getElementById("image-modal").addEventListener("click", function(event) {
    if (event.target === this) {
        this.style.display = "none";
    }
});

// üîπ –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function sortTable(n) {
    let table = document.getElementById("defects-table");
    let tbody = table.querySelector("tbody");
    let rows = Array.from(tbody.querySelectorAll("tr"));
    let isAscending = table.rows[0].cells[n].getAttribute("data-order") === "asc";

    rows.sort((rowA, rowB) => {
        let cellA = rowA.cells[n].innerText.trim().toLowerCase();
        let cellB = rowB.cells[n].innerText.trim().toLowerCase();

        // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ —Å –¥–∞—Ç–æ–π, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ–±—ä–µ–∫—Ç—ã –¥–∞—Ç—ã
        if (n === 8) {
            return isAscending
                ? new Date(cellA) - new Date(cellB)
                : new Date(cellB) - new Date(cellA);
        }

        return isAscending ? cellA.localeCompare(cellB, 'ru') : cellB.localeCompare(cellA, 'ru');
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    table.rows[0].cells[n].setAttribute("data-order", isAscending ? "desc" : "asc");

    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}