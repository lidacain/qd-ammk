{% extends "users/base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å{% endblock %}
{% block content %}

<div class="text-center">
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}</h2>
    <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ø–æ—Å—Ç–∞, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤.</p>

    <div id="qr-reader" style="width: 300px; margin: auto;"></div>
    <p id="qr-result" class="mt-3 text-danger"></p>

    <button id="start_qr_scan" class="btn btn-primary mt-3">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>

    {% if is_controller and recent_posts %}
        <div class="mt-4">
            <h5>–ù–µ–¥–∞–≤–Ω–∏–µ –ø–æ—Å—Ç—ã:</h5>
            <div class="d-grid gap-2 col-6 mx-auto">
                {% for p in recent_posts|slice:":2" %}
                    <a href="{{ p.href }}" class="btn btn-outline-primary">{{ p.label }}</a>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {% if perms.users.show_buttons_to_fi_posts_for_controllers %}
        <div class="mt-4">
            <h5>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –≤—Ä—É—á–Ω—É—é:</h5>
            <div class="d-grid gap-2 col-6 mx-auto">
                <a href="{% url 'assembly:gaps_and_drops' %}?post_id=18" class="btn btn-outline-secondary">–ó–∞–∑–æ—Ä—ã –∏ –ø–µ—Ä–µ–ø–∞–¥—ã</a>
                <a href="{% url 'assembly:exterior' %}?post_id=19" class="btn btn-outline-secondary">–≠–∫—Å—Ç–µ—Ä—å–µ—Ä</a>
                <a href="{% url 'assembly:interior' %}?post_id=32" class="btn btn-outline-secondary">–ò–Ω—Ç–µ—Ä—å–µ—Ä</a>
                <a href="{% url 'assembly:trunk' %}?post_id=20" class="btn btn-outline-secondary">–ë–∞–≥–∞–∂–Ω–∏–∫</a>
                <a href="{% url 'assembly:the_motor' %}?post_id=21" class="btn btn-outline-secondary">–ú–æ—Ç–æ—Ä</a>
                <a href="{% url 'assembly:functional' %}?post_id=22" class="btn btn-outline-secondary">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</a>
            </div>
        </div>
    {% endif %}
    <div class="mt-4">
        <h5>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –≤—Ä—É—á–Ω—É—é:</h5>
        <div class="d-grid gap-2 col-6 mx-auto">
            {% if perms.users.access_to_post_of_the_controller %}
                <a href="{% url 'assembly:torque_control_chery' %}?post_id=34" class="btn btn-outline-secondary">–ú–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–µ–∫ (Chery)</a>
                <a href="{% url 'assembly:torque_control_gwm' %}?post_id=34" class="btn btn-outline-secondary">–ú–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–µ–∫ (GWM)</a>
                <a href="{% url 'assembly:torque_control_changan' %}?post_id=34" class="btn btn-outline-secondary">–ú–æ–º–µ–Ω—Ç –∑–∞—Ç—è–∂–µ–∫ (Changan)</a>

                <a href="{% url 'assembly:chassis_chery' %}?post_id=17" class="btn btn-outline-secondary">Chassis (Chery)</a>
                <a href="{% url 'assembly:chassis_gwm' %}?post_id=17" class="btn btn-outline-secondary">Chassis (GWM)</a>
                <a href="{% url 'assembly:chassis_frame' %}?post_id=17" class="btn btn-outline-secondary">Chassis (Frame line)</a>
                <a href="{% url 'assembly:chassis_changan' %}?post_id=17" class="btn btn-outline-secondary">Chassis (Changan)</a>

                <a href="{% url 'assembly:final_current_control_chery' %}?post_id=13" class="btn btn-outline-secondary">–§–∏–Ω–∞–ª —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (Chery)</a>
                <a href="{% url 'assembly:final_current_control_gwm' %}?post_id=13" class="btn btn-outline-secondary">–§–∏–Ω–∞–ª —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (GWM)</a>
                <a href="{% url 'assembly:final_current_control_frame' %}?post_id=13" class="btn btn-outline-secondary">–§–∏–Ω–∞–ª —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (Frame line)</a>
                <a href="{% url 'assembly:final_current_control_changan' %}?post_id=13" class="btn btn-outline-secondary">–§–∏–Ω–∞–ª —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å (Changan)</a>

                <a href="{% url 'assembly:gaps_and_drops' %}?post_id=18" class="btn btn-outline-secondary">–ó–∞–∑–æ—Ä—ã –∏ –ø–µ—Ä–µ–ø–∞–¥—ã</a>

                <a href="{% url 'assembly:exterior' %}?post_id=19" class="btn btn-outline-secondary">–≠–∫—Å—Ç–µ—Ä—å–µ—Ä</a>

                <a href="{% url 'assembly:interior' %}?post_id=32" class="btn btn-outline-secondary">–ò–Ω—Ç–µ—Ä—å–µ—Ä</a>

                <a href="{% url 'assembly:trunk' %}?post_id=20" class="btn btn-outline-secondary">–ë–∞–≥–∞–∂–Ω–∏–∫</a>

                <a href="{% url 'assembly:the_motor' %}?post_id=21" class="btn btn-outline-secondary">–ú–æ—Ç–æ—Ä–Ω—ã–π –æ—Ç—Å–µ–∫</a>

                <a href="{% url 'assembly:functional' %}?post_id=22" class="btn btn-outline-secondary">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</a>

                <a href="{% url 'assembly:geometry_of_wheels' %}?post_id=23" class="btn btn-outline-secondary">–ì–µ–æ–º–µ—Ç—Ä–∏—è –∫–æ–ª–µ—Å</a>

                <a href="{% url 'assembly:adjusting_the_headlights_and_calibrating_the_steering_wheel' %}?post_id=24" class="btn btn-outline-secondary">–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–≤–µ—Ç–∞ —Ñ–∞—Ä –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä—É–ª—è</a>

                <a href="{% url 'assembly:breaking_system' %}?post_id=25" class="btn btn-outline-secondary">–¢–æ—Ä–º–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</a>

                <a href="{% url 'assembly:underbody' %}?post_id=26" class="btn btn-outline-secondary">Underbody</a>

                <a href="{% url 'assembly:adas_chery' %}?post_id=27" class="btn btn-outline-secondary">ADAS (Chery)</a>
                <a href="{% url 'assembly:adas_gwm' %}?post_id=27" class="btn btn-outline-secondary">ADAS (GWM)</a>
                <a href="{% url 'assembly:adas_changan' %}?post_id=27" class="btn btn-outline-secondary">ADAS (Changan)</a>

                <a href="{% url 'assembly:avm_chery' %}?post_id=28" class="btn btn-outline-secondary">AVM (Chery)</a>
                <a href="{% url 'assembly:avm_gwm' %}?post_id=28" class="btn btn-outline-secondary">AVM (GWM)</a>
                <a href="{% url 'assembly:avm_changan' %}?post_id=28" class="btn btn-outline-secondary">AVM (Changan)</a>

                <a href="{% url 'assembly:tightness_of_the_body' %}?post_id=29" class="btn btn-outline-secondary">–ì–µ—Ä–º–µ—Ç–∏—á–Ω–æ—Å—Ç—å –∫—É–∑–æ–≤–∞</a>

                <a href="{% url 'assembly:diagnostics' %}?post_id=33" class="btn btn-outline-secondary">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</a>

                <a href="{% url 'assembly:test_track' %}?post_id=31" class="btn btn-outline-secondary">–¢–µ—Å—Ç —Ç—Ä–µ–∫</a>

                <a href="{% url 'assembly:documentation' %}?post_id=30" class="btn btn-outline-secondary">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>

                <a href="{% url 'assembly:ves_pass_view' %}?post_id=18" class="btn btn-outline-secondary">VES –ø–µ—Ä–µ–¥–∞—á–∞/–ø—Ä–∏–µ–º</a>

                <a href="{% url 'assembly:uud_uniq' %}?post_id=38" class="btn btn-outline-secondary">–£–£–î –ø–µ—Ä–µ–¥–∞—á–∞/–ø—Ä–∏–µ–º</a>
            {% endif %}

            {% if perms.users.show_buttons_for_vqa_controllers %}
                <a href="{% url 'assembly:ves_pass_view' %}?post_id=18" class="btn btn-outline-secondary">VES –ø–µ—Ä–µ–¥–∞—á–∞/–ø—Ä–∏–µ–º</a>

                <a href="{% url 'assembly:uud_uniq' %}?post_id=38" class="btn btn-outline-secondary">–£–£–î –ø–µ—Ä–µ–¥–∞—á–∞/–ø—Ä–∏–µ–º</a>
            {% endif %}

            {% if perms.users.show_button_counter_changan %}
                <a href="{% url 'assembly:counter_changan' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM IN (Changan)</a>
            {% endif %}

            {% if perms.users.show_button_counter_chery %}
                <a href="{% url 'assembly:counter_chery' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM IN (Chery)</a>
            {% endif %}

            {% if perms.users.show_button_counter_gwm %}
                <a href="{% url 'assembly:counter_gwm' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM IN (GWM)</a>
            {% endif %}

            {% if perms.users.show_button_counter_frame %}
                <a href="{% url 'assembly:counter_frame' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM IN (FRAME)</a>
            {% endif %}

            {% if perms.users.show_button_counter_trim_out_changan %}
                <a href="{% url 'assembly:counter_trim_out_changan' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM OUT (Changan)</a>
            {% endif %}

            {% if perms.users.show_button_counter_trim_out_chery %}
                <a href="{% url 'assembly:counter_trim_out_chery' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM OUT (Chery)</a>
            {% endif %}

            {% if perms.users.show_button_counter_trim_out_gwm %}
                <a href="{% url 'assembly:counter_trim_out_gwm' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM OUT (GWM)</a>
            {% endif %}

            {% if perms.users.show_button_counter_trim_out_frame %}
                <a href="{% url 'assembly:counter_trim_out_frame' %}?post_id=35" class="btn btn-outline-secondary">–°—á–µ—Ç—á–∏–∫ TRIM OUT (FRAME)</a>
            {% endif %}
        </div>
    </div>


</div>


<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- ‚úÖ html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let qrScanner = new Html5Qrcode("qr-reader");
    let qrActive = false;

function onScanSuccess(decodedText, decodedResult) {
    console.log("QR-–∫–æ–¥:", decodedText);
    document.getElementById("qr-result").innerText = "QR-–∫–æ–¥: " + decodedText;

    if (decodedText.includes("post_id=")) {
        // 1) –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ—Å—Ç (–Ω–µ –±–ª–æ–∫–∏—Ä—É—è –ø–µ—Ä–µ—Ö–æ–¥)
        fetch("{% url 'remember_recent_post' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ url: decodedText }),
            keepalive: true, // –Ω–∞ —Å–ª—É—á–∞–π –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        }).catch(() => {});

        // 2) –ü–µ—Ä–µ—Ö–æ–¥
        qrScanner.stop().then(() => {
            const target = decodedText.startsWith("http")
                ? decodedText
                : (window.location.origin + decodedText);
            window.location.href = target;
        }).catch(e => {
            console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:", e);
            const fallback = decodedText.startsWith("http")
                ? decodedText
                : (window.location.origin + decodedText);
            window.location.href = fallback;
        });
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
    }
}

    document.getElementById("start_qr_scan").addEventListener("click", function () {
        const scanBtn = this;

        if (!qrActive) {
            scanBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";
            qrScanner.start(
                { facingMode: "environment" },  // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
                { fps: 10, qrbox: { width: 350, height: 350 } },
                onScanSuccess
            ).then(() => {
                qrActive = true;
            }).catch(err => {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err);
                console.error(err);
            });
        } else {
            qrScanner.stop().then(() => {
                scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
                qrActive = false;
            }).catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:", err));
        }
    });
});
</script>
{% endblock %}