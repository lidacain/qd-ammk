{% extends "users/base.html" %}
{% load static %}
{% block title %}–£–£–î ‚Äî –æ—Ç—á—ë—Ç –∑–∞ {{ date_local }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">‚Üê –ù–∞–∑–∞–¥</a>

  <div class="d-flex align-items-center gap-3 mb-2">
    <h4 class="m-0">–£–£–î ‚Äî –æ—Ç—á—ë—Ç –∑–∞ {{ date_local }}</h4>
  </div>
  <br>

  <div class="d-flex align-items-center gap-2 mb-2">
    <input id="global-search" type="search" class="form-control"
           placeholder="–ü–æ–∏—Å–∫ –ø–æ VIN‚Ä¶"
           style="max-width:520px">
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <ul class="nav nav-pills mb-3" id="uudTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-step1" data-bs-toggle="pill" data-bs-target="#pane-step1" type="button" role="tab">
        –û–∂–∏–¥–∞—é—Ç —Ä–µ–º–æ–Ω—Ç–∞<span class="badge bg-light text-dark ms-2">{{ step1_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step2" data-bs-toggle="pill" data-bs-target="#pane-step2" type="button" role="tab">
        –£–£–î –Ω–∞—á–∞–ª–∞ —Ä–µ–º–æ–Ω—Ç <span class="badge bg-light text-dark ms-2">{{ step2_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step3" data-bs-toggle="pill" data-bs-target="#pane-step3" type="button" role="tab">
        –ñ–¥—ë—Ç –ø—Ä–∏—ë–º–∞ –Ω–∞ –ª–∏–Ω–∏—é <span class="badge bg-light text-dark ms-2">{{ step3_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step4" data-bs-toggle="pill" data-bs-target="#pane-step4" type="button" role="tab">
        –õ–∏–Ω–∏—è –ø—Ä–∏–Ω—è–ª–∞ <span class="badge bg-light text-dark ms-2">{{ step4_count }}</span>
      </button>
    </li>
  </ul>

  <form class="row g-2 align-items-center mb-3" method="get" action="">
    <div class="col-auto">
      <label for="start" class="col-form-label">C:</label>
    </div>
    <div class="col-auto">
      <input id="start" name="start" type="date" class="form-control"
             value="{{ start_date|default:'' }}">
    </div>
    <div class="col-auto">
      <label for="end" class="col-form-label">–ø–æ:</label>
    </div>
    <div class="col-auto">
      <input id="end" name="end" type="date" class="form-control"
             value="{{ end_date|default:'' }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      <a class="btn btn-outline-secondary" href="?">–°–±—Ä–æ—Å</a>
    </div>
  </form>

  <div class="d-flex align-items-center gap-3 mb-2">
    <h4 class="m-0">–£–£–î ‚Äî –æ—Ç—á—ë—Ç –∑–∞ {{ date_local }}</h4>

    <a id="excel-btn" class="btn btn-success ms-auto"
       href="{% url 'uud_report_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
      –°–∫–∞—á–∞—Ç—å Excel
    </a>
  </div>
  <div class="uud-wide">
    <div class="tab-content" id="uudTabsContent">
      <!-- STEP 1 -->
      <div class="tab-pane fade show active" id="pane-step1" role="tabpanel" aria-labelledby="tab-step1">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step1">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>–ë—Ä–µ–Ω–¥</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>–ú–æ–¥–µ–ª—å</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">–î–∞—Ç–∞</th>
                <th style="min-width:95px;">–í—Ä–µ–º—è</th>
                <th style="min-width:135px;">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</th>
                <th style="min-width:140px;">–°—Ç–∞—Ç—É—Å –¥–µ—Ñ–µ–∫—Ç–∞</th>
                <th style="min-width:220px;">–î–µ—Ç–∞–ª—å</th>
                <th style="min-width:220px;">–î–µ—Ñ–µ–∫—Ç</th>
                <th style="min-width:260px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step1_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">‚Äî</td>
                  <td class="def-detail">‚Äî</td>
                  <td class="def-defect">‚Äî</td>
                  <td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ {{ date_local }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="tab-pane fade" id="pane-step2" role="tabpanel" aria-labelledby="tab-step2">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step2">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>–ë—Ä–µ–Ω–¥</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>–ú–æ–¥–µ–ª—å</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">–î–∞—Ç–∞</th>
                <th style="min-width:95px;">–í—Ä–µ–º—è</th>
                <th style="min-width:135px;">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</th>
                <th style="min-width:140px;">–°—Ç–∞—Ç—É—Å –¥–µ—Ñ–µ–∫—Ç–∞</th>
                <th style="min-width:220px;">–î–µ—Ç–∞–ª—å</th>
                <th style="min-width:220px;">–î–µ—Ñ–µ–∫—Ç</th>
                <th style="min-width:260px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step2_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">‚Äî</td><td class="def-detail">‚Äî</td><td class="def-defect">‚Äî</td> <td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="tab-pane fade" id="pane-step3" role="tabpanel" aria-labelledby="tab-step3">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step3">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>–ë—Ä–µ–Ω–¥</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>–ú–æ–¥–µ–ª—å</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">–î–∞—Ç–∞</th>
                <th style="min-width:95px;">–í—Ä–µ–º—è</th>
                <th style="min-width:135px;">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</th>
                <th style="min-width:140px;">–°—Ç–∞—Ç—É—Å –¥–µ—Ñ–µ–∫—Ç–∞</th>
                <th style="min-width:220px;">–î–µ—Ç–∞–ª—å</th>
                <th style="min-width:220px;">–î–µ—Ñ–µ–∫—Ç</th>
                <th style="min-width:260px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step3_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">‚Äî</td><td class="def-detail">‚Äî</td><td class="def-defect">‚Äî</td><td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="tab-pane fade" id="pane-step4" role="tabpanel" aria-labelledby="tab-step4">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step4">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>–ë—Ä–µ–Ω–¥</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>–ú–æ–¥–µ–ª—å</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="–§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª–∏">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">–î–∞—Ç–∞</th>
                <th style="min-width:95px;">–í—Ä–µ–º—è</th>
                <th style="min-width:135px;">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</th>
                <th style="min-width:140px;">–°—Ç–∞—Ç—É—Å –¥–µ—Ñ–µ–∫—Ç–∞</th>
                <th style="min-width:220px;">–î–µ—Ç–∞–ª—å</th>
                <th style="min-width:220px;">–î–µ—Ñ–µ–∫—Ç</th>
                <th style="min-width:260px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step4_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">‚Äî</td><td class="def-detail">‚Äî</td><td class="def-defect">‚Äî</td><td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- JSON —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ -->
{{ defects_by_vin|json_script:"defects-json" }}
<style>
  /* –≤—ã—Ö–æ–¥–∏–º –∏–∑ "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" –∏ —Ç—è–Ω–µ–º—Å—è –ø–æ—á—Ç–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
  .uud-wide{
    width: 90vw;
    margin-left: calc(50% - 45vw);
  }
  @media (min-width: 1600px){
    .uud-wide{
      width: 96vw;
      margin-left: calc(50% - 48vw);
    }
  }

  /* —á–∏—Ç–∞–µ–º–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã */
  .uud-table{
    table-layout: fixed;
    width: 90%;
  }
  .uud-table thead th{
    position: sticky; top: 0; z-index: 1;
    background: #f8f9fa;
  }
  .uud-table th, .uud-table td{
    white-space: nowrap;
  }

  /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö —è—á–µ–µ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  .merge-center{
    text-align: center !important;
    vertical-align: middle !important;
  }
</style>
<style>
  /* —Ü–≤–µ—Ç–Ω—ã–µ –±–µ–π–¥–∂–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
  .status-badge{display:inline-block;padding:.2rem .55rem;border-radius:9999px;font-weight:600;font-size:.85rem;line-height:1}
  .status-impossible{background:#212529;color:#fff}     /* —á—ë—Ä–Ω—ã–π */
  .status-resolved{background:#198754;color:#fff}       /* –∑–µ–ª—ë–Ω—ã–π */
  .status-not_resolved{background:#dc3545;color:#fff}   /* –∫—Ä–∞—Å–Ω—ã–π */
  .status-checking{background:#ffc107;color:#212529}    /* –∂—ë–ª—Ç—ã–π */
  .status-empty{background:#e9ecef;color:#6c757d}       /* —Å–µ—Ä—ã–π —Ç–∏—Ä–µ */

  /* –∑–∞–º–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ VIN (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≥—Ä—É–ø–ø—ã) */
  tbody tr.group-sep > *{ border-top:2px solid rgba(0,0,0,.2) !important; }

  .def-comment{
    white-space: normal;       /* –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
    word-break: break-word;    /* –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤/URL */
    max-width: 48ch;           /* —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å–ø–æ–ª–∑–∞–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞ */
  }
</style>
<script>
  // –ö–∞—Ä—Ç–∞: –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å -> {—Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç, css-–∫–ª–∞—Å—Å}
  const STATUS_MAP = {
    impossible:   { text: '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ',   cls: 'status-impossible'   },
    resolved:     { text: '–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ',    cls: 'status-resolved'     },
    not_resolved: { text: '–ù–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ', cls: 'status-not_resolved' },
    checking:     { text: '–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è',  cls: 'status-checking'     },
  };

  function renderStatusCell(tr, statusRaw){
    const s = (statusRaw || '').trim();
    const map = STATUS_MAP[s];
    const html = map
      ? `<span class="status-badge ${map.cls}">${map.text}</span>`
      : `<span class="status-badge status-empty">‚Äî</span>`;
    const el = tr.querySelector('.def-status');
    if (el) el.innerHTML = html;
  }
</script>
<script>
/* –ó–∞–ø–æ–ª–Ω—è–µ–º 3 –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –¥–µ—Ñ–µ–∫—Ç–∞–º –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º VIN –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ (–ø–æ –∫–∞–∂–¥–æ–º—É –¥–µ—Ñ–µ–∫—Ç—É). */
(function attachDefectsMinimal(){
  const defectsMap = (() => {
    try { return JSON.parse(document.getElementById('defects-json').textContent || '{}'); }
    catch(e){ return {}; }
  })();

  function expandTable(table){
    const tbody = table.tBodies[0];
    if (!tbody) return;
    const baseRows = Array.from(tbody.querySelectorAll('tr.uud-row'));

    baseRows.forEach(tr => {
      const vin = (tr.querySelector('.vin-cell')?.textContent || '').trim().toUpperCase();
      const defects = defectsMap[vin] || [];

      if (!defects.length) return;

      // –ø–µ—Ä–≤—ã–π –¥–µ—Ñ–µ–∫—Ç ‚Äî –≤–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
      fillDefectCells(tr, defects[0]);

      // –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
      for (let i = 1; i < defects.length; i++){
        const d = defects[i];
        const clone = tr.cloneNode(true);
        // —á–∏—Å—Ç–∏–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —è—á–µ–π–∫–∏ VIN/–±—Ä–µ–Ω–¥/–º–æ–¥–µ–ª—å/–£–£–î
        ['.vin-cell','.brand-cell','.model-cell','.uud-date','.uud-time','.uud-by']
          .forEach(sel => { const c = clone.querySelector(sel); if (c) c.textContent = ''; });
        fillDefectCells(clone, d);
        tbody.insertBefore(clone, tr.nextSibling);
      }
    });
  }

  function fillDefectCells(tr, d){
    renderStatusCell(tr, d.status);
    setText(tr, '.def-detail',  d.detail  || '‚Äî');
    setText(tr, '.def-defect',  d.defect  || '‚Äî');
    setText(tr, '.def-comment', d.comment || '‚Äî'); // ‚Üê –ù–û–í–û–ï
  }

  function setText(tr, sel, txt){
    const el = tr.querySelector(sel);
    if (el) el.textContent = txt;
  }

  ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'].forEach(id=>{
    const t = document.getElementById(id);
    if (t) {
      expandTable(t);
      applyRowspan(t);   // <--- –¥–æ–±–∞–≤–∏–ª–∏
    }
  });

  /* –û–±—ä–µ–¥–∏–Ω—è–µ–º VIN/–ë—Ä–µ–Ω–¥/–ú–æ–¥–µ–ª—å/–î–∞—Ç–∞/–í—Ä–µ–º—è/–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã
     –ì—Ä—É–ø–ø–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ç—ã —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–ª –¥–µ—Ñ–µ–∫—Ç—ã: —É –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —è—á–µ–π–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã,
     —É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö ‚Äî –æ—á–∏—â–µ–Ω—ã (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞). */
  function applyRowspan(tbl){
    const body = tbl.tBodies[0];
    if (!body) return;

    const mergeSelectors = ['.vin-cell','.brand-cell','.model-cell','.uud-date','.uud-time','.uud-by'];

    let i = 0;
    while (i < body.rows.length) {
      const baseRow = body.rows[i];
      const vinCell = baseRow.querySelector('.vin-cell');
      // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
      if (!vinCell) { i++; continue; }

      // —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫ –≤—Ö–æ–¥—è—Ç –≤ –≥—Ä—É–ø–ø—É (—É –Ω–∏—Ö –ø—É—Å—Ç–æ–π vin-cell)
      let span = 1;
      let j = i + 1;
      while (j < body.rows.length) {
        const nextVin = body.rows[j].querySelector('.vin-cell');
        if (!nextVin) break; // –∑–∞—â–∏—Ç–∏–º—Å—è –æ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏
        if (nextVin.textContent.trim() !== '') break; // –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
        span++; j++;
      }

      baseRow.classList.add('group-sep');

      // –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º rowSpan –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º;
      // –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö —É–¥–∞–ª—è–µ–º —è—á–µ–π–∫–∏, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä ¬´—Å–∫–ª–µ–∏–ª¬ª –∏—Ö –≤–∏–∑—É–∞–ª—å–Ω–æ
      mergeSelectors.forEach(sel => {
        const cell = baseRow.querySelector(sel);
        if (cell && span > 1) {
          cell.rowSpan = span;
          cell.classList.add('merge-center');
        } else if (cell) {
          cell.classList.add('merge-center');
        }
      });

      for (let k = i + 1; k < i + span; k++) {
        const row = body.rows[k];
        mergeSelectors.forEach(sel => {
          const c = row.querySelector(sel);
          if (c) c.remove();
        });
      }
      i += span;
    }
  }
})();
</script>
<script>
(function() {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  const tabs = document.querySelectorAll('#uudTabs [data-bs-toggle="pill"]');
  const key = 'uud_report_active_tab';
  const saved = localStorage.getItem(key);
  if (saved) {
    const btn = document.querySelector(`#uudTabs [data-bs-target="${saved}"]`);
    if (btn) new bootstrap.Tab(btn).show();
  }
  tabs.forEach(b => {
    b.addEventListener('shown.bs.tab', (e) => {
      const target = e.target.getAttribute('data-bs-target');
      localStorage.setItem(key, target);
      const pane = document.querySelector(target);
      if (pane) updateShownCountersWithin(pane);
    });
  });

  function filterTable(tableId, query) {
    query = (query || '').trim().toLowerCase();
    const tbl = document.getElementById(tableId);
    if (!tbl) return { shown: 0, total: 0 };
    const rows = Array.from(tbl.tBodies[0].rows);
    let shown = 0;
    rows.forEach(tr => {
      const match = !query || tr.innerText.toLowerCase().includes(query);
      tr.style.display = match ? '' : 'none';
      if (match) shown++;
    });
    const total = rows.length;
    const shownEl = document.getElementById(tableId + '-shown');
    const totalEl = document.getElementById(tableId + '-total');
    if (shownEl) shownEl.textContent = shown;
    if (totalEl) totalEl.textContent = total;
    return { shown, total };
  }

  function updateShownCountersWithin(pane) {
    const input = pane.querySelector('.table-search');
    if (!input) return;
    filterTable(input.dataset.target, input.value);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
  ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'].forEach(id => filterTable(id, ''));

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞
  document.querySelectorAll('.table-search').forEach(inp => {
    const target = inp.dataset.target;
    filterTable(target, '');
    inp.addEventListener('input', () => filterTable(target, inp.value));
  });
})();
</script>
<script>
(function(){
  const qInput = document.getElementById('global-search');
  const excel  = document.getElementById('excel-btn');

  const TABLE_IDS = ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'];
  const TAB_IDS   = ['tab-step1','tab-step2','tab-step3','tab-step4'];

  function setExcelHref(q, brands, models){
    if (!excel) return;
    const url = new URL(excel.getAttribute('href'), location.origin);

    // –ø—Ä–æ—Ç–∞—â–∏–º —Ç–µ–∫—É—â–∏–µ GET (start/end –∏ —Ç.–¥.)
    const cur = new URL(location.href);
    cur.searchParams.forEach((v,k)=>url.searchParams.set(k,v));

    // VIN
    if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');

    // –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ brand/model –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    url.searchParams.delete('brand');
    url.searchParams.delete('model');

    const addMulti = (vals, key) => {
      if (!vals) return;
      const arr = (vals instanceof Set) ? Array.from(vals) : (Array.isArray(vals) ? vals : []);
      arr.forEach(v => url.searchParams.append(key, v ?? ''));
    };
    addMulti(brands, 'brand');
    addMulti(models, 'model');

    excel.href = url.pathname + url.search;
  }

  // –°–¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
  window.setExcelHref = setExcelHref;

  function groupStarts(rows){
    const idxs = [];
    rows.forEach((tr, i) => { if (tr.classList.contains('group-sep')) idxs.push(i); });
    return idxs;
  }

  function filterOneTable(tableId, vinSubstr){
    const tbl = document.getElementById(tableId);
    if (!tbl || !tbl.tBodies[0]) return { shown: 0, total: 0 };
    const rows = Array.from(tbl.tBodies[0].rows);
    const heads = groupStarts(rows);
    const total = heads.length;
    let shown = 0;

    for (let g = 0; g < heads.length; g++){
      const start = heads[g];
      const end   = (g+1 < heads.length) ? heads[g+1] : rows.length;

      const headRow = rows[start];
      const vinCell = headRow.querySelector('.vin-cell');
      const vin     = (vinCell?.textContent || '').trim().toUpperCase();
      const match   = !vinSubstr || vin.includes(vinSubstr);

      for (let i = start; i < end; i++){
        rows[i].style.display = match ? '' : 'none';
      }
      if (match) shown++;
    }
    return { shown, total };
  }

  function updateTabBadges(results){
    results.forEach((r, idx) => {
      const tabBtn = document.getElementById(TAB_IDS[idx]);
      if (!tabBtn) return;
      const badge = tabBtn.querySelector('span.badge');
      if (badge) badge.textContent = r.shown;
    });
  }

  function doFilter(){
    const q = (qInput?.value || '').trim().toUpperCase();

    const results = TABLE_IDS.map(id => filterOneTable(id, q));
    updateTabBadges(results);

    // –≤—ã—Ç—è–Ω–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å –¥—Ä—É–≥–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∏—Ö
    const f = (window.__uudFilters || {});
    setExcelHref(q, f.brand, f.model);
  }

  qInput?.addEventListener('input', doFilter);
  window.addEventListener('load', doFilter);
})();
</script>

<div id="filter-popover" class="filter-popover card shadow-sm p-2" style="display:none;">
  <div class="d-flex align-items-center mb-2">
    <input id="fp-check-all" type="checkbox" class="form-check-input me-2">
    <label for="fp-check-all" class="form-check-label">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</label>
  </div>
  <div id="fp-list" class="fp-list border rounded p-1" style="max-height:260px; overflow:auto;"></div>
  <div class="d-flex justify-content-end gap-2 mt-2">
    <button id="fp-clear" type="button" class="btn btn-light btn-sm">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <button id="fp-apply" type="button" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>
</div>
<style>
  /* –ö–Ω–æ–ø–∫–∞-–≤–æ—Ä–æ–Ω–∫–∞ */
  .filter-btn{
    background:#fff;border:1px solid #dee2e6;border-radius:.5rem;
    padding:.2rem .35rem;line-height:1
  }
  .filter-btn.active{background:#198754;color:#fff;border-color:#198754}

  /* –ü–û–ü–û–í–ï–†: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π */
  .filter-popover{
    position:absolute; z-index:1080;
    width:auto;                /* —à–∏—Ä–∏–Ω–∞ –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
    min-width:160px;           /* –Ω–µ —Å–ª–∏—à–∫–æ–º —É–∑–∫–æ */
    max-width:220px;           /* –Ω–µ —à–∏—Ä–µ —è—á–µ–π–∫–∏/—ç–∫—Ä–∞–Ω–∞ */
    box-sizing:border-box;
    transform-origin:top left;
    padding:.5rem .5rem !important;
  }

  /* –°–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π */
  #fp-list{
    max-height:160px;          /* –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å */
    overflow-y:auto;
    padding:.25rem !important;
    margin:0;
  }

  /* –ö–∞–∂–¥–∞—è –æ–ø—Ü–∏—è ‚Äî –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –≥–∞–ª–æ—á–∫–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */
  .filter-popover .form-check{
    display:flex; align-items:center; gap:.4rem;
    padding:.1rem .25rem; margin:0; white-space:nowrap;
  }
  .filter-popover .form-check-input{
    margin:0; flex-shrink:0;   /* –Ω–µ —Å–∂–∏–º–∞—Ç—å —á–µ–∫–±–æ–∫—Å */
  }
  .filter-popover .form-check-label{
    font-size:.9rem; line-height:1.2;
    overflow:hidden; text-overflow:ellipsis; /* –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å —Ç—Ä–æ–µ—Ç–æ—á–∏–µ–º */
  }
</style>

<script>
(function(){
  // —ç–ª–µ–º–µ–Ω—Ç—ã
  const vinInput = document.getElementById('global-search');  // —Ç–≤–æ–π VIN-–ø–æ–∏—Å–∫
  const pop = document.getElementById('filter-popover');
  const popList = document.getElementById('fp-list');
  const popAll = document.getElementById('fp-check-all');
  const btnApply = document.getElementById('fp-apply');
  const btnClear = document.getElementById('fp-clear');

  const TABLE_IDS = ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'];
  const TAB_IDS   = ['tab-step1','tab-step2','tab-step3','tab-step4'];

  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  let state = {
    vin: '',             // –ø–æ–¥—Å—Ç—Ä–æ–∫–∞ VIN (UPPER)
    brand: null,         // Set –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ –∏–ª–∏ null (=–≤—Å–µ)
    model: null          // Set –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏–ª–∏ null (=–≤—Å–µ)
  };

  window.__uudFilters = { brand: state.brand, model: state.model };
  let currentCol = null;     // 'brand' | 'model' | null
  let currentBtn = null;     // DOM-–∫–Ω–æ–ø–∫–∞, –≤–æ–∑–ª–µ –∫–æ—Ç–æ—Ä–æ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–æ–≤–µ—Ä

  // —Å–æ–±—Ä–∞—Ç—å –≥—Ä—É–ø–ø—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
  function collectGroups(tableId){
    const tbl = document.getElementById(tableId);
    if (!tbl || !tbl.tBodies[0]) return [];
    const rows = Array.from(tbl.tBodies[0].rows);
    const heads = rows
      .map((tr, idx)=>({tr,idx}))
      .filter(o => o.tr.classList.contains('group-sep'))
      .map(o=>o.idx);
    const groups = [];
    for (let g = 0; g < heads.length; g++){
      const start = heads[g];
      const end   = (g+1 < heads.length) ? heads[g+1] : rows.length;
      const head  = rows[start];
      const vin   = (head.querySelector('.vin-cell')?.textContent || '').trim().toUpperCase();
      const brand = (head.querySelector('.brand-cell')?.textContent || '').trim();
      const model = (head.querySelector('.model-cell')?.textContent || '').trim();
      groups.push({vin, brand, model, start, end, rows});
    }
    return groups;
  }

  // –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∫–æ –≤—Å–µ–º —Ç–∞–±–ª–∏—Ü–∞–º –∏ –æ–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏
  function applyFilters(){
    const vinQ = (state.vin || '').toUpperCase();
    const counts = [];

    TABLE_IDS.forEach((tid, i)=>{
      const groups = collectGroups(tid);
      let shown = 0;
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        const vis = vinOk && brandOk && modelOk;
        for (let r=g.start; r<g.end; r++){
          g.rows[r].style.display = vis ? '' : 'none';
        }
        if (vis) shown++;
      });
      counts.push({shown, total: groups.length});
    });

    // –æ–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏
    counts.forEach((c, idx)=>{
      const tabBtn = document.getElementById(TAB_IDS[idx]);
      if (!tabBtn) return;
      const badge = tabBtn.querySelector('.badge');
      if (badge) badge.textContent = c.shown;
    });

    rebuildOtherOptions();

    // üëâ –¥–æ–±–∞–≤—å —ç—Ç–æ
   // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º Excel-—Å—Å—ã–ª–∫—É
   window.__uudFilters = { brand: state.brand, model: state.model };
   if (typeof window.setExcelHref === 'function') {
     window.setExcelHref(state.vin, state.brand, state.model);
   }
  }

  // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
  function rebuildOtherOptions(){
    const avail = { brand: new Set(), model: new Set() };
    const vinQ = (state.vin || '').toUpperCase();

    TABLE_IDS.forEach(tid=>{
      const groups = collectGroups(tid);
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        if (vinOk && modelOk) avail.brand.add(g.brand);
        if (vinOk && brandOk) avail.model.add(g.model);
      });
    });

    if (currentCol){
      const setFor = currentCol === 'brand' ? avail.brand : avail.model;
      drawPopoverOptions(setFor, currentCol);
    }
  }

  // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —á–µ–∫–±–æ–∫—Å—ã —Å–ø–∏—Å–∫–∞
  function drawPopoverOptions(valuesSet, col){
    popList.innerHTML = '';
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'ru'));
    const active = (col==='brand') ? state.brand : state.model;   // Set|null
    const allChecked = !active || values.every(v => active.has(v));
    popAll.checked = allChecked;

    values.forEach((val, i)=>{
      const id = `fp-${col}-${i}`;
      const div = document.createElement('div');
      div.className = 'form-check';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" id="${id}" value="${val}">
        <label class="form-check-label" for="${id}">${val || '‚Äî'}</label>
      `;
      const input = div.querySelector('input');
      input.checked = !active || active.has(val);
      popList.appendChild(div);
    });
  }

  // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø–æ–≤–µ—Ä–∞ –≤–æ–∑–ª–µ –∫–Ω–æ–ø–∫–∏
  function positionPopover(btn){
    const th = btn.closest('th') || btn.parentElement;
    const thRect = th.getBoundingClientRect();
    const btnRect = btn.getBoundingClientRect();

    // –®–∏—Ä–∏–Ω–∞ –ø–æ–ø–æ–≤–µ—Ä–∞: –Ω–µ —à–∏—Ä–µ –∫–æ–ª–æ–Ω–∫–∏, –Ω–æ –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è
    const minW = 250, maxW = 290;
    const popW = Math.min(Math.max(minW, thRect.width - 12), maxW);
    pop.style.width = popW + 'px';

    // –°—Ç–∞–≤–∏–º –ü–û–°–õ–ï —à–∞–ø–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ –í–ù–£–¢–†–ò –≥—Ä–∞–Ω–∏—Ü —ç—Ç–æ–≥–æ th
    let top  = window.scrollY + thRect.bottom + 6;
    let left = window.scrollX + Math.min(
      // –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –∫–Ω–æ–ø–∫–µ
      btnRect.left,
      // –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –±–ª–∏–∑–∫–æ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é ‚Äî —Å–¥–≤–∏–≥–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–ø–æ–≤–µ—Ä –Ω–µ –≤—ã–ª–µ–∑
      thRect.right - popW - 6
    );
    // –Ω–∏–∂–Ω—è—è –∏ –ø—Ä–∞–≤–∞—è ¬´—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞¬ª
    const vpRight = window.scrollX + document.documentElement.clientWidth;
    if (left + popW > vpRight - 8) left = vpRight - popW - 8;

    pop.style.top = `${top}px`;
    pop.style.left = `${left}px`;
  }
  // –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ø–æ–≤–µ—Ä –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
  function openPopover(btn, col){
    currentCol = col;
    currentBtn = btn;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    // —Å–æ–±–µ—Ä—ë–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∫—Ä–æ–º–µ —Å–∞–º–æ–π –∫–æ–ª–æ–Ω–∫–∏)
    const avail = new Set();
    const vinQ = (state.vin || '').toUpperCase();

    TABLE_IDS.forEach(tid=>{
      const groups = collectGroups(tid);
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        if (col === 'brand'){
          // –¥–ª—è –±—Ä–µ–Ω–¥–∞ —É—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã VIN –∏ –º–æ–¥–µ–ª–∏
          if (vinOk && modelOk) avail.add(g.brand);
        } else {
          // –¥–ª—è –º–æ–¥–µ–ª–∏ —É—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã VIN –∏ –±—Ä–µ–Ω–¥–∞
          if (vinOk && brandOk) avail.add(g.model);
        }
      });
    });

    drawPopoverOptions(avail, col);
    positionPopover(btn);
    pop.style.display = 'block';
  }

  function closePopover(){
    pop.style.display = 'none';
    currentCol = null;
    currentBtn = null;
    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ —Ñ–∞–∫—Ç—É: –∞–∫—Ç–∏–≤–Ω–∞—è = –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –Ω–µ ¬´–≤—Å–µ¬ª
    reflectButtonsState();
  }

  // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫
  function reflectButtonsState(){
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      const col = btn.dataset.col;
      const set = (col==='brand') ? state.brand : state.model;
      const active = !!(set && set.size > 0);
      btn.classList.toggle('active', active);
    });
  }

  // —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö ¬´–≤–æ—Ä–æ–Ω–∫–∞¬ª
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const col = btn.dataset.col;
      if (pop.style.display==='block' && currentBtn===btn) { closePopover(); return; }
      openPopover(btn, col);
    });
  });

  // —á–µ–∫–±–æ–∫—Å ¬´–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ¬ª
  popAll.addEventListener('change', ()=>{
    const inputs = popList.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(i=>i.checked = popAll.checked);
  });

  // –ü—Ä–∏–º–µ–Ω–∏—Ç—å
  btnApply.addEventListener('click', ()=>{
    const chosen = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i=>i.value));
    if (currentCol === 'brand'){
      // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –≤—Å—ë ‚Äî —Ö—Ä–∞–Ω–∏–º null; –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–Ω—è—Ç–æ ‚Äî Set
      const allVals = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]')).map(i=>i.value));
      state.brand = (chosen.size === allVals.size) ? null : chosen;
    } else if (currentCol === 'model'){
      const allVals = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]')).map(i=>i.value));
      state.model = (chosen.size === allVals.size) ? null : chosen;
    }
    closePopover();
    applyFilters();
  });

  // –°–±—Ä–æ—Å
  btnClear.addEventListener('click', ()=>{
    if (currentCol === 'brand') state.brand = null;
    if (currentCol === 'model') state.model = null;
    closePopover();
    applyFilters();
  });

  // –∫–ª–∏–∫ –≤–Ω–µ –ø–æ–ø–æ–≤–µ—Ä–∞ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
  document.addEventListener('click', (e)=>{
    if (pop.style.display !== 'block') return;
    if (pop.contains(e.target) || (currentBtn && currentBtn.contains(e.target))) return;
    closePopover();
  });

  // VIN-–ø–æ–∏—Å–∫ ‚Äî —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
  vinInput?.addEventListener('input', ()=>{
    state.vin = (vinInput.value || '').trim().toUpperCase();
    applyFilters();
  });

  // –ø–µ—Ä–≤—ã–π –ø—Ä–æ–≥–æ–Ω
  state.vin = (vinInput?.value || '').trim().toUpperCase();
  applyFilters();
  reflectButtonsState();
})();
</script>

{% endblock %}
