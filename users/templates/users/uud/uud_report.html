{% extends "users/base.html" %}
{% load static %}
{% block title %}УУД — отчёт за {{ date_local }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">← Назад</a>

  <div class="d-flex align-items-center gap-3 mb-2">
    <h4 class="m-0">УУД — отчёт за {{ date_local }}</h4>
  </div>
  <br>

  <div class="d-flex align-items-center gap-2 mb-2">
    <input id="global-search" type="search" class="form-control"
           placeholder="Поиск по VIN…"
           style="max-width:520px">
  </div>

  <!-- Вкладки -->
  <ul class="nav nav-pills mb-3" id="uudTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-step1" data-bs-toggle="pill" data-bs-target="#pane-step1" type="button" role="tab">
        Ожидают ремонта<span class="badge bg-light text-dark ms-2">{{ step1_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step2" data-bs-toggle="pill" data-bs-target="#pane-step2" type="button" role="tab">
        УУД начала ремонт <span class="badge bg-light text-dark ms-2">{{ step2_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step3" data-bs-toggle="pill" data-bs-target="#pane-step3" type="button" role="tab">
        Ждёт приёма на линию <span class="badge bg-light text-dark ms-2">{{ step3_count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-step4" data-bs-toggle="pill" data-bs-target="#pane-step4" type="button" role="tab">
        Линия приняла <span class="badge bg-light text-dark ms-2">{{ step4_count }}</span>
      </button>
    </li>
  </ul>

  <form class="row g-2 align-items-center mb-3" method="get" action="">
    <div class="col-auto">
      <label for="start" class="col-form-label">C:</label>
    </div>
    <div class="col-auto">
      <input id="start" name="start" type="date" class="form-control"
             value="{{ start_date|default:'' }}">
    </div>
    <div class="col-auto">
      <label for="end" class="col-form-label">по:</label>
    </div>
    <div class="col-auto">
      <input id="end" name="end" type="date" class="form-control"
             value="{{ end_date|default:'' }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Показать</button>
      <a class="btn btn-outline-secondary" href="?">Сброс</a>
    </div>
  </form>

  <div class="d-flex align-items-center gap-3 mb-2">
    <h4 class="m-0">УУД — отчёт за {{ date_local }}</h4>

    <a id="excel-btn" class="btn btn-success ms-auto"
       href="{% url 'uud_report_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
      Скачать Excel
    </a>
  </div>
  <div class="uud-wide">
    <div class="tab-content" id="uudTabsContent">
      <!-- STEP 1 -->
      <div class="tab-pane fade show active" id="pane-step1" role="tabpanel" aria-labelledby="tab-step1">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step1">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>Бренд</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="Фильтр по бренду">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>Модель</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="Фильтр по модели">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">Дата</th>
                <th style="min-width:95px;">Время</th>
                <th style="min-width:135px;">Контролер</th>
                <th style="min-width:140px;">Статус дефекта</th>
                <th style="min-width:220px;">Деталь</th>
                <th style="min-width:220px;">Дефект</th>
                <th style="min-width:260px;">Комментарий</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step1_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">—</td>
                  <td class="def-detail">—</td>
                  <td class="def-defect">—</td>
                  <td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">Нет данных за {{ date_local }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="tab-pane fade" id="pane-step2" role="tabpanel" aria-labelledby="tab-step2">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step2">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>Бренд</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="Фильтр по бренду">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>Модель</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="Фильтр по модели">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">Дата</th>
                <th style="min-width:95px;">Время</th>
                <th style="min-width:135px;">Контролер</th>
                <th style="min-width:140px;">Статус дефекта</th>
                <th style="min-width:220px;">Деталь</th>
                <th style="min-width:220px;">Дефект</th>
                <th style="min-width:260px;">Комментарий</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step2_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">—</td><td class="def-detail">—</td><td class="def-defect">—</td> <td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">Нет данных</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="tab-pane fade" id="pane-step3" role="tabpanel" aria-labelledby="tab-step3">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step3">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>Бренд</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="Фильтр по бренду">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>Модель</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="Фильтр по модели">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">Дата</th>
                <th style="min-width:95px;">Время</th>
                <th style="min-width:135px;">Контролер</th>
                <th style="min-width:140px;">Статус дефекта</th>
                <th style="min-width:220px;">Деталь</th>
                <th style="min-width:220px;">Дефект</th>
                <th style="min-width:260px;">Комментарий</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step3_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">—</td><td class="def-detail">—</td><td class="def-defect">—</td><td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">Нет данных</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="tab-pane fade" id="pane-step4" role="tabpanel" aria-labelledby="tab-step4">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="tbl-step4">
            <thead class="table-dark">
              <tr>
                <th style="min-width:160px;">VIN</th>
                <th style="min-width:130px;">
                  <span>Бренд</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="brand" title="Фильтр по бренду">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:140px;">
                  <span>Модель</span>
                  <button type="button" class="btn btn-sm filter-btn ms-1" data-col="model" title="Фильтр по модели">
                    <i class="bi bi-funnel"></i>
                  </button>
                </th>
                <th style="min-width:115px;">Дата</th>
                <th style="min-width:95px;">Время</th>
                <th style="min-width:135px;">Контролер</th>
                <th style="min-width:140px;">Статус дефекта</th>
                <th style="min-width:220px;">Деталь</th>
                <th style="min-width:220px;">Дефект</th>
                <th style="min-width:260px;">Комментарий</th>
              </tr>
            </thead>
            <tbody>
              {% for r in step4_rows %}
                <tr class="uud-row">
                  <td class="font-monospace vin-cell">{{ r.vin }}</td>
                  <td class="brand-cell">{{ r.brand }}</td>
                  <td class="model-cell">{{ r.model }}</td>
                  <td class="uud-date">{{ r.date }}</td>
                  <td class="uud-time">{{ r.time }}</td>
                  <td class="uud-by">{{ r.by }}</td>
                  <td class="def-status">—</td><td class="def-detail">—</td><td class="def-defect">—</td><td class="def-comment"></td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">Нет данных</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- JSON с дефектами -->
{{ defects_by_vin|json_script:"defects-json" }}
<style>
  /* выходим из "контейнера" и тянемся почти на всю ширину экрана */
  .uud-wide{
    width: 90vw;
    margin-left: calc(50% - 45vw);
  }
  @media (min-width: 1600px){
    .uud-wide{
      width: 96vw;
      margin-left: calc(50% - 48vw);
    }
  }

  /* читаемость таблицы */
  .uud-table{
    table-layout: fixed;
    width: 90%;
  }
  .uud-table thead th{
    position: sticky; top: 0; z-index: 1;
    background: #f8f9fa;
  }
  .uud-table th, .uud-table td{
    white-space: nowrap;
  }

  /* выравнивание объединённых ячеек по центру */
  .merge-center{
    text-align: center !important;
    vertical-align: middle !important;
  }
</style>
<style>
  /* цветные бейджи статусов */
  .status-badge{display:inline-block;padding:.2rem .55rem;border-radius:9999px;font-weight:600;font-size:.85rem;line-height:1}
  .status-impossible{background:#212529;color:#fff}     /* чёрный */
  .status-resolved{background:#198754;color:#fff}       /* зелёный */
  .status-not_resolved{background:#dc3545;color:#fff}   /* красный */
  .status-checking{background:#ffc107;color:#212529}    /* жёлтый */
  .status-empty{background:#e9ecef;color:#6c757d}       /* серый тире */

  /* заметный разделитель между группами VIN (первая строка группы) */
  tbody tr.group-sep > *{ border-top:2px solid rgba(0,0,0,.2) !important; }

  .def-comment{
    white-space: normal;       /* перенос строк */
    word-break: break-word;    /* безопасный разрыв длинных слов/URL */
    max-width: 48ch;           /* чтобы не расползалась строка */
  }
</style>
<script>
  // Карта: исходный статус -> {русский текст, css-класс}
  const STATUS_MAP = {
    impossible:   { text: 'Невозможно',   cls: 'status-impossible'   },
    resolved:     { text: 'Устранено',    cls: 'status-resolved'     },
    not_resolved: { text: 'Не устранено', cls: 'status-not_resolved' },
    checking:     { text: 'Проверяется',  cls: 'status-checking'     },
  };

  function renderStatusCell(tr, statusRaw){
    const s = (statusRaw || '').trim();
    const map = STATUS_MAP[s];
    const html = map
      ? `<span class="status-badge ${map.cls}">${map.text}</span>`
      : `<span class="status-badge status-empty">—</span>`;
    const el = tr.querySelector('.def-status');
    if (el) el.innerHTML = html;
  }
</script>
<script>
/* Заполняем 3 колонки по дефектам и разворачиваем VIN на несколько строк (по каждому дефекту). */
(function attachDefectsMinimal(){
  const defectsMap = (() => {
    try { return JSON.parse(document.getElementById('defects-json').textContent || '{}'); }
    catch(e){ return {}; }
  })();

  function expandTable(table){
    const tbody = table.tBodies[0];
    if (!tbody) return;
    const baseRows = Array.from(tbody.querySelectorAll('tr.uud-row'));

    baseRows.forEach(tr => {
      const vin = (tr.querySelector('.vin-cell')?.textContent || '').trim().toUpperCase();
      const defects = defectsMap[vin] || [];

      if (!defects.length) return;

      // первый дефект — вписываем в текущую строку
      fillDefectCells(tr, defects[0]);

      // остальные — отдельными строками
      for (let i = 1; i < defects.length; i++){
        const d = defects[i];
        const clone = tr.cloneNode(true);
        // чистим повторяющиеся ячейки VIN/бренд/модель/УУД
        ['.vin-cell','.brand-cell','.model-cell','.uud-date','.uud-time','.uud-by']
          .forEach(sel => { const c = clone.querySelector(sel); if (c) c.textContent = ''; });
        fillDefectCells(clone, d);
        tbody.insertBefore(clone, tr.nextSibling);
      }
    });
  }

  function fillDefectCells(tr, d){
    renderStatusCell(tr, d.status);
    setText(tr, '.def-detail',  d.detail  || '—');
    setText(tr, '.def-defect',  d.defect  || '—');
    setText(tr, '.def-comment', d.comment || '—'); // ← НОВОЕ
  }

  function setText(tr, sel, txt){
    const el = tr.querySelector(sel);
    if (el) el.textContent = txt;
  }

  ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'].forEach(id=>{
    const t = document.getElementById(id);
    if (t) {
      expandTable(t);
      applyRowspan(t);   // <--- добавили
    }
  });

  /* Объединяем VIN/Бренд/Модель/Дата/Время/Контролер для последовательных строк одной группы
     Группа определяется так же, как ты разворачивал дефекты: у первой строки ячейки заполнены,
     у дополнительных — очищены (пустая строка). */
  function applyRowspan(tbl){
    const body = tbl.tBodies[0];
    if (!body) return;

    const mergeSelectors = ['.vin-cell','.brand-cell','.model-cell','.uud-date','.uud-time','.uud-by'];

    let i = 0;
    while (i < body.rows.length) {
      const baseRow = body.rows[i];
      const vinCell = baseRow.querySelector('.vin-cell');
      // если строки таблицы без данных — пропускаем
      if (!vinCell) { i++; continue; }

      // считаем, сколько следующих строк входят в группу (у них пустой vin-cell)
      let span = 1;
      let j = i + 1;
      while (j < body.rows.length) {
        const nextVin = body.rows[j].querySelector('.vin-cell');
        if (!nextVin) break; // защитимся от неожиданной разметки
        if (nextVin.textContent.trim() !== '') break; // новая группа
        span++; j++;
      }

      baseRow.classList.add('group-sep');

      // на первой строке выставляем rowSpan и центрируем;
      // в остальных строках удаляем ячейки, чтобы браузер «склеил» их визуально
      mergeSelectors.forEach(sel => {
        const cell = baseRow.querySelector(sel);
        if (cell && span > 1) {
          cell.rowSpan = span;
          cell.classList.add('merge-center');
        } else if (cell) {
          cell.classList.add('merge-center');
        }
      });

      for (let k = i + 1; k < i + span; k++) {
        const row = body.rows[k];
        mergeSelectors.forEach(sel => {
          const c = row.querySelector(sel);
          if (c) c.remove();
        });
      }
      i += span;
    }
  }
})();
</script>
<script>
(function() {
  // Сохраняем активную вкладку
  const tabs = document.querySelectorAll('#uudTabs [data-bs-toggle="pill"]');
  const key = 'uud_report_active_tab';
  const saved = localStorage.getItem(key);
  if (saved) {
    const btn = document.querySelector(`#uudTabs [data-bs-target="${saved}"]`);
    if (btn) new bootstrap.Tab(btn).show();
  }
  tabs.forEach(b => {
    b.addEventListener('shown.bs.tab', (e) => {
      const target = e.target.getAttribute('data-bs-target');
      localStorage.setItem(key, target);
      const pane = document.querySelector(target);
      if (pane) updateShownCountersWithin(pane);
    });
  });

  function filterTable(tableId, query) {
    query = (query || '').trim().toLowerCase();
    const tbl = document.getElementById(tableId);
    if (!tbl) return { shown: 0, total: 0 };
    const rows = Array.from(tbl.tBodies[0].rows);
    let shown = 0;
    rows.forEach(tr => {
      const match = !query || tr.innerText.toLowerCase().includes(query);
      tr.style.display = match ? '' : 'none';
      if (match) shown++;
    });
    const total = rows.length;
    const shownEl = document.getElementById(tableId + '-shown');
    const totalEl = document.getElementById(tableId + '-total');
    if (shownEl) shownEl.textContent = shown;
    if (totalEl) totalEl.textContent = total;
    return { shown, total };
  }

  function updateShownCountersWithin(pane) {
    const input = pane.querySelector('.table-search');
    if (!input) return;
    filterTable(input.dataset.target, input.value);
  }

  // Инициализация для всех таблиц
  ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'].forEach(id => filterTable(id, ''));

  // Обработчики поиска
  document.querySelectorAll('.table-search').forEach(inp => {
    const target = inp.dataset.target;
    filterTable(target, '');
    inp.addEventListener('input', () => filterTable(target, inp.value));
  });
})();
</script>
<script>
(function(){
  const qInput = document.getElementById('global-search');
  const excel  = document.getElementById('excel-btn');

  const TABLE_IDS = ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'];
  const TAB_IDS   = ['tab-step1','tab-step2','tab-step3','tab-step4'];

  function setExcelHref(q, brands, models){
    if (!excel) return;
    const url = new URL(excel.getAttribute('href'), location.origin);

    // протащим текущие GET (start/end и т.д.)
    const cur = new URL(location.href);
    cur.searchParams.forEach((v,k)=>url.searchParams.set(k,v));

    // VIN
    if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');

    // актуальные brand/model из аргументов
    url.searchParams.delete('brand');
    url.searchParams.delete('model');

    const addMulti = (vals, key) => {
      if (!vals) return;
      const arr = (vals instanceof Set) ? Array.from(vals) : (Array.isArray(vals) ? vals : []);
      arr.forEach(v => url.searchParams.append(key, v ?? ''));
    };
    addMulti(brands, 'brand');
    addMulti(models, 'model');

    excel.href = url.pathname + url.search;
  }

  // Сделаем доступной для других скриптов
  window.setExcelHref = setExcelHref;

  function groupStarts(rows){
    const idxs = [];
    rows.forEach((tr, i) => { if (tr.classList.contains('group-sep')) idxs.push(i); });
    return idxs;
  }

  function filterOneTable(tableId, vinSubstr){
    const tbl = document.getElementById(tableId);
    if (!tbl || !tbl.tBodies[0]) return { shown: 0, total: 0 };
    const rows = Array.from(tbl.tBodies[0].rows);
    const heads = groupStarts(rows);
    const total = heads.length;
    let shown = 0;

    for (let g = 0; g < heads.length; g++){
      const start = heads[g];
      const end   = (g+1 < heads.length) ? heads[g+1] : rows.length;

      const headRow = rows[start];
      const vinCell = headRow.querySelector('.vin-cell');
      const vin     = (vinCell?.textContent || '').trim().toUpperCase();
      const match   = !vinSubstr || vin.includes(vinSubstr);

      for (let i = start; i < end; i++){
        rows[i].style.display = match ? '' : 'none';
      }
      if (match) shown++;
    }
    return { shown, total };
  }

  function updateTabBadges(results){
    results.forEach((r, idx) => {
      const tabBtn = document.getElementById(TAB_IDS[idx]);
      if (!tabBtn) return;
      const badge = tabBtn.querySelector('span.badge');
      if (badge) badge.textContent = r.shown;
    });
  }

  function doFilter(){
    const q = (qInput?.value || '').trim().toUpperCase();

    const results = TABLE_IDS.map(id => filterOneTable(id, q));
    updateTabBadges(results);

    // вытянем текущие фильтры с другого скрипта, если он уже инициализировал их
    const f = (window.__uudFilters || {});
    setExcelHref(q, f.brand, f.model);
  }

  qInput?.addEventListener('input', doFilter);
  window.addEventListener('load', doFilter);
})();
</script>

<div id="filter-popover" class="filter-popover card shadow-sm p-2" style="display:none;">
  <div class="d-flex align-items-center mb-2">
    <input id="fp-check-all" type="checkbox" class="form-check-input me-2">
    <label for="fp-check-all" class="form-check-label">Выбрать все</label>
  </div>
  <div id="fp-list" class="fp-list border rounded p-1" style="max-height:260px; overflow:auto;"></div>
  <div class="d-flex justify-content-end gap-2 mt-2">
    <button id="fp-clear" type="button" class="btn btn-light btn-sm">Сбросить</button>
    <button id="fp-apply" type="button" class="btn btn-primary btn-sm">Применить</button>
  </div>
</div>
<style>
  /* Кнопка-воронка */
  .filter-btn{
    background:#fff;border:1px solid #dee2e6;border-radius:.5rem;
    padding:.2rem .35rem;line-height:1
  }
  .filter-btn.active{background:#198754;color:#fff;border-color:#198754}

  /* ПОПОВЕР: компактный и адаптивный */
  .filter-popover{
    position:absolute; z-index:1080;
    width:auto;                /* ширина под контент */
    min-width:160px;           /* не слишком узко */
    max-width:220px;           /* не шире ячейки/экрана */
    box-sizing:border-box;
    transform-origin:top left;
    padding:.5rem .5rem !important;
  }

  /* Список значений */
  #fp-list{
    max-height:160px;          /* ниже, чтобы не перекрывать */
    overflow-y:auto;
    padding:.25rem !important;
    margin:0;
  }

  /* Каждая опция — в одну строку, галочка всегда видна */
  .filter-popover .form-check{
    display:flex; align-items:center; gap:.4rem;
    padding:.1rem .25rem; margin:0; white-space:nowrap;
  }
  .filter-popover .form-check-input{
    margin:0; flex-shrink:0;   /* не сжимать чекбокс */
  }
  .filter-popover .form-check-label{
    font-size:.9rem; line-height:1.2;
    overflow:hidden; text-overflow:ellipsis; /* длинные значения с троеточием */
  }
</style>

<script>
(function(){
  // элементы
  const vinInput = document.getElementById('global-search');  // твой VIN-поиск
  const pop = document.getElementById('filter-popover');
  const popList = document.getElementById('fp-list');
  const popAll = document.getElementById('fp-check-all');
  const btnApply = document.getElementById('fp-apply');
  const btnClear = document.getElementById('fp-clear');

  const TABLE_IDS = ['tbl-step1','tbl-step2','tbl-step3','tbl-step4'];
  const TAB_IDS   = ['tab-step1','tab-step2','tab-step3','tab-step4'];

  // состояние
  let state = {
    vin: '',             // подстрока VIN (UPPER)
    brand: null,         // Set выбранных брендов или null (=все)
    model: null          // Set выбранных моделей или null (=все)
  };

  window.__uudFilters = { brand: state.brand, model: state.model };
  let currentCol = null;     // 'brand' | 'model' | null
  let currentBtn = null;     // DOM-кнопка, возле которой показываем поповер

  // собрать группы из таблицы
  function collectGroups(tableId){
    const tbl = document.getElementById(tableId);
    if (!tbl || !tbl.tBodies[0]) return [];
    const rows = Array.from(tbl.tBodies[0].rows);
    const heads = rows
      .map((tr, idx)=>({tr,idx}))
      .filter(o => o.tr.classList.contains('group-sep'))
      .map(o=>o.idx);
    const groups = [];
    for (let g = 0; g < heads.length; g++){
      const start = heads[g];
      const end   = (g+1 < heads.length) ? heads[g+1] : rows.length;
      const head  = rows[start];
      const vin   = (head.querySelector('.vin-cell')?.textContent || '').trim().toUpperCase();
      const brand = (head.querySelector('.brand-cell')?.textContent || '').trim();
      const model = (head.querySelector('.model-cell')?.textContent || '').trim();
      groups.push({vin, brand, model, start, end, rows});
    }
    return groups;
  }

  // применить все фильтры ко всем таблицам и обновить бейджи
  function applyFilters(){
    const vinQ = (state.vin || '').toUpperCase();
    const counts = [];

    TABLE_IDS.forEach((tid, i)=>{
      const groups = collectGroups(tid);
      let shown = 0;
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        const vis = vinOk && brandOk && modelOk;
        for (let r=g.start; r<g.end; r++){
          g.rows[r].style.display = vis ? '' : 'none';
        }
        if (vis) shown++;
      });
      counts.push({shown, total: groups.length});
    });

    // обновить бейджи
    counts.forEach((c, idx)=>{
      const tabBtn = document.getElementById(TAB_IDS[idx]);
      if (!tabBtn) return;
      const badge = tabBtn.querySelector('.badge');
      if (badge) badge.textContent = c.shown;
    });

    rebuildOtherOptions();

    // 👉 добавь это
   // синхронизируем глобальный срез фильтров и обновляем Excel-ссылку
   window.__uudFilters = { brand: state.brand, model: state.model };
   if (typeof window.setExcelHref === 'function') {
     window.setExcelHref(state.vin, state.brand, state.model);
   }
  }

  // пересчитать доступные значения для другого фильтра с учётом текущих фильтров
  function rebuildOtherOptions(){
    const avail = { brand: new Set(), model: new Set() };
    const vinQ = (state.vin || '').toUpperCase();

    TABLE_IDS.forEach(tid=>{
      const groups = collectGroups(tid);
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        if (vinOk && modelOk) avail.brand.add(g.brand);
        if (vinOk && brandOk) avail.model.add(g.model);
      });
    });

    if (currentCol){
      const setFor = currentCol === 'brand' ? avail.brand : avail.model;
      drawPopoverOptions(setFor, currentCol);
    }
  }

  // отрисовать чекбоксы списка
  function drawPopoverOptions(valuesSet, col){
    popList.innerHTML = '';
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'ru'));
    const active = (col==='brand') ? state.brand : state.model;   // Set|null
    const allChecked = !active || values.every(v => active.has(v));
    popAll.checked = allChecked;

    values.forEach((val, i)=>{
      const id = `fp-${col}-${i}`;
      const div = document.createElement('div');
      div.className = 'form-check';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" id="${id}" value="${val}">
        <label class="form-check-label" for="${id}">${val || '—'}</label>
      `;
      const input = div.querySelector('input');
      input.checked = !active || active.has(val);
      popList.appendChild(div);
    });
  }

  // позиционирование поповера возле кнопки
  function positionPopover(btn){
    const th = btn.closest('th') || btn.parentElement;
    const thRect = th.getBoundingClientRect();
    const btnRect = btn.getBoundingClientRect();

    // Ширина поповера: не шире колонки, но и не слишком маленькая
    const minW = 250, maxW = 290;
    const popW = Math.min(Math.max(minW, thRect.width - 12), maxW);
    pop.style.width = popW + 'px';

    // Ставим ПОСЛЕ шапки таблицы и ВНУТРИ границ этого th
    let top  = window.scrollY + thRect.bottom + 6;
    let left = window.scrollX + Math.min(
      // предпочтительно выравниваем по кнопке
      btnRect.left,
      // если кнопка близко к правому краю — сдвигаем, чтобы поповер не вылез
      thRect.right - popW - 6
    );
    // нижняя и правая «страховка»
    const vpRight = window.scrollX + document.documentElement.clientWidth;
    if (left + popW > vpRight - 8) left = vpRight - popW - 8;

    pop.style.top = `${top}px`;
    pop.style.left = `${left}px`;
  }
  // открыть поповер для колонки
  function openPopover(btn, col){
    currentCol = col;
    currentBtn = btn;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    // соберём доступные значения с учётом текущих фильтров (кроме самой колонки)
    const avail = new Set();
    const vinQ = (state.vin || '').toUpperCase();

    TABLE_IDS.forEach(tid=>{
      const groups = collectGroups(tid);
      groups.forEach(g=>{
        const vinOk   = !vinQ || g.vin.includes(vinQ);
        const brandOk = !state.brand || state.brand.has(g.brand);
        const modelOk = !state.model || state.model.has(g.model);
        if (col === 'brand'){
          // для бренда учитываем фильтры VIN и модели
          if (vinOk && modelOk) avail.add(g.brand);
        } else {
          // для модели учитываем фильтры VIN и бренда
          if (vinOk && brandOk) avail.add(g.model);
        }
      });
    });

    drawPopoverOptions(avail, col);
    positionPopover(btn);
    pop.style.display = 'block';
  }

  function closePopover(){
    pop.style.display = 'none';
    currentCol = null;
    currentBtn = null;
    // подсветка кнопок остаётся по факту: активная = есть выбранный набор не «все»
    reflectButtonsState();
  }

  // состояние подсветки кнопок
  function reflectButtonsState(){
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      const col = btn.dataset.col;
      const set = (col==='brand') ? state.brand : state.model;
      const active = !!(set && set.size > 0);
      btn.classList.toggle('active', active);
    });
  }

  // события на кнопках «воронка»
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const col = btn.dataset.col;
      if (pop.style.display==='block' && currentBtn===btn) { closePopover(); return; }
      openPopover(btn, col);
    });
  });

  // чекбокс «выбрать все»
  popAll.addEventListener('change', ()=>{
    const inputs = popList.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(i=>i.checked = popAll.checked);
  });

  // Применить
  btnApply.addEventListener('click', ()=>{
    const chosen = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i=>i.value));
    if (currentCol === 'brand'){
      // если выбрано всё — храним null; если что-то снято — Set
      const allVals = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]')).map(i=>i.value));
      state.brand = (chosen.size === allVals.size) ? null : chosen;
    } else if (currentCol === 'model'){
      const allVals = new Set(Array.from(popList.querySelectorAll('input[type="checkbox"]')).map(i=>i.value));
      state.model = (chosen.size === allVals.size) ? null : chosen;
    }
    closePopover();
    applyFilters();
  });

  // Сброс
  btnClear.addEventListener('click', ()=>{
    if (currentCol === 'brand') state.brand = null;
    if (currentCol === 'model') state.model = null;
    closePopover();
    applyFilters();
  });

  // клик вне поповера — закрыть
  document.addEventListener('click', (e)=>{
    if (pop.style.display !== 'block') return;
    if (pop.contains(e.target) || (currentBtn && currentBtn.contains(e.target))) return;
    closePopover();
  });

  // VIN-поиск — связанный с фильтрами
  vinInput?.addEventListener('input', ()=>{
    state.vin = (vinInput.value || '').trim().toUpperCase();
    applyFilters();
  });

  // первый прогон
  state.vin = (vinInput?.value || '').trim().toUpperCase();
  applyFilters();
  reflectButtonsState();
})();
</script>

{% endblock %}
