{% extends "users/base.html" %}

{% block title %}–í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}

<style>
    .select2-selection__choice__remove {
        display: none !important;
    }
</style>

<div class="container-fluid">

    <div class="mb-3">
        <a href="{% url 'master_dashboard' %}" class="btn btn-light">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </div>

    <h2 class="text-center mb-4" style="color: white">–í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã—Ö</h2>

    <div class="row">
        <div class="col-md-8">
            <div class="card" style="min-height: 687px;">
                <div class="card-header" >
                    <h5 class="mb-0">üîé –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="mb-3">
                        <div class="row">
                            <div class="col-md-4">{{ search_form.search_query }}</div>
                            <div class="col-md-4">{{ search_form.position }}</div>
                            <div class="col-md-4">{{ search_form.department }}</div>
                        </div>
                        <!-- –í—Å—Ç–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ GET -->
                        {% for emp_id in employee_ids %}
                          <input type="hidden" name="employees" value="{{ emp_id }}">
                        {% endfor %}
                        <div class="d-flex mt-2">
                            <button type="submit" class="btn btn-primary me-2">–ü–æ–∏—Å–∫</button>
                            {% if employee_ids %}
                                <a href="{% url 'employee_search' %}" class="btn btn-outline-danger">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</a>
                            {% endif %}
                        </div>
                    </form>

                    {% if employees %}
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-sm table-hover">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>–§–ò–û</th>
                                        <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                        <th>–û—Ç–¥–µ–ª / –≥—Ä—É–ø–ø–∞</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for employee in employees %}
                                        {% with employee.id|stringformat:"s" as eid %}
                                        <tr class="{% if eid in employee_ids %}table-success{% endif %}">
                                            <td>{{ employee.name }}</td>
                                            <td>{{ employee.position }}</td>
                                            <td>{{ employee.department }}</td>
                                            <td>
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-primary w-100"
                                                        onclick="toggleEmployee('{{ employee.id }}')">
                                                    {% if eid in employee_ids %}‚úî –£–±—Ä–∞—Ç—å{% else %}‚ûï –í—ã–±—Ä–∞—Ç—å{% endif %}
                                                </button>
                                            </td>
                                        </tr>
                                        {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìå –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä</h5>
                </div>
                <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <!-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä) -->
                    <div class="mb-3">
                        {{ selection_form.employees.label_tag }}
                        {{ selection_form.employees }}
                        {% if selection_form.employees.errors %}
                            <div class="text-danger">{{ selection_form.employees.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –î–∞—Ç—ã (–∫–∞–ª–µ–Ω–¥–∞—Ä—å) -->
                    <div class="mb-3">
                        {{ selection_form.selected_dates.label_tag }}
                        {{ selection_form.selected_dates }}
                        {% if selection_form.selected_dates.errors %}
                            <div class="text-danger">{{ selection_form.selected_dates.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã -->
                    <div class="mb-3">
                        {{ selection_form.start_time.label_tag }}
                        {{ selection_form.start_time }}
                        {% if selection_form.start_time.errors %}
                            <div class="text-danger">{{ selection_form.start_time.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –û–∫–æ–Ω—á–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã -->
                    <div class="mb-3">
                        {{ selection_form.end_time.label_tag }}
                        {{ selection_form.end_time }}
                        {% if selection_form.end_time.errors %}
                            <div class="text-danger">{{ selection_form.end_time.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- –•–¢–ö -->
                    <div class="mb-3 form-check">
                        {{ selection_form.is_xtk }} {{ selection_form.is_xtk.label_tag }}
                    </div>

                    <!-- –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ -->
                    <div class="mb-3">
                        {{ selection_form.justification.label_tag }}
                        {{ selection_form.justification }}
                        {% if selection_form.justification.errors %}
                            <div class="text-danger">{{ selection_form.justification.errors }}</div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-success w-100">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                </form>

                    {% if selections %}
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">–¢–µ–∫—É—â–∏–µ –≤—ã–±–æ—Ä—ã:</h6>
                            <form method="post" action="{% url 'delete_all_selections' %}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–±–æ—Ä—ã?')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    üóë –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
                                </button>
                            </form>
                        </div>
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                            {% for selection in selections %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {{ selection.employee.name }} ‚Äî
                                        <span>{{ selection.selected_date|date:"d.m.Y" }}</span>
                                        {% if selection.is_xtk %}
                                            <span class="badge bg-warning text-dark ms-2">–•–¢–ö</span>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group">
                                        <a href="{% url 'edit_selection' selection.id %}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</a>
                                        <a href="{% url 'delete_selection' selection.id %}" class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±–æ—Ä {{ selection.employee.name }}?');">
                                            üóëÔ∏è
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

<!--                    <div class="mt-3 d-grid gap-2">-->
<!--                        <a href="{% url 'export_excel' %}" class="btn btn-primary">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>-->
<!--                        <a href="{% url 'export_history' %}" class="btn btn-outline-secondary">üïì –ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–æ–≤</a>-->
<!--                    </div>-->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%',
            closeOnSelect: false,
            placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'
        });
    });

    flatpickr("#date-picker", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        locale: "ru",
        altInput: true,
        altFormat: "d.m.Y (D)",
        minDate: "today",
        maxDate: new Date().fp_incr(30),
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const startSelect = document.getElementById("id_start_time");
        const endSelect = document.getElementById("id_end_time");

        function filterEndTimeOptions() {
            const selectedStart = startSelect.value;
            const startMinutes = selectedStart.split(":")[1];

            Array.from(endSelect.options).forEach(option => {
                const endMinutes = option.value.split(":")[1];
                option.disabled = endMinutes !== startMinutes;
            });

            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π end_time –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å
            if (endSelect.value && endSelect.value.split(":")[1] !== startMinutes) {
                endSelect.value = "";
            }
        }

        startSelect.addEventListener("change", filterEndTimeOptions);
        filterEndTimeOptions(); // –Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    });
</script>


<script>
    function toggleEmployee(id) {
        const form = document.createElement("form");
        form.method = "GET";
        form.action = "";

        const params = new URLSearchParams(window.location.search);
        let currentEmployees = [];

        for (const [key, value] of params.entries()) {
            if (key === "employees") {
                currentEmployees.push(value);
            } else {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
        }

        // –£–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–∏—Ç—å
        const updatedEmployees = currentEmployees.includes(id)
            ? currentEmployees.filter(eid => eid !== id)
            : [...currentEmployees, id];

        updatedEmployees.forEach(eid => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "employees";
            input.value = eid;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }
</script>


{% endblock %}