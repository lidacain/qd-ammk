{% extends "users/base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Показатели линии{% endblock %}

{% block content %}
<style>
  .filter-toggle-btn{ position: sticky; top: 8px; z-index: 5; }
  .filter-panel{ display:none; background:#ffffff; color:#111827; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.12);}
  .filter-title{ font-weight:600; margin-bottom:8px; color:#111827;}
  .form-check-label{ color:#111827; }
  .stat-card{ background:#ffffff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.1); padding:20px; height:100%; color:#111827;}
  .stat-card h5{ margin:0 0 6px 0; font-weight:700; color:#111827; }
  .stat-card .big{ font-size:56px; font-weight:800; line-height:1.2; color:#000; display:flex; justify-content:center; align-items:center; margin:20px 0; }
  .stat-card code{ white-space:normal; word-break:break-all; display:block; max-height: 180px; overflow:auto; background:#f3f4f6; padding:6px 8px; border-radius:6px; color:#111827;}
  .muted{ color:#6b7280; }
  .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:20px; }
  @media (max-width: 992px){ .grid-3{ grid-template-columns:1fr; } }
  .form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media (max-width: 768px){ .form-grid{ grid-template-columns: 1fr; } }
  .ck-list{ display: grid; grid-template-columns: repeat(3, minmax(140px,1fr)); gap:10px 18px; }
  @media (max-width: 768px){ .ck-list{ grid-template-columns: repeat(2, minmax(120px,1fr)); } }
  .vin-list-label{ font-weight:600; margin-top:8px; color:#111827; }

  .page-title-badge{
    display:inline-block;
    background:#ffffff;
    color:#111827;
    padding:10px 14px;
    border-radius:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }
  .btn-white{
    background:#ffffff !important;
    color:#111827 !important;
    border:1px solid #d1d5db !important;
  }
  .btn-white:hover{
    background:#f9fafb !important;
    border-color:#9ca3af !important;
  }
  .text-muted{ color:#6b7280; }
</style>

    <div class="mb-3">
        <a href="{% url 'master_dashboard' %}" class="btn btn-light">
            ← Назад
        </a>
    </div>

<div class="container py-3" style="max-width:1180px">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0 page-title-badge">Показатели линии</h4>
  </div>

  {% comment %}
  <!-- Панель фильтров (по умолчанию скрыта) -->
  <div id="filtersPanel" class="filter-panel mb-3">
    <form method="get" class="d-block">
      <div class="form-grid">
        <div>
          <label class="form-label">C:</label>
          <input type="date" class="form-control" name="start_date" id="start_date" value="{{ filters.start_date|default:'' }}">
        </div>
        <div>
          <label class="form-label">По:</label>
          <input type="date" class="form-control" name="end_date" id="end_date" value="{{ filters.end_date|default:'' }}">
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12 col-lg-6">
          <div class="filter-title">Бренды:</div>
          <div class="ck-list">
            {% with selected=brands_selected|default:None %}
              {% for b in brands_options %}
                <label class="form-check">
                  <input class="form-check-input" type="checkbox" name="brand" value="{{ b }}"
                         {% if not selected %}checked{% elif b in selected %}checked{% endif %}>
                  <span class="form-check-label">{{ b|upper }}</span>
                </label>
              {% empty %}
                <em class="text-muted">Нет брендов</em>
              {% endfor %}
            {% endwith %}
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="filter-title">Модели:</div>
          <div class="ck-list">
            {% with selected=models_selected|default:None %}
              {% for m in models_options %}
                <label class="form-check">
                  <input class="form-check-input" type="checkbox" name="model" value="{{ m }}"
                         {% if not selected %}checked{% elif m in selected %}checked{% endif %}>
                  <span class="form-check-label">{{ m }}</span>
                </label>
              {% empty %}
                <em class="text-muted">Нет моделей</em>
              {% endfor %}
            {% endwith %}
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-white">Применить</button>
        <a class="btn btn-outline-secondary" href="?">Сбросить</a>
      </div>
    </form>
  </div>
  {% endcomment %}

  <!-- Статистика -->
  <div class="grid-3">
    <!-- Левая: В процессе сборки (пост-счётчик) -->
    <div class="stat-card">
      <h5>В процессе сборки</h5>
      <div class="muted">Пост-счётчик (скан VIN)</div>
      <div id="count-counter" class="big mt-2">{{ counter.count|default:0 }}</div>
    </div>

    <!-- Центральная: На линии тестов (все посты от Первой инспекции до Финала) -->
    <div class="stat-card">
      <h5>На линии тестов</h5>
      <div class="muted">VIN с «Первой инспекции» по «Финал»</div>
      <div id="count-tests" class="big mt-2">{{ vehicle_history_all.count|default:0 }}</div>
    </div>

    <!-- Правая: Передано в СГП (Документация) -->
    <div class="stat-card">
      <h5>Передано в СГП</h5>
      <div class="muted">Пост «Документация»</div>
      <div id="count-docs" class="big mt-2">{{ documentation.count|default:0 }}</div>
    </div>
  </div>
</div>

<script>
  // Тоггл панели фильтров — запускаем только если есть кнопка и панель
  (function(){
    const btn = document.getElementById('toggleFilters');
    const panel = document.getElementById('filtersPanel');
    if (!btn || !panel) return; // <- важно: не ломаем остальные скрипты

    let open = false;
    function update(){
      panel.style.display = open ? 'block' : 'none';
      btn.textContent = open ? 'Скрыть фильтры' : 'Показать фильтры';
    }
    btn.addEventListener('click', () => { open = !open; update(); });
    update();
  })();

  // Значения по умолчанию: "последний день" если поля пустые
  (function(){
    const sd = document.getElementById('start_date');
    const ed = document.getElementById('end_date');
    if (sd && ed && !sd.value && !ed.value){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const today = `${yyyy}-${mm}-${dd}`;
      sd.value = today;
      ed.value = today;
    }
  })();

  // Live refresh: poll API and обновляем счётчики
  (function(){
    const elCounter = document.getElementById('count-counter');
    const elTests = document.getElementById('count-tests');
    const elDocs = document.getElementById('count-docs');
    if(!elCounter || !elTests || !elDocs) return;

    const apiUrlBase = "{% url 'assembly_counter_api' %}";

    function buildUrl(){
      const qs = window.location.search || "";
      return apiUrlBase + qs + (qs ? '&' : '?') + '_ts=' + Date.now(); // bust cache
    }

    let timer = null;
    let backoff = 10000; // 10s

    async function refresh(){
      try{
        const res = await fetch(buildUrl(), {
          method: 'GET',
          headers: {'X-Requested-With': 'XMLHttpRequest'},
          cache: 'no-store',            // не используем кеш браузера
          credentials: 'same-origin'
        });
        if(!res.ok) throw new Error('Bad status ' + res.status);
        const data = await res.json();

        if (data?.counter?.count !== undefined) elCounter.textContent = data.counter.count;
        if (data?.vehicle_history_all?.count !== undefined) elTests.textContent = data.vehicle_history_all.count;
        if (data?.documentation?.count !== undefined) elDocs.textContent = data.documentation.count;

        backoff = 10000; // успех — возвращаем 10s
      }catch(e){
        // на ошибке пробуем реже, но без шумного логгинга
        backoff = Math.min(backoff * 2, 60000); // до 60s
        // console.debug('refresh error', e);
      } finally {
        timer = setTimeout(tick, backoff);
      }
    }

    function tick(){
      // если вкладка не активна — пропускаем вызов, чтобы лишний раз не долбить сервер
      if (document.hidden) { timer = setTimeout(tick, backoff); return; }
      refresh();
    }

    // старт
    tick();

    // если вкладка вернулась на передний план — сразу обновим
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) { clearTimeout(timer); backoff = 10000; tick(); }
    });
  })();
</script>

{% endblock %}