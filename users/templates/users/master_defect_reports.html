{% extends "users/base.html" %}

{% block title %}üìä –û—Ç—á–µ—Ç—ã –ø–æ –¥–µ—Ñ–µ–∫—Ç–∞–º{% endblock %}

{% block content %}
<div class="container">

    <a href="{% url 'master_dashboard' %}" class="btn btn-secondary my-3">‚¨Ö –ù–∞–∑–∞–¥ –≤ –î—ç—à–±–æ—Ä–¥</a>

    <h2 class="text-center mt-3">üìä –û—Ç—á–µ—Ç—ã –ø–æ –¥–µ—Ñ–µ–∫—Ç–∞–º</h2>

    <div class="row">
        <!-- –¢–∞–±–ª–∏—Ü—ã -->
        <div class="col-md-6">
            <h4>üèÜ –¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</h4>
            <table class="table table-bordered" id="table-all-time">
                <thead>
                    <tr>
                        <th>–î–µ—Ç–∞–ª—å</th>
                        <th>–î–µ—Ñ–µ–∫—Ç</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h4>üìÜ –¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h4>
            <table class="table table-bordered" id="table-today">
                <thead>
                    <tr>
                        <th>–î–µ—Ç–∞–ª—å</th>
                        <th>–î–µ—Ñ–µ–∫—Ç</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h4>üìÜ –¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</h4>
            <table class="table table-bordered" id="table-week">
                <thead>
                    <tr>
                        <th>–î–µ—Ç–∞–ª—å</th>
                        <th>–î–µ—Ñ–µ–∫—Ç</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h4>üìÜ –¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü</h4>
            <table class="table table-bordered" id="table-month">
                <thead>
                    <tr>
                        <th>–î–µ—Ç–∞–ª—å</th>
                        <th>–î–µ—Ñ–µ–∫—Ç</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <h3 class="text-center mt-4">üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>

    <div class="row">
        <div class="col-md-6">
            <canvas id="chartAllTime" width="600" height="300"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="chartToday" width="600" height="300"></canvas>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <canvas id="chartWeek" width="600" height="300"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="chartMonth" width="600" height="300"></canvas>
        </div>
    </div>

</div>

<!-- JS –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let ctxAll = document.getElementById("chartAllTime").getContext("2d");
    let ctxToday = document.getElementById("chartToday").getContext("2d");
    let ctxWeek = document.getElementById("chartWeek").getContext("2d");
    let ctxMonth = document.getElementById("chartMonth").getContext("2d");

    let chartAll, chartToday, chartWeek, chartMonth;

    function updateReports() {
        fetch("{% url 'get_defect_stats' %}")
        .then(response => response.json())
        .then(data => {
            updateTable("table-all-time", data.top_all_time);
            updateTable("table-today", data.top_today);
            updateTable("table-week", data.top_week);
            updateTable("table-month", data.top_month);

            updateChart(chartAll, ctxAll, data.top_all_time, "–¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è");
            updateChart(chartToday, ctxToday, data.top_today, "–¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è");
            updateChart(chartWeek, ctxWeek, data.top_week, "–¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é");
            updateChart(chartMonth, ctxMonth, data.top_month, "–¢–æ–ø-5 –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü");
        });
    }

    function updateTable(tableId, data) {
        let tableBody = document.querySelector(`#${tableId} tbody`);
        tableBody.innerHTML = "";

        if (data.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='3' class='text-center'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
            return;
        }

        data.forEach(item => {
            let row = `<tr>
                <td>${item.detail__name}</td>
                <td>${item.defect__name}</td>
                <td>${item.total}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    function updateChart(chart, ctx, data, label) {
        let defectLabels = data.map(item => item.detail__name + " - " + item.defect__name);
        let defectCounts = data.map(item => item.total);

        if (chart) {
            chart.data.labels = defectLabels;
            chart.data.datasets[0].data = defectCounts;
            chart.update();
        } else {
            chart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: defectLabels,
                    datasets: [{
                        label: label,
                        data: defectCounts,
                        backgroundColor: ["#FF5733", "#FFBD33", "#33FF57", "#3385FF", "#D133FF"]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }

    updateReports(); // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setInterval(updateReports, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
});
</script>

{% endblock %}