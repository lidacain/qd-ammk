{% extends "users/base.html" %}
{% load static %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}

<style>
    .avatar-link img,
    .avatar-link div {
        transition: transform 0.3s ease-in-out;
    }

    .avatar-link:hover img,
    .avatar-link:hover div {
        transform: scale(1.2);
        cursor: pointer;
    }

    .widget-card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        transition: all 0.2s ease-in-out;
        text-align: left;
        color: #000;
        min-height: 150px;
    }

    .widget-card:hover {
        transform: translateY(-4px);
        box-shadow: 6px 6px 14px rgba(0, 0, 0, 0.12);
    }

    .widget-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .bg-soft-blue {
        background-color: #e3f2fd;
        color: #2196f3;
    }

    .widget-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .widget-subtitle {
        font-size: 0.9rem;
        color: #6c757d;
    }

    #troll-overlay {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none; /* ‚õî –Ω–µ –ª–æ–≤–∏—Ç –∫–ª–∏–∫–∏ */
    }

    #troll-overlay.show {
        opacity: 1;
        pointer-events: auto; /* ‚úÖ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤–∏–¥–µ–Ω ‚Äî –∞–∫—Ç–∏–≤–µ–Ω */
    }


</style>

<!-- –¢—Ä–æ–ª–ª—å-–∫–Ω–æ–ø–∫–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ -->
<button id="troll-button"
        class="btn btn-danger"
        style="position: fixed; bottom: 30px; right: 30px; z-index: 9999;">
    –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
</button>

<div id="troll-overlay"
     style="display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #fff;
            font-size: 2.2rem;
            font-weight: bold;
            padding: 2rem;">
    –ß—Ç–æ –Ω–∞–º —Ç—É—Ç –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è?<br>–ö–æ–º—É –º—ã –∂–∞–ª—É–µ–º—Å—è?<br>–ñ–∞–ª–æ–±—ã –ø–æ –Ω–æ–º–µ—Ä—É ‚Äì 87072999708<br>–í–µ–¥—É—â–∏–π –∏–Ω–∂–µ–Ω–µ—Ä ‚Äì –¢–æ“õ—à–µ–∫–µ–Ω–æ–≤ –¢–µ–º—ñ—Ä–ª–∞–Ω
</div>

<div class="container mt-4">

    <!-- üë§ –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex align-items-center">
            <div class="me-4 avatar-link">
                <a href="{% url 'profile' %}" class="avatar-link d-inline-block">
                    {% if user.avatar %}
                        <a href="{% url 'profile' %}" class="avatar-link d-inline-block">
                            <img src="{{ user.avatar.url }}" alt="Avatar"
                                 class="shadow rounded"
                                 style="width: 80px; height: 80px; object-fit: cover;">
                        </a>
                    {% else %}
                        <a href="{% url 'profile' %}" class="avatar-link d-inline-block">
                            <div class="d-flex justify-content-center align-items-center bg-light text-dark shadow rounded"
                                 style="width: 80px; height: 80px; font-size: 2rem;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                        </a>
                    {% endif %}
                </a>
            </div>
            <div>
                <h5 class="mb-1">
                    {% if user.last_name %} {{ user.last_name }}{% endif %}
                    {% if user.first_name %} {{ user.first_name }}{% endif %}
                    {% if user.patronymic %} {{ user.patronymic }}{% endif %}
                </h5>
                <p class="text-muted mb-1">{{ user.position }}</p>
                <p class="mb-0 copy-email" style="cursor: pointer;" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                    <i class="bi bi-envelope-at me-1"></i>
                    <span id="email-text">{{ user.email }}</span>
                    <span id="copy-confirm" class="text-success ms-2" style="display: none;">‚úîÔ∏è</span>
                </p>
            </div>
        </div>
    </div>

    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-dismissible fade show {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' or message.tags == 'danger' %}alert-danger{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %}" role="alert" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- üß© –í–∏–¥–∂–µ—Ç—ã -->
    <div class="row g-3">

        {% if perms.users.access_to_the_guide %}
            <div class="col-md-4">
                <a href="{% url 'helpdesk_directory' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-telephone-fill"></i>
                    </div>
                    <div class="widget-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</div>
                    <div class="widget-subtitle">–ö–æ–Ω—Ç–∞–∫—Ç—ã, –∑–≤–æ–Ω–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_post_of_the_controller %}
            <div class="col-md-4">
                <a href="{% url 'controller_dashboard' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-clipboard-check-fill"></i>
                    </div>
                    <div class="widget-title">–ü–æ—Å—Ç –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞</div>
                    <div class="widget-subtitle">–í–Ω–µ—Å–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏–Ω–∏–∏</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_shift_management %}
            <div class="col-md-4">
                <a href="{% url 'master_controller_panel' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-person-fill-gear"></i>
                    </div>
                    <div class="widget-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–æ–π</div>
                    <div class="widget-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–æ–≤</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_rvd %}
            <div class="col-md-4">
                <a href="{% url 'employee_search' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-person-lines-fill"></i>
                    </div>
                    <div class="widget-title">–†–í–î</div>
                    <div class="widget-subtitle">–í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å–≤–µ—Ä—Ö—É—Ä–æ—á–Ω—ã–µ</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_vqa_data_management %}
            <div class="col-md-4">
                <a href="{% url 'manage_post_visibility' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-table"></i>
                    </div>
                    <div class="widget-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ VQA</div>
                    <div class="widget-subtitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ñ–µ–∫—Ç–∞—Ö –Ω–∞ –ø–æ—Å—Ç–∞—Ö VQA</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_qrqc_report_vqa %}
            <div class="col-md-4">
                <a href="{% url 'qrqc_dashboard' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="widget-title">QRQC –æ—Ç—á–µ—Ç VQA</div>
                    <div class="widget-subtitle">–û—Ç—á–µ—Ç QRQC VQA –ø–æ –±—Ä–µ–Ω–¥–∞–º</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_indicators %}
            <div class="col-md-4">
                <a href="{% url 'mes_dashboard_view' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="widget-title">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                    <div class="widget-subtitle">–î–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_tracking_by_vin %}
            <div class="col-md-4">
                <a href="{% url 'vin_tracking_select' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-search-heart"></i>
                    </div>
                    <div class="widget-title">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ VIN</div>
                    <div class="widget-subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ—Å—Ç–∞–º –ø–æ VIN –Ω–æ–º–µ—Ä—É</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_pqa_data %}
            <div class="col-md-4">
                <a href="{% url 'incoming_workshop_dashboard' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-box-seam-fill"></i>
                    </div>
                    <div class="widget-title">PQA</div>
                    <div class="widget-subtitle">–ü–æ—Å—Ç—ã –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_vqa_data %}
            <div class="col-md-4">
                <a href="{% url 'assembly_workshop_dashboard' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-wrench-adjustable"></i>
                    </div>
                    <div class="widget-title">VQA</div>
                    <div class="widget-subtitle">–ü–æ—Å—Ç—ã —Å–±–æ—Ä–∫–∏ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Å–ø–µ–∫—Ü–∏–∏</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_qrr_responsible %}
            <div class="col-md-4">
                <a href="{% url 'qrr_defects_board' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="widget-title">QRR –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                    <div class="widget-subtitle">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–∞ –¥–µ—Ñ–µ–∫—Ç—ã</div>
                </a>
            </div>
        {% endif %}
<!--            <div class="col-md-4">-->
<!--                <a href="{% url 'in_development' %}" class="widget-card text-decoration-none d-block">-->
<!--                    <div class="widget-icon bg-soft-blue">-->
<!--                        <i class="bi bi-lightning-charge-fill"></i>-->
<!--                    </div>-->
<!--                    <div class="widget-title">Body Shop</div>-->
<!--                    <div class="widget-subtitle">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–≤–∞—Ä–∫–∏</div>-->
<!--                </a>-->
<!--            </div>-->
<!--            <div class="col-md-4">-->
<!--                <a href="{% url 'in_development' %}" class="widget-card text-decoration-none d-block">-->
<!--                    <div class="widget-icon bg-soft-blue">-->
<!--                        <i class="bi bi-lightning-charge-fill"></i>-->
<!--                    </div>-->
<!--                    <div class="widget-title">QRQC</div>-->
<!--                    <div class="widget-subtitle">–û—Ç—á–µ—Ç –¥–ª—è –≤—ã—Å—à–∏—Ö —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π</div>-->
<!--                </a>-->
<!--            </div>-->
<!--            <div class="col-md-4">-->
<!--                <a href="{% url 'in_development' %}" class="widget-card text-decoration-none d-block">-->
<!--                    <div class="widget-icon bg-soft-blue">-->
<!--                        <i class="bi bi-lightning-charge-fill"></i>-->
<!--                    </div>-->
<!--                    <div class="widget-title">4M</div>-->
<!--                    <div class="widget-subtitle">–ë–∞–∑–∞ 4M</div>-->
<!--                </a>-->
<!--            </div>-->
<!--            <div class="col-md-4">-->
<!--                <a href="{% url 'in_development' %}" class="widget-card text-decoration-none d-block">-->
<!--                    <div class="widget-icon bg-soft-blue">-->
<!--                        <i class="bi bi-lightning-charge-fill"></i>-->
<!--                    </div>-->
<!--                    <div class="widget-title">ILU</div>-->
<!--                    <div class="widget-subtitle">–ú–∞—Ç—Ä–∏—Ü–∞ ILU</div>-->
<!--                </a>-->
<!--            </div>-->

        {% if perms.users.access_to_the_uud_table %}
            <div class="col-md-4">
                <a href="{% url 'uud_report' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-file-earmark-arrow-down-fill"></i>
                    </div>
                    <div class="widget-title">–¢–∞–±–ª–∏—Ü–∞ –£–£–î</div>
                    <div class="widget-subtitle">–í—ã–≥—Ä—É–∑–∫–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º –¥–ª—è –£–£–î</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_the_marriage_table %}
            <div class="col-md-4">
                <a href="{% url 'assembly:assembly_marriage_table' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-table"></i>
                    </div>
                    <div class="widget-title">–¢–∞–±–ª–∏—Ü–∞ –∂–µ–Ω–∏—Ç—å–±—ã</div>
                    <div class="widget-subtitle">VIN, –Ω–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –∏ —Ç—Ä–∞–Ω—Å–º–∏—Å–∏–∏</div>
                </a>
            </div>
        {% endif %}

        {% if perms.users.access_to_dp_rvd %}
            <div class="col-md-4">
                <a href="{% url 'office_overview' %}" class="widget-card text-decoration-none d-block">
                    <div class="widget-icon bg-soft-blue">
                        <i class="bi bi-file-earmark-lock2-fill"></i>
                    </div>
                    <div class="widget-title">–î–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</div>
                    <div class="widget-subtitle">–í—ã–≥—Ä—É–∑–∫–∞ –†–í–î, –í–ù–î –∏ –ò–ë–∏–û–¢</div>
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function fetchNotifications() {
        fetch("{% url 'get_notifications' %}")
            .then(response => response.json())
            .then(data => {
                let count = data.unread_count;
                let notificationCount = document.getElementById("notification-count");
                let popup = document.getElementById("notification-popup");
                let message = document.getElementById("notification-message");

                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove("d-none");
                    message.textContent = data.latest_message;
                    popup.classList.remove("d-none");

                    setTimeout(() => popup.classList.add("d-none"), 5000);
                } else {
                    notificationCount.classList.add("d-none"); // –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:", error));
    }

    document.addEventListener("DOMContentLoaded", fetchNotifications); // –ó–∞–ø—Ä–æ—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // setInterval(fetchNotifications, 5000); // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

    document.addEventListener("DOMContentLoaded", function () {
        const vinSelector = document.getElementById("vinSelector");
        const downloadBtn = document.getElementById("downloadVinBtn");

        vinSelector.addEventListener("change", function () {
            const selectedVin = vinSelector.value;
            if (selectedVin) {
                downloadBtn.href = `/vehicle_history/export_excel/${selectedVin}/`;  // –ø—É—Ç—å –∫ vehicle_history
                downloadBtn.classList.remove("disabled");
            }
        });
    });
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const emailElement = document.querySelector(".copy-email");
    const emailText = document.getElementById("email-text");
    const confirm = document.getElementById("copy-confirm");

    emailElement.addEventListener("click", function () {
        const text = emailText.textContent.trim();
        navigator.clipboard.writeText(text).then(() => {
            confirm.style.display = "inline";
            setTimeout(() => confirm.style.display = "none", 1500);
        }).catch(err => {
            console.error("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
        });
    });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("troll-button");
    let hasMoved = false;

    document.addEventListener("mousemove", function (e) {
        const rect = btn.getBoundingClientRect();

        const mouseX = e.clientX;
        const mouseY = e.clientY;

        const btnX = rect.left + rect.width / 2;
        const btnY = rect.top + rect.height / 2;

        const distX = mouseX - btnX;
        const distY = mouseY - btnY;
        const distance = Math.sqrt(distX * distX + distY * distY);

        if (!hasMoved && distance < 160) {
            // –ü–µ—Ä–≤—ã–π —Ä–∞–∑: —É–±–∏—Ä–∞–µ–º bottom/right ‚Üí —Å—Ç–∞–≤–∏–º top/left
            const initialLeft = window.innerWidth - rect.right - 30;
            const initialTop = window.innerHeight - rect.bottom - 30;

            btn.style.left = (btn.offsetLeft - initialLeft) + 'px';
            btn.style.top = (btn.offsetTop - initialTop) + 'px';
            btn.style.right = '';
            btn.style.bottom = '';
            hasMoved = true;
        }

        if (distance < 150) {
            let newLeft = btn.offsetLeft - distX * 0.6;
            let newTop = btn.offsetTop - distY * 0.6;

            const maxX = window.innerWidth - btn.offsetWidth;
            const maxY = window.innerHeight - btn.offsetHeight;

            newLeft = Math.max(0, Math.min(maxX, newLeft));
            newTop = Math.max(0, Math.min(maxY, newTop));

            btn.style.left = newLeft + "px";
            btn.style.top = newTop + "px";
        }
    });

    btn.addEventListener("click", function () {
        const overlay = document.getElementById("troll-overlay");
        overlay.style.display = "flex";

        setTimeout(() => overlay.classList.add("show"), 10); // –¥–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ "–æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å"

        setTimeout(() => {
            overlay.style.display = "none";
            overlay.classList.remove("show");
            window.location.href = "{% url 'logout' %}";
        }, 10000);
    });
});
</script>


{% endblock %}
