{% extends "users/base.html" %}
{% load custom_filters %}
{% block title %}–û—Ç—á—ë—Ç ‚Äî –ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö{% endblock %}

{% block content %}
<div class="container py-4">

    <a href="{% url 'incoming_workshop_dashboard' %}" class="btn btn-outline-secondary mb-4">‚Üê –ù–∞–∑–∞–¥</a>
    <h3 class="mb-4 text-center">–û—Ç—á—ë—Ç ‚Äî –ó–æ–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</h3>

    <div class="row">

        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–û–ü 20 –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-center mb-3">–¢–æ–ø 20 –¥–µ—Ñ–µ–∫—Ç–æ–≤</h5>
                    <table class="table table-striped">
                        <tbody>
                            {% for defect, count in top_defects %}
                                {% with defect|split:"‚Äî" as parts %}
                                    <tr>
                                        <td>
                                            <div><strong>–î–µ—Ç–∞–ª—å:</strong> {{ parts.0|default:"‚Äî"|strip }}</div>
                                            <div><strong>–î–µ—Ñ–µ–∫—Ç:</strong> {{ parts.1|default:"‚Äî"|strip }}</div>
                                        </td>
                                        <td class="text-end align-middle">{{ count }}</td>
                                    </tr>
                                {% endwith %}
                            {% empty %}
                                <tr><td colspan="2" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–∏–ª—å—Ç—Ä—ã + –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="col-md-4 mb-4">
            <form method="get" class="mb-4 text-center">
                <div class="d-flex flex-column align-items-center gap-3">

                    <!-- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω -->
                    <div class="w-100 text-start">
                        <label class="form-label">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</label>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="form-control">
                            <span>‚Äî</span>
                            <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="form-control">
                        </div>
                        <div class="form-text">–ï—Å–ª–∏ –∑–∞–¥–∞–Ω—ã –¥–∞—Ç—ã, –æ–Ω–∏ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º</div>
                    </div>

                    <!-- –ì—Ä–µ–π–¥—ã -->
                    <div class="w-100 text-start">
                        <label class="form-label">–ì—Ä–µ–π–¥—ã:</label>
                        <select name="grade" multiple onchange="this.form.submit()" class="form-select" style="min-height: 150px;">
                            {% for grade in all_grades %}
                                <option value="{{ grade }}" {% if grade in selected_grades %}selected{% endif %}>{{ grade }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (–∏–ª–∏ Cmd) –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</div>
                    </div>

                    <button type="submit" class="btn btn-primary mt-2">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                </div>
            </form>

            <!-- üì¶ –ö–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="d-grid gap-3">
                <div class="card shadow-sm border-secondary text-center">
                    <div class="card-body">
                        <h6 class="card-title">–í—Å–µ–≥–æ –æ—Å–º–æ—Ç—Ä–æ–≤</h6>
                        <p class="fs-4 text-secondary">{{ total_inspections }}</p>
                    </div>
                </div>
                <div class="card shadow-sm border-warning text-center">
                    <div class="card-body">
                        <h6 class="card-title">–ö—É–∑–æ–≤–∞ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏</h6>
                        <p class="fs-4">{{ inspections_with_defects }}</p>
                    </div>
                </div>
                <div class="card shadow-sm border-danger text-center">
                    <div class="card-body">
                        <h6 class="card-title">–í—Å–µ–≥–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤</h6>
                        <p class="fs-4 text-danger">{{ total_defects }}</p>
                    </div>
                </div>
                <div class="card shadow-sm border-primary text-center">
                    <div class="card-body">
                        <h6 class="card-title">DPU</h6>
                        <p class="fs-4">{{ dpu }}</p>
                    </div>
                </div>
                <div class="card shadow-sm border-success text-center">
                    <div class="card-body">
                        <h6 class="card-title">STR (%)</h6>
                        <p class="fs-4">{{ str_percentage }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–û–ü 20 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-center mb-3">–¢–æ–ø 20 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤</h5>
                    <table class="table table-striped">
                        <tbody>
                            {% for controller, count in top_controllers %}
                                <tr>
                                    <td>{{ controller }}</td>
                                    <td class="text-end">{{ count }}</td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="2" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const startDateInput = document.getElementById("start_date");
    const endDateInput = document.getElementById("end_date");

    startDateInput.addEventListener("change", function () {
        if (startDateInput.value) {
            endDateInput.min = startDateInput.value;
        } else {
            endDateInput.removeAttribute("min");
        }
    });

    endDateInput.addEventListener("change", function () {
        if (endDateInput.value) {
            startDateInput.max = endDateInput.value;
        } else {
            startDateInput.removeAttribute("max");
        }
    });

    // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –≤—Ä—É—á–Ω—É—é
    if (startDateInput.value) endDateInput.min = startDateInput.value;
    if (endDateInput.value) startDateInput.max = endDateInput.value;
});
</script>
{% endblock %}