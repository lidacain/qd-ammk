{% extends "users/base.html" %}

{% block title %}–§–∏–∫—Å–∞—Ü–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–§–∏–∫—Å–∞—Ü–∏—è –¥–µ—Ñ–µ–∫—Ç–∞. –ü–æ—Å—Ç: {{ post.name }}</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <p><strong>–ü–æ—Å—Ç:</strong> {{ post.name }}</p>

        <!-- üìå –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="row mb-3">
            <div class="mb-3">
                <label class="form-label">–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
                {{ form.container_number }}
            </div>
            <div class="mb-3">
                <label class="form-label">–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
                <input type="file" name="container_image" id="container_image" class="form-control">
                <button type="button" class="btn btn-primary mt-2" onclick="openCamera('container_image')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                <img id="container_image_preview" src="" class="img-fluid mt-2" style="display:none;">
            </div>

        </div>

        <!-- üìå –ù–æ–º–µ—Ä –ø–ª–æ–º–±—ã -->
        <div class="row mb-3">
            <div class="mb-3">
                <label class="form-label">–ù–æ–º–µ—Ä –ø–∞–ª–µ—Ç–∞</label>
                {{ form.pallet_number }}
            </div>
            <div class="mb-3">
                <label class="form-label">–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –ø–∞–ª–µ—Ç–∞</label>
                <input type="file" name="pallet_image" id="pallet_image" class="form-control">
                <button type="button" class="btn btn-primary mt-2" onclick="openCamera('pallet_image')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                <img id="pallet_image_preview" src="" class="img-fluid mt-2" style="display:none;">
            </div>
        </div>

        <!-- üìå –í—ã–±–æ—Ä –¥–µ—Ç–∞–ª–∏ -->
        <div class="mb-3">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å</label>
            <select name="detail" id="detail_select" class="form-control">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å --</option>
                {% for detail in details %}
                    <option value="{{ detail.id }}">{{ detail.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- üìå –í—ã–±–æ—Ä –¥–µ—Ñ–µ–∫—Ç–∞ (—É–±—Ä–∞–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–µ—Ç–∞–ª—è–º) -->
        <div class="mb-3">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç</label>
            <select name="defect" id="defect_select" class="form-control">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç --</option>
                {% for defect in defects %}
                    <option value="{{ defect.id }}">{{ defect.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞</label>
            {{ form.defect_description }}
        </div>


        <!-- üìå –§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä) -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞</label>
            <input type="file" name="defect_images" id="defect_images" class="form-control" multiple>
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('defect_images')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div id="defect_images_preview" class="d-flex flex-wrap mt-2"></div>
        </div>

        <!-- üìå –ì–∞–ª–µ—Ä–µ—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div class="row mt-3" id="defect_images_gallery"></div>

        <button type="submit" class="btn btn-danger w-100">üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
    </form>
</div>

<!-- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã -->
<div id="camera_modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <video id="camera_feed" style="width: 90%; max-width: 500px; object-fit: contain;"></video>
    <button id="capture_button" class="btn btn-success mt-3">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<canvas id="camera_canvas" style="display:none;"></canvas>

<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!");

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function setupBootstrapDropdown(selectElement) {
        if (!selectElement) return;

        let container = document.createElement("div");
        container.classList.add("dropdown");

        let input = document.createElement("input");
        input.setAttribute("type", "text");
        input.setAttribute("class", "form-control dropdown-toggle");
        input.setAttribute("placeholder", "üîç –ü–æ–∏—Å–∫...");
        input.setAttribute("data-bs-toggle", "dropdown");

        let dropdownMenu = document.createElement("ul");
        dropdownMenu.classList.add("dropdown-menu", "w-100");
        dropdownMenu.style.maxHeight = "200px";
        dropdownMenu.style.overflowY = "auto";

        container.appendChild(input);
        container.appendChild(dropdownMenu);
        selectElement.parentNode.insertBefore(container, selectElement);
        selectElement.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π select

        function updateDropdown() {
            let query = input.value.toLowerCase();
            dropdownMenu.innerHTML = "";
            let matchCount = 0;

            Array.from(selectElement.options).forEach(option => {
                if (option.value && option.text.toLowerCase().includes(query)) {
                    let item = document.createElement("li");
                    let link = document.createElement("a");
                    link.setAttribute("href", "#");
                    link.classList.add("dropdown-item");
                    link.textContent = option.text;
                    link.onclick = function(event) {
                        event.preventDefault();
                        input.value = option.text;
                        selectElement.value = option.value;
                        dropdownMenu.classList.remove("show");
                    };
                    item.appendChild(link);
                    dropdownMenu.appendChild(item);
                    matchCount++;
                }
            });

            if (matchCount > 0) {
                dropdownMenu.classList.add("show");
            } else {
                dropdownMenu.classList.remove("show");
            }
        }

        input.addEventListener("input", updateDropdown);
        input.addEventListener("focus", updateDropdown);
        document.addEventListener("click", function(event) {
            if (!container.contains(event.target)) {
                dropdownMenu.classList.remove("show");
            }
        });
    }

    // ‚úÖ –í–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    setupBootstrapDropdown(document.getElementById("detail_select"));
    setupBootstrapDropdown(document.getElementById("defect_select"));

    // ‚úÖ –ö–∞–º–µ—Ä–∞
    let modal = document.getElementById("camera_modal");
    let video = document.getElementById("camera_feed");
    let closeButton = document.getElementById("close_camera");
    let captureButton = document.getElementById("capture_button");
    let canvas = document.createElement("canvas");

    let activeInput = null;
    let activePreview = null;
    let activeStream = null;

    let defectImagesInput = document.getElementById("defect_images");
    let galleryContainer = document.getElementById("defect_images_gallery");

    console.log("üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞!");

    window.openCamera = function(inputId) {
        console.log(`üì∑ –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –¥–ª—è ${inputId}`);

        activeInput = document.getElementById(inputId);
        activePreview = document.getElementById(`${inputId}_preview`);

        if (!activeInput) {
            console.error(`‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç input #${inputId}`);
            return;
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
            activeStream = stream;
            video.srcObject = stream;
            video.play();
            modal.style.display = "flex";
            console.log("‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∞!");
        })
        .catch(function(error) {
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ");
            console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
        });
    };

    function closeCamera() {
        console.log("‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã...");

        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            activeStream = null;
        }

        modal.style.display = "none";
    }

    captureButton.addEventListener("click", function() {
        console.log("üì∏ –ó–∞—Ö–≤–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...");
        let context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        let timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        let fileName = `photo_${timestamp}.jpg`;

        canvas.toBlob(function(blob) {
            let file = new File([blob], fileName, { type: "image/jpeg" });

            if (activeInput.id === "defect_images") {
                addFileToDefectImages(file);
            } else {
                let dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                activeInput.files = dataTransfer.files;

                if (activePreview) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        activePreview.src = e.target.result;
                        activePreview.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                }
            }

            console.log("‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ input:", fileName);
        }, "image/jpeg");

        closeCamera();
    });

    closeButton.addEventListener("click", closeCamera);

    modal.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeCamera();
        }
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function addFileToDefectImages(file) {
        let dataTransfer = new DataTransfer();

        let existingFiles = defectImagesInput.files;
        for (let i = 0; i < existingFiles.length; i++) {
            dataTransfer.items.add(existingFiles[i]);
        }

        dataTransfer.items.add(file);
        defectImagesInput.files = dataTransfer.files;

        updateDefectGallery();
    }

    // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    function updateDefectGallery() {
        galleryContainer.innerHTML = "";
        let files = defectImagesInput.files;

        for (let i = 0; i < files.length; i++) {
            let file = files[i];
            let reader = new FileReader();

            reader.onload = function(e) {
                let colDiv = document.createElement("div");
                colDiv.classList.add("col-md-3", "mb-3");

                let img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("img-fluid", "rounded", "shadow-sm");

                let deleteBtn = document.createElement("button");
                deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-1");
                deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                deleteBtn.onclick = function() {
                    removeDefectFile(i);
                };

                colDiv.appendChild(img);
                colDiv.appendChild(deleteBtn);
                galleryContainer.appendChild(colDiv);
            };

            reader.readAsDataURL(file);
        }
    }

    function removeDefectFile(index) {
        let dt = new DataTransfer();
        let files = defectImagesInput.files;

        for (let i = 0; i < files.length; i++) {
            if (i !== index) {
                dt.items.add(files[i]);
            }
        }

        defectImagesInput.files = dt.files;
        updateDefectGallery();
    }

    defectImagesInput.addEventListener("change", updateDefectGallery);
});


document.addEventListener("DOMContentLoaded", function() {
    console.log("üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!");

    let modal = document.getElementById("camera_modal");
    let video = document.getElementById("camera_feed");
    let closeButton = document.getElementById("close_camera");
    let captureButton = document.getElementById("capture_button");

    let activeStream = null;

    console.log("üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞!");

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
    function closeCamera() {
        console.log("‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã...");
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            activeStream = null;
        }
        modal.style.display = "none";
    }

    // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("load", function() {
        console.log("üîÑ –ê–≤—Ç–æ-–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã");
        closeCamera();
    });

    closeButton.addEventListener("click", closeCamera);

    modal.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeCamera();
        }
    });

});
</script>
{% endblock %}