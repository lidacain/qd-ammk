T{% extends "users/base.html" %}
{%load static %}
{% block title %}–ü–æ—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–µ–º–∫–∏ DKD{% endblock %}

{% block content %}

<style>

    /* ‚úÖ Select2 –≤–Ω–µ—à–Ω–µ –∫–∞–∫ Bootstrap 5 form-control */
    .select2-container .select2-selection--single {
        height: 38px !important;
        padding: 6px 12px;
        border: 1px solid #ced4da !important;
        border-radius: 5px !important;
        font-size: 16px;
        background-color: white;
        box-shadow: none;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #212529;
        line-height: 24px;
        padding-left: 0;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
        right: 10px;
    }

    /* ‚úÖ –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
    .select2-container {
        display: block !important;
        width: 100% !important;
        margin-bottom: 0 !important;
    }


    /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ */
    #vin_photo_preview img,
    #body_photos_preview img,
    .defect-photo-preview img {
        max-width: 300px !important; /* –î–µ–ª–∞–µ–º —Ç–∞–∫–æ–π –∂–µ —Ä–∞–∑–º–µ—Ä, –∫–∞–∫ —É —Ñ–æ—Ç–æ VIN –∏ –∫—É–∑–æ–≤–∞ */
        height: auto !important;
        border-radius: 5px !important;
        object-fit: cover !important;
        display: block !important;
    }

     .zone-btn-img {
        border: 2px solid #ccc;
        border-radius: 8px;
        padding: 0;
        background-color: #f8f9fa;
        transition: 0.2s ease-in-out;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    /* üì∑ –§–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
    .zone-btn-img img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ */
        padding: 5px; /* –î–æ–±–∞–≤–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        border-radius: 6px;
    }

    /* üì¶ –†–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫ */

    /* –ë–æ–∫–æ–≤—ã–µ ‚Äî –ª–µ–≤–∞—è / –ø—Ä–∞–≤–∞—è */
    .long-btn {
        width: 140px;
        height: 300px;
    }

    /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è (–≤–µ—Ä—Ö) */
    .long-btn-vertical {
        width: 160px;
        height: 300px;
    }

    /* –í–µ—Ä—Ö –∏ –∑–∞–¥ */
    .short-btn {
        width: 160px;
        height: 100px;
    }

    .zone-btn-img:hover {
        border-color: #007bff;
        background-color: #e0f0ff;
    }

    /* üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 576px) {
        .long-btn {
            width: 110px;
            height: 220px;
        }
        .long-btn-vertical {
            width: 130px;
            height: 220px;
        }
        .short-btn {
            width: 120px;
            height: 80px;
        }
    }
    .zone-btn-img.selected {
        border-color: red !important;
        background-color: #ffe6e6 !important;
    }


    /* ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ */
    #body_photos_preview img {
        max-width: 300px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
        height: auto;
        border-radius: 5px;
        object-fit: cover;
    }

    /* ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ç–æ VIN */
    #vin_photo_preview {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
    }

    /* ‚úÖ –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å" */
    .btn-danger {
        font-size: 14px;
        padding: 5px 10px;
    }
    .defect-photo-preview img {
    max-width: 300px !important;
    height: auto !important;
    border-radius: 5px;
    object-fit: cover;
}

.is-invalid {
  border-color: red !important;
  box-shadow: 0 0 5px red !important;
}
    #body_photos {
    pointer-events: none; /* –∑–∞–ø—Ä–µ—Ç –∫–ª–∏–∫–æ–≤ */
}

#inspection_timer_display {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 8px 20px;
    border-radius: 0 0 10px 10px;
    font-size: 16px;
    font-weight: bold;
    z-index: 99999;
    display: none;
    backdrop-filter: blur(3px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>

<div class="container mt-4">
    <h2>–ó–æ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–µ–º–∫–∏ (DKD)</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <!-- ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- üìå –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä VIN<span style="color: red">*</span></label>
            <div style="position: relative;">
                <input type="text" id="vin_search" name="vin_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ VIN..." maxlength="17">
                <span id="clear_vin_search" style="
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    font-size: 18px;
                    color: #dc3545">‚ùå</span>
            </div>
            <button type="button" id="start_qr_scan" class="btn btn-primary mt-2"><i class="bi bi-qr-code-scan"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</button>
            <div id="qr-reader" style="width: 300px; display: none;"></div>
            <button type="button" id="stop_qr_scan" class="btn btn-danger mt-2" style="display: none;">‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <ul id="vin_list" class="list-group mt-2" style="display: none; position: absolute; width: 100%; z-index: 1000;"></ul>
        </div>

        <!-- üìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ VIN -->
        <div id="vehicle_info" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É–∑–æ–≤–µ:</h5>
            <p><strong>VIN:</strong> <span id="vin_value"></span></p>
            <p><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_number_value"></span></p>
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
            <p><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
        </div>

        <!-- üìå –§–æ—Ç–æ –∫—É–∑–æ–≤–∞ -->
        <div class="mb-3 position-relative">
            <label class="form-label">–§–æ—Ç–æ –∫—É–∑–æ–≤–∞<span style="color: red">*</span></label>
            <input type="file" name="body_photos" id="body_photos" class="form-control"
                   multiple readonly
                   style="opacity: 0; pointer-events: none; position: absolute; z-index: 2; height: 100%; width: 100%; top: 0; left: 0;">
            <div id="body_photos_display" class="form-control bg-light fw-bold" style="z-index: 1;">
                 –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
            </div>
            <button type="button" class="btn btn-primary mt-2"
                    onclick="openBodyNativeCamera('body_photos','body_photos_preview')">
              <i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
            </button>
            <div id="body_photos_preview" class="d-flex flex-wrap mt-2 gap-2"></div>
        </div>

        <!-- üìå –í–æ–ø—Ä–æ—Å –æ –¥–µ—Ñ–µ–∫—Ç–∞—Ö -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç?<span style="color: red">*</span></label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no">
                <label class="form-check-label" for="defect_no">–î–µ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç</label>
            </div>
        </div>

        <!-- üìå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div id="defect_container" class="mt-3" style="display:none;">
            <h5>–°–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤:</h5>
            <div id="defect_list"></div> <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
            <button type="button" class="btn btn-primary mt-2" id="add_defect_btn"><i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>

            <!-- üìå –®–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ `defect_container`, –Ω–æ —Å–∫—Ä—ã—Ç) -->
            <div id="defect_template" class="border p-3 mt-2 rounded" style="display: none;">

                <!-- üîò –í—ã–±–æ—Ä —á–∞—Å—Ç–∏ –∫—É–∑–æ–≤–∞ -->
                <div class="mb-3 text-center">
                    <label class="form-label"></label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="zone_type_${defectIndex}" id="zone_type_exterior_${defectIndex}" value="exterior" checked>
                        <label class="form-check-label" for="zone_type_exterior_${defectIndex}">–≠–∫—Å—Ç–µ—Ä—å–µ—Ä</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="zone_type_${defectIndex}" id="zone_type_interior_${defectIndex}" value="interior">
                        <label class="form-check-label" for="zone_type_interior_${defectIndex}">–ò–Ω—Ç–µ—Ä—å–µ—Ä</label>
                    </div>
                </div>

                <!-- üîò –í—ã–±–æ—Ä —á–∞—Å—Ç–∏ –∫—É–∑–æ–≤–∞ -->
                <div class="mb-3 text-center">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å</label>

                    <!-- üì¶ –ë–ª–æ–∫ —ç–∫—Å—Ç–µ—Ä—å–µ—Ä–∞ -->
                    <div class="zone-map-wrapper" id="exterior_zone_wrapper">
                        <div class="exterior_zone_map zone-map d-flex flex-column align-items-center gap-2">
                            <button type="button" class="zone-btn-img short-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å">
                                <img src="{% static 'img/ext/front.png' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å">
                            </button>
                            <div class="d-flex justify-content-center gap-2 flex-wrap w-100">
                                <button type="button" class="zone-btn-img long-btn" data-part="–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                    <img src="{% static 'img/ext/left.png' %}" alt="–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                </button>
                                <button type="button" class="zone-btn-img long-btn-vertical" data-part="–í–µ—Ä—Ö">
                                    <img src="{% static 'img/ext/up.png' %}" alt="–í–µ—Ä—Ö">
                                </button>
                                <button type="button" class="zone-btn-img long-btn" data-part="–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                    <img src="{% static 'img/ext/right.png' %}" alt="–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                </button>
                            </div>
                            <button type="button" class="zone-btn-img short-btn" data-part="–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å">
                                <img src="{% static 'img/ext/back.png' %}" alt="–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å">
                            </button>
                        </div>
                    </div>

                    <!-- üì¶ –ë–ª–æ–∫ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ -->
                    <div class="zone-map-wrapper" id="interior_zone_wrapper" style="display: none;">
                        <div class="interior_zone_map zone-map d-flex flex-column align-items-center gap-2">
                            <button type="button" class="zone-btn-img long-btn-vertical" data-part="–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞">
                                <img src="{% static 'img/int/mult.jpg' %}" alt="–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞">
                            </button>
                            <div class="d-flex justify-content-center gap-2 w-100">
                                <button type="button" class="zone-btn-img long-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/fd_left.jpg' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                                <button type="button" class="zone-btn-img long-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/fd_right.jpg' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                            </div>
                            <button type="button" class="zone-btn-img long-btn-vertical" data-part="–°–∞–ª–æ–Ω">
                                <img src="{% static 'img/int/salon.jpg' %}" alt="–°–∞–ª–æ–Ω">
                            </button>
                            <div class="d-flex justify-content-center gap-2 w-100">
                                <button type="button" class="zone-btn-img long-btn" data-part="–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/bd_left.jpg' %}" alt="–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                                <button type="button" class="zone-btn-img long-btn" data-part="–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/bd_right.jpg' %}" alt="–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- üìç –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã -->
                    <input type="hidden" name="zone_0" class="selected-part-name">
                    <div class="mt-2">
                        <strong>–í—ã–±—Ä–∞–Ω–æ:</strong> <span class="selected-part-preview text-primary">‚Äî</span>
                    </div>
                </div>

                <!-- üìå –î–µ—Ç–∞–ª—å -->
                <div class="mb-3">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å</label>
                    <select class="form-control select2-detail defect-detail" name="detail_${defectIndex}" data-placeholder="üîç –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–∏...">
                        <option></option>  <!-- placeholder -->
                        ${detailsOptions()}
                    </select>
                    <input type="text" class="form-control mt-2 custom-detail-explanation" name="custom_detail_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>

                <!-- üìå –î–µ—Ñ–µ–∫—Ç -->
                <div class="mb-3">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç <span style="color: red">*</span></label>
                    <select class="form-control select2-defect defect-type" name="defect_${defectIndex}" data-placeholder="üîç –ü–æ–∏—Å–∫ –¥–µ—Ñ–µ–∫—Ç–∞...">
                        <option></option>  <!-- placeholder -->
                        {% for defect in defects %}
                            <option value="{{ defect.id }}">{{ defect.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" class="form-control mt-2 custom-defect-explanation" name="custom_defect_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>

                <!-- üìå –ö–æ–ª-–≤–æ -->
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="form-control defect-quantity" name="quantity" min="1" value="1">
                </div>

                <!-- üìå –ì—Ä–µ–π–¥ -->
                <div class="mb-3">
                    <label class="form-label">–ì—Ä–µ–π–¥ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <select class="form-control defect-grade" name="grade">
                        {% for grade in defect_grades %}
                            <option value="{{ grade.id }}">{{ grade.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- üìå –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
                <div class="mb-3">
                    <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¥–µ—Ñ–µ–∫—Ç</label>
                    <select name="responsible" class="form-control responsible-select">
                        <option value="">üîç –ü–æ–∏—Å–∫...</option>
                        {% for responsible in defect_responsibles %}
                            <option value="{{ responsible.id }}">{{ responsible.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- üìå –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ -->
                <div class="mb-3">
                    <label class="form-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞</label>
                    <select class="form-control defect-repair-type" name="repair_type_{{ defect_index }}">
                        <option value="online">online</option>
                        <option value="offline">offline</option>
                    </select>
                </div>

                <!-- üìå –§–æ—Ç–æ -->
                <div class="mb-3 position-relative">
                    <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <input type="file"
                           class="form-control defect-photo"
                           name="defect_photos_${defectIndex}"
                           id="defect_photo_input_${defectIndex}"
                           multiple
                           readonly
                           style="opacity: 0; pointer-events: none; position: absolute; z-index: 2; height: 100%; width: 100%; top: 0; left: 0;">
                    <div id="defect_photo_display_${defectIndex}"
                         class="form-control bg-light fw-bold"
                         style="z-index: 1;">
                         –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
                    </div>
                    <button type="button"
                            class="btn btn-primary mt-2 open-camera-btn"
                            data-input-id="defect_photo_input_${defectIndex}"
                            data-preview-id="defect_photo_preview_${defectIndex}">
                        <i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                    </button>
                    <div id="defect_photo_preview_${defectIndex}" class="d-flex flex-column align-items-center mt-2"></div>
                </div>

                <!-- üìå –£–¥–∞–ª–∏—Ç—å -->
                <button type="button" class="btn btn-danger remove-defect-btn"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
            </div>
        </div>

        <!-- üïí –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ç–∞–π–º–µ—Ä–∞ -->
        <input type="hidden" name="inspection_duration_seconds" id="inspection_duration_seconds">

        <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn btn-success w-100 mt-3"><i class="bi bi-check-circle-fill me-1"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<script>
let inspectionStartTime = null;
let inspectionTimerInterval = null;

function startInspectionTimer() {
    inspectionStartTime = new Date();

    const display = document.getElementById("inspection_timer_display");
    if (!display) return;

    display.style.display = "block";

    inspectionTimerInterval = setInterval(() => {
        const now = new Date();
        const elapsedMs = now - inspectionStartTime;
        const minutes = Math.floor(elapsedMs / 60000);
        const seconds = Math.floor((elapsedMs % 60000) / 1000);
        display.textContent = `–í—Ä–µ–º—è –æ—Å–º–æ—Ç—Ä–∞: ${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
    }, 1000);
}

function stopInspectionTimer() {
    if (!inspectionStartTime) return;

    const now = new Date();
    const elapsedSeconds = Math.floor((now - inspectionStartTime) / 1000);

    const hiddenField = document.getElementById("inspection_duration_seconds");
    if (hiddenField) {
        hiddenField.value = elapsedSeconds;
        console.log("‚è±Ô∏è –í—Ä–µ–º—è –æ—Å–º–æ—Ç—Ä–∞:", elapsedSeconds, "—Å–µ–∫—É–Ω–¥");
    } else {
        console.warn("‚ö†Ô∏è –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
    }

    clearInterval(inspectionTimerInterval);

    const display = document.getElementById("inspection_timer_display");
    if (display) display.style.display = "none";
}
document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");

    form.addEventListener("submit", async function (event) {
        event.preventDefault();              // ‚Üê –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–∞–±–º–∏—Ç –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        stopInspectionTimer();

        const formEl = event.target;
        const vinInput = document.getElementById("vin_search");
        const vin = vinInput ? vinInput.value.trim() : "";

        // helper: –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Ñ–æ–∫—É—Å + —Å–∫—Ä–æ–ª–ª –∫ VIN
        const focusScroll = (el) => {
            if (!el) return;
            el.classList.add("is-invalid");
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => el.focus({ preventScroll: true }), 200);
        };

        let bodyPhotosInput = document.getElementById("body_photos");
        let hasDefectYes = document.getElementById("defect_yes");
        let hasDefectNo  = document.getElementById("defect_no");

        let errors = [];
        let firstInvalid = null;

        // –°–±—Ä–æ—Å —Å—Ç–∞—Ä–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        [vinInput, bodyPhotosInput].forEach(input => {
            if (input) input.classList.remove("is-invalid");
        });
        const defectRadioGroup = document.querySelector("input[name='has_defect']").closest(".mb-3");
        defectRadioGroup.classList.remove("border", "border-danger");

        // === –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å) ===
        if (!vin) {
            vinInput.classList.add("is-invalid");
            errors.push("VIN-–Ω–æ–º–µ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!");
            if (!firstInvalid) firstInvalid = vinInput;
        }
        if (!bodyPhotosInput || bodyPhotosInput.files.length === 0) {
            bodyPhotosInput.classList.add("is-invalid");
            errors.push("–§–æ—Ç–æ –∫—É–∑–æ–≤–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!");
            if (!firstInvalid) firstInvalid = bodyPhotosInput;
        }
        if (!hasDefectYes.checked && !hasDefectNo.checked) {
            defectRadioGroup.classList.add("border", "border-danger", "rounded", "p-2");
            errors.push("–í—ã–±–µ—Ä–∏—Ç–µ, –µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç!");
            if (!firstInvalid) firstInvalid = defectRadioGroup;
        }

        // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç" ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        if (hasDefectYes.checked) {
            // ... –≤–∞—à –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º –¥–µ—Ñ–µ–∫—Ç–æ–≤ (–∫–∞–∫ —Å–µ–π—á–∞—Å) ...
            // –æ–Ω –º–æ–∂–µ—Ç –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å firstInvalidForm –∏ push'–∏—Ç—å –≤ errors
        }

        if (errors.length > 0) {
            // –∫–∞–∫ –∏ —Å–µ–π—á–∞—Å: —Ä–∞—Å–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ—Ñ–µ–∫—Ç–æ–≤, –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å –∫ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ, alert
            document.getElementById("defect_container").style.display = "block";
            const scrollTarget = firstInvalid; // –∏–ª–∏ firstInvalidForm, –µ—Å–ª–∏ —É –≤–∞—Å –æ–Ω –µ—Å—Ç—å
            if (scrollTarget?.scrollIntoView) {
                setTimeout(() => {
                    scrollTarget.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100);
            }
            alert(errors.join("\n"));
            return; // ‚Üê —Å–∞–±–º–∏—Ç –ù–ï –∏–¥—ë—Ç
        }

        // === –ù–û–í–û–ï: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ VIN —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ ===
        const exists = await checkVinExists(vin);
        if (!exists) {
            alert("‚ùå –í–≤–µ–¥–µ–Ω–Ω—ã–π VIN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ –±–∞–∑–µ.");
            focusScroll(vinInput);           // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ + —Å–∫—Ä–æ–ª–ª –Ω–∞ VIN
            return;                          // –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –ù–ï —Ç–µ—Ä—è—é—Ç—Å—è
        }

        // VIN –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å–∞–±–º–∏—Ç
        formEl.submit();
    });

    // ‚è¨ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    setupVinSearch();
    setupCamera();
    setupDefectHandling();
    document.querySelectorAll(".responsible-select").forEach(setupBootstrapDropdown);
});

/* ------------------- */
/* üîπ –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ VIN */
/* ------------------- */
function setupVinSearch() {
    let vinInput = document.getElementById("vin_search");
    let vinList = document.getElementById("vin_list");
    let clearButton = document.getElementById("clear_vin_search");
    let vehicleInfo = document.getElementById("vehicle_info");

    let vinValue = document.getElementById("vin_value");
    let engineNumberValue = document.getElementById("engine_number_value");
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");

    vinInput.addEventListener("input", function() {
        let query = vinInput.value.trim();

        if (query.length > 0) {
            clearButton.style.display = "block";
            startInspectionTimer();
        } else {
            clearButton.style.display = "none";
        }

        if (!query) {
            vinList.style.display = "none";
            return;
        }

        fetch(`/supplies/api/search_vin/?q=${query}`)
            .then(response => {
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                return response.json();
            })
            .then(data => {
                vinList.innerHTML = "";
                if (data.results.length === 0) {
                    vinList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.vin;
                    li.addEventListener("click", function() {
                        vinInput.value = item.vin;
                        vinList.style.display = "none";
                        clearButton.style.display = "block";

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É–∑–æ–≤–µ
                        vinValue.textContent = item.vin;
                        engineNumberValue.textContent = item.engine_number;
                        modelValue.textContent = item.model;
                        bodyColorValue.textContent = item.body_color;
                        vehicleInfo.style.display = "block";
                    });

                    vinList.appendChild(li);
                });

                vinList.style.display = "block";
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error));
    });

    clearButton.addEventListener("click", function() {
        vinInput.value = "";
        clearButton.style.display = "none";
        vinList.style.display = "none";
        vehicleInfo.style.display = "none";
    });

    document.addEventListener("click", function(event) {
        if (!vinInput.contains(event.target) && !vinList.contains(event.target)) {
            vinList.style.display = "none";
        }
    });
}

/* ------------------- */
/* üîπ –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π VIN –∏ –∫—É–∑–æ–≤–∞ */
/* ------------------- */
function setupCamera() {
    const isMobileDevice = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobileDevice()) {
        // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –Ω–∞—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
        window.openCamera = function (inputId, previewId) {
            window.continueCaptureLoop = true;
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            if (!input || !preview) return;

            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment"); // –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É

            input.onchange = function () {
                if (!input.files || input.files.length === 0) {
                    window.continueCaptureLoop = false; // ‚ùå –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
                    return;
                }
                const dt = new DataTransfer();

                const existingImages = preview.querySelectorAll("img[data-file]");
                let promises = [];

                // üîÅ 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                existingImages.forEach(img => {
                    const base64 = img.src;
                    const filename = img.getAttribute("data-file");

                    const p = fetch(base64)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], filename, { type: blob.type });
                            dt.items.add(file);
                        });

                    promises.push(p);
                });

                // üì∏ 2. –ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å –∫–∞–º–µ—Ä—ã
                const newFiles = Array.from(input.files);

                newFiles.forEach(file => {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const dataURL = e.target.result;
                        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                        const filename = `photo_${timestamp}.jpg`;

                        const blob = dataURLToBlob(dataURL);
                        const renamedFile = new File([blob], filename, { type: file.type });
                        const imageURL = URL.createObjectURL(renamedFile);

                        // üîÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—É—Å–µ–ª—å, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                        if (!preview.dataset.carouselInitialized) {
                            preview.dataset.carouselInitialized = "true";
                            preview.carouselData = [];
                            preview.currentIndex = 0;

                            preview.innerHTML = `
                                <div class="carousel-wrapper d-flex flex-column align-items-center">
                                    <div class="carousel-img-container position-relative" style="position: relative;">
                                        <img class="carousel-img img-thumbnail mb-2"
                                             style="max-width:300px; border-radius:5px; object-fit:cover; width: 100%; position: relative; z-index: 1;">

                                        <!-- –ó–æ–Ω—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫—Ä–∞—è–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                        <div class="carousel-left-zone"
                                             style="position:absolute; top:0; bottom:0; left:0; width:50%; z-index:2;"></div>
                                        <div class="carousel-right-zone"
                                             style="position:absolute; top:0; bottom:0; right:0; width:50%; z-index:2;"></div>
                                    </div>

                                    <!-- üîò –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                                    <button type="button" class="carousel-delete btn btn-danger btn-sm mt-2 mb-1">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>

                                    <!-- ‚¨ÖÔ∏è‚û°Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                                    <div class="carousel-controls d-flex justify-content-between align-items-center mt-3 w-100" style="max-width:300px;">
                                        <button type="button" class="carousel-prev btn btn-secondary btn-lg px-4">‚Üê</button>
                                        <span class="carousel-counter fs-5">1 / 1</span>
                                        <button type="button" class="carousel-next btn btn-secondary btn-lg px-4">‚Üí</button>
                                    </div>
                                </div>
                            `;

                            // üìå –ü—Ä–∏–≤—è–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            const imgElement = preview.querySelector(".carousel-img");
                            const deleteBtn = preview.querySelector(".carousel-delete");
                            const prevBtn = preview.querySelector(".carousel-prev");
                            const nextBtn = preview.querySelector(".carousel-next");
                            const counter = preview.querySelector(".carousel-counter");

                            // üìå –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—É—Å–µ–ª–∏
                            function updateCarousel() {
                                const data = preview.carouselData;
                                if (data.length === 0) {
                                    preview.innerHTML = "<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>";
                                    preview.dataset.carouselInitialized = "";
                                    preview.carouselData = null;
                                    return;
                                }

                                const current = data[preview.currentIndex];
                                imgElement.src = current.url;
                                counter.textContent = `${preview.currentIndex + 1} / ${data.length}`;
                            }

                            // üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
                            deleteBtn.onclick = () => {
                                preview.carouselData.splice(preview.currentIndex, 1);
                                if (preview.currentIndex >= preview.carouselData.length) {
                                    preview.currentIndex = preview.carouselData.length - 1;
                                }
                                updateCarousel();

                                const dt = new DataTransfer();
                                preview.carouselData.forEach(item => dt.items.add(item.file));
                                input.files = dt.files;

                                // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                                if (input.id === "body_photos") {
                                    const display = document.getElementById("body_photos_display");
                                    if (display) {
                                        const count = input.files.length;
                                        display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                    }
                                } else if (input.id.startsWith("defect_photo_input_")) {
                                    const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                                    const display = document.getElementById(`defect_photo_display_${index}`);
                                    if (display) {
                                        const count = input.files.length;
                                        display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                    }
                                }
                            };

                            prevBtn.onclick = () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    updateCarousel();
                                }
                            };

                            nextBtn.onclick = () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    updateCarousel();
                                }
                            };

                            preview.updateCarousel = updateCarousel;
                            const leftZone = preview.querySelector(".carousel-left-zone");
                            const rightZone = preview.querySelector(".carousel-right-zone");

                            leftZone.addEventListener("click", () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    preview.updateCarousel();
                                }
                            });

                            rightZone.addEventListener("click", () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    preview.updateCarousel();
                                }
                            });
                        }

                        // ‚ûï –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        preview.carouselData.push({ file: renamedFile, url: imageURL });
                        preview.currentIndex = preview.carouselData.length - 1;
                        preview.updateCarousel();

                        // üóÇÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º input.files
                        const dt = new DataTransfer();
                        preview.carouselData.forEach(item => dt.items.add(item.file));
                        input.files = dt.files;

                        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                        if (input.id === "body_photos") {
                            const display = document.getElementById("body_photos_display");
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        } else if (input.id.startsWith("defect_photo_input_")) {
                            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                            const display = document.getElementById(`defect_photo_display_${index}`);
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        }
                    };

                    reader.readAsDataURL(file);
                });


                // ‚è≥ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å–µ—Ö fetch
                Promise.all(promises).then(() => {
                    input.files = dt.files;
                    // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                    if (input.id === "body_photos") {
                        const display = document.getElementById("body_photos_display");
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    } else if (input.id.startsWith("defect_photo_input_")) {
                        const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                        const display = document.getElementById(`defect_photo_display_${index}`);
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    }
                });
            };

            input.click();
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è base64 –≤ Blob
        function dataURLToBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        };


    } else {
        // üíª –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let modal = document.createElement("div");
        modal.id = "camera_modal";
        modal.style.display = "none";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.flexDirection = "column";
        modal.innerHTML = `
            <video id="camera_feed" autoplay playsinline style="width:90%; max-width:500px;"></video>
            <button id="capture_button" class="btn btn-success mt-3"><i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        document.body.appendChild(modal);

        let video = document.getElementById("camera_feed");
        let captureButton = document.getElementById("capture_button");
        let closeButton = document.getElementById("close_camera");

        let canvas = document.createElement("canvas");
        let activeStream = null;
        let activeInput = null;
        let activePreview = null;

        window.openCamera = function (inputId, previewId) {
            activeInput = document.getElementById(inputId);
            activePreview = document.getElementById(previewId);

            if (!activeInput || !activePreview) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –∏–ª–∏ preview");
                return;
            }

            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function (stream) {
                    activeStream = stream;
                    video.srcObject = stream;
                    modal.style.display = "flex";
                    setTimeout(() => video.play(), 500);
                })
                .catch(function (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                    alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
                });

            captureButton.onclick = function () {
                if (!activeInput || !activePreview) return;

                let context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(function (blob) {
                    let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

                    let dataTransfer = new DataTransfer();
                    if (!activeInput.multiple) {
                        activeInput.value = "";
                        while (activePreview.firstChild) activePreview.removeChild(activePreview.firstChild);
                    } else {
                        for (let f of activeInput.files) {
                            dataTransfer.items.add(f);
                        }
                    }

                    dataTransfer.items.add(file);
                    activeInput.files = dataTransfer.files;

                    let imgContainer = document.createElement("div");
                    imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

                    let img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    img.classList.add("img-thumbnail");
                    img.style.maxWidth = "300px";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";

                    let deleteBtn = document.createElement("button");
                    deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
                    deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
                    deleteBtn.onclick = function () {
                        imgContainer.remove();
                        removeFileFromInput(activeInput, file);
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(deleteBtn);
                    activePreview.appendChild(imgContainer);

                    closeCamera();
                }, "image/jpeg");
            };
        };

        function removeFileFromInput(inputElement, fileToRemove) {
            let dataTransfer = new DataTransfer();
            for (let i = 0; i < inputElement.files.length; i++) {
                let file = inputElement.files[i];
                if (file.name !== fileToRemove.name || file.size !== fileToRemove.size) {
                    dataTransfer.items.add(file);
                }
            }
            inputElement.files = dataTransfer.files;
        }

        function closeCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
            }
            video.srcObject = null;
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", closeCamera);
        modal.addEventListener("click", function (event) {
            if (event.target === modal) closeCamera();
        });
    }
}


function rebuildInputFiles(input, preview) {
    const dt = new DataTransfer();

    const images = preview.querySelectorAll("img[data-file]");
    let promises = [];

    images.forEach(img => {
        const base64 = img.src;
        const filename = img.getAttribute("data-file");

        const p = fetch(base64)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], filename, { type: blob.type });
                dt.items.add(file);
            });

        promises.push(p);
    });

    Promise.all(promises).then(() => {
        input.files = dt.files;
        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
        if (input.id === "body_photos") {
            const display = document.getElementById("body_photos_display");
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        } else if (input.id.startsWith("defect_photo_input_")) {
            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
            const display = document.getElementById(`defect_photo_display_${index}`);
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : " –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        }
    });
}
function initSelect2Filters(scope = document) {
    // –î–µ—Ç–∞–ª—å
    $(scope).find('.select2-detail').select2({
        placeholder: "üîç –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–∏...",
        width: '100%',
        allowClear: true,
        language: {
            noResults: function () {
                return "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            }
        }
    });

    // –î–µ—Ñ–µ–∫—Ç
    $(scope).find('.select2-defect').select2({
        placeholder: "üîç –ü–æ–∏—Å–∫ –¥–µ—Ñ–µ–∫—Ç–∞...",
        width: '100%',
        allowClear: true,
        language: {
            noResults: function () {
                return "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            }
        }
    });
}


/* ------------------- */
/* üîπ –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ */
/* ------------------- */
function setupDefectHandling() {
    console.log("üöÄ –°–∫—Ä–∏–ø—Ç –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω!");

    let defectContainer = document.getElementById("defect_container");
    let defectList = document.getElementById("defect_list");
    let addDefectBtn = document.getElementById("add_defect_btn");
    let defectRadioButtons = document.querySelectorAll("input[name='has_defect']");

    // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏
    defectRadioButtons.forEach(radio => {
        radio.addEventListener("change", function() {
            if (this.value === "yes") {
                defectContainer.style.display = "block";
                if (defectList.children.length === 0) {
                    addDefectForm(); // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ä–º—É –¥–µ—Ñ–µ–∫—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–±–æ—Ä–µ
                }
            } else {
                defectContainer.style.display = "none";
                defectList.innerHTML = ""; // ‚úÖ –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–î–µ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç"
            }
        });
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–∞
    function addDefectForm() {
        let defectIndex = defectList.querySelectorAll(".defect-form").length + 1;

        let defectForm = document.createElement("div");
        defectForm.classList.add("border", "p-3", "mt-2", "rounded", "defect-form");
        defectForm.innerHTML = `
            <h6>–î–µ—Ñ–µ–∫—Ç ${defectIndex}</h6>

            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å<span style="color: red">*</span></label>
                <!-- üîò –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–æ–Ω—ã: —ç–∫—Å—Ç–µ—Ä—å–µ—Ä –∏–ª–∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä -->
                <div class="mb-3 text-center">
                    <label class="form-label"></label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="zone_type_${defectIndex}" id="zone_type_exterior_${defectIndex}" value="exterior" checked>
                        <label class="form-check-label" for="zone_type_exterior_${defectIndex}">–≠–∫—Å—Ç–µ—Ä—å–µ—Ä</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="zone_type_${defectIndex}" id="zone_type_interior_${defectIndex}" value="interior">
                        <label class="form-check-label" for="zone_type_interior_${defectIndex}">–ò–Ω—Ç–µ—Ä—å–µ—Ä</label>
                    </div>
                </div>

                <!-- üîò –í—ã–±–æ—Ä —á–∞—Å—Ç–∏ –∫—É–∑–æ–≤–∞ -->
                <div class="mb-3 text-center">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å</label>

                    <!-- üì¶ –ë–ª–æ–∫ —ç–∫—Å—Ç–µ—Ä—å–µ—Ä–∞ -->
                    <div class="zone-map-wrapper" id="exterior_zone_wrapper">
                        <div class="exterior_zone_map zone-map d-flex flex-column align-items-center gap-2">
                            <button type="button" class="zone-btn-img short-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å">
                                <img src="{% static 'img/ext/front.png' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å">
                            </button>

                            <div class="d-flex justify-content-center gap-2 flex-wrap w-100">
                                <button type="button" class="zone-btn-img long-btn" data-part="–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                    <img src="{% static 'img/ext/left.png' %}" alt="–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                </button>

                                <button type="button" class="zone-btn-img long-btn-vertical" data-part="–í–µ—Ä—Ö">
                                    <img src="{% static 'img/ext/up.png' %}" alt="–í–µ—Ä—Ö">
                                </button>

                                <button type="button" class="zone-btn-img long-btn" data-part="–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                    <img src="{% static 'img/ext/right.png' %}" alt="–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞">
                                </button>
                            </div>

                            <button type="button" class="zone-btn-img short-btn" data-part="–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å">
                                <img src="{% static 'img/ext/back.png' %}" alt="–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å">
                            </button>
                        </div>
                    </div>

                    <!-- üì¶ –ë–ª–æ–∫ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ -->
                    <div class="zone-map-wrapper" id="interior_zone_wrapper" style="display: none;">
                        <div class="interior_zone_map zone-map d-flex flex-column align-items-center gap-2">
                            <button type="button" class="zone-btn-img m-btn" data-part="–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞">
                                <img src="{% static 'img/int/mult.jpg' %}" alt="–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞">
                            </button>

                            <div class="d-flex justify-content-center gap-2 w-100">
                                <button type="button" class="zone-btn-img door-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/fd_left.jpg' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>

                                <button type="button" class="zone-btn-img door-btn" data-part="–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/fd_right.jpg' %}" alt="–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                            </div>

                            <button type="button" class="zone-btn-img wide-btn" data-part="–°–∞–ª–æ–Ω">
                                <img src="{% static 'img/int/salon.jpg' %}" alt="–°–∞–ª–æ–Ω">
                            </button>

                            <div class="d-flex justify-content-center gap-2 w-100">
                                <button type="button" class="zone-btn-img door-btn" data-part="–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/bd_left.jpg' %}" alt="–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>

                                <button type="button" class="zone-btn-img door-btn" data-part="–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                    <img src="{% static 'img/int/bd_right.jpg' %}" alt="–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- üìç –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã -->
                    <input type="hidden" name="zone_0" class="selected-part-name">
                    <div class="mt-2">
                        <strong>–í—ã–±—Ä–∞–Ω–æ:</strong> <span class="selected-part-preview text-primary">‚Äî</span>
                    </div>
                </div>

                <select class="form-control select2-detail defect-detail" name="detail_${defectIndex}" data-placeholder="üîç –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–∏...">
                    <option></option>  <!-- placeholder -->
                    ${detailsOptions()}
                </select>
                <input type="text" class="form-control mt-2 custom-detail-explanation" name="custom_detail_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç<span style="color: red">*</span></label>

                <!-- üì¶ Select —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º -->
                <div style="position: relative;">
                    <select class="form-control select2-defect defect-type" name="defect_${defectIndex}" data-placeholder="üîç –ü–æ–∏—Å–∫ –¥–µ—Ñ–µ–∫—Ç–∞...">
                        <option></option>  <!-- placeholder -->
                        {% for defect in defects %}
                            <option value="{{ defect.id }}">{{ defect.name }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- üìò –ü–æ–ª–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è -->
                <div class="mt-2" style="position: relative;">
                    <input type="text" class="form-control custom-defect-explanation" id="custom_defect_explanation_${defectIndex}" name="custom_defect_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ<span style="color: red">*</span></label>
                <input type="number" class="form-control defect-quantity" name="quantity_${defectIndex}" min="1" value="1">
            </div>
            <div class="mb-3">
                <label class="form-label">–ì—Ä–µ–π–¥ –¥–µ—Ñ–µ–∫—Ç–∞<span style="color: red">*</span></label>
                <select class="form-control defect-grade" name="grade_${defectIndex}">
                    ${gradesOptions()}
                </select>
            </div>
             <div class="mb-3">
                <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¥–µ—Ñ–µ–∫—Ç<span style="color: red">*</span></label>
                <select class="form-control responsible-select" name="responsible_${defectIndex}">
                    ${responsiblesOptions()}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞<span style="color: red">*</span></label>
                <select class="form-control defect-repair-type" name="repair_type_${defectIndex}">
                    <option value="online">online</option>
                    <option value="offline">offline</option>
                </select>
            </div>
            <div class="mb-3 position-relative">
                <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞<span style="color: red">*</span></label>

                <!-- üìÇ input —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID -->
                <input type="file"
                       class="form-control defect-photo"
                       name="defect_photos_${defectIndex}"
                       id="defect_photo_input_${defectIndex}"
                       multiple
                       readonly
                       style="opacity: 0; pointer-events: none; position: absolute; z-index: 2; height: 100%; width: 100%; top: 0; left: 0;">

                <!-- üìã –ò–Ω—Ñ–æ –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ -->
                <div id="defect_photo_display_${defectIndex}"
                     class="form-control bg-light fw-bold"
                     style="z-index: 1;">
                     –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
                </div>

                <!-- üì∏ –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã -->
                <button type="button"
                        class="btn btn-primary mt-2 open-camera-btn"
                        data-defect-index="${defectIndex}"
                        data-input-id="defect_photo_input_${defectIndex}"
                        data-preview-id="defect_photo_preview_${defectIndex}">
                    <i class="bi bi-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                </button>

                <!-- üñºÔ∏è –ü—Ä–µ–≤—å—é-–∫–∞—Ä—É—Å–µ–ª—å -->
                <div id="defect_photo_preview_${defectIndex}" class="d-flex flex-column align-items-center mt-2"></div>
            </div>
            <button type="button" class="btn btn-danger remove-defect-btn"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
        `;

        defectList.appendChild(defectForm);
        initSelect2Filters(defectForm);
        setupZoneButtons(defectForm);
        setupZoneTypeSwitchingSimple(defectForm);
        setupClearInputButtons();

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        setupBootstrapDropdown(defectForm.querySelector(".responsible-select"));
        setupBootstrapDropdown(defectForm.querySelector(".defect-detail"));
        setupBootstrapDropdown(defectForm.querySelector(".defect-type"));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞
        defectForm.querySelector(".open-camera-btn").addEventListener("click", function () {
            let defectIndex = this.getAttribute("data-defect-index");
            openCamera(`defect_photo_input_${defectIndex}`, `defect_photo_preview_${defectIndex}`);
        });


        // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
        defectForm.querySelector(".remove-defect-btn").addEventListener("click", function() {
            defectForm.remove();
            updateDefectNumbers(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤
        });
    }

    function setupZoneButtons(formElement) {
        const buttons = formElement.querySelectorAll(".zone-btn-img");
        const hiddenInput = formElement.querySelector(".selected-part-name");
        const selectedPreview = formElement.querySelector(".selected-part-preview");

        buttons.forEach(btn => {
            btn.addEventListener("click", function () {
                // –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                buttons.forEach(b => b.classList.remove("selected"));
                // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
                this.classList.add("selected");

                const selectedZone = this.getAttribute("data-part");
                hiddenInput.value = selectedZone;
                selectedPreview.textContent = selectedZone;

                applyDetailFilterFromSelectedZone(formElement, selectedZone);
            });
        });
    }

    function applyDetailFilterFromSelectedZone(defectForm, selectedZoneName) {
        const detailSelect = defectForm.querySelector(".defect-detail");
        const explanationField = defectForm.querySelector(".custom-detail-explanation");

        const zoneMap = {
            // –≠–∫—Å—Ç–µ—Ä—å–µ—Ä
            "–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞": "left",
            "–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞": "right",
            "–ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å": "front",
            "–ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å": "back",
            "–í–µ—Ä—Ö": "up",

            // –ò–Ω—Ç–µ—Ä—å–µ—Ä (–Ω–æ–≤—ã–µ)
            "–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞": "mult",
            "–°–∞–ª–æ–Ω": "salon",
            "–ü–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å": "fd_left",
            "–ü–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å": "fd_right",
            "–ó–∞–¥–Ω—è—è –ª–µ–≤–∞—è –¥–≤–µ—Ä—å": "bd_left",
            "–ó–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è –¥–≤–µ—Ä—å": "bd_right",

            // –ü—Ä–æ—á–µ–µ
            "–ü—Ä–æ—á–µ–µ": "all"
        };

        const zone = zoneMap[selectedZoneName] || "all"; // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Äî –≥—Ä—É–∑–∏–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏

        fetch(`/supplies/api/body-details/?zone=${zone}`)
            .then(res => res.json())
            .then(data => {
                if (!detailSelect) return;

                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                detailSelect.innerHTML = `<option value="">üîç –ü–æ–∏—Å–∫...</option>`;

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏
                data.details.forEach(detail => {
                    const opt = document.createElement("option");
                    opt.value = detail.id;
                    opt.textContent = detail.name;
                    detailSelect.appendChild(opt);
                });

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –≤–Ω—É—Ç—Ä–∏ select (–µ—Å–ª–∏ –±—ã–ª —Å–¥–µ–ª–∞–Ω —á–µ—Ä–µ–∑ bootstrap dropdown)
                setupBootstrapDropdown(detailSelect);

                // üîπ –ü—Ä—è—á–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è
                if (explanationField) {
                    explanationField.style.display = "block"; // ‚úÖ –í–°–ï–ì–î–ê –≤–∏–¥–Ω–æ –ø–æ–ª–µ

                    if (selectedZoneName === "–ü—Ä–æ—á–µ–µ") {
                        explanationField.required = true; // –µ—Å–ª–∏ "–ü—Ä–æ—á–µ–µ", –¥–µ–ª–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
                    } else {
                        explanationField.required = false; // –∏–Ω–∞—á–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ
                    }
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:", error));
    }



    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç"
    addDefectBtn.addEventListener("click", function() {
        addDefectForm();
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
    function responsiblesOptions() {
        return `{% for responsible in defect_responsibles %}<option value="{{ responsible.id }}">{{ responsible.name }}</option>{% endfor %}`;
    }

    function detailsOptions() {
        return `{% for detail in details %}<option value="{{ detail.id }}">{{ detail.name }}</option>{% endfor %}`;
    }

    function defectsOptions() {
        return `{% for defect in defects %}<option value="{{ defect.id }}">{{ defect.name }}</option>{% endfor %}`;
    }

    function gradesOptions() {
        return `{% for grade in defect_grades %}<option value="{{ grade.id }}">{{ grade.name }}</option>{% endfor %}`;
    }

    // üìå –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –¥–ª—è —Ñ–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤
    document.addEventListener("click", function(event) {
        if (event.target.classList.contains("open-camera-btn")) {
            let inputId = event.target.getAttribute("data-input-id"); // –ü–æ–ª—É—á–∞–µ–º id input
            let previewId = event.target.getAttribute("data-preview-id"); // –ü–æ–ª—É—á–∞–µ–º id preview
            openCamera(inputId, previewId);
        }
    });


    document.addEventListener("click", function(event) {
        if (event.target.classList.contains("remove-defect-btn")) {
            event.target.closest(".defect-form").remove();
            updateDefectNumbers();
        }
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    function updateDefectNumbers() {
        document.querySelectorAll(".defect-form").forEach((form, index) => {
            form.querySelector("h6").textContent = `–î–µ—Ñ–µ–∫—Ç ${index + 1}`;
        });
    }
}



function setupZoneTypeSwitchingSimple(defectForm) {
    const exteriorWrapper = defectForm.querySelector('#exterior_zone_wrapper');
    const interiorWrapper = defectForm.querySelector('#interior_zone_wrapper');
    const zoneTypeRadios = defectForm.querySelectorAll('input[type="radio"][name^="zone_type_"]');

    zoneTypeRadios.forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "exterior") {
                exteriorWrapper.style.display = "block";
                interiorWrapper.style.display = "none";
            } else if (this.value === "interior") {
                exteriorWrapper.style.display = "none";
                interiorWrapper.style.display = "block";
            }
        });
    });

    // –ù–∞—á–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
    zoneTypeRadios.forEach(radio => {
        if (radio.checked) {
            if (radio.value === "exterior") {
                exteriorWrapper.style.display = "block";
                interiorWrapper.style.display = "none";
            } else {
                exteriorWrapper.style.display = "none";
                interiorWrapper.style.display = "block";
            }
        }
    });
}



document.addEventListener("DOMContentLoaded", function () {
    initSelect2Filters();  // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
});

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫ –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–∞–º
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".responsible-select, .defect-detail").forEach(setupBootstrapDropdown);
});

// ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
document.addEventListener("DOMContentLoaded", function() {
    console.log("üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞!");

    let modal = document.getElementById("camera_modal");
    let video = document.getElementById("camera_feed");
    let closeButton = document.getElementById("close_camera");
    let captureButton = document.getElementById("capture_button");
    let canvas = document.createElement("canvas");

    let activeInput = null;
    let activePreview = null;
    let activeStream = null;

    // ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –¢–û–õ–¨–ö–û –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞
    document.addEventListener("click", function(event) {
        if (event.target.classList.contains("open-camera-btn")) {
            let defectForm = event.target.closest(".defect-form"); // ‚úÖ –ë–µ—Ä–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π div –¥–µ—Ñ–µ–∫—Ç–∞
            let input = defectForm.querySelector("input[type='file']");
            let preview = defectForm.querySelector(".defect-photo-preview"); // ‚úÖ Preview –¢–û–õ–¨–ö–û –≤–Ω—É—Ç—Ä–∏ –¥–µ—Ñ–µ–∫—Ç–∞

            if (!input || !preview) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –∏–ª–∏ preview –¥–ª—è —Ñ–æ—Ç–æ");
                return;
            }

            activeInput = input;
            activePreview = preview;

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    activeStream = stream;
                    video.srcObject = stream;
                    video.play();
                    modal.style.display = "flex";
                })
                .catch(function(error) {
                    alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + error.message);
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                });
        }
    });

    // ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã
    function closeCamera() {
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        modal.style.display = "none";
    }

    closeButton.addEventListener("click", closeCamera);

    // ‚úÖ –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ (—Ç–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ–µ–º –¥–µ—Ñ–µ–∫—Ç–µ)
    captureButton.addEventListener("click", function () {
        if (!activeInput || !activePreview) return;

        let context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function (blob) {
            let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

            let dataTransfer = new DataTransfer();

            // ‚úÖ –ï—Å–ª–∏ multiple=false, –æ—á–∏—â–∞–µ–º input –∏ preview –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ
            if (!activeInput.multiple) {
                activeInput.value = "";
                while (activePreview.firstChild) {
                    activePreview.removeChild(activePreview.firstChild);
                }
            } else {
                // ‚úÖ –ï—Å–ª–∏ multiple=true, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
                for (let i = 0; i < activeInput.files.length; i++) {
                    dataTransfer.items.add(activeInput.files[i]);
                }
            }

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
            dataTransfer.items.add(file);
            activeInput.files = dataTransfer.files;

            // ‚úÖ –°–æ–∑–¥–∞—ë–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
            let imgContainer = document.createElement("div");
            imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            let img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail");
            img.style.maxWidth = "300px";
            img.style.borderRadius = "5px";
            img.style.objectFit = "cover";

            let deleteBtn = document.createElement("button");
            deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
            deleteBtn.onclick = function () {
                imgContainer.remove();
                removeFileFromInput(activeInput, file);
            };

            imgContainer.appendChild(img);
            imgContainer.appendChild(deleteBtn);
            activePreview.appendChild(imgContainer);

            // ‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–æ—Å–ª–µ —Å–Ω–∏–º–∫–∞
            closeCamera();
        }, "image/jpeg");
    });


    modal.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeCamera();
        }
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ input
    function removeFileFromInput(inputElement, fileToRemove) {
        let dataTransfer = new DataTransfer();

        for (let i = 0; i < inputElement.files.length; i++) {
            if (inputElement.files[i] !== fileToRemove) {
                dataTransfer.items.add(inputElement.files[i]);
            }
        }

        inputElement.files = dataTransfer.files;

        // ‚úÖ –ï—Å–ª–∏ –≤—Å–µ —Ñ–æ—Ç–æ —É–¥–∞–ª–µ–Ω—ã, –æ—á–∏—â–∞–µ–º input
        if (dataTransfer.files.length === 0) {
            inputElement.value = "";
        }
    }

});

document.addEventListener("DOMContentLoaded", function () {
    let defectNo = document.getElementById("defect_no");
    let hiddenNoDefect = document.getElementById("hidden_no_defect");

    defectNo.addEventListener("change", function () {
        if (defectNo.checked) {
            hiddenNoDefect.value = "no"; // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ "–î–µ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç", –ø–µ—Ä–µ–¥–∞–µ–º "no"
        }
    });
});

</script>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let qrScanner = new Html5Qrcode("qr-reader");

    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById("vin_search").value = decodedText;
        startInspectionTimer();
        document.getElementById("qr-reader").style.display = "none";

        // üìå –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        qrScanner.stop().then(() => {
            console.log("üì∏ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR");
        }).catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:", err);
        });

        // üìå –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ VIN
        triggerVinSearch(decodedText);
    }

    let qrActive = false; // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã

    document.getElementById("start_qr_scan").addEventListener("click", function () {
        const qrReader = document.getElementById("qr-reader");
        const scanBtn = document.getElementById("start_qr_scan");

        if (!qrActive) {
            qrReader.style.display = "block";
            scanBtn.innerText = "‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ";

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).then(() => {
                qrActive = true;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
            });
        } else {
            qrScanner.stop().then(() => {
                qrReader.style.display = "none";
                scanBtn.innerText = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR";
                qrActive = false;
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–µ—Ä—ã:", err);
            });
        }
    });


    document.getElementById("stop_qr_scan").addEventListener("click", function () {
        qrScanner.stop();
        document.getElementById("qr-reader").style.display = "none";
    });
});

function triggerVinSearch(vin) {
    let vinInput = document.getElementById("vin_search");
    let vehicleInfo = document.getElementById("vehicle_info");

    let vinValue = document.getElementById("vin_value");
    let engineNumberValue = document.getElementById("engine_number_value");
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");

    fetch(`/supplies/api/search_vin/?q=${vin}`)
        .then(response => {
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.results.length === 0) {
                vehicleInfo.style.display = "none";
                return;
            }

            let vinData = data.results[0];

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É–∑–æ–≤–µ
            vinValue.textContent = vinData.vin;
            engineNumberValue.textContent = vinData.engine_number;
            modelValue.textContent = vinData.model;
            bodyColorValue.textContent = vinData.body_color;
            vehicleInfo.style.display = "block";
        })
        .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ VIN:", error));
    startInspectionTimer();
}
function setupClearInputButtons() {
    document.querySelectorAll(".clear-input-btn").forEach(btn => {
        const targetId = btn.dataset.target;
        const input = document.getElementById(targetId);
        if (!input) return;

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–ª–∏ —Å–∫—Ä—ã—Ç—å –∫—Ä–µ—Å—Ç–∏–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        input.addEventListener("input", () => {
            btn.style.display = input.value.trim() ? "block" : "none";
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
        btn.addEventListener("click", () => {
            input.value = "";
            input.dispatchEvent(new Event("input")); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        });

        // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        btn.style.display = input.value.trim() ? "block" : "none";
    });
}

function setupClearSelectButtons() {
    document.querySelectorAll(".clear-select-btn").forEach(btn => {
        const targetId = btn.dataset.target;
        const select = document.getElementById(targetId);
        if (!select) return;

        function updateClearBtn() {
            const hasValue = select.value && select.value !== "";
            btn.style.display = hasValue ? "block" : "none";
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        select.addEventListener("change", updateClearBtn);

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é
        btn.addEventListener("click", () => {
            select.value = "";
            select.dispatchEvent(new Event("change"));
            updateClearBtn();
        });

        // –ü–µ—Ä–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateClearBtn();
    });
}
</script>
<style>
    /* ===== –ö–∞–º–µ—Ä–∞ –∫—É–∑–æ–≤–∞ (–º–æ–¥–∞–ª–∫–∞) ===== */
#bodycam_native_modal{
  position:fixed; inset:0; display:none; z-index:99999;
  background:#000; color:#fff;
}
#bodycam_native_modal .bcam-top{
  position:absolute; top:0; left:0; right:0; height:56px;
  display:flex; align-items:center; justify-content:flex-end; gap:10px;
  padding:0 12px; background:linear-gradient(#0008,#0000);
}
#bodycam_native_modal .bcam-bottom{
  position:absolute; bottom:0; left:0; right:0;
  padding:10px 12px 22px; background:linear-gradient(#0000,#0008);
}
#bodycam_native_modal .bcam-actions{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-top:8px;
}
#bodycam_native_modal .bcam-video{
  position:absolute; top:56px; bottom:120px; left:0; right:0;
  display:flex; align-items:center; justify-content:center;
}
#bodycam_native_modal video{
  width:100%; height:100%; object-fit:cover; background:#000;
}
#bodycam_native_modal .bcam-shutter{
  width:70px; height:70px; border-radius:50%;
  border:4px solid #fff; background:#0005; display:inline-block;
}
#bodycam_native_modal .bcam-thumbs{
  display:flex; gap:8px; overflow-x:auto; padding-top:6px;
}
#bodycam_native_modal .bcam-thumb{
  position:relative; width:64px; height:64px; flex:0 0 auto;
  border-radius:6px; overflow:hidden; border:1px solid #ffffff44;
}
#bodycam_native_modal .bcam-thumb img{ width:100%; height:100%; object-fit:cover; }
#bodycam_native_modal .bcam-x{
  position:absolute; top:2px; right:2px; width:18px; height:18px;
  border-radius:50%; background:#000c; display:flex; align-items:center; justify-content:center;
  font-size:12px; border:1px solid #fff8; cursor:pointer;
}
.bcam-btn{ border:1px solid #ffffff66; background:#ffffff10; color:#fff; border-radius:10px; padding:6px 12px; }
.bcam-btn[disabled]{ opacity:.4; cursor:not-allowed; }
#bodycam_native_modal {
  touch-action: manipulation;           /* iOS/Chrome/Android */
  -ms-touch-action: manipulation;       /* —Å—Ç–∞—Ä—ã–µ Edge */
}
</style>

<script>
(() => {
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ú–æ–¥–∞–ª–∫–∞ (—Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!document.getElementById('bodycam_native_modal')) {
    const modal = document.createElement('div');
    modal.id = 'bodycam_native_modal';
    modal.innerHTML = `
      <div class="bcam-top">
        <button class="bcam-btn" id="bcam_torch"><i class="bi bi-lightning-charge-fill"></i></button>
        <button class="bcam-btn" id="bcam_flip"><i class="bi bi-arrow-repeat"></i></button>
      </div>
      <div class="bcam-video">
        <video id="bcam_video" autoplay playsinline muted></video>
      </div>
      <div class="bcam-bottom">
        <div class="bcam-thumbs" id="bcam_thumbs"></div>
        <div class="bcam-actions">
          <button class="bcam-btn" id="bcam_cancel">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button class="bcam-shutter" id="bcam_shutter" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ"></button>
          <button class="bcam-btn" id="bcam_done">–ì–æ—Ç–æ–≤–æ</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  const modal   = document.getElementById('bodycam_native_modal');
  const videoEl = document.getElementById('bcam_video');
  // üîí –≥–∞—Å–∏–º double-tap zoom –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ (iOS Safari –æ—Å–æ–±–µ–Ω–Ω–æ)
  function disableDoubleTapZoom(root) {
    let lastTouchEnd = 0;

    root.addEventListener('touchend', function (e) {
      const now = Date.now();
      // –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —Ç–∞–ø –ø—Ä–∏—à—ë–ª <300–º—Å ‚Äî —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ double-tap –∏ –æ—Ç–º–µ–Ω—è–µ–º –∑—É–º
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();   // –≤–∞–∂–Ω–æ: {passive:false} —Å–º. –Ω–∏–∂–µ
      }
      lastTouchEnd = now;
    }, { passive: false });

    // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º dblclick (desktop Safari/Chrome)
    root.addEventListener('dblclick', function (e) {
      e.preventDefault();
    }, { passive: false });

    // –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –µ—â—ë –∏ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ü–ò–ù–ß-–∑—É–º –≤ –º–æ–¥–∞–ª–∫–µ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
    // root.addEventListener('gesturestart',  e => e.preventDefault(), { passive:false });
    // root.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    // root.addEventListener('gestureend',    e => e.preventDefault(), { passive:false });
  }

  // üëâ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∑–∞—â–∏—Ç—É –¥–ª—è –º–æ–¥–∞–ª–∫–∏
  disableDoubleTapZoom(modal);

  const thumbs  = document.getElementById('bcam_thumbs');
  const btnTorch= document.getElementById('bcam_torch');
  btnTorch.innerHTML = '<i class="bi bi-lightning-charge"></i>';
  const btnFlip = document.getElementById('bcam_flip');
  const btnShot = document.getElementById('bcam_shutter');
  const btnCancel = document.getElementById('bcam_cancel');
  const btnDone   = document.getElementById('bcam_done');

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let stream=null, track=null, imageCapture=null;
  let targetInput=null, targetPreview=null;
  let dt=null;                // DataTransfer –¥–ª—è input#body_photos
  let sessionPhotos=[];       // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–Ω–∏–º–∫–∏ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
  let devices=[], currentDeviceId=null, preferFacing='environment';
  let torchOn=false;


  function disableVolumeShutter() {
    if (!volumeShutterEnabled) return;
    volumeShutterEnabled = false;

    window.removeEventListener('keydown', volumeKeyHandler, true);
    window.removeEventListener('keyup', volumeKeyHandler, true);
    window.removeEventListener('keydown', desktopDebugHandler, true);

    try {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.setActionHandler('play', null);
        navigator.mediaSession.setActionHandler('pause', null);
        navigator.mediaSession.setActionHandler('previoustrack', null);
        navigator.mediaSession.setActionHandler('nexttrack', null);
        navigator.mediaSession.metadata = null;
      }
    } catch {}
  }


  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  function buildDTFromInput(input){
    dt = new DataTransfer();
    if (input?.files?.length) for (const f of input.files) dt.items.add(f);
  }

  function stopStream(){
    try{ stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
    stream=track=imageCapture=null;
  }

  async function ensureDevices(){
    try{
      const all = await navigator.mediaDevices.enumerateDevices();
      devices = all.filter(d=>d.kind==='videoinput');
    }catch(_){ devices=[]; }
  }

  async function startStream(){
    stopStream();
    let constraints = {
      video: currentDeviceId
        ? { deviceId: { exact: currentDeviceId } }
        : { facingMode: { ideal: preferFacing }, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    track  = stream.getVideoTracks()[0];
    videoEl.srcObject = stream;
    // ImageCapture –¥–ª—è full-res (Android/Chrome)
    if ('ImageCapture' in window) {
      try { imageCapture = new ImageCapture(track); } catch { imageCapture=null; }
    }
    // torch –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    const caps = track.getCapabilities?.() || {};
    if (caps.torch) {
      btnTorch.disabled = false;
      btnTorch.innerHTML = '<i class="bi bi-lightning-charge"></i>';
    } else {
      btnTorch.disabled = true;
      torchOn = false;
    }
  }

  async function toggleTorch(){
    if (!track?.applyConstraints) return;
    try{
      torchOn = !torchOn;
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.innerHTML = torchOn
      ? '<i class="bi bi-lightning-charge-fill"></i>'  // –≤–∫–ª—é—á–µ–Ω–æ
      : '<i class="bi bi-lightning-charge"></i>';      // –≤—ã–∫–ª—é—á–µ–Ω–æ
    }catch(_){
        btnTorch.disabled = true;
        torchOn = false;
        btnTorch.innerHTML = '<i class="bi bi-lightning-charge"></i>';
    }
  }

  async function flipCamera(){
    await ensureDevices();
    if (!devices.length){ preferFacing = (preferFacing==='environment'?'user':'environment'); return startStream(); }
    // –µ—Å–ª–∏ –∑–Ω–∞–µ–º —Å–ø–∏—Å–æ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ü–∏–∫–ª–∏–º –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
    if (!currentDeviceId){
      // –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –¥—Ä—É–≥–∏–º facing (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å)
      const front = devices.find(d=>/front|user/i.test(d.label));
      const back  = devices.find(d=>/back|rear|environment/i.test(d.label));
      const next  = (preferFacing==='environment' ? front : back) || devices.find(d=>d.deviceId!==currentDeviceId) || devices[0];
      preferFacing = (preferFacing==='environment'?'user':'environment');
      currentDeviceId = next?.deviceId || null;
    } else {
      const idx = devices.findIndex(d=>d.deviceId===currentDeviceId);
      const next = devices[(idx+1) % devices.length];
      currentDeviceId = next.deviceId;
    }
    await startStream();
  }

  async function frameToBlob(){
    // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî takePhoto; –∏–Ω–∞—á–µ canvas
    if (imageCapture?.takePhoto) {
      try { return await imageCapture.takePhoto(); }
      catch(_){}
    }
    const canvas = document.createElement('canvas');
    const w = videoEl.videoWidth || 1280, h = videoEl.videoHeight || 720;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d', {alpha:false});
    ctx.drawImage(videoEl, 0, 0, w, h);
    return await new Promise(res => canvas.toBlob(res,'image/jpeg',0.92));
  }

  function renderThumbs(){
    thumbs.innerHTML = '';
    sessionPhotos.forEach((file, i) => {
      const box = document.createElement('div');
      box.className='bcam-thumb';
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      const x = document.createElement('div');


      x.className='bcam-x';
      x.textContent='‚úï';
      x.onclick = () => { sessionPhotos.splice(i,1); renderThumbs(); };
      box.appendChild(img);
      box.appendChild(x);
      thumbs.appendChild(box);
    });
    // –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ–∂–∏–π –∫–∞–¥—Ä (–æ–Ω –ø–µ—Ä–≤—ã–π)
    thumbs.scrollLeft = 0;
  }

  function mergeSessionToInput(){
    if (!targetInput) return;
    // –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∏–∑ sessionPhotos –≤ dt –∏ –≤ input
    for (const f of sessionPhotos) dt.items.add(f);
    targetInput.files = dt.files;
    updateBodyFilesDisplay();
    buildOrUpdateBodyCarousel(targetPreview, targetInput); // –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—É—Å–µ–ª—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    sessionPhotos = [];
  }

  function updateBodyFilesDisplay(){
    const display = document.getElementById('body_photos_display');
    if (display && targetInput){
      const c = targetInput.files?.length || 0;
      display.textContent = c ? ` –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${c}` : ' –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
    }
  }

  // –ü—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ –∫–Ω–æ–ø–∫–∏
  window.openBodyNativeCamera = async (inputId, previewId) => {
    targetInput  = document.getElementById(inputId);
    targetPreview= document.getElementById(previewId);
    if (!targetInput || !targetPreview) { alert('–ù–µ –Ω–∞–π–¥–µ–Ω input/preview –¥–ª—è –∫—É–∑–æ–≤–∞'); return; }

    buildDTFromInput(targetInput);
    sessionPhotos = [];
    renderThumbs();
    currentDeviceId = null; preferFacing='environment'; torchOn=false;

    try{
      await ensureDevices();
      await startStream();
      modal.style.display = 'block';
      // iOS –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ play()
      setTimeout(()=>{ try{ videoEl.play(); }catch(_){ } }, 50);
    }catch(e){
      alert('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + e.message);
      stopStream();
    }
  };

  // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏
  btnTorch.addEventListener('click', toggleTorch);
  btnFlip.addEventListener('click', flipCamera);

  btnShot.addEventListener('click', async () => {
    try{
      const blob = await frameToBlob();
      const file = new File([blob], `body_${Date.now()}.jpg`, {type:'image/jpeg'});
      sessionPhotos.unshift(file);     // ‚Üê —Ç–µ–ø–µ—Ä—å –Ω–æ–≤—ã–µ ‚Äî –≤ –Ω–∞—á–∞–ª–æ
      renderThumbs();
    }catch(e){ console.error('–û—à–∏–±–∫–∞ —Å–Ω–∏–º–∫–∞:', e); }
  });

  function closeModalAndKeep(){
    mergeSessionToInput();   // ‚ùó –ø–æ –¢–ó: –∏ –û—Ç–º–µ–Ω–∏—Ç—å, –∏ –ì–æ—Ç–æ–≤–æ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–¥–µ–ª–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
    modal.style.display='none';
    stopStream();
  }

  btnCancel.addEventListener('click', closeModalAndKeep);
  btnDone.addEventListener('click', closeModalAndKeep);

  // –∫–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º ‚Äî —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å–ª—É—á–∞–π–Ω–æ
  modal.addEventListener('click', (e) => {
    // noop ‚Äî –∏–∑–±–µ–≥–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ö–∞—Ä—É—Å–µ–ª—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–∫–∞–∫ —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildOrUpdateBodyCarousel(preview, input){
    if (!preview.dataset.carouselInitialized){
      preview.dataset.carouselInitialized = 'true';
      preview.carouselData = []; preview.currentIndex = 0;
      preview.innerHTML = `
        <div class="carousel-wrapper d-flex flex-column align-items-center">
          <div class="carousel-img-container position-relative" style="position:relative;">
            <img class="carousel-img img-thumbnail mb-2"
                 style="max-width:300px; border-radius:5px; object-fit:cover; width:100%; position:relative; z-index:1;">
            <div class="carousel-left-zone"  style="position:absolute; top:0; bottom:0; left:0; width:50%; z-index:2;"></div>
            <div class="carousel-right-zone" style="position:absolute; top:0; bottom:0; right:0; width:50%; z-index:2;"></div>
          </div>
          <button type="button" class="carousel-delete btn btn-danger btn-sm mt-2 mb-1">–£–¥–∞–ª–∏—Ç—å</button>
          <div class="carousel-controls d-flex justify-content-between align-items-center mt-3 w-100" style="max-width:300px;">
            <button type="button" class="carousel-prev btn btn-secondary btn-lg px-4">‚Üê</button>
            <span class="carousel-counter fs-5">1 / 1</span>
            <button type="button" class="carousel-next btn btn-secondary btn-lg px-4">‚Üí</button>
          </div>
        </div>
      `;
      const imgEl   = preview.querySelector('.carousel-img');
      const delBtn  = preview.querySelector('.carousel-delete');
      const prevBtn = preview.querySelector('.carousel-prev');
      const nextBtn = preview.querySelector('.carousel-next');
      const counter = preview.querySelector('.carousel-counter');
      const leftZone  = preview.querySelector('.carousel-left-zone');
      const rightZone = preview.querySelector('.carousel-right-zone');

      function update(){
        const data = preview.carouselData;
        if (!data.length){
          preview.innerHTML = '<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>';
          preview.dataset.carouselInitialized = '';
          return;
        }
        const cur = data[preview.currentIndex];
        imgEl.src = cur.url;
        counter.textContent = `${preview.currentIndex+1} / ${data.length}`;
      }

      function rebuildInputFromCarousel(){
        const ndt = new DataTransfer();
        preview.carouselData.forEach(item => ndt.items.add(item.file));
        input.files = ndt.files;
        updateBodyFilesDisplay();
      }

      delBtn.onclick = () => {
        preview.carouselData.splice(preview.currentIndex, 1);
        if (preview.currentIndex >= preview.carouselData.length) preview.currentIndex = preview.carouselData.length-1;
        if (preview.currentIndex < 0) preview.currentIndex = 0;
        if (preview.carouselData.length === 0){
          rebuildInputFromCarousel();
          preview.innerHTML = '<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>';
          preview.dataset.carouselInitialized = '';
          return;
        }
        update(); rebuildInputFromCarousel();
      };
      prevBtn.onclick = () => { if (preview.currentIndex>0){ preview.currentIndex--; update(); } };
      nextBtn.onclick = () => { if (preview.currentIndex<preview.carouselData.length-1){ preview.currentIndex++; update(); } };
      leftZone.addEventListener('click', () => { if (preview.currentIndex>0){ preview.currentIndex--; update(); } });
      rightZone.addEventListener('click', () => { if (preview.currentIndex<preview.carouselData.length-1){ preview.currentIndex++; update(); } });

      preview.updateCarousel = update;
    }

    // –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏ –∏–∑ input.files
    const files = Array.from(input.files || []);
    preview.carouselData = files.map(f => ({ file:f, url:URL.createObjectURL(f) }));
    preview.currentIndex = Math.min(preview.currentIndex, Math.max(files.length-1,0));
    preview.updateCarousel && preview.updateCarousel();
  }
})();
</script>

<script>
async function checkVinExists(vin) {
  try {
    const res = await fetch(`/supplies/api/search_vin/?q=${encodeURIComponent(vin)}`, { cache: 'no-store' });
    if (!res.ok) return false;
    const data = await res.json();
    return Array.isArray(data.results) && data.results.some(r => (r.vin || '').toUpperCase() === vin.toUpperCase());
  } catch (e) {
    console.error('VIN check error:', e);
    return false;
  }
}
</script>
{% endblock %}
