{% extends "users/base.html" %}

{% block title %}–§–∏–∫—Å–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>–§–∏–∫—Å–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- üìå –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            {{ form.container_number }}
        </div>
        
        <!-- üìå –§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            <input type="file" name="container_number_image" id="container_number_image" class="form-control">
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('container_number_image')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <img id="container_number_image_preview" src="" class="img-fluid mt-2" style="display:none;">
        </div>
        
        <!-- üìå –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            {{ form.container_description }}
        </div>
        
        <!-- üìå –§–æ—Ç–æ –ø–ª–æ–º–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ –ø–ª–æ–º–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            <input type="file" name="seal_image" id="seal_image" class="form-control">
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('seal_image')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <img id="seal_image_preview" src="" class="img-fluid mt-2" style="display:none;">
        </div>
        
        <!-- üìå –û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–æ–º–±—ã -->
        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–æ–º–±—ã</label>
            {{ form.seal_description }}
        </div>
        
        <!-- üìå –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            {{ form.container_status }}
        </div>
        
        <!-- üìå –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            <input type="file" name="container_images" id="container_images" class="form-control" multiple>
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('container_images')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div id="container_images_preview" class="d-flex flex-wrap mt-2"></div>
        </div>
        
        <!-- üìå –ì–∞–ª–µ—Ä–µ—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="row mt-3" id="container_images_gallery"></div>
        
        <button type="submit" class="btn btn-danger w-100">üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</button>
    </form>
</div>

<!-- ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã -->
<div id="camera_modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <video id="camera_feed" style="width: 90%; max-width: 500px; object-fit: contain;"></video>
    <button id="capture_button" class="btn btn-success mt-3">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<canvas id="camera_canvas" style="display:none;"></canvas>
<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!");

    // ‚úÖ –ö–∞–º–µ—Ä–∞
    let modal = document.getElementById("camera_modal");
    let video = document.getElementById("camera_feed");
    let closeButton = document.getElementById("close_camera");
    let captureButton = document.getElementById("capture_button");
    let canvas = document.createElement("canvas");

    let activeInput = null;
    let activePreview = null;
    let activeStream = null;

    let containerImagesInput = document.getElementById("container_images");
    let galleryContainer = document.getElementById("container_images_gallery");

    console.log("üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞!");

    window.openCamera = function(inputId) {
        console.log(`üì∑ –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –¥–ª—è ${inputId}`);

        activeInput = document.getElementById(inputId);
        activePreview = document.getElementById(`${inputId}_preview`);

        if (!activeInput) {
            console.error(`‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç input #${inputId}`);
            return;
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
            activeStream = stream;
            video.srcObject = stream;
            video.play();
            modal.style.display = "flex";
            console.log("‚úÖ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∞!");
        })
        .catch(function(error) {
            alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ");
            console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
        });
    };

    function closeCamera() {
        console.log("‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã...");

        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            activeStream = null;
        }

        modal.style.display = "none";
    }

    captureButton.addEventListener("click", function() {
        console.log("üì∏ –ó–∞—Ö–≤–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...");
        let context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        let timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        let fileName = `photo_${timestamp}.jpg`;

        canvas.toBlob(function(blob) {
            let file = new File([blob], fileName, { type: "image/jpeg" });

            if (activeInput.id === "container_images") {
                addFileToContainerImages(file);
            } else {
                let dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                activeInput.files = dataTransfer.files;

                if (activePreview) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        activePreview.src = e.target.result;
                        activePreview.style.display = "block";
                    };
                    reader.readAsDataURL(file);
                }
            }

            console.log("‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ input:", fileName);
        }, "image/jpeg");

        closeCamera();
    });

    closeButton.addEventListener("click", closeCamera);
    modal.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeCamera();
        }
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    function addFileToContainerImages(file) {
        let dataTransfer = new DataTransfer();

        let existingFiles = containerImagesInput.files;
        for (let i = 0; i < existingFiles.length; i++) {
            dataTransfer.items.add(existingFiles[i]);
        }

        dataTransfer.items.add(file);
        containerImagesInput.files = dataTransfer.files;

        updateContainerGallery();
    }

    // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    function updateContainerGallery() {
        galleryContainer.innerHTML = "";
        let files = containerImagesInput.files;

        for (let i = 0; i < files.length; i++) {
            let file = files[i];
            let reader = new FileReader();

            reader.onload = function(e) {
                let colDiv = document.createElement("div");
                colDiv.classList.add("col-md-3", "mb-3");

                let img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("img-fluid", "rounded", "shadow-sm");

                let deleteBtn = document.createElement("button");
                deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-1");
                deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                deleteBtn.onclick = function() {
                    removeContainerFile(i);
                };

                colDiv.appendChild(img);
                colDiv.appendChild(deleteBtn);
                galleryContainer.appendChild(colDiv);
            };

            reader.readAsDataURL(file);
        }
    }

    function removeContainerFile(index) {
        let dt = new DataTransfer();
        let files = containerImagesInput.files;

        for (let i = 0; i < files.length; i++) {
            if (i !== index) {
                dt.items.add(files[i]);
            }
        }

        containerImagesInput.files = dt.files;
        updateContainerGallery();
    }

    containerImagesInput.addEventListener("change", updateContainerGallery);

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
    function closeCamera() {
        console.log("‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã...");
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            activeStream = null;
        }
        modal.style.display = "none";
    }

    // ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("load", function() {
        console.log("üîÑ –ê–≤—Ç–æ-–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã");
        closeCamera();
    });

    closeButton.addEventListener("click", closeCamera);

    modal.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeCamera();
        }
    });
});
</script>

{% endblock %}
