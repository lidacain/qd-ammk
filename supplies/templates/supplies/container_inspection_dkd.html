{% extends "users/base.html" %}
{% load static %}
{% block title %}–û—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤{% endblock %}

{% block content %}

<div class="container mt-4">
    <h2>–ü–æ—Å—Ç –æ—Å–º–æ—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- –ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3">
            <label class="form-label">–ù–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ <span style="color: red">*</span></label>
            <input type="text" name="container_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞" required>
        </div>

        <!-- –§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
        <div class="mb-3 position-relative">
            <label class="form-label">–§–æ—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ <span style="color: red">*</span></label>

            <!-- –°–∫—Ä—ã—Ç—ã–π input -->
            <input type="file" name="container_photos" id="container_photos"
                   class="form-control"
                   multiple readonly
                   style="opacity: 0; pointer-events: none; position: absolute; z-index: 2; height: 100%; width: 100%; top: 0; left: 0;">

            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
            <div id="container_photos_display" class="form-control bg-light fw-bold" style="z-index: 1;">
                üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã -->
            <button type="button" class="btn btn-primary mt-2"
                    onclick="openCamera('container_photos', 'container_photos_preview')">
                üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
            </button>

            <!-- –ü—Ä–µ–≤—å—é -->
            <div id="container_photos_preview" class="d-flex flex-wrap mt-2 gap-2"></div>
        </div>

        <!-- –ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç? <span style="color: red">*</span></label><br>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–î–∞</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no">
                <label class="form-check-label" for="defect_no">–ù–µ—Ç</label>
            </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</label>
            <textarea name="description" rows="4" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)"></textarea>
        </div>

        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ç–∞–π–º–µ—Ä–∞ -->
        <input type="hidden" name="inspection_duration_seconds" id="inspection_duration_seconds">

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="submit" class="btn btn-success w-100 mt-5 mb-5">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>
<script>
// ‚úÖ JS-–∞–Ω–∞–ª–æ–≥ compress_uploaded_image
async function compressDataURLToFile(dataURL, {
  quality = 0.6,
  maxWidth = 1600,
  filename = `photo_${new Date().toISOString().replace(/[:.]/g,'-')}.jpg`
} = {}) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const scale = Math.min(1, maxWidth / img.naturalWidth);
      const w = Math.round(img.naturalWidth * scale);
      const h = Math.round(img.naturalHeight * scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        if (!blob) return reject(new Error('Compression failed'));
        resolve(new File([blob], filename, { type: 'image/jpeg' }));
      }, 'image/jpeg', quality);
    };
    img.onerror = reject;
    img.src = dataURL;
  });
}
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        setupCamera(); // üì∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∫–∞–º–µ—Ä—ã
    });

function setupCamera() {
    const isMobileDevice = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobileDevice()) {
        // üì± –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –Ω–∞—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
        window.openCamera = function (inputId, previewId) {
            window.continueCaptureLoop = true;
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            if (!input || !preview) return;

            input.setAttribute("accept", "image/*");
            input.setAttribute("capture", "environment"); // –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É

            input.onchange = function () {
                if (!input.files || input.files.length === 0) {
                    window.continueCaptureLoop = false; // ‚ùå –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û—Ç–º–µ–Ω–∞"
                    return;
                }
                const dt = new DataTransfer();

                const existingImages = preview.querySelectorAll("img[data-file]");
                let promises = [];

                // üîÅ 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏–∑ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                existingImages.forEach(img => {
                    const base64 = img.src;
                    const filename = img.getAttribute("data-file");

                    const p = fetch(base64)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], filename, { type: blob.type });
                            dt.items.add(file);
                        });

                    promises.push(p);
                });

                // üì∏ 2. –ù–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å –∫–∞–º–µ—Ä—ã
                const newFiles = Array.from(input.files);

                newFiles.forEach(file => {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const dataURL = e.target.result;
                        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                        const filename = `photo_${timestamp}.jpg`;

                        // ‚¨áÔ∏è –°–ñ–ê–¢–ò–ï
                        compressDataURLToFile(dataURL, { quality: 0.6, maxWidth: 1600, filename })
                          .then((compressedFile) => {
                            const imageURL = URL.createObjectURL(compressedFile);

                            // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—É—Å–µ–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ ...

                            // ‚ûï –∫–ª–∞–¥—ë–º –°–ñ–ê–¢–´–ô —Ñ–∞–π–ª
                            preview.carouselData.push({ file: compressedFile, url: imageURL });
                            preview.currentIndex = preview.carouselData.length - 1;
                            preview.updateCarousel();

                            // üóÇÔ∏è –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º input.files —Ç–æ–ª—å–∫–æ –∏–∑ —Å–∂–∞—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤
                            const dt2 = new DataTransfer();
                            preview.carouselData.forEach(item => dt2.items.add(item.file));
                            input.files = dt2.files;

                            // üîÑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
                            if (input.id === "body_photos") {
                              const display = document.getElementById("body_photos_display");
                              if (display) display.textContent = input.files.length > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${input.files.length}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            } else if (input.id.startsWith("defect_photo_input_")) {
                              const idx = input.id.split("_").pop();
                              const display = document.getElementById(`defect_photo_display_${idx}`);
                              if (display) display.textContent = input.files.length > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${input.files.length}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                          })
                          .catch(err => {
                            console.error('Compression error:', err);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                          });

                        // üîÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—É—Å–µ–ª—å, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                        if (!preview.dataset.carouselInitialized) {
                            preview.dataset.carouselInitialized = "true";
                            preview.carouselData = [];
                            preview.currentIndex = 0;

                            preview.innerHTML = `
                                <div class="carousel-wrapper d-flex flex-column align-items-center">
                                    <div class="carousel-img-container position-relative" style="position: relative;">
                                        <img class="carousel-img img-thumbnail mb-2"
                                             style="max-width:300px; border-radius:5px; object-fit:cover; width: 100%; position: relative; z-index: 1;">

                                        <!-- –ó–æ–Ω—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫—Ä–∞—è–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                                        <div class="carousel-left-zone"
                                             style="position:absolute; top:0; bottom:0; left:0; width:50%; z-index:2;"></div>
                                        <div class="carousel-right-zone"
                                             style="position:absolute; top:0; bottom:0; right:0; width:50%; z-index:2;"></div>
                                    </div>

                                    <!-- üîò –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                                    <button type="button" class="carousel-delete btn btn-danger btn-sm mt-2 mb-1">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>

                                    <!-- ‚¨ÖÔ∏è‚û°Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                                    <div class="carousel-controls d-flex justify-content-between align-items-center mt-3 w-100" style="max-width:300px;">
                                        <button type="button" class="carousel-prev btn btn-secondary btn-lg px-4">‚Üê</button>
                                        <span class="carousel-counter fs-5">1 / 1</span>
                                        <button type="button" class="carousel-next btn btn-secondary btn-lg px-4">‚Üí</button>
                                    </div>
                                </div>
                            `;

                            // üìå –ü—Ä–∏–≤—è–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            const imgElement = preview.querySelector(".carousel-img");
                            const deleteBtn = preview.querySelector(".carousel-delete");
                            const prevBtn = preview.querySelector(".carousel-prev");
                            const nextBtn = preview.querySelector(".carousel-next");
                            const counter = preview.querySelector(".carousel-counter");

                            // üìå –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—É—Å–µ–ª–∏
                            function updateCarousel() {
                                const data = preview.carouselData;
                                if (data.length === 0) {
                                    preview.innerHTML = "<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>";
                                    preview.dataset.carouselInitialized = "";
                                    preview.carouselData = null;
                                    return;
                                }

                                const current = data[preview.currentIndex];
                                imgElement.src = current.url;
                                counter.textContent = `${preview.currentIndex + 1} / ${data.length}`;
                            }

                            // üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
                            deleteBtn.onclick = () => {
                                preview.carouselData.splice(preview.currentIndex, 1);
                                if (preview.currentIndex >= preview.carouselData.length) {
                                    preview.currentIndex = preview.carouselData.length - 1;
                                }
                                updateCarousel();

                                const dt = new DataTransfer();
                                preview.carouselData.forEach(item => dt.items.add(item.file));
                                input.files = dt.files;

                                // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                                if (input.id === "container_photos") {
                                    const display = document.getElementById("container_photos_display");
                                    if (display) {
                                        const count = input.files.length;
                                        display.textContent = count > 0
                                            ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}`
                                            : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                                    }
                                }
                            };

                            prevBtn.onclick = () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    updateCarousel();
                                }
                            };

                            nextBtn.onclick = () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    updateCarousel();
                                }
                            };

                            preview.updateCarousel = updateCarousel;
                            const leftZone = preview.querySelector(".carousel-left-zone");
                            const rightZone = preview.querySelector(".carousel-right-zone");

                            leftZone.addEventListener("click", () => {
                                if (preview.currentIndex > 0) {
                                    preview.currentIndex--;
                                    preview.updateCarousel();
                                }
                            });

                            rightZone.addEventListener("click", () => {
                                if (preview.currentIndex < preview.carouselData.length - 1) {
                                    preview.currentIndex++;
                                    preview.updateCarousel();
                                }
                            });
                        }

                        // ‚ûï –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        preview.carouselData.push({ file: renamedFile, url: imageURL });
                        preview.currentIndex = preview.carouselData.length - 1;
                        preview.updateCarousel();

                        // üóÇÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º input.files
                        const dt = new DataTransfer();
                        preview.carouselData.forEach(item => dt.items.add(item.file));
                        input.files = dt.files;

                        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
                        if (input.id === "body_photos") {
                            const display = document.getElementById("body_photos_display");
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        } else if (input.id.startsWith("defect_photo_input_")) {
                            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
                            const display = document.getElementById(`defect_photo_display_${index}`);
                            if (display) {
                                const count = input.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        }
                    };

                    reader.readAsDataURL(file);
                });


                // ‚è≥ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å–µ—Ö fetch
                Promise.all(promises).then(() => {
                    input.files = dt.files;
                    // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    if (input.id === "container_photos") {
                        const display = document.getElementById("container_photos_display");
                        if (display) {
                            const count = input.files.length;
                            display.textContent = count > 0
                                ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}`
                                : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    }
                });
            };

            input.click();
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è base64 –≤ Blob
        function dataURLToBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        };


    } else {
        // üíª –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let modal = document.createElement("div");
        modal.id = "camera_modal";
        modal.style.display = "none";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.flexDirection = "column";
        modal.innerHTML = `
            <video id="camera_feed" autoplay playsinline style="width:90%; max-width:500px;"></video>
            <button id="capture_button" class="btn btn-success mt-3">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        document.body.appendChild(modal);

        let video = document.getElementById("camera_feed");
        let captureButton = document.getElementById("capture_button");
        let closeButton = document.getElementById("close_camera");

        let canvas = document.createElement("canvas");
        let activeStream = null;
        let activeInput = null;
        let activePreview = null;

        window.openCamera = function (inputId, previewId) {
            activeInput = document.getElementById(inputId);
            activePreview = document.getElementById(previewId);

            if (!activeInput || !activePreview) {
                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –∏–ª–∏ preview");
                return;
            }

            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function (stream) {
                    activeStream = stream;
                    video.srcObject = stream;
                    modal.style.display = "flex";
                    setTimeout(() => video.play(), 500);
                })
                .catch(function (error) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                    alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
                });

            captureButton.onclick = function () {
                if (!activeInput || !activePreview) return;

                const ctx = canvas.getContext("2d");

                // ‚¨áÔ∏è –ú–∞—Å—à—Ç–∞–±: —à–∏—Ä–∏–Ω–∞ ‚â§ 1600px, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                const MAX_W = 1600;
                const vw = video.videoWidth || 0;
                const vh = video.videoHeight || 0;
                const scale = vw ? Math.min(1, MAX_W / vw) : 1;

                canvas.width = Math.round(vw * scale);
                canvas.height = Math.round(vh * scale);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // ‚¨áÔ∏è JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.6 (—Å–∂–∞—Ç–∏–µ)
                canvas.toBlob(function (blob) {
                    if (!blob) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–Ω–∏–º–æ–∫.");
                        return;
                    }
                    const ts = new Date().toISOString().replace(/[:.]/g, "-");
                    const file = new File([blob], `photo_${ts}.jpg`, { type: "image/jpeg" });

                    // –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π FileList
                    const dt = new DataTransfer();
                    if (!activeInput.multiple) {
                        activeInput.value = "";
                        while (activePreview.firstChild) activePreview.removeChild(activePreview.firstChild);
                    } else {
                        for (const f of activeInput.files) dt.items.add(f);
                    }
                    dt.items.add(file);
                    activeInput.files = dt.files;

                    // –ü—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
                    const imgContainer = document.createElement("div");
                    imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

                    const img = document.createElement("img");
                    img.src = URL.createObjectURL(file);
                    img.classList.add("img-thumbnail");
                    img.style.maxWidth = "300px";
                    img.style.borderRadius = "5px";
                    img.style.objectFit = "cover";

                    const deleteBtn = document.createElement("button");
                    deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
                    deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                    deleteBtn.onclick = function () {
                        imgContainer.remove();
                        removeFileFromInput(activeInput, file);

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
                        if (activeInput.id === "body_photos") {
                            const display = document.getElementById("body_photos_display");
                            if (display) {
                                const count = activeInput.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        } else if (activeInput.id.startsWith("defect_photo_input_")) {
                            const idx = activeInput.id.split("_").pop();
                            const display = document.getElementById(`defect_photo_display_${idx}`);
                            if (display) {
                                const count = activeInput.files.length;
                                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                            }
                        }
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(deleteBtn);
                    activePreview.appendChild(imgContainer);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
                    if (activeInput.id === "body_photos") {
                        const display = document.getElementById("body_photos_display");
                        if (display) {
                            const count = activeInput.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    } else if (activeInput.id.startsWith("defect_photo_input_")) {
                        const idx = activeInput.id.split("_").pop();
                        const display = document.getElementById(`defect_photo_display_${idx}`);
                        if (display) {
                            const count = activeInput.files.length;
                            display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
                        }
                    }

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
                    closeCamera();
                }, "image/jpeg", 0.6);
            };
        };

        function removeFileFromInput(inputElement, fileToRemove) {
            let dataTransfer = new DataTransfer();
            for (let i = 0; i < inputElement.files.length; i++) {
                let file = inputElement.files[i];
                if (file.name !== fileToRemove.name || file.size !== fileToRemove.size) {
                    dataTransfer.items.add(file);
                }
            }
            inputElement.files = dataTransfer.files;
        }

        function closeCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
            }
            video.srcObject = null;
            modal.style.display = "none";
        }

        closeButton.addEventListener("click", closeCamera);
        modal.addEventListener("click", function (event) {
            if (event.target === modal) closeCamera();
        });
    }
}


function rebuildInputFiles(input, preview) {
    const dt = new DataTransfer();

    const images = preview.querySelectorAll("img[data-file]");
    let promises = [];

    images.forEach(img => {
        const base64 = img.src;
        const filename = img.getAttribute("data-file");

        const p = fetch(base64)
            .then(res => res.blob())
            .then(blob => {
                const file = new File([blob], filename, { type: blob.type });
                dt.items.add(file);
            });

        promises.push(p);
    });

    Promise.all(promises).then(() => {
        input.files = dt.files;
        // üîÑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—É–∑–æ–≤–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–∞
        if (input.id === "body_photos") {
            const display = document.getElementById("body_photos_display");
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        } else if (input.id.startsWith("defect_photo_input_")) {
            const index = input.id.split("_").pop(); // –ø–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –∏–∑ id
            const display = document.getElementById(`defect_photo_display_${index}`);
            if (display) {
                const count = input.files.length;
                display.textContent = count > 0 ? `üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ç–æ: ${count}` : "üì∑ –§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
            }
        }
    });
}
</script>
{% endblock %}
