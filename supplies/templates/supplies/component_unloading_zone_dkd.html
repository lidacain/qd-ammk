{% extends "users/base.html" %}

{% block title %}–ü–æ—Å—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –î–í–°, DKD{% endblock %}

{% block content %}

<style>
.defect-photo-preview:empty {
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ */
}
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
.photo-preview-container,
#vin_photo_preview,
#component_photos_preview,
.defect-photo-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-start;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.photo-preview-container img,
#vin_photo_preview img,
#component_photos_preview img,
.defect-photo-preview img {
    max-width: 200px !important; /* –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ—Ç –∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    height: auto !important;
    border-radius: 5px !important;
    object-fit: cover !important;
    display: block !important;
}
.defect-photo-preview .img-thumbnail {
    max-width: 200px !important;
    height: auto !important;
    border-radius: 5px;
    object-fit: cover;
    display: block;
}




</style>

<div class="container mt-4">
    <h2>–ü–æ—Å—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –î–í–°, DKD</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- üìå –ü–æ–∏—Å–∫ –ø–æ VIN -->
        <div class="mb-3 position-relative">
            <label class="form-label">–ù–æ–º–µ—Ä –î–í–°</label>
            <div style="position: relative;">
                <input type="text" id="engine_search" name="engine_number" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è...">
                <span id="clear_engine_search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none;">‚ùå</span>
            </div>
            <ul id="engine_list" class="list-group mt-2" style="display: none; position: absolute; width: 100%; z-index: 1000;"></ul>
        </div>

        <!-- üìå –î–∞–Ω–Ω—ã–µ –æ –∫—É–∑–æ–≤–µ -->
        <div id="vehicle_info" class="mb-3 p-3 border rounded" style="display: none;">
            <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É–∑–æ–≤–µ:</h5>
            <p><strong>–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è:</strong> <span id="engine_value"></span></p> <!-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π ID -->
            <p><strong>VIN:</strong> <span id="engine_number_value"></span></p> <!-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π ID -->
            <p><strong>–ú–æ–¥–µ–ª—å:</strong> <span id="model_value"></span></p>
            <p><strong>–¶–≤–µ—Ç –∫—É–∑–æ–≤–∞:</strong> <span id="body_color_value"></span></p>
        </div>

        <!-- üìå –§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ VIN (–æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) -->
        <div class="mb-3 defect-photo-container">
            <label class="form-label">–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –î–í–°</label>
            <input type="file" class="form-control engine_photo" name="engine_photo" id="engine_photo">
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('engine_photo')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div id="engine_photo_preview" class="photo-preview-container mt-2"></div>
        </div>

        <!-- üìå –§–æ—Ç–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä) -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</label>
            <input type="file" name="component_photos" id="component_photos" class="form-control" multiple>
            <button type="button" class="btn btn-primary mt-2" onclick="openCamera('component_photos')">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <div id="component_photos_preview" class="d-flex flex-wrap mt-2 gap-2"></div> <!-- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ gap-2 -->
        </div>

        <!-- üìå –í—ã–±–æ—Ä –µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç -->
        <div class="mb-3">
            <label class="form-label">–ï—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç?</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_yes" value="yes">
                <label class="form-check-label" for="defect_yes">–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="has_defect" id="defect_no" value="no">
                <label class="form-check-label" for="defect_no">–î–µ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç</label>
            </div>
        </div>

        <!-- üìå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
        <div id="defect_container" class="mt-3" style="display:none;">
            <h5>–°–ø–∏—Å–æ–∫ –¥–µ—Ñ–µ–∫—Ç–æ–≤:</h5>
            <div id="defect_list"></div> <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–æ–≤ -->
            <button type="button" class="btn btn-primary mt-2" id="add_defect_btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>

            <!-- üìå –®–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ `defect_container`, –Ω–æ —Å–∫—Ä—ã—Ç) -->
            <div id="defect_template" class="defect-form border p-3 mt-2 rounded" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¥–µ—Ñ–µ–∫—Ç</label>
                    <select name="responsible" class="form-control responsible-select">
                        <option value="">üîç –ü–æ–∏—Å–∫...</option>
                        {% for responsible in defect_responsibles %}
                            <option value="{{ responsible.id }}">{{ responsible.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å</label>
                    <select name="detail" class="form-control detail-select">
                        <option value="">üîç –ü–æ–∏—Å–∫...</option>
                        {% for detail in details %}
                            <option value="{{ detail.id }}">{{ detail.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç</label>
                    <select class="form-control defect-type" name="defect">
                        {% for defect in defects %}
                            <option value="{{ defect.id }}">{{ defect.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" class="form-control mt-2 custom-defect-explanation" name="custom_defect_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>

                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="form-control defect-quantity" name="quantity" min="1" value="1">
                </div>

                <div class="mb-3">
                    <label class="form-label">–ì—Ä–µ–π–¥ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <select class="form-control defect-grade" name="grade">
                        {% for grade in defect_grades %}
                            <option value="{{ grade.id }}">{{ grade.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- üìå –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ä–µ–º–æ–Ω—Ç–∞ -->
                <div class="mb-3">
                    <label class="form-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="repair_type" id="repair_online" value="online" checked>
                        <label class="form-check-label" for="repair_online">Online</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="repair_type" id="repair_offline" value="offline">
                        <label class="form-check-label" for="repair_offline">Offline</label>
                    </div>
                </div>

                <!-- üìå –§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ -->
                <div class="mb-3">
                    <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                    <input type="file" name="defect_photos[]" class="form-control defect-photo" multiple>
                    <button type="button" class="btn btn-primary mt-2 open-camera-btn" data-defect-index="">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                    <div class="defect-photo-preview photo-preview-container mt-2"></div>
                </div>
                <!-- üìå –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞ -->
                <button type="button" class="btn btn-danger remove-defect-btn">‚ùå –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
            </div>
        </div>

        <button type="submit" class="btn btn-success w-100 mt-5 mb-5">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω!");

    // üîπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –¥–≤–∏–≥–∞—Ç–µ–ª—è
    setupEngineSearch();

    // üîπ –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ—Ñ–µ–∫—Ç–æ–≤
    setupDefectHandling();

    // üîπ –í–∫–ª—é—á–∞–µ–º –ø–æ–∏—Å–∫ –≤ select-–∞—Ö
    enableSearchableDropdowns();

    // üîπ –í–∫–ª—é—á–∞–µ–º —Ä–∞–±–æ—Ç—É —Å –∫–∞–º–µ—Ä–æ–π
    setupCamera();

    // üîπ –í–∫–ª—é—á–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    setupFormValidation();

    setupToggleRepairField;

    console.log("‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
});


function setupEngineSearch() {
    let engineInput = document.getElementById("engine_search");
    let engineList = document.getElementById("engine_list");
    let clearButton = document.getElementById("clear_engine_search");
    let vehicleInfo = document.getElementById("vehicle_info");

    let engineValue = document.getElementById("engine_value"); // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
    let vinValue = document.getElementById("engine_number_value"); // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º ID
    let modelValue = document.getElementById("model_value");
    let bodyColorValue = document.getElementById("body_color_value");

    engineInput.addEventListener("input", function () {
        let query = engineInput.value.trim();

        if (query.length > 0) {
            clearButton.style.display = "block";
        } else {
            clearButton.style.display = "none";
        }

        if (!query) {
            engineList.style.display = "none";
            return;
        }

        // ‚úÖ –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è
        fetch(`/supplies/api/search_engine/?q=${query}`)
            .then(response => {
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                return response.json();
            })
            .then(data => {
                engineList.innerHTML = "";
                if (data.results.length === 0) {
                    engineList.style.display = "none";
                    return;
                }

                data.results.forEach(item => {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = item.engine_number;
                    li.addEventListener("click", function () {
                        engineInput.value = item.engine_number;
                        engineList.style.display = "none";
                        clearButton.style.display = "block";

                        // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—à–∏–Ω–µ
                        if (item.engine_number) engineValue.textContent = item.engine_number;
                        if (item.vin) vinValue.textContent = item.vin;
                        if (item.model) modelValue.textContent = item.model;
                        if (item.body_color) bodyColorValue.textContent = item.body_color;

                        // ‚úÖ –î–µ–ª–∞–µ–º –±–ª–æ–∫ vehicle_info –≤–∏–¥–∏–º—ã–º
                        vehicleInfo.style.display = "block";
                    });

                    engineList.appendChild(li);
                });

                engineList.style.display = "block";
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –Ω–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è:", error));
    });

    // ‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
    clearButton.addEventListener("click", function () {
        engineInput.value = "";
        clearButton.style.display = "none";
        engineList.style.display = "none";
        vehicleInfo.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ
    });

    // ‚úÖ –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –Ω–µ–≥–æ
    document.addEventListener("click", function (event) {
        if (!engineInput.contains(event.target) && !engineList.contains(event.target)) {
            engineList.style.display = "none";
        }
    });

    console.log("‚úÖ –ü–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω!");
}


function setupCamera() {
    console.log("üì∏ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞!");

    // ‚úÖ –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã –≤ DOM
    let modal = document.createElement("div");
    modal.id = "camera_modal";
    modal.style.display = "none"; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.background = "rgba(0,0,0,0.8)";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.flexDirection = "column";
    modal.innerHTML = `
        <video id="camera_feed" autoplay playsinline style="width:90%; max-width:500px;"></video>
        <button id="capture_button" class="btn btn-success mt-3">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
        <button id="close_camera" class="btn btn-danger mt-2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    `;
    document.body.appendChild(modal);

    let video = document.getElementById("camera_feed");
    let captureButton = document.getElementById("capture_button");
    let closeButton = document.getElementById("close_camera");
    let canvas = document.createElement("canvas");

    let activeInput = null;
    let activePreview = null;
    let activeStream = null;

    // üîπ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
    window.openCamera = function (inputId) {
        console.log(`üì∑ –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã –¥–ª—è ${inputId}`);

        if (!captureButton) {
            console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            return;
        }

        activeInput = document.getElementById(inputId);

        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã `id` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–Ω—ã—Ö —Ñ–æ—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª –≤–µ—Ä–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
        let previewId = inputId.includes("defect_photo_") ? `defect_photo_preview_${inputId.split("_")[2]}` : `${inputId}_preview`;
        activePreview = document.getElementById(previewId);

        // ‚úÖ –ï—Å–ª–∏ preview –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        if (!activePreview) {
            activePreview = document.createElement("div");
            activePreview.id = previewId; // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π `id`
            activePreview.classList.add("d-flex", "flex-wrap", "gap-2", "mt-2");
            activeInput.parentNode.appendChild(activePreview);
        }


        if (!activeInput) {
            console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –¥–ª—è", inputId);
            return;
        }

        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
                activeStream = stream;
                video.srcObject = stream;
                modal.style.display = "flex";
                setTimeout(() => video.play(), 500);
            })
            .catch(function (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
                alert(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
            });
    };

    // üîπ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å—ä–µ–º–∫–∏ —Ñ–æ—Ç–æ (–î–û–ë–ê–í–õ–Ø–ï–ú addEventListener!)
    captureButton.addEventListener("click", function () {
        if (!activeInput || !activePreview) {
            console.error("‚ùå –û—à–∏–±–∫–∞: –∞–∫—Ç–∏–≤–Ω—ã–µ input –∏–ª–∏ preview –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!");
            return;
        }

        console.log(`üì∏ –ó–∞—Ö–≤–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è ${activeInput.id}...`);
        let context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function (blob) {
            let file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });

            let dataTransfer = new DataTransfer();
            if (activeInput.multiple) {
                // ‚úÖ –ï—Å–ª–∏ input –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                for (let existingFile of activeInput.files) {
                    dataTransfer.items.add(existingFile);
                }
            }
            dataTransfer.items.add(file);
            activeInput.files = dataTransfer.files;

            // ‚úÖ –ï—Å–ª–∏ input –æ–¥–∏–Ω–æ—á–Ω—ã–π ‚Äî —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–µ–≤—å—é –≤—Ä—É—á–Ω—É—é
            if (!activeInput.multiple) {
                while (activePreview.firstChild) {
                    activePreview.removeChild(activePreview.firstChild);
                }
            }


            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
            let imgContainer = document.createElement("div");
            imgContainer.classList.add("d-flex", "flex-column", "align-items-center", "m-2");

            let img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-thumbnail", "defect-photo-img"); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã


            let deleteBtn = document.createElement("button");
            deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            deleteBtn.innerHTML = "–£–¥–∞–ª–∏—Ç—å";
            deleteBtn.onclick = function () {
                imgContainer.remove();
                removeFileFromInput(activeInput, file); // ‚úÖ –§–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –∏–∑ input.files
            };
            imgContainer.appendChild(img);
            imgContainer.appendChild(deleteBtn);
            activePreview.appendChild(imgContainer);

            closeCamera();
        }, "image/jpeg");
    });


    function removeFileFromInput(inputElement, fileToRemove) {
        let dataTransfer = new DataTransfer();
        for (let i = 0; i < inputElement.files.length; i++) {
            let file = inputElement.files[i];
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏ —Ä–∞–∑–º–µ—Ä—É (—ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
            if (file.name !== fileToRemove.name || file.size !== fileToRemove.size) {
                dataTransfer.items.add(file);
            }
        }
        inputElement.files = dataTransfer.files;
    }


    // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã
    function closeCamera() {
        console.log("‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–º–µ—Ä—ã");
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }
        video.srcObject = null;
        modal.style.display = "none";
    }

    closeButton.addEventListener("click", closeCamera);

    modal.addEventListener("click", function (event) {
        if (event.target === modal) {
            closeCamera();
        }
    });

    // üîπ –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏–∑ input
    function removeFileFromInput(inputElement, fileToRemove) {
        let dataTransfer = new DataTransfer();
        for (let i = 0; i < inputElement.files.length; i++) {
            if (inputElement.files[i] !== fileToRemove) {
                dataTransfer.items.add(inputElement.files[i]);
            }
        }
        inputElement.files = dataTransfer.files;
    }
}


function enableSearchableDropdowns() {
    document.querySelectorAll(".searchable-dropdown").forEach(selectElement => {
        if (selectElement.classList.contains("dropdown-initialized")) return;
        selectElement.classList.add("dropdown-initialized");

        let container = document.createElement("div");
        container.classList.add("dropdown");

        let inputGroup = document.createElement("div");
        inputGroup.classList.add("input-group");

        let input = document.createElement("input");
        input.setAttribute("type", "text");
        input.setAttribute("class", "form-control dropdown-toggle");
        input.setAttribute("placeholder", "üîç –ü–æ–∏—Å–∫...");
        input.setAttribute("data-bs-toggle", "dropdown");

        let dropdownMenu = document.createElement("ul");
        dropdownMenu.classList.add("dropdown-menu", "w-100");
        dropdownMenu.style.maxHeight = "250px";
        dropdownMenu.style.overflowY = "auto";

        inputGroup.appendChild(input);
        container.appendChild(inputGroup);
        container.appendChild(dropdownMenu);
        selectElement.parentNode.insertBefore(container, selectElement);
        selectElement.style.display = "none"; // ‚úÖ –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π select

        function updateDropdown() {
            let query = input.value.toLowerCase();
            dropdownMenu.innerHTML = "";
            let matchCount = 0;

            Array.from(selectElement.options).forEach(option => {
                if (option.value && option.text.toLowerCase().includes(query)) {
                    let item = document.createElement("li");
                    let link = document.createElement("a");
                    link.setAttribute("href", "#");
                    link.classList.add("dropdown-item");
                    link.textContent = option.text;
                    link.onclick = function (event) {
                        event.preventDefault();
                        input.value = option.text;
                        selectElement.value = option.value;
                        dropdownMenu.classList.remove("show");
                    };
                    item.appendChild(link);
                    dropdownMenu.appendChild(item);
                    matchCount++;
                }
            });

            if (matchCount > 0) {
                dropdownMenu.classList.add("show");
            } else {
                dropdownMenu.classList.remove("show");
            }
        }

        input.addEventListener("input", updateDropdown);
        input.addEventListener("focus", updateDropdown);
        document.addEventListener("click", function (event) {
            if (!container.contains(event.target)) {
                dropdownMenu.classList.remove("show");
            }
        });
    });
}



function setupDefectHandling() {
    console.log("üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!");

    let defectContainer = document.getElementById("defect_container");
    let defectList = document.getElementById("defect_list");
    let addDefectBtn = document.getElementById("add_defect_btn");
    let defectRadioButtons = document.querySelectorAll("input[name='has_defect']");

    // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–ï—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç"
    defectRadioButtons.forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "yes") {
                defectContainer.style.display = "block";
                if (defectList.children.length === 0) {
                    addDefectForm(); // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º—É–º 1 —Ñ–æ—Ä–º—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–±–æ—Ä–µ
                }
            } else {
                defectContainer.style.display = "none";
                defectList.innerHTML = ""; // ‚úÖ –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–ù–µ—Ç –¥–µ—Ñ–µ–∫—Ç–æ–≤"
            }
        });
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã –¥–µ—Ñ–µ–∫—Ç–∞
    function addDefectForm() {
        let defectIndex = document.querySelectorAll(".defect-form").length; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–µ—Ñ–µ–∫—Ç–∞

        let defectForm = document.createElement("div");
        defectForm.classList.add("border", "p-3", "mt-2", "rounded", "defect-form");
        defectForm.innerHTML = `
            <h6>–î–µ—Ñ–µ–∫—Ç ${defectIndex }</h6>
            <div class="mb-3">
                <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –¥–µ—Ñ–µ–∫—Ç</label>
                <select class="form-control searchable-dropdown responsible-select" name="responsible_${defectIndex}">
                    ${responsiblesOptions()}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å</label>
                <select class="form-control searchable-dropdown defect-detail" name="detail_${defectIndex}">
                    ${detailsOptions()}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç</label>
                <select class="form-control searchable-dropdown defect-type" name="defect_${defectIndex}">
                    ${defectsOptions()}
                </select>
                <input type="text" class="form-control mt-2 custom-defect-explanation" name="custom_defect_explanation_${defectIndex}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            </div>
            <div class="mb-3">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" class="form-control defect-quantity" name="quantity_${defectIndex}" min="1" value="1">
            </div>
            <div class="mb-3">
                <label class="form-label">–ì—Ä–µ–π–¥ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                <select class="form-control searchable-dropdown defect-grade" name="grade_${defectIndex}">
                    ${gradesOptions()}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞</label>
                <select class="form-control defect-repair-type" name="repair_type_${defectIndex}" onchange="toggleRepairField(this, ${defectIndex})">
                    <option value="online">online</option>
                    <option value="offline">offline</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–§–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞</label>
                <input type="file" class="form-control defect-photo" name="defect_photos_${defectIndex}" id="defect_photo_${defectIndex}" multiple>
                <button type="button" class="btn btn-primary mt-2 open-camera-btn" data-defect-index="${defectIndex}">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                <div id="defect_photo_preview_${defectIndex}" class="photo-preview-container defect-photo-preview mt-2 d-flex flex-wrap gap-2"></div>
            </div>
            <button type="button" class="btn btn-danger remove-defect-btn">‚ùå –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç</button>
        `;

        defectList.appendChild(defectForm); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç –≤ —Å–ø–∏—Å–æ–∫


        // ‚úÖ –í–∫–ª—é—á–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤ select (–æ–±–Ω–æ–≤–ª—è–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
        enableSearchableDropdowns();

        // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
        defectForm.querySelector(".open-camera-btn").addEventListener("click", function () {
            let defectIndex = this.getAttribute("data-defect-index");
            openCamera(`defect_photo_${defectIndex}`, `defect_photo_preview_${defectIndex}`);
        });

        // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞
        defectForm.querySelector(".remove-defect-btn").addEventListener("click", function () {
            defectForm.remove();
            updateDefectNumbers(); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
        });
    }

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    function updateDefectNumbers() {
        document.querySelectorAll(".defect-form").forEach((form, index) => {
            form.querySelector("h6").textContent = `–î–µ—Ñ–µ–∫—Ç ${index + 1}`;
        });
    }

    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç"
    addDefectBtn.addEventListener("click", function () {
        addDefectForm();
    });

    // ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ Django (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è)
    function responsiblesOptions() {
        return `{% for responsible in defect_responsibles %}<option value="{{ responsible.id }}">{{ responsible.name }}</option>{% endfor %}`;
    }

    function detailsOptions() {
        return `{% for detail in details %}<option value="{{ detail.id }}">{{ detail.name }}</option>{% endfor %}`;
    }

    function defectsOptions() {
        return `{% for defect in defects %}<option value="{{ defect.id }}">{{ defect.name }}</option>{% endfor %}`;
    }

    function gradesOptions() {
        return `{% for grade in defect_grades %}<option value="{{ grade.id }}">{{ grade.name }}</option>{% endfor %}`;
    }

}
function enableSearchableDropdown(selectElement) {
    if (!selectElement || selectElement.classList.contains("dropdown-initialized")) return;
    selectElement.classList.add("dropdown-initialized");

    let container = document.createElement("div");
    container.classList.add("dropdown");

    let inputGroup = document.createElement("div");
    inputGroup.classList.add("input-group");

    let input = document.createElement("input");
    input.setAttribute("type", "text");
    input.setAttribute("class", "form-control dropdown-toggle");
    input.setAttribute("placeholder", "üîç –ü–æ–∏—Å–∫...");
    input.setAttribute("data-bs-toggle", "dropdown");

    let dropdownMenu = document.createElement("ul");
    dropdownMenu.classList.add("dropdown-menu", "w-100");
    dropdownMenu.style.maxHeight = "250px";
    dropdownMenu.style.overflowY = "auto";

    inputGroup.appendChild(input);
    container.appendChild(inputGroup);
    container.appendChild(dropdownMenu);
    selectElement.parentNode.insertBefore(container, selectElement);
    selectElement.style.display = "none"; // ‚úÖ –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π select

    function updateDropdown() {
        let query = input.value.toLowerCase();
        dropdownMenu.innerHTML = "";
        let matchCount = 0;

        Array.from(selectElement.options).forEach(option => {
            if (option.value && option.text.toLowerCase().includes(query)) {
                let item = document.createElement("li");
                let link = document.createElement("a");
                link.setAttribute("href", "#");
                link.classList.add("dropdown-item");
                link.textContent = option.text;
                link.onclick = function (event) {
                    event.preventDefault();
                    input.value = option.text;
                    selectElement.value = option.value;
                    dropdownMenu.classList.remove("show");
                };
                item.appendChild(link);
                dropdownMenu.appendChild(item);
                matchCount++;
            }
        });

        if (matchCount > 0) {
            dropdownMenu.classList.add("show");
        } else {
            dropdownMenu.classList.remove("show");
        }
    }

    input.addEventListener("input", updateDropdown);
    input.addEventListener("focus", updateDropdown);
    document.addEventListener("click", function (event) {
        if (!container.contains(event.target)) {
            dropdownMenu.classList.remove("show");
        }
    });
}

// ‚úÖ –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç enableSearchableDropdown() –¥–ª—è –≤—Å–µ—Ö select
function enableSearchableDropdowns() {
    document.querySelectorAll(".responsible-select, .defect-detail, .defect-type").forEach(enableSearchableDropdown);
}

function validateForm(event) {
    let errors = [];
    let engineInput = document.getElementById("engine_search");
    let enginePhotoInput = document.getElementById("engine_photo");
    let componentPhotosInput = document.getElementById("component_photos");
    let hasDefectYes = document.getElementById("defect_yes");
    let hasDefectNo = document.getElementById("defect_no");
    let defectContainer = document.getElementById("defect_container");

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ VIN
    if (!engineInput.value.trim()) {
        errors.push("–ù–æ–º–µ—Ä –¥–≤–∏–≥–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!");
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ª–∏ —Ñ–æ—Ç–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è
    if (enginePhotoInput.files.length === 0) {
        errors.push("–§–æ—Ç–æ –Ω–æ–º–µ—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!");
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ª–∏ —Ñ–æ—Ç–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö
    if (componentPhotosInput.files.length === 0) {
        errors.push("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö!");
    }

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ `has_defect`
    if (!hasDefectYes.checked && !hasDefectNo.checked) {
        errors.push("–í—ã–±–µ—Ä–∏—Ç–µ, –µ—Å—Ç—å –ª–∏ –¥–µ—Ñ–µ–∫—Ç!");
    }

    // ‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π
    if (hasDefectYes.checked) {
        let defectForms = document.querySelectorAll(".defect-form");
        if (defectForms.length === 0) {
            errors.push("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ—Ñ–µ–∫—Ç!");
        } else {
            defectForms.forEach((form, index) => {
                let responsible = form.querySelector(".responsible-select");
                let detail = form.querySelector(".defect-detail");
                let defectType = form.querySelector(".defect-type");
                let quantity = form.querySelector(".defect-quantity");
                let repairType = form.querySelector(".defect-repair-type");

                if (!responsible.value) errors.push(`–î–µ—Ñ–µ–∫—Ç ${index + 1}: –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ!`);
                if (!detail.value) errors.push(`–î–µ—Ñ–µ–∫—Ç ${index + 1}: –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å!`);
                if (!defectType.value) errors.push(`–î–µ—Ñ–µ–∫—Ç ${index + 1}: –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞!`);
                if (!quantity.value || quantity.value < 1) errors.push(`–î–µ—Ñ–µ–∫—Ç ${index + 1}: —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!`);
                if (!repairType.value) errors.push(`–î–µ—Ñ–µ–∫—Ç ${index + 1}: –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞!`);
            });
        }
    }

    // ‚ùå –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Äì –æ—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∏ –≤—ã–≤–æ–¥–∏–º –∏—Ö
    if (errors.length > 0) {
        event.preventDefault();
        alert(errors.join("\n"));
    }
}

// ‚úÖ –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫ —Ñ–æ—Ä–º–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.addEventListener("DOMContentLoaded", function () {
    let form = document.querySelector("form");
    form.addEventListener("submit", validateForm);
});



</script>

{% endblock %}